<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>ã€Œåˆ†å‰²é¡¹ç›®ã€ï¼ˆä¸‰ï¼‰åŸºäºBiSeNetçš„ç½‘é¡µç«¯äººåƒåˆ†å‰²ä»»åŠ¡</title>
      <link href="/2022/05/22/%E3%80%8C%E5%88%86%E5%89%B2%E9%A1%B9%E7%9B%AE%E3%80%8D%EF%BC%88%E4%B8%89%EF%BC%89%E5%9F%BA%E4%BA%8EBiSeNet%E7%9A%84%E4%BA%BA%E5%83%8F%E5%88%86%E5%89%B2%E4%BB%BB%E5%8A%A1/"/>
      <url>/2022/05/22/%E3%80%8C%E5%88%86%E5%89%B2%E9%A1%B9%E7%9B%AE%E3%80%8D%EF%BC%88%E4%B8%89%EF%BC%89%E5%9F%BA%E4%BA%8EBiSeNet%E7%9A%84%E4%BA%BA%E5%83%8F%E5%88%86%E5%89%B2%E4%BB%BB%E5%8A%A1/</url>
      
        <content type="html"><![CDATA[<h2 id="BiSeNetæ¨¡å‹ä»‹ç»"><a href="#BiSeNetæ¨¡å‹ä»‹ç»" class="headerlink" title="BiSeNetæ¨¡å‹ä»‹ç»"></a>BiSeNetæ¨¡å‹ä»‹ç»</h2><blockquote><p>ã€Œ<a href="https://zhuanlan.zhihu.com/p/41475332">å‚è€ƒæ–‡ç« </a>ã€</p></blockquote><p>BiSeNetåˆ†æäº†æ¨¡å‹ç»“æ„å±‚é¢åŠ é€Ÿçš„æ–¹æ³•ï¼Œå¹¶æå‡ºåŒåˆ†æ”¯çš„BiSeNetæ¥åŠ é€Ÿ</p><h3 id="åœ¨è¾“å…¥å’Œæ¨¡å‹ä¸Šæ”¹åŠ¨"><a href="#åœ¨è¾“å…¥å’Œæ¨¡å‹ä¸Šæ”¹åŠ¨" class="headerlink" title="åœ¨è¾“å…¥å’Œæ¨¡å‹ä¸Šæ”¹åŠ¨"></a>åœ¨è¾“å…¥å’Œæ¨¡å‹ä¸Šæ”¹åŠ¨</h3><p>åŸå§‹å›¾åƒresizeç¼ºç‚¹ï¼šä¸¢å¤±ç©ºé—´ä¿¡æ¯ï¼ˆspatial information ï¼‰</p><p>åˆ å‡ç½‘ç»œå±‚ï¼Œä»¥æé€Ÿç¼ºç‚¹ï¼šæ¨¡å‹å®¹é‡ä¸‹é™ï¼Œç²¾åº¦é™ä½</p><span id="more"></span><h3 id="åœ¨ç»“æ„ä¸Šæ”¹åŠ¨"><a href="#åœ¨ç»“æ„ä¸Šæ”¹åŠ¨" class="headerlink" title="åœ¨ç»“æ„ä¸Šæ”¹åŠ¨"></a>åœ¨ç»“æ„ä¸Šæ”¹åŠ¨</h3><p>Uå‹å¼¥è¡¥ä¸¢å¤±çš„ç©ºé—´ä¿¡æ¯çš„ç¼ºç‚¹ï¼šæ…¢ï¼</p><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hjq8b3jwj20zk0etgnv.jpg"></p><p>BiSeNetä¸»è¦æœ‰ä¸¤å¤§åˆ†æ”¯æ„æˆï¼Œåˆ†åˆ«æ˜¯<strong>Spatialåˆ†æ”¯</strong>å’Œ<strong>Contextåˆ†æ”¯</strong></p><p><strong>Spatialåˆ†æ”¯</strong>é‡‡ç”¨å°æ­¥é•¿çš„ç­–ç•¥ï¼Œå°‘é™ä½åˆ†è¾¨ç‡ï¼Œä»¥ä¿ç•™æ›´å¤šç©ºé—´ä¿¡æ¯</p><p><strong>Contextåˆ†æ”¯</strong>é‡‡ç”¨å¿«é€Ÿä¸‹é™åˆ†è¾¨ç‡çš„ç­–ç•¥ï¼Œä½¿ç‰¹å¾å…·æœ‰ä¸°å¯Œçš„æ„Ÿå—é‡æœ€ååˆ©ç”¨ç‰¹å¾èåˆæ¨¡å—FFMï¼Œå°†ä¸¤ä¸ªåˆ†æ”¯ç‰¹å¾è¿›è¡Œèåˆå³å¯è¾“å‡º</p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hjr92kljj20k00nomz4.jpg" style="zoom:50%;" /><p>ARMï¼šAttention Refinment Moduleæ³¨æ„åŠ›æœºåˆ¶æ¨¡å—</p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hjrxi3oej20zk0g3ta1.jpg" style="zoom: 33%;" /><p>FFMï¼šFeature Fusion Moduleï¼Œç‰¹å¾èåˆæ¨¡å—ï¼Œè®¾è®¡ä¸€ä¸ªèƒ½å°†ç‰¹å¾å›¾èåˆåœ¨ä¸€èµ·çš„æ¨¡å—</p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hjs9dnt1j20zk0fv403.jpg" style="zoom: 33%;" /><p>è¾…åŠ©æŸå¤±ï¼šåœ¨Contextåˆ†æ”¯è¾“å‡ºçš„ç‰¹å¾å›¾ç›´æ¥ç”¨äºè®¡ç®—åˆ†å‰²ç»“æœï¼Œè€ŒFeature map è¾“å…¥åˆ°ä¸€ä¸ªconvå±‚ç”¨äºè¾“å‡ºåˆ†å‰²ç»“æœ</p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hk5l3ar7j20k00p20tv.jpg" style="zoom: 33%;" />$$L(X;W) = l_p(X;W) + \alpha \sum_{i=2}^{K}l_i(X_i;W)$$<h2 id="äººåƒåˆ†å‰²æ•°æ®é›†"><a href="#äººåƒåˆ†å‰²æ•°æ®é›†" class="headerlink" title="äººåƒåˆ†å‰²æ•°æ®é›†"></a>äººåƒåˆ†å‰²æ•°æ®é›†</h2><h3 id="Portrait-Dataset-2000ã€Œé“¾æ¥ğŸ”—ã€"><a href="#Portrait-Dataset-2000ã€Œé“¾æ¥ğŸ”—ã€" class="headerlink" title="Portrait Dataset 2000ã€Œé“¾æ¥ğŸ”—ã€"></a>Portrait Dataset 2000ã€Œ<a href="http://www.cse.cuhk.edu.hk/~leojia/projects/automatting/index.html">é“¾æ¥</a>ğŸ”—ã€</h3><p>Portrait æ•°æ®é›†ç”±é¦™æ¸¯ä¸­æ–‡å¤§å­¦äº2016å¹´å‘å¸ƒï¼Œæ˜¯å½“å‰æ ‡æ³¨è´¨é‡è¾ƒé«˜çš„æ•°æ®é›†ä¹‹ä¸€ã€‚å…±æœ‰2000å¼ è‡ªæ‹äººåƒå›¾åƒï¼Œ1700è®­ç»ƒã€300æµ‹è¯•</p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hkf9crvtj20k00ka76o.jpg" style="zoom:50%;" /><h3 id="Portrait-Dataset-34427ã€Œ-é“¾æ¥-https-github-com-aisegmentcn-matting-human-datasets"><a href="#Portrait-Dataset-34427ã€Œ-é“¾æ¥-https-github-com-aisegmentcn-matting-human-datasets" class="headerlink" title="Portrait Dataset 34427ã€Œ[é“¾æ¥](https://github.com/aisegmentcn/matting_human_datasets"></a>Portrait Dataset 34427ã€Œ[é“¾æ¥](<a href="https://github.com/aisegmentcn/matting_human_datasets">https://github.com/aisegmentcn/matting_human_datasets</a></h3><p>)ğŸ”—ã€</p><p>ç”±åŒ—äº¬ç©æ˜Ÿæ±‡èšç§‘æŠ€æœ‰é™å…¬å¸é«˜è´¨é‡æ ‡æ³¨ï¼ŒåŸå§‹å›¾ç‰‡æ¥æºäºFlickrã€ç™¾åº¦ã€æ·˜å®ã€‚ç»è¿‡äººè„¸æ£€æµ‹å’ŒåŒºåŸŸè£å‰ªåç”Ÿæˆäº†600*800çš„åŠèº«äººåƒã€‚</p><table><thead><tr><th><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hkhip0rnj20nb0k00vg.jpg"></th><th><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hki1lxs8j20nu0k076q.jpg"></th></tr></thead></table><h2 id="æŸå¤±å‡½æ•°"><a href="#æŸå¤±å‡½æ•°" class="headerlink" title="æŸå¤±å‡½æ•°"></a>æŸå¤±å‡½æ•°</h2><p>å›¾åƒåˆ†å‰²ä»»åŠ¡ä¸­ï¼ŒæŸå¤±å‡½æ•°æ˜¯ä¸€å¤§ç ”ç©¶æ–¹å‘ï¼Œä¸»è¦ä»¥ã€Œ**åŸºäºæ•°æ®åˆ†å¸ƒçš„$CE$<strong>ã€å’Œ ã€Œ</strong>åŸºäºåŒºåŸŸçš„$Dice$**ã€ä¸ºåŸºç¡€è¿›è¡Œå±•å¼€</p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hmq8ya63j20zk0i1whm.jpg" style="zoom:67%;" /><h3 id="Dice-Loss"><a href="#Dice-Loss" class="headerlink" title="Dice Loss"></a>Dice Loss</h3><p>$Dice Loss$ æ¥è‡ª<a href="https://arxiv.org/abs/1606.04797">æ–‡çŒ®</a>ï¼Œæ˜¯ä»Diceç³»æ•°æ¨å¹¿å¾—åˆ°çš„æŸå¤±å‡½æ•°ã€‚</p><p>$Dice$ ç³»æ•°æ˜¯ä¸€ç§é›†åˆç›¸ä¼¼åº¦åº¦é‡å‡½æ•°ï¼Œæ˜¯ä»<strong>åŒºåŸŸè§’åº¦</strong>è¡¡é‡ä¸¤ä¸ªé›†åˆçš„ç›¸ä¼¼åº¦ã€‚ï¼ˆ$CE Loss$æ˜¯ä»æ¦‚ç‡åˆ†å¸ƒè§’åº¦ï¼‰</p><p>$Dice$ ç³»æ•°å€¼åŸŸä¸º $[0, 1]$ ï¼Œä¸¤ä¸ªé›†åˆå®Œå…¨é‡å æ—¶ä¸º$1$ï¼Œ å®Œå…¨ä¸é‡å æ—¶ä¸º$0$ï¼Œè®¡ç®—å…¬å¼å¦‚ä¸‹<br>$$<br>Dice &#x3D; \frac{2TP}{FP + 2TP + FN} \Leftrightarrow  \frac{2*gtmask\cap predmask}{gtmask + predmask}<br>$$<br><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hn1oplx2j20qb0k00ue.jpg" style="zoom:50%;" /></p><p>å…·ä½“æ¥è®²<br>$$<br>Dice Loss &#x3D; 1 - \frac{2|A\cap B|}{|A| + |B|}<br>$$<br>å€¼åŸŸ$[0, 1]$ï¼Œlosså€¼è¶Šå°ï¼Œé‡åˆç¨‹åº¦è¶Šé«˜ï¼›</p><p>åˆ†æ¯çš„è®¡ç®—ï¼š$|A|$å’Œ$|B|$åˆ†åˆ«è¡¨ç¤º$A$ ã€$B$çš„å…ƒç´ å€¼ä¹‹å’Œ</p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hnn177m4j20zk0g1gmg.jpg" style="zoom: 33%;" /><p>åˆ†å­çš„è®¡ç®—ï¼š$A$ ã€$B$çš„äº¤é›†ï¼Œç”¨ç‚¹ä¹˜ï¼Œ</p><p>$Soft Dice Loss$ï¼šPredictionä¸å°†å®ƒä»¬è½¬æ¢ä¸ºäºŒè¿›åˆ¶mask</p><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hnowwhtrj20zk06owez.jpg"></p><h3 id="CE-Dice-Loss"><a href="#CE-Dice-Loss" class="headerlink" title="CE + Dice Loss"></a>CE + Dice Loss</h3><p>é‡‡ç”¨$CE + Dice$ ï¼Œæƒé‡æ¯”ä¾‹$1:1$</p><p>ä»<strong>æ¦‚ç‡åˆ†å¸ƒ</strong>å’Œ<strong>åŒºåŸŸ</strong>ä¸¤ä¸ªè§’åº¦è¡¡é‡æ¨¡å‹</p><h3 id="Focal-Lossã€Œé“¾æ¥ğŸ”—ã€"><a href="#Focal-Lossã€Œé“¾æ¥ğŸ”—ã€" class="headerlink" title="Focal Lossã€Œé“¾æ¥ğŸ”—ã€"></a>Focal Lossã€Œ<a href="https://arxiv.org/abs/1708.02002">é“¾æ¥</a>ğŸ”—ã€</h3><p>$Focal Loss$ï¼šé’ˆå¯¹Two-Stageç›®æ ‡æ£€æµ‹RPNç½‘ç»œä¸­<strong>æ­£è´Ÿæ ·æœ¬ä¸¥é‡ä¸å‡è¡¡</strong>åŠ<strong>å›°éš¾æ ·æœ¬</strong>æå‡ºçš„Loss</p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hnri2npkj20tg0k00wd.jpg" style="zoom:33%;" /><p>è§£å†³ä¸å‡è¡¡ï¼šå¢åŠ ç±»åˆ«æƒé‡ $\alpha_t$<br>$$<br>CE(p_t) &#x3D; -\alpha_t log(p_t)<br>$$<br>è§£å†³å›°éš¾æ ·æœ¬ï¼šå¢åŠ éš¾åº¦æƒé‡ $\gamma$<br>$$<br>FL(p_t) &#x3D; -(1 - p_t)^\gamma log(p_t)<br>$$</p><table><thead><tr><th><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hnux5dalj20w00k040s.jpg" style="zoom: 33%;" /></th><th><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hnw7rifmj20zk0dlmzt.jpg" style="zoom:50%;" /></th></tr></thead></table><p>$$<br>FL_{ç»¼åˆ}(p_t) &#x3D; - \alpha_t Â·(1-p_t)^\gamma Â· log(p_t)<br>$$</p><p>å…¶ä¸­ $\alpha_t$ä¸º<strong>ç±»åˆ«æƒé‡</strong>ï¼Œ$(1-p_t)^\gamma$ä¸º<strong>éš¾åº¦æƒé‡</strong></p><h2 id="å­¦ä¹ ç‡è°ƒæ•´ç­–ç•¥"><a href="#å­¦ä¹ ç‡è°ƒæ•´ç­–ç•¥" class="headerlink" title="å­¦ä¹ ç‡è°ƒæ•´ç­–ç•¥"></a>å­¦ä¹ ç‡è°ƒæ•´ç­–ç•¥</h2><p>è‰¯å¥½çš„å­¦ä¹ ç‡è°ƒæ•´å¯ç›´æ¥å½±å“æ¨¡å‹ç²¾åº¦ï¼šåŸºæœ¬åŸåˆ™ä»ç¨³å®šçŠ¶æ€é€æ­¥é™ä½å­¦ä¹ ç‡</p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2i5qq3pxzj20vy0k0dhh.jpg" style="zoom: 50%;" /><h3 id="Warmup-Cosine"><a href="#Warmup-Cosine" class="headerlink" title="Warmup + Cosine"></a>Warmup + Cosine</h3><p>æ¯ä¸ªiterationé€æ¸å¢å¤§è‡³åˆå§‹å­¦ä¹ ç‡ï¼Œç„¶åä½™å¼¦ä¸‹é™è‡³ç»ˆæ­¢å­¦ä¹ ç‡</p><p>â€‹batchesï¼šä¸€ä¸ªEpochå¯¹åº”å‡ ä¸ªiteration</p><p>â€‹max_epochsï¼šæ€»å…±è·‘å‡ ä¸ªEpoch</p><p>â€‹base_lrï¼šåˆå§‹å­¦ä¹ ç‡</p><p>â€‹final_lrï¼šç»ˆæ­¢å­¦ä¹ ç‡</p><p>â€‹warmup_epochsï¼šwarmupå¤šä¹…</p><p>â€‹warmup_init_lrï¼šwarmupåˆå§‹å­¦ä¹ ç‡æ˜¯å¤šå°‘</p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2i5pkk8kuj20uf0k075d.jpg" style="zoom: 50%;" /><h2 id="æ•°æ®å¢å¼º"><a href="#æ•°æ®å¢å¼º" class="headerlink" title="æ•°æ®å¢å¼º"></a>æ•°æ®å¢å¼º</h2><h3 id="æ•°æ®å¢å¼ºå·¥å…·-Albumentationsã€Œ-å®˜ç½‘-https-albumentations-ai"><a href="#æ•°æ®å¢å¼ºå·¥å…·-Albumentationsã€Œ-å®˜ç½‘-https-albumentations-ai" class="headerlink" title="æ•°æ®å¢å¼ºå·¥å…·-Albumentationsã€Œ[å®˜ç½‘](https://albumentations.ai/"></a>æ•°æ®å¢å¼ºå·¥å…·-Albumentationsã€Œ[å®˜ç½‘](<a href="https://albumentations.ai/">https://albumentations.ai/</a></h3><p>)ã€ã€Œ<a href="https://github.com/albumentations-team/albumentations">GitHub</a>ã€</p><p>PyTorchæä¾›çš„transformsæ¨¡å—å¤§éƒ¨åˆ†ä¸é€‚ç”¨äºå›¾åƒåˆ†å‰²åŠç›®æ ‡æ£€æµ‹ä»»åŠ¡</p><p>å›¾åƒåˆ†å‰²å’Œç›®æ ‡æ£€æµ‹ï¼Œåœ¨è¿›è¡Œç©ºé—´å˜æ¢ï¼Œéœ€è¦å¯¹å›¾åƒå’Œæ ‡ç­¾åšç›¸åŒçš„å˜æ¢</p><p>Albumentationsâ€”â€”å¹¿æ³›åº”ç”¨äºå·¥ä¸šç•Œã€å­¦æœ¯ç•Œã€AIç«èµ›å’Œå¼€æºé¡¹ç›®ä¸­çš„CVæ•°æ®å¢å¼ºå·¥å…·</p><p>â€‹é€‚ç”¨ä»»åŠ¡ï¼šå›¾åƒåˆ†ç±»ã€å›¾åƒåˆ†å‰²ã€ç›®æ ‡æ£€æµ‹ã€å®ä¾‹åˆ†å‰²ç­‰</p><p>â€‹é€‚ç”¨é¢†åŸŸï¼šè‡ªç„¶å›¾åƒã€åŒ»ç–—å½±åƒã€å«æ˜Ÿå›¾åƒã€å·¥ä¸šå›¾åƒç­‰</p><p>â€‹æ— ç¼è¡”æ¥ï¼šå¯æ— ç¼è¡”æ¥PyTorchã€Kerasæ¡†æ¶</p><table><thead><tr><th><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2i5xch4vsj20r00k0419.jpg"></th><th><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2i5xh29n5j20qx0k0wi6.jpg"></th></tr></thead></table><h4 id="Pixel-level"><a href="#Pixel-level" class="headerlink" title="Pixel level"></a>Pixel level</h4><table><thead><tr><th><img src="/Users/kenton/Library/Application Support/typora-user-images/image-20220523111250059.png" style="zoom: 50%;" /></th><th><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2i60hzctuj20k00xzmzd.jpg" style="zoom: 67%;" /></th><th><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2i60o4aesj20k00kct9z.jpg"></th><th><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2i60vjb48j20ks0k0dgn.jpg"></th></tr></thead></table><h4 id="Spatial-level"><a href="#Spatial-level" class="headerlink" title="Spatial level"></a>Spatial level</h4><table><thead><tr><th><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2i61rhdi1j20k00rxq4a.jpg" style="zoom:67%;" /></th><th><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2i6205jehj20k00sfdh9.jpg" style="zoom:67%;" /></th><th><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2i627k45zj20k00snq4y.jpg" style="zoom:67%;" /></th><th><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2i62est1tj20k00m6wfg.jpg" style="zoom:67%;" /></th></tr></thead></table><h4 id="Albumentations-å›¾åƒåˆ†å‰²ä½¿ç”¨é€»è¾‘"><a href="#Albumentations-å›¾åƒåˆ†å‰²ä½¿ç”¨é€»è¾‘" class="headerlink" title="Albumentations å›¾åƒåˆ†å‰²ä½¿ç”¨é€»è¾‘"></a>Albumentations å›¾åƒåˆ†å‰²ä½¿ç”¨é€»è¾‘</h4><p>å®šä¹‰å¥½ä¸€ç³»åˆ—transformæ–¹æ³•ï¼›åŒæ—¶ä¼ å…¥imageå’Œmaskï¼›è¿”å›å­—å…¸ï¼Œé€šè¿‡â€imageâ€å’Œâ€œmaskâ€è·å¾—å¤„ç†åçš„æ•°æ®</p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2i63do3hjj20zi0k0765.jpg" style="zoom:67%;" /><h4 id="å›¾åƒåˆ†å‰²å¸¸ç”¨æ•°æ®å¢å¼ºæ–¹æ³•"><a href="#å›¾åƒåˆ†å‰²å¸¸ç”¨æ•°æ®å¢å¼ºæ–¹æ³•" class="headerlink" title="å›¾åƒåˆ†å‰²å¸¸ç”¨æ•°æ®å¢å¼ºæ–¹æ³•"></a>å›¾åƒåˆ†å‰²å¸¸ç”¨æ•°æ®å¢å¼ºæ–¹æ³•</h4><h5 id="è‰²å½©æ‰°åŠ¨"><a href="#è‰²å½©æ‰°åŠ¨" class="headerlink" title="è‰²å½©æ‰°åŠ¨"></a>è‰²å½©æ‰°åŠ¨</h5><p>ColorJitter (brightness&#x3D;0.2, contrast&#x3D;0.2, saturation&#x3D;0.2, hue&#x3D;0.2, always_apply&#x3D;False, p&#x3D;0.5)</p><p>å‚æ•°ï¼š</p><p>â€‹brightness: äº®åº¦çš„åç§»å¹…åº¦ã€‚å›¾åƒç»™äººçš„ç›´è§‚æ„Ÿå—ï¼Œå¦‚æœæ˜¯ç°åº¦å›¾åƒï¼Œç°åº¦å€¼è¶Šé«˜åˆ™å›¾åƒè¶Šäº®ã€‚</p><p>â€‹contrast: å¯¹æ¯”åº¦åç§»å¹…åº¦ã€‚ä¸åŒé¢œè‰²æœ€äº®å¤„å’Œæœ€æš—å¤„ä¹‹é—´çš„å·®åˆ«ï¼Œå½±å“çº¹ç†ç»†èŠ‚ã€‚</p><p>â€‹saturationï¼šé¥±å’Œåº¦åç§»å¹…åº¦ã€‚é¥±å’Œåº¦è¶Šé«˜ï¼Œé¢œè‰²è¡¨ç°è¶Šä¸°å¯Œã€‚</p><p>â€‹hueï¼šè‰²ç›¸åç§»å¹…åº¦ã€‚</p><p>äº®åº¦ã€å¯¹æ¯”åº¦å’Œé¥±å’Œåº¦æ˜¯æ•°å­—å›¾åƒå¤„ç†ä¸­å¸¸ç”¨æ¦‚å¿µã€‚ å¤œæ™šåœºæ™¯ï¼Œäº®åº¦åä½ï¼›é›¨é›¾å¤©å¯¹æ¯”åº¦ä½</p><h5 id="ä»¿å°„å˜æ¢"><a href="#ä»¿å°„å˜æ¢" class="headerlink" title="ä»¿å°„å˜æ¢"></a>ä»¿å°„å˜æ¢</h5><p>Affine (scale&#x3D;None, translate_percent&#x3D;None, translate_px&#x3D;None, rotate&#x3D;None, shear&#x3D;None, interpolation&#x3D;1, cval&#x3D;0, cval_mask&#x3D;0, mode&#x3D;0, fit_output&#x3D;False, always_apply&#x3D;False, p&#x3D;0.5)</p><p>å‚æ•°ï¼š</p><p>â€‹rotateï¼šæ—‹è½¬è§’åº¦ï¼Œ int or tuple</p><p>â€‹shear: é”™åˆ‡ï¼Œint or tuple</p><p>â€‹translate_percentï¼šå¹³ç§»ï¼Œint or tuple</p><p>â€‹scaleï¼šç¼©æ”¾ï¼Œ int or tuple</p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2i6bl6su6j20r30k0wfd.jpg" style="zoom:33%;" /><h5 id="å¼¹æ€§å˜æ¢"><a href="#å¼¹æ€§å˜æ¢" class="headerlink" title="å¼¹æ€§å˜æ¢"></a>å¼¹æ€§å˜æ¢</h5><p>ElasticTransform (alpha&#x3D;1, sigma&#x3D;50, alpha_affine&#x3D;50, interpolation&#x3D;1, border_mode&#x3D;4, value&#x3D;None, mask_value&#x3D;None, always_apply&#x3D;False, approximate&#x3D;False, p&#x3D;0.5)</p><p>è¿‡ç¨‹: </p><p>ï¼ˆ1ï¼‰æ¯ä¸ªåƒç´ ç‚¹(x, y)äº§ç”Ÿä¸¤ä¸ª-1~1ä¹‹é—´çš„éšæœºæ•°ï¼ŒÎ”x(x,y)å’ŒÎ”y(x,y)ï¼Œåˆ†åˆ«è¡¨ç¤ºè¯¥åƒç´ ç‚¹çš„xæ–¹å‘å’Œyæ–¹å‘çš„ç§»åŠ¨è·ç¦»ï¼›</p><p>ï¼ˆ2ï¼‰ç”Ÿæˆä¸€ä¸ªä»¥0ä¸ºå‡å€¼ï¼Œä»¥Ïƒä¸ºæ ‡å‡†å·®çš„é«˜æ–¯æ ¸k_nnï¼Œå¹¶ç”¨å‰é¢çš„éšæœºæ•°ä¸ä¹‹åšå·ç§¯ï¼Œå¹¶å°†ç»“æœä½œç”¨äºåŸå›¾åƒã€‚</p><p>ä½¿ç”¨æŒ‡å¯¼ï¼šalphaè¶Šå°ï¼Œsigmaè¶Šå¤§ï¼Œäº§ç”Ÿçš„åå·®è¶Šå°ï¼Œå’ŒåŸå›¾è¶Šæ¥è¿‘</p><table><thead><tr><th><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2i6cui1iyj20k00k8402.jpg"></th><th><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2i6cy80bwj20k00kptab.jpg"></th></tr></thead></table><h3 id="é¢å¤–æ•°æ®è®­ç»ƒ"><a href="#é¢å¤–æ•°æ®è®­ç»ƒ" class="headerlink" title="é¢å¤–æ•°æ®è®­ç»ƒ"></a>é¢å¤–æ•°æ®è®­ç»ƒ</h3><h4 id="åŠ å…¥Portrait-Dataset-34427"><a href="#åŠ å…¥Portrait-Dataset-34427" class="headerlink" title="åŠ å…¥Portrait Dataset 34427"></a>åŠ å…¥Portrait Dataset 34427</h4><p>åŸºäºPortrait Dataset 2000å¯è€ƒè™‘å¢åŠ Portrait Dataset 34427æ•°æ®é›†è®­ç»ƒ</p><table><thead><tr><th><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2i6maabzdj20k00ka76o.jpg"></th><th><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2i6mha97nj20nb0k00vg.jpg"></th></tr></thead></table><p>$$<br>PortraitDataSet2000+PortraitDataSet34427&#x3D;NewDataSet(concat)<br>$$</p><h4 id="åŸºäºCOCOè‡ªåˆ¶æ•°æ®é›†"><a href="#åŸºäºCOCOè‡ªåˆ¶æ•°æ®é›†" class="headerlink" title="åŸºäºCOCOè‡ªåˆ¶æ•°æ®é›†"></a>åŸºäºCOCOè‡ªåˆ¶æ•°æ®é›†</h4><p>MS COCOçš„å…¨ç§°æ˜¯Microsoft Common Objects in Contextï¼Œèµ·æºäºå¾®è½¯äº2014å¹´å‡ºèµ„æ ‡æ³¨çš„Microsoft COCOæ•°æ®é›†ï¼Œæ•°æ®é›†ä»¥scene understandingä¸ºç›®æ ‡ã€‚ç›®å‰ä¸ºæ­¢æœ‰è¯­ä¹‰åˆ†å‰²çš„æœ€å¤§æ•°æ®é›†ï¼Œæä¾›çš„ç±»åˆ«æœ‰80 ç±»ï¼Œæœ‰è¶…è¿‡33 ä¸‡å¼ å›¾ç‰‡ï¼Œå…¶ä¸­20 ä¸‡å¼ æœ‰æ ‡æ³¨ï¼Œæ•´ä¸ªæ•°æ®é›†ä¸­ä¸ªä½“çš„æ•°ç›®è¶…è¿‡150 ä¸‡ä¸ªã€‚</p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2i70dea2mj20zk0d70vp.jpg" style="zoom:33%;" /><p>å¸¸ç”¨æ•°æ®é›†ä¸º coco2017ï¼Œ å…¶ä¸­è®­ç»ƒé›†118287å¼ å›¾ç‰‡ï¼ŒéªŒè¯é›†æœ‰5000å¼ å›¾ç‰‡ç‰©ä½“çš„æ ‡æ³¨åˆ†ä¸ºsupercategoryã€Œè¶…ç±»ã€ å’Œ categoryã€Œç±»ã€</p><p>$å‰æ™¯å›¾ç‰‡* \alpha +èƒŒæ™¯* (1-\alpha) &#x3D;æ–°å›¾åƒ$ </p><table><thead><tr><th><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2i74bws0dj20k00qnmzi.jpg"></th><th><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2i74fflk4j20k00qowg4.jpg"></th><th><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2i74eig6xj20k00qoabl.jpg"></th><th><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2i74dzwlcj20k00qo75d.jpg"></th><th><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2i74d20x4j20k00qo40w.jpg"></th></tr></thead></table><p>èƒŒæ™¯å›¾ç‰‡æŒ‘é€‰ï¼šå°½é‡ç¬¦åˆçœŸå®åœºæ™¯ï¼Œå®¤å†…ç…§ç‰‡æˆ–è€…å®¤å¤–ç…§ç‰‡ï¼Œä¸èƒ½å‡ºç°äººç‰©</p><h2 id="æ¨¡å‹å°è£…"><a href="#æ¨¡å‹å°è£…" class="headerlink" title="æ¨¡å‹å°è£…"></a>æ¨¡å‹å°è£…</h2><blockquote><p>é¢å‘å¯¹è±¡ä¸‰å¤§ç‰¹æ€§ä¹‹ä¸€</p></blockquote><p>é¢å‘å¯¹è±¡ï¼ˆObject Oriented Programmingï¼‰ä¸‰å¤§ç‰¹æ€§</p><p>â€‹1.å°è£…ï¼ˆEncapsulationï¼‰ï¼šéšè—å¯¹è±¡çš„å±æ€§å’Œå®ç°ç»†èŠ‚ï¼Œä»…å¯¹å¤–æä¾›å…¬å…±è®¿é—®æ–¹å¼</p><p>â€‹2.ç»§æ‰¿ï¼ˆInheritanceï¼‰ï¼šä½¿ç”¨å·²å­˜åœ¨çš„ç±»çš„å®šä¹‰ä½œä¸ºåŸºç¡€å»ºç«‹æ–°ç±»çš„æ–¹æ³•</p><p>â€‹3.å¤šæ€ï¼ˆPolymorphismï¼‰ï¼šâ€å¤šç§çŠ¶æ€â€ï¼Œæ¥å£çš„å¤šç§ä¸åŒçš„å®ç°æ–¹å¼å³ä¸ºå¤šæ€</p><p><strong>å°è£…å¥½å¤„</strong>ï¼š</p><p>â€‹1.éšè—å®ç°ç»†èŠ‚ï¼Œæä¾›å…¬å…±çš„è®¿é—®æ–¹å¼</p><p>â€‹2.æé«˜äº†ä»£ç çš„å¤ç”¨æ€§</p><p>â€‹3.æé«˜å®‰å…¨æ€§</p><p><strong>å°è£…åŸåˆ™</strong>ï¼š</p><p>â€‹1.å°†ä¸éœ€è¦å¯¹å¤–æä¾›çš„å†…å®¹éƒ½éšè—èµ·æ¥</p><p>â€‹2.æŠŠå±æ€§éšè—ï¼Œæä¾›å…¬å…±æ–¹æ³•å¯¹å…¶è®¿é—®</p><h2 id="TTAï¼ˆæµ‹è¯•æ—¶æ•°æ®å¢å¼ºï¼‰"><a href="#TTAï¼ˆæµ‹è¯•æ—¶æ•°æ®å¢å¼ºï¼‰" class="headerlink" title="TTAï¼ˆæµ‹è¯•æ—¶æ•°æ®å¢å¼ºï¼‰"></a>TTAï¼ˆæµ‹è¯•æ—¶æ•°æ®å¢å¼ºï¼‰</h2><p>æµ‹è¯•æ—¶å°†åŸå§‹æ•°æ®åšä¸åŒå½¢å¼çš„å¢å¼º,ç„¶åå–ç»“æœçš„å¹³å‡å€¼ä½œä¸ºæœ€ç»ˆç»“æœ</p><p>å¯ä»¥è¿›ä¸€æ­¥æå‡æœ€ç»ˆç»“æœçš„ç²¾åº¦ï¼Œä½¿æ¨¡å‹è¾“å‡ºæ›´ç¨³å®š</p><h3 id="AlexNet-çš„TTAæ–¹æ³•"><a href="#AlexNet-çš„TTAæ–¹æ³•" class="headerlink" title="AlexNet çš„TTAæ–¹æ³•"></a>AlexNet çš„TTAæ–¹æ³•</h3><p>â€‹1.å›¾ç‰‡ç»Ÿä¸€ç¼©æ”¾è‡³256*256</p><p>â€‹2.å·¦ä¸Šã€å³ä¸Šã€å·¦ä¸‹ã€å³ä¸‹ã€ä¸­å¿ƒè£å‰ªå‡º5ä¸ª224*224åŒºåŸŸ</p><p>â€‹3.å‡è¿›è¡Œæ°´å¹³ç¿»è½¬ï¼Œå…±å¾—åˆ°10å¼ 224*224å›¾ç‰‡</p><p>â€‹4.å¯¹10å¼ å›¾ç‰‡è¿›è¡Œæ¨ç†ï¼Œå¾—åˆ°10ä¸ªåˆ†ç±»æ¦‚ç‡åå–å¹³å‡å€¼è¾“å‡º</p><h3 id="å›¾åƒåˆ†å‰²çš„TTA"><a href="#å›¾åƒåˆ†å‰²çš„TTA" class="headerlink" title="å›¾åƒåˆ†å‰²çš„TTA"></a>å›¾åƒåˆ†å‰²çš„TTA</h3><p>æ—‹è½¬ã€ç¿»è½¬ã€ç¼©æ”¾ã€åƒç´ æ‰°åŠ¨ç­‰</p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2i7jqcqcrj20zk0ab0u4.jpg" style="zoom:50%;" /><h3 id="PyTorchçš„TTAå·¥å…·â€”â€”TTAch"><a href="#PyTorchçš„TTAå·¥å…·â€”â€”TTAch" class="headerlink" title="PyTorchçš„TTAå·¥å…·â€”â€”TTAch"></a>PyTorchçš„TTAå·¥å…·â€”â€”TTAch</h3><p>TTAchå·¥å…·åº“æ˜¯ä¸€ä¸ªPyTorchçš„TTAå·¥å…·ï¼Œå¯å®ç°å›¾åƒåˆ†ç±»ã€å›¾åƒåˆ†å‰²ã€å…³é”®ç‚¹æ£€æµ‹çš„TTAæ–¹æ³•ã€Œ<a href="https://github.com/qubvel/ttach">æºä»£ç </a>ã€</p><h4 id="TTAchä½¿ç”¨é€»è¾‘"><a href="#TTAchä½¿ç”¨é€»è¾‘" class="headerlink" title="TTAchä½¿ç”¨é€»è¾‘"></a>TTAchä½¿ç”¨é€»è¾‘</h4><p>å®šä¹‰transformsæ–¹æ³•å°†åŸæ¨¡å‹ä¸transformsç»‘å®šï¼Œç”Ÿæˆæ–°æ¨¡å‹ï¼ˆnn.Moduleï¼‰</p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2i7mltxx3j20x30k00uh.jpg" style="zoom:33%;" /><h4 id="å…·ä½“å®ç°"><a href="#å…·ä½“å®ç°" class="headerlink" title="å…·ä½“å®ç°"></a>å…·ä½“å®ç°</h4><p>åœ¨forwardä¸­ä¾æ¬¡æ‰§è¡Œå„transformsåŸæ¨¡å‹forwardåå˜æ¢maskæ”¶é›†ç»“æœï¼Œè¾“å‡º</p><h2 id="æ¨ç†å†…å­˜åˆ†æ"><a href="#æ¨ç†å†…å­˜åˆ†æ" class="headerlink" title="æ¨ç†å†…å­˜åˆ†æ"></a>æ¨ç†å†…å­˜åˆ†æ</h2><h3 id="PyTorchçš„å†…å­˜åˆ†æ"><a href="#PyTorchçš„å†…å­˜åˆ†æ" class="headerlink" title="PyTorchçš„å†…å­˜åˆ†æ"></a>PyTorchçš„å†…å­˜åˆ†æ</h3><h4 id="å ç”¨æ˜¾å­˜çš„æ•°æ®"><a href="#å ç”¨æ˜¾å­˜çš„æ•°æ®" class="headerlink" title="å ç”¨æ˜¾å­˜çš„æ•°æ®"></a>å ç”¨æ˜¾å­˜çš„æ•°æ®</h4><p>â€‹<strong>æ¨¡å‹å‚æ•°weights</strong>ï¼šå·ç§¯æ ¸æƒé‡ã€BNå±‚çš„Î±å’ŒÎ²ã€FCå±‚çš„æƒé‡ç­‰</p><p>â€‹<strong>æ¨¡å‹ä¸­é—´å˜é‡</strong>ï¼šfeature maps</p><p>â€‹<strong>è¾“å…¥è¾“å‡ºæ•°æ®</strong>ï¼šinput_tensor, outputs_tensor</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒWith no_grad() å¯è§£å†³æ¨¡å‹ä¸­é—´å˜é‡çš„å ç”¨ï¼šæ˜¯ä¸€ä¸ªä¸Šä¸‹æ–‡ç®¡ç†å™¨,è¢«è¯¥è¯­å¥ wrap èµ·æ¥çš„éƒ¨åˆ†å°†ä¸ä¼štrackæ¢¯åº¦</p><p>ä¸­é—´éƒ¨åˆ†ç¼“å­˜å¯é€šè¿‡ï¼štorch.cuda.empty_cache()åˆ é™¤</p><h2 id="Badcaseåˆ†æ"><a href="#Badcaseåˆ†æ" class="headerlink" title="Badcaseåˆ†æ"></a>Badcaseåˆ†æ</h2><p>è®­ç»ƒé›†çš„åˆ†æä½œç”¨ï¼šå‰”é™¤å¼‚å¸¸æ ·æœ¬ï¼Œé¿å…è¿™äº›æ ·æœ¬æŠŠæ¨¡å‹å¸¦åï¼Œå°±åƒè€ƒè¯•é¢˜ä¸­çš„è¶…çº²é¢˜</p><p>æµ‹è¯•é›†çš„åˆ†æä½œç”¨ï¼šå½’çº³æ€»ç»“å“ªä¸€ç±»çš„æ•°æ®åˆ†å¸ƒå¥½ï¼Œé’ˆå¯¹æ€§çš„åšæ•°æ®å¢å¼ºæˆ–è€…Trickçš„è®¾è®¡</p><p>â€‹å¦‚å…‰ç…§å·®çš„å›¾åƒè¡¨ç°ä¸å¥½ï¼Œè€ƒè™‘è°ƒæ•´äº®åº¦</p><p>â€‹èƒŒæ™¯ä¸äººç‰©æ¨¡ç³Šçš„å›¾åƒï¼Œè€ƒè™‘åŠ é«˜æ–¯æ¨¡ç³Š</p><p>â€‹ä»è®­ç»ƒé›†ä¸­æ‰¾å‡ºâ€œæ ·æœ¬ä¸å‡è¡¡â€çš„æ•°æ®ï¼Œè¿›è¡Œæ•°æ®å¢å¼ºï¼Œå¦‚å­”æ´ã€å¤´å‘ä¸è¾ƒå¤šç­‰å›¾åƒè¿›è¡ŒFusionæ“ä½œï¼Œå¢åŠ è®­ç»ƒé›†</p><h2 id="æ¨¡å‹æäº¤"><a href="#æ¨¡å‹æäº¤" class="headerlink" title="æ¨¡å‹æäº¤"></a>æ¨¡å‹æäº¤</h2><p>æœ€ä¼˜çš„æ¨¡å‹ï¼š<strong>é‡‡ç”¨è®­ç»ƒé›†+éªŒè¯é›†è®­ç»ƒæ¨¡å‹</strong></p><p>éªŒè¯é›†çš„ä½œç”¨æ˜¯è°ƒå‚ï¼Œå½“å‚æ•°ç¡®å®šåï¼Œéœ€æŠŠæ‰‹ä¸­æ‰€æœ‰æ•°æ®ç”¨äºæ¨¡å‹è®­ç»ƒï¼Œå¾—åˆ°æœ€ç»ˆæäº¤çš„æ¨¡å‹</p><h2 id="åŸºäºFlaskå°†æ¨¡å‹éƒ¨ç½²åˆ°webä¸Š"><a href="#åŸºäºFlaskå°†æ¨¡å‹éƒ¨ç½²åˆ°webä¸Š" class="headerlink" title="åŸºäºFlaskå°†æ¨¡å‹éƒ¨ç½²åˆ°webä¸Š"></a>åŸºäºFlaskå°†æ¨¡å‹éƒ¨ç½²åˆ°webä¸Š</h2><h3 id="Flask"><a href="#Flask" class="headerlink" title="Flask"></a>Flask</h3><p>Flaskè¯ç”Ÿäº2010å¹´ï¼Œæ˜¯åŸºäºPythonç¼–å†™çš„è½»é‡çº§Webå¼€å‘æ¡†æ¶Webå®ŒæˆServeræ¡†ä¸­é—´çš„å†…å®¹</p><p>åˆ©ç”¨Flaskå®ç°Webåç«¯æœåŠ¡ï¼Œéœ€è¦ä¸¤æ­¥ï¼š</p><p>â€‹1.è®¾ç½®ç½‘å€ï¼šurl </p><p>â€‹2.è®¾ç½®urlå“åº”ï¼šå“åº”å¯èƒ½è¾ƒä¸ºå¤æ‚ï¼Œé€šå¸¸é€šè¿‡ä¸€ä¸ªåŠŸèƒ½å‡½æ•°å®ç°</p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2i99mh27pj20zk0je75x.jpg" style="zoom:50%;" /><h3 id="è£…é¥°å™¨"><a href="#è£…é¥°å™¨" class="headerlink" title="è£…é¥°å™¨"></a>è£…é¥°å™¨</h3><p>ç»™<strong>åŸå‡½æ•°</strong>å¢åŠ <strong>é¢å¤–åŠŸèƒ½</strong>ï¼Œé¢å¤–åŠŸèƒ½â€œè£…é¥°â€åŸå‡½æ•°</p><p>è£…é¥°ï¼Œå°±æ˜¯è£…ç‚¹ã€æä¾›ä¸€äº›é¢å¤–çš„ç‚¹ç¼€ã€‚åœ¨ Python ä¸­çš„è£…é¥°å™¨åˆ™æ˜¯æä¾›äº†ä¸€äº›é¢å¤–çš„åŠŸèƒ½ã€‚ä¾‹å¦‚ï¼šè®¡ç®—æ‰§è¡Œå‡½æ•°æ‰€éœ€çš„æ—¶é—´</p><p>è£…é¥°å™¨æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒæ¥æ”¶å‡½æ•°ï¼Œå†…éƒ¨å®šä¹‰æ–°å‡½æ•°ï¼Œå¹¶è¿”å›æ–°å‡½æ•°</p><p>è£…é¥°å™¨å·¥ä½œé€»è¾‘æ˜¯ï¼šå½“ç¼–è¯‘å™¨é‡åˆ°@XXXæ—¶ï¼Œå°±ä¼šå°†åŸå‡½æ•°è¿›è¡Œè£…é¥°ï¼Œå¯ç†è§£ä¸ºåŸå‡½æ•°åœ¨ç¼–è¯‘é˜¶æ®µå³è¢«ç¼–è¯‘å™¨â€œæ›¿æ¢â€ä¸ºè£…é¥°å™¨è¿”å›çš„é‚£ä¸ªå‡½æ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@clock</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">foo_decorator</span>(<span class="params">seconds</span>):</span><br><span class="line"><span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç­‰ä»·äº</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">foo_decorator</span>(<span class="params">seconds</span>):</span><br><span class="line"><span class="keyword">pass</span></span><br><span class="line">foo_decorator = clock(foo_decorator)</span><br></pre></td></tr></table></figure><h3 id="Requestsåº“"><a href="#Requestsåº“" class="headerlink" title="Requestsåº“"></a>Requestsåº“</h3><h4 id="HTTPåè®®"><a href="#HTTPåè®®" class="headerlink" title="HTTPåè®®"></a>HTTPåè®®</h4><p>HTTPï¼ŒHypertext Transfer Protocolï¼Œè¶…æ–‡æœ¬ä¼ è¾“åè®®æ˜¯åŸºäºâ€œè¯·æ±‚ä¸å“åº”â€æ¨¡å¼çš„åº”ç”¨å±‚åè®®</p><p>HTTPåè®®é‡‡ç”¨<strong>URL</strong>ï¼ˆUniform Resource Locator,ç»Ÿä¸€èµ„æºå®šä½å™¨ï¼‰ä½œä¸º<strong>å®šä½ç½‘ç»œèµ„æºçš„æ ‡è¯†</strong>ï¼ŒURLæ ¼å¼å¦‚ä¸‹ï¼š<br>$$<br><a href="https://host[:port][path]">https://host[:port][path]</a><br>$$<br>$host$: åˆæ³•çš„Internetä¸»æœºåŸŸåæˆ–IPåœ°å€</p><p>$port$: ç«¯å£å·ï¼Œç¼ºçœç«¯å£ä¸º80</p><p>$path$: è¯·æ±‚èµ„æºçš„è·¯å¾„HTTP</p><p>URLçš„ç†è§£ï¼šURLæ˜¯è·¯å¾„ï¼šURLæ˜¯é€šè¿‡HTTPåè®®å­˜å–èµ„æºçš„Internetè·¯å¾„ï¼Œä¸€ä¸ªURLå¯¹åº”ä¸€ä¸ªæ•°æ®èµ„æº</p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2i9vww0iaj20xw0k0dhp.jpg" style="zoom:50%;" /><h4 id="Pythonçš„HTTPåº“â€”â€”Requests"><a href="#Pythonçš„HTTPåº“â€”â€”Requests" class="headerlink" title="Pythonçš„HTTPåº“â€”â€”Requests"></a>Pythonçš„HTTPåº“â€”â€”Requests</h4><p>Requestsåº“æ˜¯Pythonçš„ç®€æ˜“HTTPåè®®æ“ä½œåº“</p><table><thead><tr><th><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2i9xjyxyuj20zk0j478m.jpg"></th><th><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2i9xngyfjj20zk0d7ju5.jpg"></th></tr></thead></table><h2 id="ä»£ç ç¼–å†™"><a href="#ä»£ç ç¼–å†™" class="headerlink" title="ä»£ç ç¼–å†™"></a>ä»£ç ç¼–å†™</h2><p>ä»£ç æ¡†æ¶å¦‚ä¸‹ï¼š</p><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2ic4tsrugj20lk0p0jsy.jpg"></p><p>ä»£ç å¼€æºåœ¨<strong>GitHubï¼Œ<a href="https://github.com/zz0320/Portrait_Seg_Flask">ç‚¹å‡»é“¾æ¥</a>æŸ¥çœ‹</strong></p><h2 id="æµ‹è¯•é˜¶æ®µ"><a href="#æµ‹è¯•é˜¶æ®µ" class="headerlink" title="æµ‹è¯•é˜¶æ®µ"></a>æµ‹è¯•é˜¶æ®µ</h2><h3 id="æµ‹è¯•ä¸€"><a href="#æµ‹è¯•ä¸€" class="headerlink" title="æµ‹è¯•ä¸€"></a>æµ‹è¯•ä¸€</h3><blockquote><p>ä¸åŒè¾“å…¥åˆ†è¾¨ç‡ä¸‹è®­ç»ƒBiSeNetï¼ŒmIoUå˜åŒ–ï¼Œå¦‚112*112,224*224,448*448,512*512ç­‰</p></blockquote><p>è®­ç»ƒå‚æ•°</p><table><thead><tr><th>å‚æ•°ç±»åˆ«</th><th>å‚æ•°å€¼</th></tr></thead><tbody><tr><td>train_bs</td><td>6</td></tr><tr><td>valid_bs</td><td>2</td></tr><tr><td>workers</td><td>16</td></tr><tr><td>lr_init</td><td>0.01</td></tr><tr><td>factor</td><td>0.1</td></tr><tr><td>milestones</td><td>[25, 45]</td></tr><tr><td>weight_decay</td><td>0.0005</td></tr><tr><td>momentum</td><td>0.9</td></tr><tr><td>log_interval</td><td>10</td></tr><tr><td>bce_pos_weight</td><td>Tensor(0.7500)</td></tr></tbody></table><table><thead><tr><th>è®­ç»ƒåˆ†è¾¨ç‡</th><th>Train_Acc</th><th>Valid_Acc</th><th>Train_loss&#x2F;Train_miou</th><th>Valid_loss&#x2F;Valid_miou</th><th>Epoch</th></tr></thead><tbody><tr><td>112</td><td>98.29%</td><td>96.94%</td><td>0.0405&#x2F;0.9676</td><td>0.0786&#x2F;<strong>0.9504</strong></td><td>24</td></tr><tr><td>224</td><td>99.01%</td><td>97.74%</td><td>0.0317&#x2F;0.9817</td><td>0.0644&#x2F;<strong>0.9645</strong></td><td>29</td></tr><tr><td>448</td><td>99.30%</td><td>98.06%</td><td>0.0288&#x2F;0.9872</td><td>0.0650&#x2F;<strong>0.9697</strong></td><td>43</td></tr><tr><td>512</td><td>99.24%</td><td>97.97%</td><td>0.0300&#x2F;0.9863</td><td>0.0648&#x2F;<strong>0.9691</strong></td><td>19</td></tr></tbody></table><h3 id="æµ‹è¯•äºŒ"><a href="#æµ‹è¯•äºŒ" class="headerlink" title="æµ‹è¯•äºŒ"></a><strong>æµ‹è¯•äºŒ</strong></h3><blockquote><p>ä¸åŒlossæµ‹è¯•</p></blockquote><table><thead><tr><th>æ¨¡å‹</th><th>mIoU</th><th>å‡é™</th></tr></thead><tbody><tr><td>BCE pos_weight &#x3D; 1</td><td>best_miou: 0.9659 in :46</td><td>N&#x2F;A</td></tr><tr><td>BCE pos_weight &#x3D; 0.55</td><td>best_miou: 0.9622 in :9</td><td>-0.38%</td></tr><tr><td>focal loss alpha&#x3D;0.5 gamma&#x3D;0.5</td><td>best_miou: 0.9644 in :22</td><td>-0.15%</td></tr><tr><td>BCE&amp;dice</td><td>best_miou: 0.9659 in :16</td><td>0%</td></tr><tr><td>dice</td><td>best_miou: 0.9658 in :11</td><td>-0.01%</td></tr></tbody></table><h3 id="æµ‹è¯•ä¸‰"><a href="#æµ‹è¯•ä¸‰" class="headerlink" title="æµ‹è¯•ä¸‰"></a>æµ‹è¯•ä¸‰</h3><blockquote><p>é‡‡ç”¨colorjitterã€æ°´å¹³ç¿»è½¬ ã€æ—‹è½¬ä¸€å®šè§’åº¦è¿›è¡Œè®­ç»ƒï¼Œè§‚å¯Ÿæ¨¡å‹åˆ†å‰²ç»“æœï¼Œåˆ†ææ˜¯å¦å­˜åœ¨é—®é¢˜</p></blockquote><table><thead><tr><th>æ¨¡å‹</th><th>mIoU.img</th><th>mIoU</th></tr></thead><tbody><tr><td>BaselineBCE weight 0.75</td><td><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2iclshq1vj213x0u0mxz.jpg"></td><td>best_miou: 0.9651 in :26</td></tr><tr><td>æ°´å¹³ç¿»è½¬A.HorizontalFlip(p&#x3D;1)</td><td><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2icltpeihj213x0u0js9.jpg"></td><td>best_miou: 0.9643 in :40</td></tr><tr><td>æ—‹è½¬ä¸€å®šè§’åº¦A.IAAAffine(rotate&#x3D;(-10, 10), p&#x3D;1</td><td><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2iclxx5hfj21400u075a.jpg"></td><td>best_miou: 0.9640 in :41</td></tr><tr><td>è‰²å½©æ‰°åŠ¨A.ColorJitter(brightness&#x3D;0.1, contrast&#x3D;0.2, saturation&#x3D;0.2, hue&#x3D;0.2, p&#x3D;1)</td><td><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2icm24007j21400u0aaz.jpg"></td><td>best_miou: 0.9630 in :46</td></tr><tr><td>è‰²å½©æ‰°åŠ¨A.ColorJitter(brightness&#x3D;0.2, contrast&#x3D;0.2, saturation&#x3D;0.2, hue&#x3D;0.2, p&#x3D;1)</td><td><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2icm5vgmjj213z0u0dgs.jpg"></td><td>best_miou: 0.9627 in :48</td></tr></tbody></table>]]></content>
      
      
      
        <tags>
            
            <tag> åˆ†å‰²é¡¹ç›® </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Œåˆ†å‰²é¡¹ç›®ã€ï¼ˆäºŒï¼‰åŸºäºè‡ªåŠ¨é©¾é©¶CamVidæ•°æ®é›†çš„åˆ†å‰²ä»»åŠ¡</title>
      <link href="/2022/05/22/%E3%80%8C%E5%88%86%E5%89%B2%E9%A1%B9%E7%9B%AE%E3%80%8D%EF%BC%88%E4%BA%8C%EF%BC%89%E5%9F%BA%E4%BA%8E%E8%87%AA%E5%8A%A8%E9%A9%BE%E9%A9%B6CamVid%E6%95%B0%E6%8D%AE%E9%9B%86%E7%9A%84%E5%88%86%E5%89%B2%E4%BB%BB%E5%8A%A1/"/>
      <url>/2022/05/22/%E3%80%8C%E5%88%86%E5%89%B2%E9%A1%B9%E7%9B%AE%E3%80%8D%EF%BC%88%E4%BA%8C%EF%BC%89%E5%9F%BA%E4%BA%8E%E8%87%AA%E5%8A%A8%E9%A9%BE%E9%A9%B6CamVid%E6%95%B0%E6%8D%AE%E9%9B%86%E7%9A%84%E5%88%86%E5%89%B2%E4%BB%BB%E5%8A%A1/</url>
      
        <content type="html"><![CDATA[<h2 id="CamVidæ•°æ®é›†ä»‹ç»"><a href="#CamVidæ•°æ®é›†ä»‹ç»" class="headerlink" title="CamVidæ•°æ®é›†ä»‹ç»"></a>CamVidæ•°æ®é›†ä»‹ç»</h2><p>CamVidé©¾é©¶åœºæ™¯æ•°æ®é›†ï¼Œæ”¶é›†äº†701å¼ é©¾é©¶åœºæ™¯è¯­ä¹‰åˆ†å‰²å›¾åƒï¼Œåˆ’åˆ†ä¸º<strong>è®­ç»ƒ</strong>ã€<strong>éªŒè¯</strong>å’Œ<strong>æµ‹è¯•</strong>ï¼Œåˆ†åˆ«æœ‰367ã€101å’Œ233ä¸ªæ ·æœ¬</p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hbmhcm0wj20tx0k0dj5.jpg" style="zoom:67%;" /><span id="more"></span><h2 id="åˆ†å‰²æ¨¡å‹é€‰æ‹©"><a href="#åˆ†å‰²æ¨¡å‹é€‰æ‹©" class="headerlink" title="åˆ†å‰²æ¨¡å‹é€‰æ‹©"></a>åˆ†å‰²æ¨¡å‹é€‰æ‹©</h2><h3 id="SegNet"><a href="#SegNet" class="headerlink" title="SegNet"></a>SegNet</h3><h4 id="æŠ€æœ¯è¦ç‚¹"><a href="#æŠ€æœ¯è¦ç‚¹" class="headerlink" title="æŠ€æœ¯è¦ç‚¹"></a>æŠ€æœ¯è¦ç‚¹</h4><p>VGG16 &#x2F; Encoder-Decoder &#x2F; å¸¦ç´¢å¼•çš„æœ€å¤§æ± åŒ–ä¸Šé‡‡æ ·</p><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2he3khqu6j20zk0bkdig.jpg"></p><p>å¸¦ç´¢å¼•çš„æœ€å¤§æ± åŒ–ä¸Šé‡‡æ ·ï¼šè®°å½•ä¸‹é‡‡æ ·è¿‡ç¨‹çš„indicesï¼Œåœ¨ä¸Šé‡‡æ ·è¿‡ç¨‹ä¸­ä½¿ç”¨ï¼Œä»¥æä¾›ä½ç½®ä¿¡æ¯</p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2he43aq3jj20zk0dfgn0.jpg" style="zoom:67%;" /><h4 id="å…¶ä»–ä¸Šé‡‡æ ·ç»„ä»¶"><a href="#å…¶ä»–ä¸Šé‡‡æ ·ç»„ä»¶" class="headerlink" title="å…¶ä»–ä¸Šé‡‡æ ·ç»„ä»¶"></a>å…¶ä»–ä¸Šé‡‡æ ·ç»„ä»¶</h4><p>UnPoolingï¼šåæ± åŒ–ï¼Œå¸¦ç´¢å¼•çš„åæ± åŒ–</p><p>æ’å€¼è¿ç®—ï¼šæœ€è¿‘é‚»æ’å€¼ï¼ŒåŒçº¿æ€§æ’å€¼ï¼ŒåŒä¸‰æ¬¡æ’å€¼ç­‰</p><p>Transposed conv: è½¬ç½®å·ç§¯ï¼Œå·ç§¯æ ¸çŸ©é˜µçš„shapeè¿›è¡Œäº†è½¬ç½®è€Œå¾—å</p><h2 id="å¯»æ‰¾æœ€ä½³å­¦ä¹ ç‡"><a href="#å¯»æ‰¾æœ€ä½³å­¦ä¹ ç‡" class="headerlink" title="å¯»æ‰¾æœ€ä½³å­¦ä¹ ç‡"></a>å¯»æ‰¾æœ€ä½³å­¦ä¹ ç‡</h2><blockquote><p><a href="https://arxiv.org/abs/1506.01186">å‚è€ƒæ–‡ç« ã€ŠCyclical Learning Rates for Training Neural Networksã€‹</a></p><p><a href="https://github.com/vmbbc/pytorch-lr-finder">å‚è€ƒä»£ç </a></p></blockquote><p>æ–‡ç« ä¸­æå‡ºäº†ä¸€ç§å¯»æ‰¾æœ€ä¼˜å­¦ä¹ ç‡çš„æ–¹æ³•ï¼Œå¯é€‚ç”¨äºå„ç±»ç¥ç»ç½‘ç»œçš„åˆå§‹å­¦ä¹ ç‡è®¾ç½®æ¯ä¸ªIterationé€æ¸å¢åŠ å­¦ä¹ ç‡ï¼Œè§‚å¯Ÿlossçš„å˜åŒ–é€‰æ‹©ä¸€ä¸ªæŸå¤±ä¸‹é™æœ€å¿«çš„ç‚¹å¯¹åº”çš„å­¦ä¹ ç‡</p><p>é€‰æ‹©ä¸€ä¸ª<strong>æŸå¤±ä¸‹é™æœ€å¿«ç‚¹å¯¹åº”çš„LR</strong>ï¼šè§‚å¯ŸLoss æ¢¯åº¦ï¼Œå¾—åˆ°æ¢¯åº¦æ»‘åŠ¨å¹³å‡å›¾ï¼Œæ‰¾åˆ°ä¸‹é™æœ€å¿«çš„åœ°æ–¹ï¼Œä»ä¸‹å›¾ä¾‹å¯çŸ¥é“0.01çš„LRæ˜¯å¯¹åº”æŸå¤±ä¸‹é™æœ€å¿«çš„LR</p><table><thead><tr><th>Lossæ¢¯åº¦å›¾</th><th>Lossæ¢¯åº¦æ»‘åŠ¨å¹³å‡å›¾</th></tr></thead><tbody><tr><td><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2heg5db1gj20v30k00uw.jpg"></td><td><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2heiokcisj20u90k00tn.jpg"></td></tr></tbody></table><p>ä¸‹å›¾ä¸ºSegNetåœ¨CamVidä¸Šçš„åŒºé—´æµ‹è¯•ç»“æœ</p><p>LR Finderä¼šè‡ªåŠ¨è®¡ç®—æœ€ä¼˜å­¦ä¹ ç‡ä¸º<strong>steepest gradientï¼ˆé™¡å³­çš„æ¢¯åº¦ï¼‰</strong></p><p>å¯¹åº”çš„å­¦ä¹ ç‡ä¸º<strong>Suggested LR: 4.33E-01</strong></p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hei5y43jj20ql0k03z8.jpg" style="zoom: 50%;" /><h2 id="æ¢¯åº¦è£å‰ª"><a href="#æ¢¯åº¦è£å‰ª" class="headerlink" title="æ¢¯åº¦è£å‰ª"></a>æ¢¯åº¦è£å‰ª</h2><h3 id="æ¢¯åº¦æ¿€å¢é—®é¢˜"><a href="#æ¢¯åº¦æ¿€å¢é—®é¢˜" class="headerlink" title="æ¢¯åº¦æ¿€å¢é—®é¢˜"></a>æ¢¯åº¦æ¿€å¢é—®é¢˜</h3><p>è®­ç»ƒSegResnet-50è¿‡ç¨‹ä¸­æœ‰æ—¶å€™ä¼šå‡ºç°lossæ¿€å¢çš„ç°è±¡ï¼Œé€šå¸¸æ˜¯å› ä¸ºå‡ºç°æ¢¯åº¦è¿‡å¤§å¯¼è‡´çš„ä¸ç¨³å®šï¼Œå¯é€šè¿‡æ¢¯åº¦è£å‰ªæ¥ç¨³å®šæ¨¡å‹è®­ç»ƒ</p><table><thead><tr><th><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hexbngo5j20qo0k0mxs.jpg"></th><th><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hexgdedtj20qo0k0t9k.jpg"></th></tr></thead></table><h3 id="æ¢¯åº¦è£å‰ª-1"><a href="#æ¢¯åº¦è£å‰ª-1" class="headerlink" title="æ¢¯åº¦è£å‰ª"></a>æ¢¯åº¦è£å‰ª</h3><p>PyTorchæä¾›äº†ä¸¤ä¸ªæ¢¯åº¦è£å‰ªå‡½æ•°</p><p>clip_grad_norm_ ï¼šClips gradient norm of an iterable of parameters.</p><p>clip_grad_value_ :Clips gradient of an iterable of parameters at specified value.</p><p>è£å‰ªæ€è·¯ï¼šç»Ÿè®¡æ¨¡å‹è®­ç»ƒè¿‡ç¨‹ä¸­çš„æ¢¯åº¦çš„ç›´æ–¹å›¾ï¼Œè®¾å®šclipçš„é˜ˆå€¼</p><p>ä¾‹ï¼šclip_value :0.5ï¼Œ0.3ä»æ¿€å¢</p><p>å½“è°ƒæ•´ä¸º0.2æ—¶å¦‚ä¸‹æ‰€ç¤ºï¼ŒmIoUä»0.6025ä¸‹é™åˆ°0.5982</p><table><thead><tr><th><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hf0z7oxdj20qo0k0gly.jpg"></th><th><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hf140i1tj20qo0k03z4.jpg"></th><th><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hf192jy2j20qo0k0q3p.jpg"></th></tr></thead></table><h2 id="ä»£ç ç¼–å†™"><a href="#ä»£ç ç¼–å†™" class="headerlink" title="ä»£ç ç¼–å†™"></a>ä»£ç ç¼–å†™</h2><h3 id="bins-x2F-lr-range-test-py"><a href="#bins-x2F-lr-range-test-py" class="headerlink" title="bins&#x2F;lr_range_test.py"></a>bins&#x2F;lr_range_test.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"># @file name  : lr_range_test.py</span></span><br><span class="line"><span class="string"># @author     : zz0320</span></span><br><span class="line"><span class="string"># @date       : 2022-04-17</span></span><br><span class="line"><span class="string"># @brief      : lr åŒºé—´æµ‹è¯•è„šæœ¬</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> matplotlib</span><br><span class="line"><span class="comment"># matplotlib.use(&#x27;agg&#x27;)</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">BASE_DIR = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">sys.path.append(os.path.join(BASE_DIR, <span class="string">&#x27;..&#x27;</span>))</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> torch.optim <span class="keyword">as</span> optim</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> DataLoader</span><br><span class="line"><span class="keyword">from</span> datasets.camvid_dataset <span class="keyword">import</span> CamvidDataset</span><br><span class="line"><span class="keyword">from</span> tools.common_tools <span class="keyword">import</span> setup_seed, show_confMat, plot_line, Logger, check_data_dir</span><br><span class="line"><span class="keyword">from</span> config.camvid_config <span class="keyword">import</span> cfg</span><br><span class="line"><span class="keyword">from</span> models.deeplabv3_plus <span class="keyword">import</span> DeepLabV3Plus</span><br><span class="line"><span class="keyword">from</span> models.unet <span class="keyword">import</span> UNet, UNetResnet</span><br><span class="line"><span class="keyword">from</span> models.segnet <span class="keyword">import</span> SegNet, SegResNet</span><br><span class="line"><span class="keyword">from</span> torch_lr_finder <span class="keyword">import</span> LRFinder</span><br><span class="line"></span><br><span class="line">setup_seed(<span class="number">12345</span>)  <span class="comment"># å…ˆå›ºå®šéšæœºç§å­</span></span><br><span class="line"></span><br><span class="line">parser = argparse.ArgumentParser(description=<span class="string">&#x27;Training&#x27;</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;--lr&#x27;</span>, default=<span class="literal">None</span>, <span class="built_in">help</span>=<span class="string">&#x27;learning rate&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">float</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;--max_epoch&#x27;</span>, default=<span class="literal">None</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;--train_bs&#x27;</span>, default=<span class="number">0</span>, <span class="built_in">type</span>=<span class="built_in">int</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;--data_root_dir&#x27;</span>, default=<span class="string">r&quot;/Users/kenton/Downloads/deeplearning_dataset/camvid_from_paper&quot;</span>,</span><br><span class="line">                    <span class="built_in">help</span>=<span class="string">&quot;path to your dataset&quot;</span>)</span><br><span class="line">args = parser.parse_args()</span><br><span class="line">cfg.lr_init = args.lr <span class="keyword">if</span> args.lr <span class="keyword">else</span> cfg.lr_init</span><br><span class="line">cfg.train_bs = args.train_bs <span class="keyword">if</span> args.train_bs <span class="keyword">else</span> cfg.train_bs</span><br><span class="line">cfg.max_epoch = args.max_epoch <span class="keyword">if</span> args.max_epoch <span class="keyword">else</span> cfg.max_epoch</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># è®¾ç½®è·¯å¾„</span></span><br><span class="line">    path_model_50 = <span class="string">&quot;/Users/kenton/Downloads/deeplearning_dataset/pretrain_model/resnet50-19c8e357.pth&quot;</span> <span class="comment"># segnet</span></span><br><span class="line">    path_model_101 = <span class="string">&quot;/Users/kenton/Downloads/deeplearning_dataset/pretrain_model/resnet101s-03a0f310.pth&quot;</span>  <span class="comment"># deeplab</span></span><br><span class="line">    path_model_50s = <span class="string">&quot;/Users/kenton/Downloads/deeplearning_dataset/pretrain_model/resnet50s-a75c83cf.pth&quot;</span>  <span class="comment"># unet</span></span><br><span class="line">    path_model_vgg = <span class="string">&quot;/Users/kenton/Downloads/deeplearning_dataset/pretrain_model/vgg16_bn-6c64b313.pth&quot;</span></span><br><span class="line">    <span class="comment"># ------------------------------------ step 1/5 : åŠ è½½æ•°æ®------------------------------------</span></span><br><span class="line">    <span class="comment"># æ„å»ºDatasetå®ä¾‹</span></span><br><span class="line">    root_dir = args.data_root_dir</span><br><span class="line">    train_img_dir = os.path.join(root_dir, <span class="string">&#x27;train&#x27;</span>)</span><br><span class="line">    train_lable_dir = os.path.join(root_dir, <span class="string">&#x27;train_labels&#x27;</span>)</span><br><span class="line">    path_to_dict = os.path.join(root_dir, <span class="string">&#x27;class_dict.csv&#x27;</span>)</span><br><span class="line">    check_data_dir(train_img_dir)</span><br><span class="line">    check_data_dir(train_lable_dir)</span><br><span class="line"></span><br><span class="line">    train_set = CamvidDataset(train_img_dir, train_lable_dir, path_to_dict, cfg.crop_size)</span><br><span class="line"></span><br><span class="line">    train_loader = DataLoader(train_set, batch_size=cfg.train_bs, shuffle=<span class="literal">True</span>, num_workers=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ------------------------------------ step 2/5 : å®šä¹‰ç½‘ç»œ------------------------------------</span></span><br><span class="line">    model = SegNet(num_classes=train_set.cls_num, path_model=path_model_vgg)</span><br><span class="line">    <span class="comment"># model = SegResNet(num_classes=train_set.cls_num, path_model=None)</span></span><br><span class="line">    <span class="comment"># model = UNet(num_classes=train_set.cls_num)</span></span><br><span class="line">    <span class="comment"># model = DeepLabV3Plus(num_classes=train_set.cls_num, path_model=path_model)</span></span><br><span class="line">    model.to(cfg.device)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ------------------------------------ step 3/5 : å®šä¹‰æŸå¤±å‡½æ•°å’Œä¼˜åŒ–å™¨ ------------------------------------</span></span><br><span class="line">    loss_f = nn.CrossEntropyLoss().to(cfg.device)</span><br><span class="line">    optimizer = optim.SGD(model.parameters(), lr=<span class="number">1e-3</span>, weight_decay=<span class="number">1e-4</span>)</span><br><span class="line">    <span class="comment"># ------------------------------------ step 4/5 : è®­ç»ƒ --------------------------------------------------</span></span><br><span class="line">    <span class="comment"># æ¥å£ï¼šdata loaderã€modelã€optimizerã€loss_f</span></span><br><span class="line">    lr_finder = LRFinder(model, optimizer, loss_f, device=cfg.device)</span><br><span class="line">    lr_finder.range_test(train_loader, end_lr=<span class="number">100</span>, num_iter=<span class="number">100</span>)</span><br><span class="line">    lr_finder.plot()  <span class="comment"># to inspect the loss-learning rate graph</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="bins-x2F-segnet-inference-py"><a href="#bins-x2F-segnet-inference-py" class="headerlink" title="bins&#x2F;segnet_inference.py"></a>bins&#x2F;segnet_inference.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"># @file name  : segnet_inference.py</span></span><br><span class="line"><span class="string"># @author     : zz0320</span></span><br><span class="line"><span class="string"># @date       : 2022-04-17</span></span><br><span class="line"><span class="string"># @brief      : å‰å‘æ¨ç†ä»£ç  + ç»“æœè¾“å‡º</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> matplotlib</span><br><span class="line"><span class="comment"># matplotlib.use(&#x27;agg&#x27;)</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">BASE_DIR = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">sys.path.append(os.path.join(BASE_DIR, <span class="string">&#x27;..&#x27;</span>))</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> models.segnet <span class="keyword">import</span> SegResNet</span><br><span class="line"><span class="keyword">import</span> torchvision.transforms <span class="keyword">as</span> transforms</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line">device = torch.device(<span class="string">&quot;cuda&quot;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&#x27;cpu&#x27;</span>)</span><br><span class="line"></span><br><span class="line">parser = argparse.ArgumentParser(description=<span class="string">&#x27;Inference&#x27;</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;--path_checkpoint&#x27;</span>,</span><br><span class="line">    default=<span class="string">r&quot;/Users/kenton/Downloads/terminal_download/results/04-18_08-23/checkpoint_best.pkl&quot;</span>,</span><br><span class="line">    <span class="built_in">help</span> = <span class="string">&#x27;path to your dataset&#x27;</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;--path_img&#x27;</span>, default=<span class="string">r&quot;/Users/kenton/Downloads/deeplearning_dataset/camvid_from_paper/test/Seq05VD_f00210.png&quot;</span>,</span><br><span class="line">                    <span class="built_in">help</span>=<span class="string">&quot;path to your dataset&quot;</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;--path_csv&#x27;</span>, default=<span class="string">r&quot;/Users/kenton/Downloads/deeplearning_dataset/camvid_from_paper/class_dict.csv&quot;</span>,</span><br><span class="line">                    <span class="built_in">help</span>=<span class="string">&quot;path to your csv&quot;</span>)</span><br><span class="line">args = parser.parse_args()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># å›¾ç‰‡é¢„å¤„ç†</span></span><br><span class="line">    transform_img = transforms.Compose([</span><br><span class="line">        transforms.ToTensor(),</span><br><span class="line">        transforms.Normalize([<span class="number">0.485</span>, <span class="number">0.456</span>, <span class="number">0.406</span>], [<span class="number">0.229</span>, <span class="number">0.224</span>, <span class="number">0.225</span>])</span><br><span class="line">    ])</span><br><span class="line">    img = Image.<span class="built_in">open</span>(args.path_img)</span><br><span class="line">    img_tensor = transform_img(img)</span><br><span class="line">    img_tensor.unsqueeze_(<span class="number">0</span>)</span><br><span class="line">    img_tensor = img_tensor.to(device)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ¨¡å‹åŠ è½½</span></span><br><span class="line">    model = SegResNet(num_classes=<span class="number">12</span>)</span><br><span class="line">    checkpoint = torch.load(args.path_checkpoint, map_location=<span class="string">&#x27;cpu&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    model.load_state_dict(checkpoint[<span class="string">&quot;model_state_dict&quot;</span>])</span><br><span class="line">    model.to(device)</span><br><span class="line"></span><br><span class="line">    model.<span class="built_in">eval</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ¨ç†</span></span><br><span class="line">    <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">        outputs = model(img_tensor)</span><br><span class="line">    outputs = torch.<span class="built_in">max</span>(outputs, dim=<span class="number">1</span>)</span><br><span class="line">    pre_label = outputs[<span class="number">1</span>].squeeze().cpu().data.numpy()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ç»“æœå±•ç¤º</span></span><br><span class="line">    pd_label_color = pd.read_csv(args.path_csv, sep=<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">    name_value = pd_label_color[<span class="string">&#x27;name&#x27;</span>].values</span><br><span class="line">    num_class = <span class="built_in">len</span>(name_value)</span><br><span class="line">    colormap = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_class):</span><br><span class="line">        tmp = pd_label_color.iloc[i]</span><br><span class="line">        color = [tmp[<span class="string">&#x27;r&#x27;</span>], tmp[<span class="string">&#x27;g&#x27;</span>], tmp[<span class="string">&#x27;b&#x27;</span>]]</span><br><span class="line">        colormap.append(color)</span><br><span class="line"></span><br><span class="line">    cm = np.array(colormap).astype(<span class="string">&#x27;uint8&#x27;</span>)</span><br><span class="line">    pre = cm[pre_label]</span><br><span class="line">    pre1 = Image.fromarray(pre)</span><br><span class="line"></span><br><span class="line">    plt.subplot(<span class="number">121</span>)</span><br><span class="line">    plt.imshow(pre1)</span><br><span class="line">    plt.subplot(<span class="number">122</span>)</span><br><span class="line">    plt.imshow(img)</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å±•ç¤ºå›¾ä¾‹</span></span><br><span class="line">    height = <span class="number">20</span></span><br><span class="line">    fake_img = np.zeros((height*<span class="number">12</span>, <span class="number">100</span>, <span class="number">3</span>), dtype=np.uint8)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_class):</span><br><span class="line">        tmp = pd_label_color.iloc[i]</span><br><span class="line">        color = [tmp[<span class="string">&#x27;r&#x27;</span>], tmp[<span class="string">&#x27;g&#x27;</span>], tmp[<span class="string">&#x27;b&#x27;</span>]]</span><br><span class="line">        fake_img[height*i:height*(i+<span class="number">1</span>), :, :] = color</span><br><span class="line"></span><br><span class="line">    plt.imshow(fake_img)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_class):</span><br><span class="line">        name = pd_label_color[<span class="string">&quot;name&quot;</span>][i]</span><br><span class="line">        plt.text(<span class="number">10</span>, <span class="number">15</span> + height*i, name)</span><br><span class="line">    plt.show()</span><br></pre></td></tr></table></figure><h3 id="config-x2F-camvid-config-py"><a href="#config-x2F-camvid-config-py" class="headerlink" title="config&#x2F;camvid_config.py"></a>config&#x2F;camvid_config.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"># @file name  : camvid_config.py</span></span><br><span class="line"><span class="string"># @author     : zz0320</span></span><br><span class="line"><span class="string"># @date       : 2022-03-12</span></span><br><span class="line"><span class="string"># @brief      : camvidåˆ†å‰²å‚æ•°é…ç½®</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> easydict <span class="keyword">import</span> EasyDict</span><br><span class="line"></span><br><span class="line">cfg = EasyDict()  <span class="comment"># è®¿é—®å±æ€§çš„æ–¹å¼å»ä½¿ç”¨key-value å³é€šè¿‡ .keyè·å¾—value</span></span><br><span class="line"></span><br><span class="line">cfg.device = torch.device(<span class="string">&quot;cuda&quot;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&quot;cpu&quot;</span>)</span><br><span class="line">cfg.max_epoch = <span class="number">150</span>  <span class="comment"># 150</span></span><br><span class="line"></span><br><span class="line">cfg.crop_size = (<span class="number">360</span>, <span class="number">480</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># batch size</span></span><br><span class="line">cfg.train_bs = <span class="number">2</span>  <span class="comment"># 8</span></span><br><span class="line">cfg.valid_bs = <span class="number">1</span>    <span class="comment"># 4</span></span><br><span class="line">cfg.workers = <span class="number">1</span>  <span class="comment"># 16</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å­¦ä¹ ç‡</span></span><br><span class="line">cfg.lr_init = <span class="number">0.1</span>  <span class="comment"># pretraied_model::0.1</span></span><br><span class="line">cfg.factor = <span class="number">0.1</span></span><br><span class="line">cfg.milestones = [<span class="number">75</span>, <span class="number">130</span>]</span><br><span class="line">cfg.weight_decay = <span class="number">1e-4</span></span><br><span class="line">cfg.momentum = <span class="number">0.9</span></span><br><span class="line"></span><br><span class="line">cfg.log_interval = <span class="number">10</span></span><br></pre></td></tr></table></figure><h3 id="models-x2F-segnet-py"><a href="#models-x2F-segnet-py" class="headerlink" title="models&#x2F;segnet.py"></a>models&#x2F;segnet.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"># @file name  : segnet.py</span></span><br><span class="line"><span class="string"># @author     : zz0320</span></span><br><span class="line"><span class="string"># @date       : 2022-4-16</span></span><br><span class="line"><span class="string"># @brief      : segnetç½‘ç»œæ¶æ„</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"><span class="keyword">from</span> torchvision <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line"><span class="keyword">from</span> math <span class="keyword">import</span> ceil</span><br><span class="line"><span class="keyword">from</span> tools.helpers <span class="keyword">import</span> set_trainable</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SegNet</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, num_classes, in_channels=<span class="number">3</span>, freeze_bn=<span class="literal">False</span>,</span></span><br><span class="line"><span class="params">        freeze_backbone=<span class="literal">False</span>, path_model=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(SegNet, self).__init__()</span><br><span class="line">        vgg_bn = models.vgg16_bn()</span><br><span class="line">        <span class="keyword">if</span> path_model:</span><br><span class="line">            vgg_bn.load_state_dict(torch.load(path_model, map_location=<span class="string">&#x27;cpu&#x27;</span>))</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;load pretrain model done!&quot;</span>)</span><br><span class="line"></span><br><span class="line">        encoder = <span class="built_in">list</span>(vgg_bn.features.children())</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Adjust the input size</span></span><br><span class="line">        <span class="keyword">if</span> in_channels != <span class="number">3</span>:</span><br><span class="line">            encoder[<span class="number">0</span>] = nn.Conv2d(in_channels, <span class="number">64</span>, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Encoder, VGG without any maxpooling</span></span><br><span class="line">        self.stage1_encoder = nn.Sequential(*encoder[:<span class="number">6</span>])</span><br><span class="line">        self.stage2_encoder = nn.Sequential(*encoder[<span class="number">7</span>:<span class="number">13</span>])</span><br><span class="line">        self.stage3_encoder = nn.Sequential(*encoder[<span class="number">14</span>:<span class="number">23</span>])</span><br><span class="line">        self.stage4_encoder = nn.Sequential(*encoder[<span class="number">24</span>:<span class="number">33</span>])</span><br><span class="line">        self.stage5_encoder = nn.Sequential(*encoder[<span class="number">34</span>:-<span class="number">1</span>])</span><br><span class="line">        self.pool = nn.MaxPool2d(kernel_size=<span class="number">2</span>, stride=<span class="number">2</span>, return_indices=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Decoder, same as the encoder but reversed, maxpool will not be used</span></span><br><span class="line">        decoder = encoder</span><br><span class="line">        decoder = [i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">list</span>(<span class="built_in">reversed</span>(decoder)) <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(i, nn.MaxPool2d)]</span><br><span class="line">        <span class="comment"># Replace the last conv layer</span></span><br><span class="line">        decoder[-<span class="number">1</span>] = nn.Conv2d(<span class="number">64</span>, <span class="number">64</span>, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># When reversing, we also reversed conv-&gt;batchN-&gt;relu, correct it</span></span><br><span class="line">        decoder = [item <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(decoder), <span class="number">3</span>) <span class="keyword">for</span> item <span class="keyword">in</span> decoder[i:i + <span class="number">3</span>][::-<span class="number">1</span>]]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Replace some conv layers &amp; batchN after them</span></span><br><span class="line">        <span class="keyword">for</span> i, module <span class="keyword">in</span> <span class="built_in">enumerate</span>(decoder):</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(module, nn.Conv2d):</span><br><span class="line">                <span class="keyword">if</span> module.in_channels != module.out_channels:</span><br><span class="line">                    decoder[i + <span class="number">1</span>] = nn.BatchNorm2d(module.in_channels)</span><br><span class="line">                    decoder[i] = nn.Conv2d(module.out_channels, module.in_channels, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        self.stage1_decoder = nn.Sequential(*decoder[<span class="number">0</span>:<span class="number">9</span>])</span><br><span class="line">        self.stage2_decoder = nn.Sequential(*decoder[<span class="number">9</span>:<span class="number">18</span>])</span><br><span class="line">        self.stage3_decoder = nn.Sequential(*decoder[<span class="number">18</span>:<span class="number">27</span>])</span><br><span class="line">        self.stage4_decoder = nn.Sequential(*decoder[<span class="number">27</span>:<span class="number">33</span>])</span><br><span class="line">        self.stage5_decoder = nn.Sequential(*decoder[<span class="number">33</span>:],</span><br><span class="line">                                            nn.Conv2d(<span class="number">64</span>, num_classes, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">1</span>)</span><br><span class="line">                                            )</span><br><span class="line">        self.unpool = nn.MaxUnpool2d(kernel_size=<span class="number">2</span>, stride=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">        self._initialize_weights(self.stage1_decoder, self.stage2_decoder, self.stage3_decoder,</span><br><span class="line">                                 self.stage4_decoder, self.stage5_decoder)</span><br><span class="line">        <span class="keyword">if</span> freeze_bn:</span><br><span class="line">            self.freeze_bn()</span><br><span class="line">        <span class="keyword">if</span> freeze_backbone:</span><br><span class="line">            set_trainable([self.stage1_encoder, self.stage2_encoder, self.stage3_encoder, self.stage4_encoder,</span><br><span class="line">                           self.stage5_encoder], <span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_initialize_weights</span>(<span class="params">self, *stages</span>):</span><br><span class="line">        <span class="keyword">for</span> modules <span class="keyword">in</span> stages:</span><br><span class="line">            <span class="keyword">for</span> module <span class="keyword">in</span> modules.modules():</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">isinstance</span>(module, nn.Conv2d):</span><br><span class="line">                    nn.init.kaiming_normal_(module.weight)</span><br><span class="line">                    <span class="keyword">if</span> module.bias <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                        module.bias.data.zero_()</span><br><span class="line">                <span class="keyword">elif</span> <span class="built_in">isinstance</span>(module, nn.BatchNorm2d):</span><br><span class="line">                    module.weight.data.fill_(<span class="number">1</span>)</span><br><span class="line">                    module.bias.data.zero_()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">freeze_bn</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">for</span> module <span class="keyword">in</span> self.modules():</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(module, nn.BatchNorm2d):</span><br><span class="line">                module.<span class="built_in">eval</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="comment"># Encoder</span></span><br><span class="line">        x = self.stage1_encoder(x)</span><br><span class="line">        x1_size = x.size()</span><br><span class="line">        x, indices1 = self.pool(x)</span><br><span class="line"></span><br><span class="line">        x = self.stage2_encoder(x)</span><br><span class="line">        x2_size = x.size()</span><br><span class="line">        x, indices2 = self.pool(x)</span><br><span class="line"></span><br><span class="line">        x = self.stage3_encoder(x)</span><br><span class="line">        x3_size = x.size()</span><br><span class="line">        x, indices3 = self.pool(x)</span><br><span class="line"></span><br><span class="line">        x = self.stage4_encoder(x)</span><br><span class="line">        x4_size = x.size()</span><br><span class="line">        x, indices4 = self.pool(x)</span><br><span class="line"></span><br><span class="line">        x = self.stage5_encoder(x)</span><br><span class="line">        x5_size = x.size()</span><br><span class="line">        x, indices5 = self.pool(x)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Decoder</span></span><br><span class="line">        x = self.unpool(x, indices=indices5, output_size=x5_size)</span><br><span class="line">        x = self.stage1_decoder(x)</span><br><span class="line"></span><br><span class="line">        x = self.unpool(x, indices=indices4, output_size=x4_size)</span><br><span class="line">        x = self.stage2_decoder(x)</span><br><span class="line"></span><br><span class="line">        x = self.unpool(x, indices=indices3, output_size=x3_size)</span><br><span class="line">        x = self.stage3_decoder(x)</span><br><span class="line"></span><br><span class="line">        x = self.unpool(x, indices=indices2, output_size=x2_size)</span><br><span class="line">        x = self.stage4_decoder(x)</span><br><span class="line"></span><br><span class="line">        x = self.unpool(x, indices=indices1, output_size=x1_size)</span><br><span class="line">        x = self.stage5_decoder(x)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DecoderBottleneck</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, inchannels</span>):</span><br><span class="line">        <span class="built_in">super</span>(DecoderBottleneck, self).__init__()</span><br><span class="line">        self.conv1 = nn.Conv2d(inchannels, inchannels//<span class="number">4</span>, kernel_size=<span class="number">1</span>, bias=<span class="literal">False</span>)</span><br><span class="line">        self.bn1 = nn.BatchNorm2d(inchannels//<span class="number">4</span>)</span><br><span class="line">        self.conv2 = nn.ConvTranspose2d(inchannels//<span class="number">4</span>, inchannels//<span class="number">4</span>, kernel_size=<span class="number">2</span>, stride=<span class="number">2</span>, bias=<span class="literal">False</span>)</span><br><span class="line">        self.bn2 = nn.BatchNorm2d(inchannels//<span class="number">4</span>)</span><br><span class="line">        self.conv3 = nn.Conv2d(inchannels//<span class="number">4</span>, inchannels//<span class="number">2</span>, <span class="number">1</span>, bias=<span class="literal">False</span>)</span><br><span class="line">        self.bn3 = nn.BatchNorm2d(inchannels//<span class="number">2</span>)</span><br><span class="line">        self.relu = nn.ReLU(inplace=<span class="literal">True</span>)</span><br><span class="line">        self.downsample = nn.Sequential(</span><br><span class="line">                nn.ConvTranspose2d(inchannels, inchannels//<span class="number">2</span>, kernel_size=<span class="number">2</span>, stride=<span class="number">2</span>, bias=<span class="literal">False</span>),</span><br><span class="line">                nn.BatchNorm2d(inchannels//<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        out = self.conv1(x)</span><br><span class="line">        out = self.bn1(out)</span><br><span class="line">        out = self.relu(out)</span><br><span class="line">        out = self.conv2(out)</span><br><span class="line">        out = self.bn2(out)</span><br><span class="line">        out = self.relu(out)</span><br><span class="line">        out = self.conv3(out)</span><br><span class="line">        out = self.bn3(out)</span><br><span class="line"></span><br><span class="line">        identity = self.downsample(x)</span><br><span class="line">        out += identity</span><br><span class="line">        out = self.relu(out)</span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LastBottleneck</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, inchannels</span>):</span><br><span class="line">        <span class="built_in">super</span>(LastBottleneck, self).__init__()</span><br><span class="line">        self.conv1 = nn.Conv2d(inchannels, inchannels // <span class="number">4</span>, kernel_size=<span class="number">1</span>, bias=<span class="literal">False</span>)</span><br><span class="line">        self.bn1 = nn.BatchNorm2d(inchannels // <span class="number">4</span>)</span><br><span class="line">        self.conv2 = nn.Conv2d(inchannels // <span class="number">4</span>, inchannels // <span class="number">4</span>, kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>, bias=<span class="literal">False</span>)</span><br><span class="line">        self.bn2 = nn.BatchNorm2d(inchannels // <span class="number">4</span>)</span><br><span class="line">        self.conv3 = nn.Conv2d(inchannels // <span class="number">4</span>, inchannels // <span class="number">4</span>, <span class="number">1</span>, bias=<span class="literal">False</span>)</span><br><span class="line">        self.bn3 = nn.BatchNorm2d(inchannels // <span class="number">4</span>)</span><br><span class="line">        self.relu = nn.ReLU(inplace=<span class="literal">True</span>)</span><br><span class="line">        self.downsample = nn.Sequential(</span><br><span class="line">            nn.Conv2d(inchannels, inchannels // <span class="number">4</span>, kernel_size=<span class="number">1</span>, bias=<span class="literal">False</span>),</span><br><span class="line">            nn.BatchNorm2d(inchannels // <span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        out = self.conv1(x)</span><br><span class="line">        out = self.bn1(out)</span><br><span class="line">        out = self.relu(out)</span><br><span class="line">        out = self.conv2(out)</span><br><span class="line">        out = self.bn2(out)</span><br><span class="line">        out = self.relu(out)</span><br><span class="line">        out = self.conv3(out)</span><br><span class="line">        out = self.bn3(out)</span><br><span class="line"></span><br><span class="line">        identity = self.downsample(x)</span><br><span class="line">        out += identity</span><br><span class="line">        out = self.relu(out)</span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SegResNet</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, num_classes, in_channels=<span class="number">3</span>, freeze_bn=<span class="literal">False</span>, path_model=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(SegResNet, self).__init__()</span><br><span class="line">        resnet101 = models.resnet101()</span><br><span class="line">        <span class="keyword">if</span> path_model:</span><br><span class="line">            resnet101.load_state_dict(torch.load(path_model, map_location=<span class="string">&quot;cpu&quot;</span>))</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;load pretrain model done!&quot;</span>)</span><br><span class="line"></span><br><span class="line">        encoder = <span class="built_in">list</span>(resnet101.children())</span><br><span class="line">        <span class="keyword">if</span> in_channels != <span class="number">3</span>:</span><br><span class="line">            encoder[<span class="number">0</span>] = nn.Conv2d(in_channels, <span class="number">64</span>, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">1</span>)</span><br><span class="line">        encoder[<span class="number">3</span>].return_indices = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Encoder</span></span><br><span class="line">        self.first_conv = nn.Sequential(*encoder[:<span class="number">4</span>])</span><br><span class="line">        resnet101_blocks = <span class="built_in">list</span>(resnet101.children())[<span class="number">4</span>:-<span class="number">2</span>]</span><br><span class="line">        self.encoder = nn.Sequential(*resnet101_blocks)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Decoder</span></span><br><span class="line">        resnet101_untrained = models.resnet101(pretrained=<span class="literal">False</span>)</span><br><span class="line">        resnet101_blocks = <span class="built_in">list</span>(resnet101_untrained.children())[<span class="number">4</span>:-<span class="number">2</span>][::-<span class="number">1</span>]</span><br><span class="line">        decoder = []</span><br><span class="line">        channels = (<span class="number">2048</span>, <span class="number">1024</span>, <span class="number">512</span>)</span><br><span class="line">        <span class="keyword">for</span> i, block <span class="keyword">in</span> <span class="built_in">enumerate</span>(resnet101_blocks[:-<span class="number">1</span>]):</span><br><span class="line">            new_block = <span class="built_in">list</span>(block.children())[::-<span class="number">1</span>][:-<span class="number">1</span>]</span><br><span class="line">            decoder.append(nn.Sequential(*new_block, DecoderBottleneck(channels[i])))</span><br><span class="line">        new_block = <span class="built_in">list</span>(resnet101_blocks[-<span class="number">1</span>].children())[::-<span class="number">1</span>][:-<span class="number">1</span>]</span><br><span class="line">        decoder.append(nn.Sequential(*new_block, LastBottleneck(<span class="number">256</span>)))</span><br><span class="line"></span><br><span class="line">        self.decoder = nn.Sequential(*decoder)</span><br><span class="line">        self.last_conv = nn.Sequential(</span><br><span class="line">            nn.ConvTranspose2d(<span class="number">64</span>, <span class="number">64</span>, kernel_size=<span class="number">2</span>, stride=<span class="number">2</span>, bias=<span class="literal">False</span>),</span><br><span class="line">            nn.Conv2d(<span class="number">64</span>, num_classes, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">1</span>)</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">if</span> freeze_bn:</span><br><span class="line">            self.freeze_bn()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        inputsize = x.size()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Encoder</span></span><br><span class="line">        x, indices = self.first_conv(x)</span><br><span class="line">        x = self.encoder(x)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Decoder</span></span><br><span class="line">        x = self.decoder(x)</span><br><span class="line">        h_diff = ceil((x.size()[<span class="number">2</span>] - indices.size()[<span class="number">2</span>]) / <span class="number">2</span>)</span><br><span class="line">        w_diff = ceil((x.size()[<span class="number">3</span>] - indices.size()[<span class="number">3</span>]) / <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">if</span> indices.size()[<span class="number">2</span>] % <span class="number">2</span> == <span class="number">1</span>:</span><br><span class="line">            x = x[:, :, h_diff:x.size()[<span class="number">2</span>] - (h_diff - <span class="number">1</span>), w_diff: x.size()[<span class="number">3</span>] - (w_diff - <span class="number">1</span>)]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            x = x[:, :, h_diff:x.size()[<span class="number">2</span>] - h_diff, w_diff: x.size()[<span class="number">3</span>] - w_diff]</span><br><span class="line"></span><br><span class="line">        x = F.max_unpool2d(x, indices, kernel_size=<span class="number">2</span>, stride=<span class="number">2</span>)</span><br><span class="line">        x = self.last_conv(x)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> inputsize != x.size():</span><br><span class="line">            h_diff = (x.size()[<span class="number">2</span>] - inputsize[<span class="number">2</span>]) // <span class="number">2</span></span><br><span class="line">            w_diff = (x.size()[<span class="number">3</span>] - inputsize[<span class="number">3</span>]) // <span class="number">2</span></span><br><span class="line">            x = x[:, :, h_diff:x.size()[<span class="number">2</span>] - h_diff, w_diff: x.size()[<span class="number">3</span>] - w_diff]</span><br><span class="line">            <span class="keyword">if</span> h_diff % <span class="number">2</span> != <span class="number">0</span>: x = x[:, :, :-<span class="number">1</span>, :]</span><br><span class="line">            <span class="keyword">if</span> w_diff % <span class="number">2</span> != <span class="number">0</span>: x = x[:, :, :, :-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">freeze_bn</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">for</span> module <span class="keyword">in</span> self.modules():</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(module, nn.BatchNorm2d): module.<span class="built_in">eval</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    fake_img = torch.randn((<span class="number">2</span>, <span class="number">3</span>, <span class="number">224</span>, <span class="number">224</span>))</span><br><span class="line"></span><br><span class="line">    model = SegNet(num_classes=<span class="number">21</span>, path_model=<span class="number">0</span>)</span><br><span class="line">    <span class="comment"># model = SegResNet(num_classes=12)</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    output = model(fake_img)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(output.shape)</span><br></pre></td></tr></table></figure><h3 id="src-x2F-camvid-train-py"><a href="#src-x2F-camvid-train-py" class="headerlink" title="src&#x2F;camvid_train.py"></a>src&#x2F;camvid_train.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"># @file name  : camvid_train.py</span></span><br><span class="line"><span class="string"># @author     : zz0320</span></span><br><span class="line"><span class="string"># @date       : 2022-4-16</span></span><br><span class="line"><span class="string"># @brief      : æ¨¡å‹è®­ç»ƒä¸»ä»£ç </span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> matplotlib</span><br><span class="line"><span class="comment"># matplotlib.use(&#x27;agg&#x27;)</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">BASE_DIR = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">sys.path.append(os.path.join(BASE_DIR, <span class="string">&#x27;..&#x27;</span>))</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> torch.optim <span class="keyword">as</span> optim</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> DataLoader</span><br><span class="line"><span class="keyword">from</span> datasets.camvid_dataset <span class="keyword">import</span> CamvidDataset</span><br><span class="line"><span class="keyword">from</span> tools.model_trainer <span class="keyword">import</span> ModelTrainer</span><br><span class="line"><span class="keyword">from</span> tools.common_tools <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> config.camvid_config <span class="keyword">import</span> cfg</span><br><span class="line"><span class="keyword">from</span> models.segnet <span class="keyword">import</span> SegNet, SegResNet</span><br><span class="line"><span class="keyword">from</span> models.unet <span class="keyword">import</span> UNet, UNetResnet</span><br><span class="line"><span class="keyword">from</span> models.deeplabv3_plus <span class="keyword">import</span> DeepLabV3Plus</span><br><span class="line"><span class="keyword">from</span> tools.evalution_segmentaion <span class="keyword">import</span> calc_semantic_segmentation_iou</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">setup_seed(<span class="number">12345</span>)  <span class="comment"># å…ˆå›ºå®šéšæœºç§å­</span></span><br><span class="line"></span><br><span class="line">parser = argparse.ArgumentParser(description=<span class="string">&#x27;Training&#x27;</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;--lr&#x27;</span>, default=<span class="literal">None</span>, <span class="built_in">help</span>=<span class="string">&#x27;learning rate&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">float</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;--max_epoch&#x27;</span>, default=<span class="literal">None</span>, <span class="built_in">type</span>=<span class="built_in">int</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;--train_bs&#x27;</span>, default=<span class="number">0</span>, <span class="built_in">type</span>=<span class="built_in">int</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;--data_root_dir&#x27;</span>, default= <span class="string">r&quot;/Users/kenton/Downloads/deeplearning_dataset/camvid_from_paper&quot;</span>,</span><br><span class="line">                    <span class="built_in">help</span>=<span class="string">&quot;path to your dataset&quot;</span>)</span><br><span class="line">args = parser.parse_args()</span><br><span class="line">cfg.lr_init = args.lr <span class="keyword">if</span> args.lr <span class="keyword">else</span> cfg.lr_init</span><br><span class="line">cfg.train_bs = args.train_bs <span class="keyword">if</span> args.train_bs <span class="keyword">else</span> cfg.train_bs</span><br><span class="line">cfg.max_epoch = args.max_epoch <span class="keyword">if</span> args.max_epoch <span class="keyword">else</span> cfg.max_epoch</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># step0: setting path</span></span><br><span class="line">    <span class="comment"># path_model_101 = &#x27;/Users/kenton/Downloads/deeplearning_dataset/pretrain_model/resnet101s-03a0f310.pth&#x27;  # deeplab</span></span><br><span class="line">    <span class="comment"># path_model_50 = &#x27;/Users/kenton/Downloads/deeplearning_dataset/pretrain_model/resnet50s-a75c83cf.pth&#x27;  # unet</span></span><br><span class="line">    <span class="comment"># path_model_vgg = &#x27;/Users/kenton/Downloads/deeplearning_dataset/pretrain_model/vgg16_bn-6c64b313.pth&#x27;</span></span><br><span class="line">    <span class="comment"># path_model_50s = &#x27;/Users/kenton/Downloads/deeplearning_dataset/pretrain_model/resnet50s-a75c83cf.pth&#x27;</span></span><br><span class="line">    res_dir = os.path.join(BASE_DIR, <span class="string">&quot;..&quot;</span>, <span class="string">&quot;..&quot;</span>, <span class="string">&quot;results&quot;</span>)</span><br><span class="line">    logger, log_dir = make_logger(res_dir)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ------------------------------------ step 1/4 : åŠ è½½æ•°æ®------------------------------------</span></span><br><span class="line">    <span class="comment"># æ„å»ºDatasetå®ä¾‹</span></span><br><span class="line">    root_dir = args.data_root_dir</span><br><span class="line">    train_img_dir = os.path.join(root_dir, <span class="string">&#x27;train&#x27;</span>)</span><br><span class="line">    train_lable_dir = os.path.join(root_dir, <span class="string">&#x27;train_labels&#x27;</span>)</span><br><span class="line">    valid_img_dir = os.path.join(root_dir, <span class="string">&#x27;val&#x27;</span>)</span><br><span class="line">    valid_label_dir = os.path.join(root_dir, <span class="string">&#x27;val_labels&#x27;</span>)</span><br><span class="line">    path_to_dict = os.path.join(root_dir, <span class="string">&#x27;class_dict.csv&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    check_data_dir(train_img_dir)</span><br><span class="line">    check_data_dir(train_lable_dir)</span><br><span class="line">    check_data_dir(valid_img_dir)</span><br><span class="line">    check_data_dir(valid_label_dir)</span><br><span class="line"></span><br><span class="line">    train_data = CamvidDataset(train_img_dir, train_lable_dir, path_to_dict, cfg.crop_size)</span><br><span class="line">    valid_data = CamvidDataset(valid_img_dir, valid_label_dir, path_to_dict, cfg.crop_size)</span><br><span class="line">    train_loader = DataLoader(train_data, batch_size=cfg.train_bs, shuffle=<span class="literal">True</span>, num_workers=cfg.workers)</span><br><span class="line">    valid_loader = DataLoader(valid_data, batch_size=cfg.valid_bs, num_workers=cfg.workers)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ------------------------------------ step 2/4 : å®šä¹‰ç½‘ç»œ------------------------------------</span></span><br><span class="line">    <span class="comment"># model = DeepLabV3Plus(num_classes=train_data.cls_num, path_model=path_model_101)</span></span><br><span class="line">    <span class="comment"># model = UNet(num_classes=train_data.cls_num)</span></span><br><span class="line">    <span class="comment"># model = UNetResnet(num_classes=train_data.cls_num, backbone=&#x27;resnet50&#x27;, path_model=path_model_50)</span></span><br><span class="line">    model = SegResNet(num_classes=train_data.cls_num)</span><br><span class="line">    model.to(cfg.device)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ------------------------------------ step 3/4 : å®šä¹‰æŸå¤±å‡½æ•°å’Œä¼˜åŒ–å™¨ ------------------------------------</span></span><br><span class="line">    loss_f = nn.CrossEntropyLoss().to(cfg.device)</span><br><span class="line">    optimizer = optim.SGD(model.parameters(), lr=cfg.lr_init, momentum=cfg.momentum, weight_decay=cfg.weight_decay)</span><br><span class="line">    scheduler = optim.lr_scheduler.MultiStepLR(optimizer, gamma=cfg.factor, milestones=cfg.milestones)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ------------------------------------ step 4/4 : è®­ç»ƒ --------------------------------------------------</span></span><br><span class="line">    <span class="comment"># è®°å½•è®­ç»ƒé…ç½®ä¿¡æ¯</span></span><br><span class="line">    logger.info(<span class="string">&quot;cfg:\n&#123;&#125;\n loss_f:\n&#123;&#125;\n scheduler:\n&#123;&#125;\n optimizer:\n&#123;&#125;\n model name:\n&#123;&#125;\nmodel:\n&#123;&#125;&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">        cfg, loss_f, scheduler, optimizer, model._get_name(), model))</span><br><span class="line"></span><br><span class="line">    loss_rec = &#123;<span class="string">&quot;train&quot;</span>: [], <span class="string">&quot;valid&quot;</span>: []&#125;</span><br><span class="line">    acc_rec = &#123;<span class="string">&quot;train&quot;</span>: [], <span class="string">&quot;valid&quot;</span>: []&#125;</span><br><span class="line">    miou_rec = &#123;<span class="string">&quot;train&quot;</span>: [], <span class="string">&quot;valid&quot;</span>: []&#125;</span><br><span class="line">    best_miou, best_epoch = <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">    grad_lst_epoch = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(cfg.max_epoch):</span><br><span class="line"></span><br><span class="line">        loss_train, acc_train, mat_train, miou_train, grad_lst = ModelTrainer.train(</span><br><span class="line">            train_loader, model, loss_f, cfg, optimizer, epoch, logger)</span><br><span class="line">        loss_valid, acc_valid, mat_valid, miou_valid = ModelTrainer.valid(</span><br><span class="line">            valid_loader, model, loss_f, cfg)</span><br><span class="line">        grad_lst_epoch.extend(grad_lst)</span><br><span class="line">        scheduler.step()</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">&quot;Epoch[&#123;:0&gt;3&#125;/&#123;:0&gt;3&#125;] Train Acc: &#123;:.2%&#125; Valid Acc:&#123;:.2%&#125;\n&quot;</span></span><br><span class="line">                    <span class="string">&quot;Train loss:&#123;:.4f&#125; Train miou:&#123;:.4f&#125;\n&quot;</span></span><br><span class="line">                    <span class="string">&quot;Valid loss:&#123;:.4f&#125; Valid miou:&#123;:.4f&#125;\n&quot;</span></span><br><span class="line">                    <span class="string">&quot;LR:&#123;&#125;&quot;</span>. <span class="built_in">format</span>(epoch, cfg.max_epoch, acc_train, acc_valid, loss_train, miou_train,</span><br><span class="line">                                    loss_valid, miou_valid, optimizer.param_groups[<span class="number">0</span>][<span class="string">&quot;lr&quot;</span>]))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è®°å½•è®­ç»ƒä¿¡æ¯</span></span><br><span class="line">        loss_rec[<span class="string">&quot;train&quot;</span>].append(loss_train), loss_rec[<span class="string">&quot;valid&quot;</span>].append(loss_valid)</span><br><span class="line">        acc_rec[<span class="string">&quot;train&quot;</span>].append(acc_train), acc_rec[<span class="string">&quot;valid&quot;</span>].append(acc_valid)</span><br><span class="line">        miou_rec[<span class="string">&quot;train&quot;</span>].append(miou_train), miou_rec[<span class="string">&quot;valid&quot;</span>].append(miou_valid)</span><br><span class="line">        <span class="comment"># ä¿å­˜æ··æ·†çŸ©é˜µå›¾</span></span><br><span class="line">        show_confMat(mat_train, train_data.names, <span class="string">&quot;train&quot;</span>, log_dir, epoch=epoch,</span><br><span class="line">                     verbose=epoch == cfg.max_epoch - <span class="number">1</span>, perc=<span class="literal">True</span>)</span><br><span class="line">        show_confMat(mat_valid, valid_data.names, <span class="string">&quot;valid&quot;</span>, log_dir, epoch=epoch,</span><br><span class="line">                     verbose=epoch == cfg.max_epoch - <span class="number">1</span>, perc=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># ä¿å­˜lossæ›²çº¿ï¼Œ accæ›²çº¿ï¼Œ miouæ›²çº¿</span></span><br><span class="line">        plt_x = np.arange(<span class="number">1</span>, epoch + <span class="number">2</span>)</span><br><span class="line">        plot_line(plt_x, loss_rec[<span class="string">&quot;train&quot;</span>], plt_x, loss_rec[<span class="string">&quot;valid&quot;</span>], mode=<span class="string">&quot;loss&quot;</span>, out_dir=log_dir)</span><br><span class="line">        plot_line(plt_x, acc_rec[<span class="string">&quot;train&quot;</span>], plt_x, acc_rec[<span class="string">&quot;valid&quot;</span>], mode=<span class="string">&quot;acc&quot;</span>, out_dir=log_dir)</span><br><span class="line">        plot_line(plt_x, miou_rec[<span class="string">&quot;train&quot;</span>], plt_x, miou_rec[<span class="string">&quot;valid&quot;</span>], mode=<span class="string">&quot;miou&quot;</span>, out_dir=log_dir)</span><br><span class="line">        <span class="comment"># ä¿å­˜æ¨¡å‹</span></span><br><span class="line">        <span class="keyword">if</span> best_miou &lt; miou_valid <span class="keyword">or</span> epoch == cfg.max_epoch-<span class="number">1</span>:</span><br><span class="line"></span><br><span class="line">            best_epoch = epoch <span class="keyword">if</span> best_miou &lt; miou_valid <span class="keyword">else</span> best_epoch</span><br><span class="line">            best_miou = miou_valid <span class="keyword">if</span> best_miou &lt; miou_valid <span class="keyword">else</span> best_miou</span><br><span class="line">            checkpoint = &#123;<span class="string">&quot;model_state_dict&quot;</span>: model.state_dict(),</span><br><span class="line">                          <span class="string">&quot;optimizer_state_dict&quot;</span>: optimizer.state_dict(),</span><br><span class="line">                          <span class="string">&quot;epoch&quot;</span>: epoch,</span><br><span class="line">                          <span class="string">&quot;best_miou&quot;</span>: best_miou&#125;</span><br><span class="line">            pkl_name = <span class="string">&quot;checkpoint_&#123;&#125;.pkl&quot;</span>.<span class="built_in">format</span>(epoch) <span class="keyword">if</span> epoch == cfg.max_epoch-<span class="number">1</span> <span class="keyword">else</span> <span class="string">&quot;checkpoint_best.pkl&quot;</span></span><br><span class="line">            path_checkpoint = os.path.join(log_dir, pkl_name)</span><br><span class="line">            torch.save(checkpoint, path_checkpoint)</span><br><span class="line">            <span class="comment"># è§‚å¯Ÿå„ç±»åˆ«çš„iouï¼š</span></span><br><span class="line">            iou_array = calc_semantic_segmentation_iou(mat_valid)</span><br><span class="line">            info = [<span class="string">&quot;&#123;&#125;_iou:&#123;:.2f&#125;&quot;</span>.<span class="built_in">format</span>(n, iou) <span class="keyword">for</span> n, iou <span class="keyword">in</span> <span class="built_in">zip</span>(train_data.names, iou_array)]</span><br><span class="line">            logger.info(<span class="string">&quot;Best mIoU in &#123;&#125;. &#123;&#125;&quot;</span>.<span class="built_in">format</span>(epoch, <span class="string">&quot;\n&quot;</span>.join(info)))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ¢¯åº¦å‰ªè£çš„å›¾ æ˜¾ç¤º æœ€å¤§çš„æ¢¯åº¦</span></span><br><span class="line">        <span class="keyword">if</span> cfg.hist_grad:</span><br><span class="line">            path_grad_png = os.path.join(log_dir, <span class="string">&quot;grad_hist.png&quot;</span>)</span><br><span class="line">            logger.info(<span class="string">&quot;max grad in &#123;&#125;, is &#123;&#125;&quot;</span>.<span class="built_in">format</span>(grad_lst_epoch.index(<span class="built_in">max</span>(grad_lst_epoch)), <span class="built_in">max</span>(grad_lst_epoch)))</span><br><span class="line">            <span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">            plt.hist(grad_lst_epoch)</span><br><span class="line">            plt.close()</span><br><span class="line">            plt.savefig(path_grad_png)</span><br><span class="line">            logger.info(grad_lst_epoch)</span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">&quot;&#123;&#125; done, best_miou: &#123;:.4f&#125; in :&#123;&#125;&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">        datetime.strftime(datetime.now(), <span class="string">&#x27;%m-%d_%H-%M&#x27;</span>), best_miou, best_epoch))</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="datasets-x2F-camvid-dataset-py"><a href="#datasets-x2F-camvid-dataset-py" class="headerlink" title="datasets&#x2F;camvid_dataset.py"></a>datasets&#x2F;camvid_dataset.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"># @file name  : camvid_dataset.py</span></span><br><span class="line"><span class="string"># @author     : zz0320</span></span><br><span class="line"><span class="string"># @date       : 2022-03-12</span></span><br><span class="line"><span class="string"># @brief      : CamVidæ•°æ®é›†çš„Datasetå®šä¹‰</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> Dataset</span><br><span class="line"><span class="keyword">import</span> torchvision.transforms.functional <span class="keyword">as</span> ff</span><br><span class="line"><span class="keyword">import</span> torchvision.transforms <span class="keyword">as</span> transforms</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> DataLoader</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LabelProcessor</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å¯¹æ ‡ç­¾å›¾åƒçš„ç¼–ç &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, file_path</span>):</span><br><span class="line">        self.colormap = self.read_color_map(file_path)  <span class="comment"># è¯»å–csvï¼Œè·å¾—labelå¯¹åº”çš„rgbå€¼, csv --&gt; rgb</span></span><br><span class="line">        self.cm2lbl = self.encode_label_pix(self.colormap)  <span class="comment"># å¯¹labelçš„rgbå€¼åˆ¶ä½œæ˜ å°„çŸ©é˜µï¼Œrgb --&gt; cls index</span></span><br><span class="line">        self.names = pd.read_csv(file_path, sep=<span class="string">&#x27;,&#x27;</span>).name.tolist()</span><br><span class="line">    <span class="comment"># é™æ€æ–¹æ³•è£…é¥°å™¨ï¼Œ å¯ä»¥ç†è§£ä¸ºå®šä¹‰åœ¨ç±»ä¸­çš„æ™®é€šå‡½æ•°ï¼Œå¯ä»¥ç”¨self.&lt;name&gt;æ–¹å¼è°ƒç”¨</span></span><br><span class="line">    <span class="comment"># åœ¨é™æ€æ–¹æ³•å†…éƒ¨ä¸å¯ä»¥ç¤ºä¾‹å±æ€§å’Œå®åˆ—å¯¹è±¡ï¼Œå³ä¸å¯ä»¥è°ƒç”¨self.ç›¸å…³çš„å†…å®¹</span></span><br><span class="line">    <span class="comment"># ä½¿ç”¨é™æ€æ–¹æ³•çš„åŸå› ä¹‹ä¸€æ˜¯ç¨‹åºè®¾è®¡çš„éœ€è¦ï¼ˆç®€æ´ä»£ç ï¼Œå°è£…åŠŸèƒ½ç­‰ï¼‰</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">read_color_map</span>(<span class="params">file_path</span>):  <span class="comment"># data process and load.ipynb: å¤„ç†æ ‡ç­¾æ–‡ä»¶ä¸­colormapçš„æ•°æ®</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        è¯»å–csvä¸­ä¿¡æ¯ï¼Œè·å¾—å„ç±»åˆ«æ ‡ç­¾çš„rgbåƒç´ ï¼Œä»¥listå½¢å¼è¿”å›</span></span><br><span class="line"><span class="string">        :param file_path:</span></span><br><span class="line"><span class="string">        :return: listï¼Œ list[0] == [128, 128, 128] ...</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        pd_label_color = pd.read_csv(file_path, sep=<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">        colormap = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(pd_label_color.index)):</span><br><span class="line">            tmp = pd_label_color.iloc[i]</span><br><span class="line">            color = [tmp[<span class="string">&#x27;r&#x27;</span>], tmp[<span class="string">&#x27;g&#x27;</span>], tmp[<span class="string">&#x27;b&#x27;</span>]]</span><br><span class="line">            colormap.append(color)</span><br><span class="line">        <span class="keyword">return</span> colormap</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">encode_label_pix</span>(<span class="params">colormap</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        ç”Ÿæˆæ ‡ç­¾ç¼–ç ï¼Œè¿”å›å“ˆå¸Œè¡¨</span></span><br><span class="line"><span class="string">        keyæ˜¯åƒç´ å€¼çš„ç¼–ç ï¼Œç¼–ç å…¬å¼ï¼š(cm[0] * 256 + cm[1]) * 256 + cm[2]</span></span><br><span class="line"><span class="string">        valueæ˜¯ç±»åˆ«ï¼Œ0,1,2,3,...,11</span></span><br><span class="line"><span class="string">        :param colormap:</span></span><br><span class="line"><span class="string">        :return: ndarray, shape =  (16777216,)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        cm2lbl = np.zeros(<span class="number">256</span> ** <span class="number">3</span>)</span><br><span class="line">        <span class="keyword">for</span> i, cm <span class="keyword">in</span> <span class="built_in">enumerate</span>(colormap):</span><br><span class="line">            cm2lbl[(cm[<span class="number">0</span>] * <span class="number">256</span> + cm[<span class="number">1</span>]) * <span class="number">256</span> + cm[<span class="number">2</span>]] = i</span><br><span class="line">        <span class="keyword">return</span> cm2lbl</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">encode_label_img</span>(<span class="params">self, img</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        å°†rgbåƒç´ è½¬æ¢ä¸º 0-11 çš„æ ‡ç­¾å½¢å¼</span></span><br><span class="line"><span class="string">        :param img:</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        data = np.array(img, dtype=<span class="string">&#x27;int32&#x27;</span>)</span><br><span class="line">        idx = (data[:, :, <span class="number">0</span>] * <span class="number">256</span> + data[:, :, <span class="number">1</span>]) * <span class="number">256</span> + data[:, :, <span class="number">2</span>]</span><br><span class="line">        <span class="keyword">return</span> np.array(self.cm2lbl[idx], dtype=<span class="string">&#x27;int64&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CamvidDataset</span>(<span class="title class_ inherited__">Dataset</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, dir_img, dir_l, path_csv, crop_size=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;para:</span></span><br><span class="line"><span class="string">            file_path(list): æ•°æ®å’Œæ ‡ç­¾è·¯å¾„,åˆ—è¡¨å…ƒç´ ç¬¬ä¸€ä¸ªä¸ºå›¾ç‰‡è·¯å¾„ï¼Œç¬¬äºŒä¸ªä¸ºæ ‡ç­¾è·¯å¾„</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.img_path = dir_img</span><br><span class="line">        self.label_path = dir_l</span><br><span class="line">        <span class="comment"># 2 ä»è·¯å¾„ä¸­å–å‡ºå›¾ç‰‡å’Œæ ‡ç­¾æ•°æ®çš„æ–‡ä»¶åä¿æŒåˆ°ä¸¤ä¸ªåˆ—è¡¨å½“ä¸­ï¼ˆç¨‹åºä¸­çš„æ•°æ®æ¥æºï¼‰</span></span><br><span class="line">        self.imgs = self.read_file(self.img_path)</span><br><span class="line">        self.labels = self.read_file(self.label_path)</span><br><span class="line">        <span class="comment"># 3 åˆå§‹åŒ–æ•°æ®å¤„ç†å‡½æ•°è®¾ç½®</span></span><br><span class="line">        self.crop_size = crop_size</span><br><span class="line">        <span class="comment"># åˆå§‹åŒ–æ ‡ç­¾å¤„ç†å™¨</span></span><br><span class="line">        self.label_processor = LabelProcessor(path_csv)</span><br><span class="line">        self.names = pd.read_csv(path_csv, sep=<span class="string">&#x27;,&#x27;</span>).name.tolist()</span><br><span class="line">        self.cls_num = <span class="built_in">len</span>(self.names)</span><br><span class="line">        <span class="comment"># ç»Ÿè®¡ç±»åˆ«æ•°é‡</span></span><br><span class="line">        self.nums_per_cls = self.cal_cls_nums()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, index</span>):</span><br><span class="line">        img = self.imgs[index]</span><br><span class="line">        label = self.labels[index]</span><br><span class="line"></span><br><span class="line">        img = Image.<span class="built_in">open</span>(img)</span><br><span class="line">        label = Image.<span class="built_in">open</span>(label).convert(<span class="string">&#x27;RGB&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        img, label = self.center_crop(img, label, self.crop_size)</span><br><span class="line">        img, label = self.img_transform(img, label)</span><br><span class="line">        <span class="keyword">return</span> img, label</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(self.imgs) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">&quot;\ndata_dir:&#123;&#125; is a empty dir! Please checkout your path to images!&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">                self.dir_img))   <span class="comment"># ä»£ç å…·æœ‰å‹å¥½çš„æç¤ºåŠŸèƒ½ï¼Œä¾¿äºdebug</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(self.imgs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">read_file</span>(<span class="params">self, path</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;ä»æ–‡ä»¶å¤¹ä¸­è¯»å–æ•°æ®&quot;&quot;&quot;</span></span><br><span class="line">        files_list = os.listdir(path)</span><br><span class="line">        file_path_list = [os.path.join(path, img) <span class="keyword">for</span> img <span class="keyword">in</span> files_list]</span><br><span class="line">        file_path_list.sort()</span><br><span class="line">        <span class="keyword">return</span> file_path_list</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">center_crop</span>(<span class="params">self, data, label, crop_size</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è£å‰ªè¾“å…¥çš„å›¾ç‰‡å’Œæ ‡ç­¾å¤§å°&quot;&quot;&quot;</span></span><br><span class="line">        data = ff.center_crop(data, crop_size)</span><br><span class="line">        label = ff.center_crop(label, crop_size)</span><br><span class="line">        <span class="keyword">return</span> data, label</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">img_transform</span>(<span class="params">self, img, label</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å¯¹å›¾ç‰‡å’Œæ ‡ç­¾åšä¸€äº›æ•°å€¼å¤„ç†&quot;&quot;&quot;</span></span><br><span class="line">        label = np.array(label)  <span class="comment"># ä»¥é˜²ä¸æ˜¯npæ ¼å¼çš„æ•°æ®</span></span><br><span class="line">        label = Image.fromarray(label.astype(<span class="string">&#x27;uint8&#x27;</span>))</span><br><span class="line">        transform_img = transforms.Compose(</span><br><span class="line">            [</span><br><span class="line">                transforms.ToTensor(),</span><br><span class="line">                transforms.Normalize([<span class="number">0.485</span>, <span class="number">0.456</span>, <span class="number">0.406</span>], [<span class="number">0.229</span>, <span class="number">0.224</span>, <span class="number">0.225</span>])</span><br><span class="line">            ]</span><br><span class="line">        )</span><br><span class="line">        img = transform_img(img)</span><br><span class="line">        label = self.label_processor.encode_label_img(label)  <span class="comment"># RGB np.array --&gt;   label index</span></span><br><span class="line">        label = torch.from_numpy(label)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> img, label</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">cal_cls_nums</span>(<span class="params">self</span>):</span><br><span class="line">        counter = np.zeros((<span class="number">12</span>,))</span><br><span class="line">        <span class="keyword">for</span> path <span class="keyword">in</span> self.labels:</span><br><span class="line">            label_img = Image.<span class="built_in">open</span>(path).convert(<span class="string">&#x27;RGB&#x27;</span>)</span><br><span class="line">            label = self.label_processor.encode_label_img(label_img).flatten()</span><br><span class="line">            count = np.bincount(label, minlength=<span class="number">12</span>)</span><br><span class="line">            counter += count</span><br><span class="line">        <span class="keyword">return</span> counter.tolist()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line"></span><br><span class="line">    camvid_dir = <span class="string">r&quot;G:\deep_learning_data\camvid_from_paper&quot;</span></span><br><span class="line">    path_to_dict = os.path.join(camvid_dir, <span class="string">&#x27;class_dict.csv&#x27;</span>)</span><br><span class="line">    TRAIN_ROOT = os.path.join(camvid_dir, <span class="string">&#x27;train&#x27;</span>)</span><br><span class="line">    TRAIN_LABEL = os.path.join(camvid_dir, <span class="string">&#x27;train_labels&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    crop_size = (<span class="number">360</span>, <span class="number">480</span>)</span><br><span class="line">    train_data = CamvidDataset(TRAIN_ROOT, TRAIN_LABEL, path_to_dict, crop_size)</span><br><span class="line">    train_loader = DataLoader(train_data, batch_size=<span class="number">1</span>, shuffle=<span class="literal">True</span>, num_workers=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, data <span class="keyword">in</span> <span class="built_in">enumerate</span>(train_loader):</span><br><span class="line">        img_data, img_label = data</span><br><span class="line">        <span class="built_in">print</span>(img_data.shape, img_data.dtype, <span class="built_in">type</span>(img_data))       <span class="comment"># torch.float32</span></span><br><span class="line">        <span class="built_in">print</span>(img_label.shape, img_label.dtype, <span class="built_in">type</span>(img_label))     <span class="comment"># torch.longint(int64)</span></span><br></pre></td></tr></table></figure><h3 id="src-x2F-camvid-train-py-1"><a href="#src-x2F-camvid-train-py-1" class="headerlink" title="src&#x2F;camvid_train.py"></a>src&#x2F;camvid_train.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"># @file name  : camvid_train.py</span></span><br><span class="line"><span class="string"># @author     : zz0320</span></span><br><span class="line"><span class="string"># @date       : 2022-03-12</span></span><br><span class="line"><span class="string"># @brief      : æ¨¡å‹è®­ç»ƒä¸»ä»£ç </span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> matplotlib</span><br><span class="line"><span class="comment"># matplotlib.use(&#x27;agg&#x27;)</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">BASE_DIR = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">sys.path.append(os.path.join(BASE_DIR, <span class="string">&#x27;..&#x27;</span>))</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> torch.optim <span class="keyword">as</span> optim</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> DataLoader</span><br><span class="line"><span class="keyword">from</span> datasets.camvid_dataset <span class="keyword">import</span> CamvidDataset</span><br><span class="line"><span class="keyword">from</span> tools.model_trainer <span class="keyword">import</span> ModelTrainer</span><br><span class="line"><span class="keyword">from</span> tools.common_tools <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> config.camvid_config <span class="keyword">import</span> cfg</span><br><span class="line"><span class="keyword">from</span> models.unet <span class="keyword">import</span> UNet, UNetResnet</span><br><span class="line"><span class="keyword">from</span> models.deeplabv3_plus <span class="keyword">import</span> DeepLabV3Plus</span><br><span class="line"><span class="keyword">from</span> tools.evalution_segmentaion <span class="keyword">import</span> calc_semantic_segmentation_iou</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">setup_seed(<span class="number">12345</span>)  <span class="comment"># å…ˆå›ºå®šéšæœºç§å­</span></span><br><span class="line"></span><br><span class="line">parser = argparse.ArgumentParser(description=<span class="string">&#x27;Training&#x27;</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;--lr&#x27;</span>, default=<span class="literal">None</span>, <span class="built_in">help</span>=<span class="string">&#x27;learning rate&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">float</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;--max_epoch&#x27;</span>, default=<span class="literal">None</span>, <span class="built_in">type</span>=<span class="built_in">int</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;--train_bs&#x27;</span>, default=<span class="number">0</span>, <span class="built_in">type</span>=<span class="built_in">int</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;--data_root_dir&#x27;</span>, default=<span class="string">r&quot;G:\deep_learning_data\camvid_from_paper&quot;</span>,</span><br><span class="line">                    <span class="built_in">help</span>=<span class="string">&quot;path to your dataset&quot;</span>)</span><br><span class="line">args = parser.parse_args()</span><br><span class="line">cfg.lr_init = args.lr <span class="keyword">if</span> args.lr <span class="keyword">else</span> cfg.lr_init</span><br><span class="line">cfg.train_bs = args.train_bs <span class="keyword">if</span> args.train_bs <span class="keyword">else</span> cfg.train_bs</span><br><span class="line">cfg.max_epoch = args.max_epoch <span class="keyword">if</span> args.max_epoch <span class="keyword">else</span> cfg.max_epoch</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># step0: setting path</span></span><br><span class="line">    path_model_101 = os.path.join(BASE_DIR, <span class="string">&quot;..&quot;</span>, <span class="string">&quot;..&quot;</span>, <span class="string">&quot;data&quot;</span>, <span class="string">&quot;pretrained_model&quot;</span>, <span class="string">&quot;resnet101s-03a0f310.pth&quot;</span>)  <span class="comment"># deeplab</span></span><br><span class="line">    path_model_50 = os.path.join(BASE_DIR, <span class="string">&quot;..&quot;</span>, <span class="string">&quot;..&quot;</span>, <span class="string">&quot;data&quot;</span>, <span class="string">&quot;pretrained_model&quot;</span>, <span class="string">&quot;resnet50s-a75c83cf.pth&quot;</span>)  <span class="comment"># unet</span></span><br><span class="line">    path_model_vgg = os.path.join(BASE_DIR, <span class="string">&quot;..&quot;</span>, <span class="string">&quot;..&quot;</span>, <span class="string">&quot;data&quot;</span>, <span class="string">&quot;pretrained_model&quot;</span>, <span class="string">&quot;vgg16_bn-6c64b313.pth&quot;</span>)</span><br><span class="line">    res_dir = os.path.join(BASE_DIR, <span class="string">&quot;..&quot;</span>, <span class="string">&quot;..&quot;</span>, <span class="string">&quot;results&quot;</span>)</span><br><span class="line">    logger, log_dir = make_logger(res_dir)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ------------------------------------ step 1/4 : åŠ è½½æ•°æ®------------------------------------</span></span><br><span class="line">    <span class="comment"># æ„å»ºDatasetå®ä¾‹</span></span><br><span class="line">    root_dir = args.data_root_dir</span><br><span class="line">    train_img_dir = os.path.join(root_dir, <span class="string">&#x27;train&#x27;</span>)</span><br><span class="line">    train_lable_dir = os.path.join(root_dir, <span class="string">&#x27;train_labels&#x27;</span>)</span><br><span class="line">    valid_img_dir = os.path.join(root_dir, <span class="string">&#x27;val&#x27;</span>)</span><br><span class="line">    valid_label_dir = os.path.join(root_dir, <span class="string">&#x27;val_labels&#x27;</span>)</span><br><span class="line">    path_to_dict = os.path.join(root_dir, <span class="string">&#x27;class_dict.csv&#x27;</span>)</span><br><span class="line">    check_data_dir(train_img_dir)</span><br><span class="line">    check_data_dir(train_lable_dir)</span><br><span class="line">    check_data_dir(valid_img_dir)</span><br><span class="line">    check_data_dir(valid_label_dir)</span><br><span class="line"></span><br><span class="line">    train_data = CamvidDataset(train_img_dir, train_lable_dir, path_to_dict, cfg.crop_size)</span><br><span class="line">    valid_data = CamvidDataset(valid_img_dir, valid_label_dir, path_to_dict, cfg.crop_size)</span><br><span class="line">    train_loader = DataLoader(train_data, batch_size=cfg.train_bs, shuffle=<span class="literal">True</span>, num_workers=cfg.workers)</span><br><span class="line">    valid_loader = DataLoader(valid_data, batch_size=cfg.valid_bs, num_workers=cfg.workers)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ------------------------------------ step 2/4 : å®šä¹‰ç½‘ç»œ------------------------------------</span></span><br><span class="line">    model = DeepLabV3Plus(num_classes=train_data.cls_num, path_model=path_model_101)</span><br><span class="line">    <span class="comment"># model = UNet(num_classes=train_data.cls_num)</span></span><br><span class="line">    <span class="comment"># model = UNetResnet(num_classes=train_data.cls_num, backbone=&#x27;resnet50&#x27;, path_model=path_model_50)</span></span><br><span class="line">    model.to(cfg.device)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ------------------------------------ step 3/4 : å®šä¹‰æŸå¤±å‡½æ•°å’Œä¼˜åŒ–å™¨ ------------------------------------</span></span><br><span class="line">    loss_f = nn.CrossEntropyLoss().to(cfg.device)</span><br><span class="line">    optimizer = optim.SGD(model.parameters(), lr=cfg.lr_init, momentum=cfg.momentum, weight_decay=cfg.weight_decay)</span><br><span class="line">    scheduler = optim.lr_scheduler.MultiStepLR(optimizer, gamma=cfg.factor, milestones=cfg.milestones)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ------------------------------------ step 4/4 : è®­ç»ƒ --------------------------------------------------</span></span><br><span class="line">    <span class="comment"># è®°å½•è®­ç»ƒé…ç½®ä¿¡æ¯</span></span><br><span class="line">    logger.info(<span class="string">&quot;cfg:\n&#123;&#125;\n loss_f:\n&#123;&#125;\n scheduler:\n&#123;&#125;\n optimizer:\n&#123;&#125;\n model name:\n&#123;&#125;\nmodel:\n&#123;&#125;&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">        cfg, loss_f, scheduler, optimizer, model._get_name(), model))</span><br><span class="line"></span><br><span class="line">    loss_rec = &#123;<span class="string">&quot;train&quot;</span>: [], <span class="string">&quot;valid&quot;</span>: []&#125;</span><br><span class="line">    acc_rec = &#123;<span class="string">&quot;train&quot;</span>: [], <span class="string">&quot;valid&quot;</span>: []&#125;</span><br><span class="line">    miou_rec = &#123;<span class="string">&quot;train&quot;</span>: [], <span class="string">&quot;valid&quot;</span>: []&#125;</span><br><span class="line">    best_miou, best_epoch = <span class="number">0</span>, <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(cfg.max_epoch):</span><br><span class="line"></span><br><span class="line">        loss_train, acc_train, mat_train, miou_train, grad_lst = ModelTrainer.train(</span><br><span class="line">            train_loader, model, loss_f, cfg, optimizer, epoch, logger)</span><br><span class="line">        loss_valid, acc_valid, mat_valid, miou_valid = ModelTrainer.valid(</span><br><span class="line">            valid_loader, model, loss_f, cfg)</span><br><span class="line"></span><br><span class="line">        scheduler.step()</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">&quot;Epoch[&#123;:0&gt;3&#125;/&#123;:0&gt;3&#125;] Train Acc: &#123;:.2%&#125; Valid Acc:&#123;:.2%&#125;\n&quot;</span></span><br><span class="line">                    <span class="string">&quot;Train loss:&#123;:.4f&#125; Train miou:&#123;:.4f&#125;\n&quot;</span></span><br><span class="line">                    <span class="string">&quot;Valid loss:&#123;:.4f&#125; Valid miou:&#123;:.4f&#125;\n&quot;</span></span><br><span class="line">                    <span class="string">&quot;LR:&#123;&#125;&quot;</span>. <span class="built_in">format</span>(epoch, cfg.max_epoch, acc_train, acc_valid, loss_train, miou_train,</span><br><span class="line">                                    loss_valid, miou_valid, optimizer.param_groups[<span class="number">0</span>][<span class="string">&quot;lr&quot;</span>]))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è®°å½•è®­ç»ƒä¿¡æ¯</span></span><br><span class="line">        loss_rec[<span class="string">&quot;train&quot;</span>].append(loss_train), loss_rec[<span class="string">&quot;valid&quot;</span>].append(loss_valid)</span><br><span class="line">        acc_rec[<span class="string">&quot;train&quot;</span>].append(acc_train), acc_rec[<span class="string">&quot;valid&quot;</span>].append(acc_valid)</span><br><span class="line">        miou_rec[<span class="string">&quot;train&quot;</span>].append(miou_train), miou_rec[<span class="string">&quot;valid&quot;</span>].append(miou_valid)</span><br><span class="line">        <span class="comment"># ä¿å­˜æ··æ·†çŸ©é˜µå›¾</span></span><br><span class="line">        show_confMat(mat_train, train_data.names, <span class="string">&quot;train&quot;</span>, log_dir, epoch=epoch,</span><br><span class="line">                     verbose=epoch == cfg.max_epoch - <span class="number">1</span>, perc=<span class="literal">True</span>)</span><br><span class="line">        show_confMat(mat_valid, valid_data.names, <span class="string">&quot;valid&quot;</span>, log_dir, epoch=epoch,</span><br><span class="line">                     verbose=epoch == cfg.max_epoch - <span class="number">1</span>, perc=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># ä¿å­˜lossæ›²çº¿ï¼Œ accæ›²çº¿ï¼Œ miouæ›²çº¿</span></span><br><span class="line">        plt_x = np.arange(<span class="number">1</span>, epoch + <span class="number">2</span>)</span><br><span class="line">        plot_line(plt_x, loss_rec[<span class="string">&quot;train&quot;</span>], plt_x, loss_rec[<span class="string">&quot;valid&quot;</span>], mode=<span class="string">&quot;loss&quot;</span>, out_dir=log_dir)</span><br><span class="line">        plot_line(plt_x, acc_rec[<span class="string">&quot;train&quot;</span>], plt_x, acc_rec[<span class="string">&quot;valid&quot;</span>], mode=<span class="string">&quot;acc&quot;</span>, out_dir=log_dir)</span><br><span class="line">        plot_line(plt_x, miou_rec[<span class="string">&quot;train&quot;</span>], plt_x, miou_rec[<span class="string">&quot;valid&quot;</span>], mode=<span class="string">&quot;miou&quot;</span>, out_dir=log_dir)</span><br><span class="line">        <span class="comment"># ä¿å­˜æ¨¡å‹</span></span><br><span class="line">        <span class="keyword">if</span> best_miou &lt; miou_valid <span class="keyword">or</span> epoch == cfg.max_epoch-<span class="number">1</span>:</span><br><span class="line"></span><br><span class="line">            best_epoch = epoch <span class="keyword">if</span> best_miou &lt; miou_valid <span class="keyword">else</span> best_epoch</span><br><span class="line">            best_miou = miou_valid <span class="keyword">if</span> best_miou &lt; miou_valid <span class="keyword">else</span> best_miou</span><br><span class="line">            checkpoint = &#123;<span class="string">&quot;model_state_dict&quot;</span>: model.state_dict(),</span><br><span class="line">                          <span class="string">&quot;optimizer_state_dict&quot;</span>: optimizer.state_dict(),</span><br><span class="line">                          <span class="string">&quot;epoch&quot;</span>: epoch,</span><br><span class="line">                          <span class="string">&quot;best_miou&quot;</span>: best_miou&#125;</span><br><span class="line">            pkl_name = <span class="string">&quot;checkpoint_&#123;&#125;.pkl&quot;</span>.<span class="built_in">format</span>(epoch) <span class="keyword">if</span> epoch == cfg.max_epoch-<span class="number">1</span> <span class="keyword">else</span> <span class="string">&quot;checkpoint_best.pkl&quot;</span></span><br><span class="line">            path_checkpoint = os.path.join(log_dir, pkl_name)</span><br><span class="line">            torch.save(checkpoint, path_checkpoint)</span><br><span class="line">            <span class="comment"># è§‚å¯Ÿå„ç±»åˆ«çš„iouï¼š</span></span><br><span class="line">            iou_array = calc_semantic_segmentation_iou(mat_valid)</span><br><span class="line">            info = [<span class="string">&quot;&#123;&#125;_iou:&#123;:.2f&#125;&quot;</span>.<span class="built_in">format</span>(n, iou) <span class="keyword">for</span> n, iou <span class="keyword">in</span> <span class="built_in">zip</span>(train_data.names, iou_array)]</span><br><span class="line">            logger.info(<span class="string">&quot;Best mIoU in &#123;&#125;. &#123;&#125;&quot;</span>.<span class="built_in">format</span>(epoch, <span class="string">&quot;\n&quot;</span>.join(info)))</span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">&quot;&#123;&#125; done, best_miou: &#123;:.4f&#125; in :&#123;&#125;&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">        datetime.strftime(datetime.now(), <span class="string">&#x27;%m-%d_%H-%M&#x27;</span>), best_miou, best_epoch))</span><br></pre></td></tr></table></figure><h3 id="tools-x2F-common-tools-py"><a href="#tools-x2F-common-tools-py" class="headerlink" title="tools&#x2F;common_tools.py"></a>tools&#x2F;common_tools.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"># @file name  : common_tools.py</span></span><br><span class="line"><span class="string"># @author     : zz0320</span></span><br><span class="line"><span class="string"># @date       : 2022-04-16</span></span><br><span class="line"><span class="string"># @brief      : é€šç”¨å‡½æ•°åº“</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">setup_seed</span>(<span class="params">seed=<span class="number">12345</span></span>):</span><br><span class="line">    np.random.seed(seed)</span><br><span class="line">    random.seed(seed)</span><br><span class="line">    torch.manual_seed(seed)     <span class="comment"># cpu</span></span><br><span class="line">    <span class="keyword">if</span> torch.cuda.is_available():</span><br><span class="line">        torch.cuda.manual_seed_all(seed)</span><br><span class="line">        torch.backends.cudnn.deterministic = <span class="literal">True</span></span><br><span class="line">        torch.backends.cudnn.benchmark = <span class="literal">True</span> <span class="comment"># è®­ç»ƒé›†å˜åŒ–ä¸å¤§æ—¶ä½¿è®­ç»ƒåŠ é€Ÿï¼Œæ˜¯å›ºå®šcudnnæœ€ä¼˜é…ç½®ï¼Œå¦‚å·ç§¯ç®—æ³•</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_confMat</span>(<span class="params">confusion_mat, classes, set_name, out_dir, epoch=<span class="number">999</span>, verbose=<span class="literal">False</span>, perc=<span class="literal">False</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    æ··æ·†çŸ©é˜µç»˜åˆ¶å¹¶ä¿å­˜å›¾ç‰‡</span></span><br><span class="line"><span class="string">    :param confusion_mat:  nd.array</span></span><br><span class="line"><span class="string">    :param classes: list or tuple, ç±»åˆ«åç§°</span></span><br><span class="line"><span class="string">    :param set_name: str, æ•°æ®é›†åç§° train or valid or test?</span></span><br><span class="line"><span class="string">    :param out_dir:  str, å›¾ç‰‡è¦ä¿å­˜çš„æ–‡ä»¶å¤¹</span></span><br><span class="line"><span class="string">    :param epoch:  int, ç¬¬å‡ ä¸ªepoch</span></span><br><span class="line"><span class="string">    :param verbose: bool, æ˜¯å¦æ‰“å°ç²¾åº¦ä¿¡æ¯</span></span><br><span class="line"><span class="string">    :param perc: bool, æ˜¯å¦é‡‡ç”¨ç™¾åˆ†æ¯”ï¼Œå›¾åƒåˆ†å‰²æ—¶ç”¨ï¼Œå› åˆ†ç±»æ•°ç›®è¿‡å¤§</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    cls_num = <span class="built_in">len</span>(classes)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å½’ä¸€åŒ–</span></span><br><span class="line">    confusion_mat_tmp = confusion_mat.copy()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(classes)):</span><br><span class="line">        confusion_mat_tmp[i, :] = confusion_mat[i, :] / confusion_mat[i, :].<span class="built_in">sum</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¾ç½®å›¾åƒå¤§å°</span></span><br><span class="line">    <span class="keyword">if</span> cls_num &lt; <span class="number">10</span>:</span><br><span class="line">        figsize = <span class="number">6</span></span><br><span class="line">    <span class="keyword">elif</span> cls_num &gt;= <span class="number">100</span>:</span><br><span class="line">        figsize = <span class="number">30</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        figsize = np.linspace(<span class="number">6</span>, <span class="number">30</span>, <span class="number">91</span>)[cls_num-<span class="number">10</span>]</span><br><span class="line">    plt.figure(figsize=(<span class="built_in">int</span>(figsize), <span class="built_in">int</span>(figsize*<span class="number">1.3</span>)))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è·å–é¢œè‰²</span></span><br><span class="line">    cmap = plt.cm.get_cmap(<span class="string">&#x27;Greys&#x27;</span>)  <span class="comment"># æ›´å¤šé¢œè‰²: http://matplotlib.org/examples/color/colormaps_reference.html</span></span><br><span class="line">    plt.imshow(confusion_mat_tmp, cmap=cmap)</span><br><span class="line">    plt.colorbar(fraction=<span class="number">0.03</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¾ç½®æ–‡å­—</span></span><br><span class="line">    xlocations = np.array(<span class="built_in">range</span>(<span class="built_in">len</span>(classes)))</span><br><span class="line">    plt.xticks(xlocations, <span class="built_in">list</span>(classes), rotation=<span class="number">60</span>)</span><br><span class="line">    plt.yticks(xlocations, <span class="built_in">list</span>(classes))</span><br><span class="line">    plt.xlabel(<span class="string">&#x27;Predict label&#x27;</span>)</span><br><span class="line">    plt.ylabel(<span class="string">&#x27;True label&#x27;</span>)</span><br><span class="line">    plt.title(<span class="string">&quot;Confusion_Matrix_&#123;&#125;_&#123;&#125;&quot;</span>.<span class="built_in">format</span>(set_name, epoch))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ‰“å°æ•°å­—</span></span><br><span class="line">    <span class="keyword">if</span> perc:</span><br><span class="line"></span><br><span class="line">        cls_per_nums = confusion_mat.<span class="built_in">sum</span>(axis=<span class="number">1</span>).reshape((cls_num, <span class="number">1</span>))</span><br><span class="line">        conf_mat_per = confusion_mat / cls_per_nums</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(confusion_mat_tmp.shape[<span class="number">0</span>]):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(confusion_mat_tmp.shape[<span class="number">1</span>]):</span><br><span class="line">                plt.text(x=j, y=i, s=<span class="string">&quot;&#123;:.0%&#125;&quot;</span>.<span class="built_in">format</span>(conf_mat_per[i, j]), va=<span class="string">&#x27;center&#x27;</span>, ha=<span class="string">&#x27;center&#x27;</span>, color=<span class="string">&#x27;red&#x27;</span>,</span><br><span class="line">                         fontsize=<span class="number">10</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(confusion_mat_tmp.shape[<span class="number">0</span>]):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(confusion_mat_tmp.shape[<span class="number">1</span>]):</span><br><span class="line">                plt.text(x=j, y=i, s=<span class="built_in">int</span>(confusion_mat[i, j]), va=<span class="string">&#x27;center&#x27;</span>, ha=<span class="string">&#x27;center&#x27;</span>, color=<span class="string">&#x27;red&#x27;</span>, fontsize=<span class="number">10</span>)</span><br><span class="line">    <span class="comment"># ä¿å­˜</span></span><br><span class="line">    plt.savefig(os.path.join(out_dir, <span class="string">&quot;Confusion_Matrix_&#123;&#125;.png&quot;</span>.<span class="built_in">format</span>(set_name)))</span><br><span class="line">    plt.close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> verbose:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(cls_num):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;class:&#123;:&lt;10&#125;, total num:&#123;:&lt;6&#125;, correct num:&#123;:&lt;5&#125;  Recall: &#123;:.2%&#125; Precision: &#123;:.2%&#125;&#x27;</span>.<span class="built_in">format</span>(</span><br><span class="line">                classes[i], np.<span class="built_in">sum</span>(confusion_mat[i, :]), confusion_mat[i, i],</span><br><span class="line">                confusion_mat[i, i] / (<span class="number">.1</span> + np.<span class="built_in">sum</span>(confusion_mat[i, :])),</span><br><span class="line">                confusion_mat[i, i] / (<span class="number">.1</span> + np.<span class="built_in">sum</span>(confusion_mat[:, i]))))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">plot_line</span>(<span class="params">train_x, train_y, valid_x, valid_y, mode, out_dir</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    ç»˜åˆ¶è®­ç»ƒå’ŒéªŒè¯é›†çš„lossæ›²çº¿/accæ›²çº¿</span></span><br><span class="line"><span class="string">    :param train_x: epoch</span></span><br><span class="line"><span class="string">    :param train_y: æ ‡é‡å€¼</span></span><br><span class="line"><span class="string">    :param valid_x:</span></span><br><span class="line"><span class="string">    :param valid_y:</span></span><br><span class="line"><span class="string">    :param mode:  &#x27;loss&#x27; or &#x27;acc&#x27;</span></span><br><span class="line"><span class="string">    :param out_dir:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    plt.plot(train_x, train_y, label=<span class="string">&#x27;Train&#x27;</span>)</span><br><span class="line">    plt.plot(valid_x, valid_y, label=<span class="string">&#x27;Valid&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    plt.ylabel(<span class="built_in">str</span>(mode))</span><br><span class="line">    plt.xlabel(<span class="string">&#x27;Epoch&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    location = <span class="string">&#x27;upper right&#x27;</span> <span class="keyword">if</span> mode == <span class="string">&#x27;loss&#x27;</span> <span class="keyword">else</span> <span class="string">&#x27;upper left&#x27;</span></span><br><span class="line">    plt.legend(loc=location)</span><br><span class="line"></span><br><span class="line">    plt.title(<span class="string">&#x27;_&#x27;</span>.join([mode]))</span><br><span class="line">    plt.savefig(os.path.join(out_dir, mode + <span class="string">&#x27;.png&#x27;</span>))</span><br><span class="line">    plt.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Logger</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, path_log</span>):</span><br><span class="line">        log_name = os.path.basename(path_log)</span><br><span class="line">        self.log_name = log_name <span class="keyword">if</span> log_name <span class="keyword">else</span> <span class="string">&quot;root&quot;</span></span><br><span class="line">        self.out_path = path_log</span><br><span class="line"></span><br><span class="line">        log_dir = os.path.dirname(self.out_path)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(log_dir):</span><br><span class="line">            os.makedirs(log_dir)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">init_logger</span>(<span class="params">self</span>):</span><br><span class="line">        logger = logging.getLogger(self.log_name)</span><br><span class="line">        logger.setLevel(level=logging.INFO)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># é…ç½®æ–‡ä»¶Handler</span></span><br><span class="line">        file_handler = logging.FileHandler(self.out_path, <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">        file_handler.setLevel(logging.INFO)</span><br><span class="line">        formatter = logging.Formatter(<span class="string">&#x27;%(asctime)s - %(name)s - %(levelname)s - %(message)s&#x27;</span>)</span><br><span class="line">        file_handler.setFormatter(formatter)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># é…ç½®å±å¹•Handler</span></span><br><span class="line">        console_handler = logging.StreamHandler()</span><br><span class="line">        console_handler.setLevel(logging.INFO)</span><br><span class="line">        <span class="comment"># console_handler.setFormatter(logging.Formatter(&#x27;%(asctime)s - %(name)s - %(levelname)s - %(message)s&#x27;))</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ·»åŠ handler</span></span><br><span class="line">        logger.addHandler(file_handler)</span><br><span class="line">        logger.addHandler(console_handler)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> logger</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_logger</span>(<span class="params">out_dir</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    åœ¨out_diræ–‡ä»¶å¤¹ä¸‹ä»¥å½“å‰æ—¶é—´å‘½åï¼Œåˆ›å»ºæ—¥å¿—æ–‡ä»¶å¤¹ï¼Œå¹¶åˆ›å»ºloggerç”¨äºè®°å½•ä¿¡æ¯</span></span><br><span class="line"><span class="string">    :param out_dir: str</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    now_time = datetime.now()</span><br><span class="line">    time_str = datetime.strftime(now_time, <span class="string">&#x27;%m-%d_%H-%M&#x27;</span>)</span><br><span class="line">    log_dir = os.path.join(out_dir, time_str)  <span class="comment"># æ ¹æ®configä¸­çš„åˆ›å»ºæ—¶é—´ä½œä¸ºæ–‡ä»¶å¤¹å</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(log_dir):</span><br><span class="line">        os.makedirs(log_dir)</span><br><span class="line">    <span class="comment"># åˆ›å»ºlogger</span></span><br><span class="line">    path_log = os.path.join(log_dir, <span class="string">&quot;log.log&quot;</span>)</span><br><span class="line">    logger = Logger(path_log)</span><br><span class="line">    logger = logger.init_logger()</span><br><span class="line">    <span class="keyword">return</span> logger, log_dir</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_data_dir</span>(<span class="params">path_tmp</span>):</span><br><span class="line">    <span class="keyword">assert</span> os.path.exists(path_tmp), \</span><br><span class="line">        <span class="string">&quot;\n\nè·¯å¾„ä¸å­˜åœ¨ï¼Œå½“å‰å˜é‡ä¸­æŒ‡å®šçš„è·¯å¾„æ˜¯ï¼š\n&#123;&#125;\nè¯·æ£€æŸ¥ç›¸å¯¹è·¯å¾„çš„è®¾ç½®ï¼Œæˆ–è€…æ–‡ä»¶æ˜¯å¦å­˜åœ¨&quot;</span>.<span class="built_in">format</span>(os.path.abspath(path_tmp))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_logger</span>(<span class="params">BASE_DIR</span>):</span><br><span class="line">    <span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">    now_time = datetime.now()</span><br><span class="line">    time_str = datetime.strftime(now_time, <span class="string">&#x27;%m-%d_%H-%M&#x27;</span>)</span><br><span class="line">    log_dir = os.path.join(BASE_DIR, <span class="string">&quot;..&quot;</span>, <span class="string">&quot;..&quot;</span>, <span class="string">&quot;results&quot;</span>, time_str)  <span class="comment"># æ ¹æ®configä¸­çš„åˆ›å»ºæ—¶é—´ä½œä¸ºæ–‡ä»¶å¤¹å</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(log_dir):</span><br><span class="line">        os.makedirs(log_dir)</span><br><span class="line">    path_log = os.path.join(log_dir, <span class="string">&quot;log.log&quot;</span>)</span><br><span class="line">    logger = Logger(path_log)</span><br><span class="line">    logger = logger.init_logger()</span><br><span class="line">    <span class="keyword">return</span> logger, log_dir</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">adjust_learning_rate</span>(<span class="params">optimizer, epoch, args, multiple</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Sets the learning rate to the initial LR decayed by 0.95 every 20 epochs&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># lr = args.lr * (0.95 ** (epoch // 4))</span></span><br><span class="line">    lr = args.lr * (<span class="number">0.95</span> ** (epoch // <span class="number">20</span>))</span><br><span class="line">    <span class="keyword">for</span> i, param_group <span class="keyword">in</span> <span class="built_in">enumerate</span>(optimizer.param_groups):</span><br><span class="line">        param_group[<span class="string">&#x27;lr&#x27;</span>] = lr * multiple[i]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line"></span><br><span class="line">    setup_seed(<span class="number">2</span>)</span><br><span class="line">    <span class="built_in">print</span>(np.random.randint(<span class="number">0</span>, <span class="number">10</span>, <span class="number">1</span>))</span><br></pre></td></tr></table></figure><h3 id="tools-x2F-evalution-segmentation-py"><a href="#tools-x2F-evalution-segmentation-py" class="headerlink" title="tools&#x2F;evalution_segmentation.py"></a>tools&#x2F;evalution_segmentation.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"># @file name  : evalution_segmention.py</span></span><br><span class="line"><span class="string"># @author     : zz0320</span></span><br><span class="line"><span class="string"># @date       : 2022-04-16</span></span><br><span class="line"><span class="string"># @brief      : è®¾å®šåˆ†å‰²ä»»åŠ¡çš„è¯„ä»·æŒ‡æ ‡ å…·ä½“çš„æœ‰ æ··æ·†çŸ©é˜µ mIOU è¯„ä¼°çŸ©é˜µç­‰ç­‰</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> division</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> six</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calc_semantic_segmentation_confusion</span>(<span class="params">pred_labels, gt_labels, n_class</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Collect a confusion matrix.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    The number of classes :math:`n\_class` is</span></span><br><span class="line"><span class="string">    :math:`max(pred\_labels, gt\_labels) + 1`, which is</span></span><br><span class="line"><span class="string">    the maximum class id of the inputs added by one.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        pred_labels (iterable of numpy.ndarray): A collection of predicted</span></span><br><span class="line"><span class="string">            labels. The shape of a label array</span></span><br><span class="line"><span class="string">            is :math:`(H, W)`. :math:`H` and :math:`W`</span></span><br><span class="line"><span class="string">            are height and width of the label.</span></span><br><span class="line"><span class="string">        gt_labels (iterable of numpy.ndarray): A collection of ground</span></span><br><span class="line"><span class="string">            truth labels. The shape of a ground truth label array is</span></span><br><span class="line"><span class="string">            :math:`(H, W)`, and its corresponding prediction label should</span></span><br><span class="line"><span class="string">            have the same shape.</span></span><br><span class="line"><span class="string">            A pixel with value :obj:`-1` will be ignored during evaluation.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        numpy.ndarray:</span></span><br><span class="line"><span class="string">        A confusion matrix. Its shape is :math:`(n\_class, n\_class)`.</span></span><br><span class="line"><span class="string">        The :math:`(i, j)` th element corresponds to the number of pixels</span></span><br><span class="line"><span class="string">        that are labeled as class :math:`i` by the ground truth and</span></span><br><span class="line"><span class="string">        class :math:`j` by the prediction.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    pred_labels = <span class="built_in">iter</span>(pred_labels)  <span class="comment"># (352, 480)</span></span><br><span class="line">    gt_labels = <span class="built_in">iter</span>(gt_labels)  <span class="comment"># (352, 480)</span></span><br><span class="line"></span><br><span class="line">    confusion = np.zeros((n_class, n_class), dtype=np.int64)  <span class="comment"># (12, 12)</span></span><br><span class="line">    <span class="keyword">for</span> pred_label, gt_label <span class="keyword">in</span> six.moves.<span class="built_in">zip</span>(pred_labels, gt_labels):</span><br><span class="line">        <span class="keyword">if</span> pred_label.ndim != <span class="number">2</span> <span class="keyword">or</span> gt_label.ndim != <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&#x27;ndim of labels should be two. pred.ndim:&#123;&#125;, gt.ndim:&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(</span><br><span class="line">                pred_label.ndim, gt_label.ndim))</span><br><span class="line">        <span class="keyword">if</span> pred_label.shape != gt_label.shape:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&#x27;Shape of ground truth and prediction should&#x27;</span></span><br><span class="line">                             <span class="string">&#x27; be same.&#x27;</span>)</span><br><span class="line">        pred_label = pred_label.flatten()  <span class="comment"># (168960, )</span></span><br><span class="line">        gt_label = gt_label.flatten()  <span class="comment"># (168960, )</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Dynamically expand the confusion matrix if necessary.</span></span><br><span class="line">        lb_max = np.<span class="built_in">max</span>((pred_label, gt_label))</span><br><span class="line">        <span class="comment"># print(lb_max)</span></span><br><span class="line">        <span class="keyword">if</span> lb_max &gt;= n_class:</span><br><span class="line">            expanded_confusion = np.zeros(</span><br><span class="line">                (lb_max + <span class="number">1</span>, lb_max + <span class="number">1</span>), dtype=np.int64)</span><br><span class="line">            expanded_confusion[<span class="number">0</span>:n_class, <span class="number">0</span>:n_class] = confusion</span><br><span class="line"></span><br><span class="line">            n_class = lb_max + <span class="number">1</span></span><br><span class="line">            confusion = expanded_confusion</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Count statistics from valid pixels.  æåº¦å·§å¦™ Ã— class_nums æ­£å¥½ä½¿å¾—æ¯ä¸ªijèƒ½å¤Ÿå¯¹åº”.</span></span><br><span class="line">        <span class="comment"># æŠŠ2dçŸ©é˜µå˜ä¸º1dè¿›è¡Œç¼–å·æ’åºï¼Œn_cls*gt æ˜¯ç¡®å®šåœ¨å“ªä¸€è¡Œï¼Œ+pred è¡¨ç¤ºçœŸå®æ ‡ç­¾åœ¨è¿™ä¸€è¡Œï¼Œç„¶åé¢„æµ‹ä¸ºç¬¬å‡ ä¸ª</span></span><br><span class="line">        <span class="comment"># ç»Ÿè®¡å®Œæˆåå†reshapeå›2dçŸ©é˜µ</span></span><br><span class="line">        mask = gt_label &gt;= <span class="number">0</span></span><br><span class="line">        confusion += np.bincount(</span><br><span class="line">            n_class * gt_label[mask].astype(<span class="built_in">int</span>) + pred_label[mask],</span><br><span class="line">            minlength=n_class ** <span class="number">2</span>) \</span><br><span class="line">            .reshape((n_class, n_class))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> iter_ <span class="keyword">in</span> (pred_labels, gt_labels):</span><br><span class="line">        <span class="comment"># This code assumes any iterator does not contain None as its items.</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">next</span>(iter_, <span class="literal">None</span>) <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&#x27;Length of input iterables need to be same&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> confusion</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calc_semantic_segmentation_iou</span>(<span class="params">confusion</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Calculate Intersection over Union with a given confusion matrix.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    The definition of Intersection over Union (IoU) is as follows,</span></span><br><span class="line"><span class="string">    where :math:`N_&#123;ij&#125;` is the number of pixels</span></span><br><span class="line"><span class="string">    that are labeled as class :math:`i` by the ground truth and</span></span><br><span class="line"><span class="string">    class :math:`j` by the prediction.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    * :math:`\\text&#123;IoU of the i-th class&#125; =  \</span></span><br><span class="line"><span class="string">        \\frac&#123;N_&#123;ii&#125;&#125;&#123;\\sum_&#123;j=1&#125;^k N_&#123;ij&#125; + \\sum_&#123;j=1&#125;^k N_&#123;ji&#125; - N_&#123;ii&#125;&#125;`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        confusion (numpy.ndarray): A confusion matrix. Its shape is</span></span><br><span class="line"><span class="string">            :math:`(n\_class, n\_class)`.</span></span><br><span class="line"><span class="string">            The :math:`(i, j)` th element corresponds to the number of pixels</span></span><br><span class="line"><span class="string">            that are labeled as class :math:`i` by the ground truth and</span></span><br><span class="line"><span class="string">            class :math:`j` by the prediction.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        numpy.ndarray:</span></span><br><span class="line"><span class="string">        An array of IoUs for the :math:`n\_class` classes. Its shape is</span></span><br><span class="line"><span class="string">        :math:`(n\_class,)`.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    iou_denominator = (confusion.<span class="built_in">sum</span>(axis=<span class="number">1</span>) + confusion.<span class="built_in">sum</span>(axis=<span class="number">0</span>)</span><br><span class="line">                       - np.diag(confusion))</span><br><span class="line">    <span class="comment"># æ··æ·†çŸ©é˜µ è¡Œå’Œ + åˆ—å’Œ- ä¸­é—´å‡ºç°è¿‡ä¸¤æ¬¡çš„å€¼ ==&gt;&gt; å¹¶é›†</span></span><br><span class="line">    <span class="comment"># æ··æ·†çŸ©é˜µ å€¼ ==&gt;&gt; äº¤é›†</span></span><br><span class="line">    iou = np.diag(confusion) / iou_denominator  <span class="comment"># é¢„æµ‹æ­£ç¡®çš„æ•°é‡ / çœŸå®çš„æ•°é‡+é¢„æµ‹ä¸ºè¯¥ç±»çš„æ•°é‡ï¼Œå³  äº¤é›†/å¹¶é›†</span></span><br><span class="line">    <span class="keyword">return</span> iou</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">eval_semantic_segmentation</span>(<span class="params">pred_labels, gt_labels, n_class</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Evaluate metrics used in Semantic Segmentation.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    This function calculates Intersection over Union (IoU), Pixel Accuracy</span></span><br><span class="line"><span class="string">    and Class Accuracy for the task of semantic segmentation.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    The definition of metrics calculated by this function is as follows,</span></span><br><span class="line"><span class="string">    where :math:`N_&#123;ij&#125;` is the number of pixels</span></span><br><span class="line"><span class="string">    that are labeled as class :math:`i` by the ground truth and</span></span><br><span class="line"><span class="string">    class :math:`j` by the prediction.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    * :math:`\\text&#123;IoU of the i-th class&#125; =  \</span></span><br><span class="line"><span class="string">        \\frac&#123;N_&#123;ii&#125;&#125;&#123;\\sum_&#123;j=1&#125;^k N_&#123;ij&#125; + \\sum_&#123;j=1&#125;^k N_&#123;ji&#125; - N_&#123;ii&#125;&#125;`</span></span><br><span class="line"><span class="string">    * :math:`\\text&#123;mIoU&#125; = \\frac&#123;1&#125;&#123;k&#125; \</span></span><br><span class="line"><span class="string">        \\sum_&#123;i=1&#125;^k \</span></span><br><span class="line"><span class="string">        \\frac&#123;N_&#123;ii&#125;&#125;&#123;\\sum_&#123;j=1&#125;^k N_&#123;ij&#125; + \\sum_&#123;j=1&#125;^k N_&#123;ji&#125; - N_&#123;ii&#125;&#125;`</span></span><br><span class="line"><span class="string">    * :math:`\\text&#123;Pixel Accuracy&#125; =  \</span></span><br><span class="line"><span class="string">        \\frac \</span></span><br><span class="line"><span class="string">        &#123;\\sum_&#123;i=1&#125;^k N_&#123;ii&#125;&#125; \</span></span><br><span class="line"><span class="string">        &#123;\\sum_&#123;i=1&#125;^k \\sum_&#123;j=1&#125;^k N_&#123;ij&#125;&#125;`</span></span><br><span class="line"><span class="string">    * :math:`\\text&#123;Class Accuracy&#125; = \</span></span><br><span class="line"><span class="string">        \\frac&#123;N_&#123;ii&#125;&#125;&#123;\\sum_&#123;j=1&#125;^k N_&#123;ij&#125;&#125;`</span></span><br><span class="line"><span class="string">    * :math:`\\text&#123;Mean Class Accuracy&#125; = \\frac&#123;1&#125;&#123;k&#125; \</span></span><br><span class="line"><span class="string">        \\sum_&#123;i=1&#125;^k \</span></span><br><span class="line"><span class="string">        \\frac&#123;N_&#123;ii&#125;&#125;&#123;\\sum_&#123;j=1&#125;^k N_&#123;ij&#125;&#125;`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    The more detailed description of the above metrics can be found in a</span></span><br><span class="line"><span class="string">    review on semantic segmentation [#]_.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    The number of classes :math:`n\_class` is</span></span><br><span class="line"><span class="string">    :math:`max(pred\_labels, gt\_labels) + 1`, which is</span></span><br><span class="line"><span class="string">    the maximum class id of the inputs added by one.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    .. [#] Alberto Garcia-Garcia, Sergio Orts-Escolano, Sergiu Oprea, \</span></span><br><span class="line"><span class="string">    Victor Villena-Martinez, Jose Garcia-Rodriguez. \</span></span><br><span class="line"><span class="string">    `A Review on Deep Learning Techniques Applied to Semantic Segmentation \</span></span><br><span class="line"><span class="string">    &lt;https://arxiv.org/abs/1704.06857&gt;`_. arXiv 2017.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        pred_labels (iterable of numpy.ndarray): A collection of predicted</span></span><br><span class="line"><span class="string">            labels. The shape of a label array</span></span><br><span class="line"><span class="string">            is :math:`(H, W)`. :math:`H` and :math:`W`</span></span><br><span class="line"><span class="string">            are height and width of the label.</span></span><br><span class="line"><span class="string">            For example, this is a list of labels</span></span><br><span class="line"><span class="string">            :obj:`[label_0, label_1, ...]`, where</span></span><br><span class="line"><span class="string">            :obj:`label_i.shape = (H_i, W_i)`.</span></span><br><span class="line"><span class="string">        gt_labels (iterable of numpy.ndarray): A collection of ground</span></span><br><span class="line"><span class="string">            truth labels. The shape of a ground truth label array is</span></span><br><span class="line"><span class="string">            :math:`(H, W)`, and its corresponding prediction label should</span></span><br><span class="line"><span class="string">            have the same shape.</span></span><br><span class="line"><span class="string">            A pixel with value :obj:`-1` will be ignored during evaluation.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        dict:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        The keys, value-types and the description of the values are listed</span></span><br><span class="line"><span class="string">        below.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        * **iou** (*numpy.ndarray*): An array of IoUs for the \</span></span><br><span class="line"><span class="string">            :math:`n\_class` classes. Its shape is :math:`(n\_class,)`.</span></span><br><span class="line"><span class="string">        * **miou** (*float*): The average of IoUs over classes.</span></span><br><span class="line"><span class="string">        * **pixel_accuracy** (*float*): The computed pixel accuracy.</span></span><br><span class="line"><span class="string">        * **class_accuracy** (*numpy.ndarray*): An array of class accuracies \</span></span><br><span class="line"><span class="string">            for the :math:`n\_class` classes. \</span></span><br><span class="line"><span class="string">            Its shape is :math:`(n\_class,)`.</span></span><br><span class="line"><span class="string">        * **mean_class_accuracy** (*float*): The average of class accuracies.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    # Evaluation code is based on</span></span><br><span class="line"><span class="string">    # https://github.com/shelhamer/fcn.berkeleyvision.org/blob/master/</span></span><br><span class="line"><span class="string">    # score.py#L37</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    confusion = calc_semantic_segmentation_confusion(pred_labels, gt_labels, n_class)</span><br><span class="line">    iou = calc_semantic_segmentation_iou(confusion)</span><br><span class="line">    pixel_accuracy = np.diag(confusion).<span class="built_in">sum</span>() / confusion.<span class="built_in">sum</span>()</span><br><span class="line">    class_accuracy = np.diag(confusion) / (np.<span class="built_in">sum</span>(confusion, axis=<span class="number">1</span>) + <span class="number">1e-10</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&#x27;iou&#x27;</span>: iou, <span class="string">&#x27;miou&#x27;</span>: np.nanmean(iou), <span class="comment"># å–å¹³å‡å°±æ˜¯mIoU</span></span><br><span class="line">            <span class="string">&#x27;pixel_accuracy&#x27;</span>: pixel_accuracy,</span><br><span class="line">            <span class="string">&#x27;class_accuracy&#x27;</span>: class_accuracy,</span><br><span class="line">            <span class="string">&#x27;mean_class_accuracy&#x27;</span>: np.nanmean(class_accuracy),</span><br><span class="line">            <span class="string">&#x27;conf_mat&#x27;</span>: confusion&#125;</span><br><span class="line">    <span class="comment"># &#x27;mean_class_accuracy&#x27;: np.nanmean(class_accuracy)&#125;</span></span><br></pre></td></tr></table></figure><h3 id="tools-x2F-helpers-py"><a href="#tools-x2F-helpers-py" class="headerlink" title="tools&#x2F;helpers.py"></a>tools&#x2F;helpers.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> PIL</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dir_exists</span>(<span class="params">path</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(path):</span><br><span class="line">            os.makedirs(path)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">initialize_weights</span>(<span class="params">*models</span>):</span><br><span class="line">    <span class="keyword">for</span> model <span class="keyword">in</span> models:</span><br><span class="line">        <span class="keyword">for</span> m <span class="keyword">in</span> model.modules():</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(m, nn.Conv2d):</span><br><span class="line">                nn.init.kaiming_normal_(m.weight.data, nonlinearity=<span class="string">&#x27;relu&#x27;</span>)</span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">isinstance</span>(m, nn.BatchNorm2d):</span><br><span class="line">                m.weight.data.fill_(<span class="number">1.</span>)</span><br><span class="line">                m.bias.data.fill_(<span class="number">1e-4</span>)</span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">isinstance</span>(m, nn.Linear):</span><br><span class="line">                m.weight.data.normal_(<span class="number">0.0</span>, <span class="number">0.0001</span>)</span><br><span class="line">                m.bias.data.zero_()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_upsampling_weight</span>(<span class="params">in_channels, out_channels, kernel_size</span>):</span><br><span class="line">    factor = (kernel_size + <span class="number">1</span>) // <span class="number">2</span></span><br><span class="line">    <span class="keyword">if</span> kernel_size % <span class="number">2</span> == <span class="number">1</span>:</span><br><span class="line">            center = factor - <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">            center = factor - <span class="number">0.5</span></span><br><span class="line">    og = np.ogrid[:kernel_size, :kernel_size]</span><br><span class="line">    filt = (<span class="number">1</span> - <span class="built_in">abs</span>(og[<span class="number">0</span>] - center) / factor) * (<span class="number">1</span> - <span class="built_in">abs</span>(og[<span class="number">1</span>] - center) / factor)</span><br><span class="line">    weight = np.zeros((in_channels, out_channels, kernel_size, kernel_size), dtype=np.float64)</span><br><span class="line">    weight[<span class="built_in">list</span>(<span class="built_in">range</span>(in_channels)), <span class="built_in">list</span>(<span class="built_in">range</span>(out_channels)), :, :] = filt</span><br><span class="line">    <span class="keyword">return</span> torch.from_numpy(weight).<span class="built_in">float</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">colorize_mask</span>(<span class="params">mask, palette</span>):</span><br><span class="line">    zero_pad = <span class="number">256</span> * <span class="number">3</span> - <span class="built_in">len</span>(palette)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(zero_pad):</span><br><span class="line">        palette.append(<span class="number">0</span>)</span><br><span class="line">    new_mask = PIL.Image.fromarray(mask.astype(np.uint8)).convert(<span class="string">&#x27;P&#x27;</span>)</span><br><span class="line">    new_mask.putpalette(palette)</span><br><span class="line">    <span class="keyword">return</span> new_mask</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">set_trainable_attr</span>(<span class="params">m, b</span>):</span><br><span class="line">    m.trainable = b</span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> m.parameters():</span><br><span class="line">        p.requires_grad = b</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">apply_leaf</span>(<span class="params">m, f</span>):</span><br><span class="line">    c = m <span class="keyword">if</span> <span class="built_in">isinstance</span>(m, (<span class="built_in">list</span>, <span class="built_in">tuple</span>)) <span class="keyword">else</span> <span class="built_in">list</span>(m.children())</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(m, nn.Module):</span><br><span class="line">        f(m)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(c) &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">for</span> l <span class="keyword">in</span> c:</span><br><span class="line">            apply_leaf(l, f)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">set_trainable</span>(<span class="params">l, b</span>):</span><br><span class="line">    apply_leaf(l, <span class="keyword">lambda</span> m: set_trainable_attr(m, b))</span><br></pre></td></tr></table></figure><h3 id="tools-x2F-model-trainer-py"><a href="#tools-x2F-model-trainer-py" class="headerlink" title="tools&#x2F;model_trainer.py"></a>tools&#x2F;model_trainer.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"># @file name  : model_trainer.py</span></span><br><span class="line"><span class="string"># @author     : zz0320</span></span><br><span class="line"><span class="string"># @date       : 2022-04-16</span></span><br><span class="line"><span class="string"># @brief      : æ¨¡å‹è®­ç»ƒæµç¨‹ç±»</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> Counter</span><br><span class="line"><span class="keyword">from</span> tools.evalution_segmentaion <span class="keyword">import</span> eval_semantic_segmentation</span><br><span class="line"><span class="keyword">from</span> torch.nn.utils <span class="keyword">import</span> clip_grad_value_</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ModelTrainer</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">train</span>(<span class="params">data_loader, model, loss_f, cfg, optimizer, epoch_idx, logger</span>):</span><br><span class="line">        model.train()</span><br><span class="line"></span><br><span class="line">        class_num = data_loader.dataset.cls_num</span><br><span class="line">        conf_mat = np.zeros((class_num, class_num))</span><br><span class="line">        loss_sigma = []</span><br><span class="line">        train_acc = []</span><br><span class="line">        train_miou = []</span><br><span class="line">        grad_lst_iter = []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i, data <span class="keyword">in</span> <span class="built_in">enumerate</span>(data_loader):</span><br><span class="line">            inputs, labels = data</span><br><span class="line">            inputs, labels = inputs.to(cfg.device), labels.to(cfg.device)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># foward &amp; backward</span></span><br><span class="line">            outputs = model(inputs)</span><br><span class="line">            optimizer.zero_grad()</span><br><span class="line">            loss = loss_f(outputs.cpu(), labels.cpu())</span><br><span class="line">            loss.backward()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> cfg.is_clip:</span><br><span class="line">                clip_grad_value_(model.parameters(), cfg.clip_value)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> cfg.hist_grad:</span><br><span class="line">                grad_lst_tmp = []</span><br><span class="line">                <span class="keyword">for</span> p <span class="keyword">in</span> model.parameters():</span><br><span class="line">                    grad_lst_tmp.append(torch.<span class="built_in">max</span>(p.grad.<span class="built_in">abs</span>()).cpu().numpy())</span><br><span class="line">                grad_lst_iter.append(<span class="built_in">max</span>(grad_lst_tmp).flatten()[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">            optimizer.step()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># eval</span></span><br><span class="line">            pre_label = outputs.<span class="built_in">max</span>(dim=<span class="number">1</span>)[<span class="number">1</span>].data.cpu().numpy()  <span class="comment"># (bs, 360, 480)</span></span><br><span class="line">            pre_label = [i <span class="keyword">for</span> i <span class="keyword">in</span> pre_label]  <span class="comment"># ä¸€ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªæ ·æœ¬çš„é¢„æµ‹ã€‚pre_label[0].shape = (360,480)</span></span><br><span class="line">            true_label = labels.data.cpu().numpy()</span><br><span class="line">            true_label = [i <span class="keyword">for</span> i <span class="keyword">in</span> true_label]  <span class="comment"># true_label[0].shape (360, 480)</span></span><br><span class="line"></span><br><span class="line">            eval_metrix = eval_semantic_segmentation(pre_label, true_label, class_num)</span><br><span class="line">            train_acc.append(eval_metrix[<span class="string">&#x27;mean_class_accuracy&#x27;</span>])</span><br><span class="line">            train_miou.append(eval_metrix[<span class="string">&#x27;miou&#x27;</span>])</span><br><span class="line">            conf_mat += eval_metrix[<span class="string">&quot;conf_mat&quot;</span>]</span><br><span class="line">            loss_sigma.append(loss.item())</span><br><span class="line"></span><br><span class="line">            <span class="comment"># é—´éš” log_interval ä¸ª iteration æ‰“å°ä¸€æ¬¡è®­ç»ƒä¿¡æ¯</span></span><br><span class="line">            <span class="keyword">if</span> i % cfg.log_interval == cfg.log_interval - <span class="number">1</span>:</span><br><span class="line">                logger.info(<span class="string">&#x27;|Epoch[&#123;&#125;/&#123;&#125;]||batch[&#123;&#125;/&#123;&#125;]|batch_loss:&#123;:.4f&#125;||mIoU:&#123;:.4f&#125;&#x27;</span>.<span class="built_in">format</span>(epoch_idx,</span><br><span class="line">                                    cfg.max_epoch, i + <span class="number">1</span>, <span class="built_in">len</span>(data_loader), loss.item(), eval_metrix[<span class="string">&#x27;miou&#x27;</span>]))</span><br><span class="line"></span><br><span class="line">        loss_mean = np.mean(loss_sigma)</span><br><span class="line">        acc_mean = np.mean(train_acc)</span><br><span class="line">        miou_mean = np.mean(train_miou)</span><br><span class="line">        <span class="keyword">return</span> loss_mean, acc_mean, conf_mat, miou_mean, grad_lst_iter</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">valid</span>(<span class="params">data_loader, model, loss_f, cfg</span>):</span><br><span class="line">        model.<span class="built_in">eval</span>()</span><br><span class="line"></span><br><span class="line">        class_num = data_loader.dataset.cls_num</span><br><span class="line">        conf_mat = np.zeros((class_num, class_num))</span><br><span class="line">        loss_sigma = []</span><br><span class="line">        valid_acc = []</span><br><span class="line">        valid_miou = []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i, data <span class="keyword">in</span> <span class="built_in">enumerate</span>(data_loader):</span><br><span class="line">            inputs, labels = data</span><br><span class="line">            inputs, labels = inputs.to(cfg.device), labels.to(cfg.device)</span><br><span class="line"></span><br><span class="line">            outputs = model(inputs)</span><br><span class="line">            loss = loss_f(outputs.cpu(), labels.cpu())</span><br><span class="line"></span><br><span class="line">            <span class="comment"># ç»Ÿè®¡loss</span></span><br><span class="line">            loss_sigma.append(loss.item())</span><br><span class="line"></span><br><span class="line">            <span class="comment"># è¯„ä¼° mIoUçš„è®¡ç®—</span></span><br><span class="line">            pre_label = outputs.<span class="built_in">max</span>(dim=<span class="number">1</span>)[<span class="number">1</span>].data.cpu().numpy()  <span class="comment"># (bs, 360, 480)</span></span><br><span class="line">            pre_label = [i <span class="keyword">for</span> i <span class="keyword">in</span> pre_label]  <span class="comment"># ä¸€ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªæ ·æœ¬çš„é¢„æµ‹ã€‚pre_label[0].shape = (360,480)</span></span><br><span class="line">            true_label = labels.data.cpu().numpy()</span><br><span class="line">            true_label = [i <span class="keyword">for</span> i <span class="keyword">in</span> true_label]  <span class="comment"># true_label[0].shape (360, 480)</span></span><br><span class="line"></span><br><span class="line">            eval_metrix = eval_semantic_segmentation(pre_label, true_label, class_num) <span class="comment"># ä¸€ç³»åˆ—æŒ‡æ ‡çš„è®¡ç®— ä¸»è¦æ˜¯IoUçš„è®¡ç®—</span></span><br><span class="line">            valid_acc.append(eval_metrix[<span class="string">&#x27;mean_class_accuracy&#x27;</span>])</span><br><span class="line">            valid_miou.append(eval_metrix[<span class="string">&#x27;miou&#x27;</span>])</span><br><span class="line">            conf_mat += eval_metrix[<span class="string">&quot;conf_mat&quot;</span>]</span><br><span class="line">            loss_sigma.append(loss.item())</span><br><span class="line"></span><br><span class="line">        loss_mean = np.mean(loss_sigma)</span><br><span class="line">        acc_mean = np.mean(valid_acc)</span><br><span class="line">        miou_mean = np.mean(valid_miou)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> loss_mean, acc_mean, conf_mat, miou_mean</span><br></pre></td></tr></table></figure><h2 id="å®è·µ"><a href="#å®è·µ" class="headerlink" title="å®è·µ"></a>å®è·µ</h2><h3 id="è®­ç»ƒå‚æ•°"><a href="#è®­ç»ƒå‚æ•°" class="headerlink" title="è®­ç»ƒå‚æ•°"></a>è®­ç»ƒå‚æ•°</h3><table><thead><tr><th>å‚æ•°</th><th>å€¼</th></tr></thead><tbody><tr><td>max_epoch</td><td>100</td></tr><tr><td>crop_size</td><td>[360, 480]</td></tr><tr><td>clip_valueã€Œæ¢¯åº¦è£å‰ªé˜ˆå€¼ã€</td><td>1</td></tr><tr><td>train_bs</td><td>4</td></tr><tr><td>valid_bs</td><td>2</td></tr><tr><td>workers</td><td>4</td></tr><tr><td>lr_init</td><td>1</td></tr><tr><td>weight_decay</td><td>0.0001</td></tr><tr><td>momentum</td><td>0.9</td></tr><tr><td>milestones</td><td>[50, 85]</td></tr><tr><td>log_interval</td><td>10</td></tr><tr><td>loss_f</td><td>CrossEntropyLoss</td></tr><tr><td>optimizer</td><td>SGD</td></tr><tr><td>Backbone</td><td>ResNet-101</td></tr></tbody></table><h3 id="è®­ç»ƒç»“æœ"><a href="#è®­ç»ƒç»“æœ" class="headerlink" title="è®­ç»ƒç»“æœ"></a>è®­ç»ƒç»“æœ</h3><table><thead><tr><th></th><th>Train Acc</th><th>Valid Acc</th><th>Train loss</th><th>Train miou</th><th>Valid loss</th><th>Valid miou</th><th>LR</th><th>max grad</th></tr></thead><tbody><tr><td><strong>è£å‰ªå‰</strong></td><td>72.46%</td><td>57.25%</td><td>0.1807</td><td>0.6480</td><td>0.4784</td><td>0.4776</td><td>0.1</td><td>in 0, is 13.799564361572266</td></tr><tr><td><strong>è£å‰ªå</strong></td><td>71.02%</td><td>58.07%</td><td>0.1994</td><td>0.6318</td><td>0.4389</td><td>0.4875</td><td>0.1</td><td>in 0, is 1.0</td></tr></tbody></table>]]></content>
      
      
      
        <tags>
            
            <tag> åˆ†å‰²é¡¹ç›® </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Œåˆ†å‰²é¡¹ç›®ã€ï¼ˆä¸€ï¼‰åˆ†å‰²è¯„ä»·æŒ‡æ ‡ä¸å¸¸ç”¨æ¨¡å‹ä»‹ç»</title>
      <link href="/2022/05/22/%E3%80%8C%E5%88%86%E5%89%B2%E9%A1%B9%E7%9B%AE%E3%80%8D%EF%BC%88%E4%B8%80%EF%BC%89%E5%88%86%E5%89%B2%E8%AF%84%E4%BB%B7%E6%8C%87%E6%A0%87%E4%B8%8E%E5%B8%B8%E7%94%A8%E6%A8%A1%E5%9E%8B%E4%BB%8B%E7%BB%8D/"/>
      <url>/2022/05/22/%E3%80%8C%E5%88%86%E5%89%B2%E9%A1%B9%E7%9B%AE%E3%80%8D%EF%BC%88%E4%B8%80%EF%BC%89%E5%88%86%E5%89%B2%E8%AF%84%E4%BB%B7%E6%8C%87%E6%A0%87%E4%B8%8E%E5%B8%B8%E7%94%A8%E6%A8%A1%E5%9E%8B%E4%BB%8B%E7%BB%8D/</url>
      
        <content type="html"><![CDATA[<h2 id="å›¾åƒåˆ†å‰²æŒ‡æ ‡è¯„ä»·"><a href="#å›¾åƒåˆ†å‰²æŒ‡æ ‡è¯„ä»·" class="headerlink" title="å›¾åƒåˆ†å‰²æŒ‡æ ‡è¯„ä»·"></a>å›¾åƒåˆ†å‰²æŒ‡æ ‡è¯„ä»·</h2><p>$Accuracy$ï¼šé€åƒç´ åˆ†ç±»è®¡ç®—å‡†ç¡®ç‡</p><p>$mIoU$ï¼ˆmean intersection over unionï¼Œå‡äº¤å¹¶æ¯”ï¼‰ï¼š$mIoU$æŒ‡å¯¹æ¯ä¸ªç±»çš„$IoU$å–å¹³å‡å¾—åˆ°$mIoU$</p><p>å…¶ä¸­$IoU$ä¸ºï¼š<br>$$<br>IoU &#x3D; \frac{target \wedge prediction}{target \cap prediction}<br>$$<br>å…¶ä¸­ï¼Œåˆ†å­ä¸ºåƒç´ åˆ†ç±»æ­£ç¡®çš„æ•°é‡ï¼Œåˆ†æ¯ä¸ºæ ‡ç­¾çš„æ•°é‡ä¸é¢„æµ‹æ•°é‡çš„å’Œ</p><span id="more"></span><h2 id="å¸¸ç”¨åˆ†å‰²æ¨¡å‹"><a href="#å¸¸ç”¨åˆ†å‰²æ¨¡å‹" class="headerlink" title="å¸¸ç”¨åˆ†å‰²æ¨¡å‹"></a>å¸¸ç”¨åˆ†å‰²æ¨¡å‹</h2><h3 id="FCN"><a href="#FCN" class="headerlink" title="FCN"></a><a href="https://arxiv.org/abs/1411.4038">FCN</a></h3><p>åˆ©ç”¨å…¨å·ç§¯ç¥ç»ç½‘ç»œå®ŒæˆPixel Wise Prediction</p><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2haoqx9lij20zk0istaw.jpg"></p><h3 id="U-Net"><a href="#U-Net" class="headerlink" title="U-Net"></a><a href="https://arxiv.org/abs/1505.04597">U-Net</a></h3><p>U-Netç³»åˆ—åˆ†å‰²æ¨¡å‹çš„åŸºæœ¬ç»“æ„ â€”â€”ç¼–ç å™¨ä¸è§£ç å™¨çš„ç‰¹å¾èåˆ</p><table><thead><tr><th><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2harru1xij20hi0ebdgx.jpg"></th><th><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2harbvu4zj20hi0eawfv.jpg"></th><th><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2has4a0k6j20hh0e9wfx.jpg"></th><th><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hasg2enrj20hf0eaq4m.jpg"></th></tr></thead></table><h3 id="DeepLabç³»åˆ—-V1"><a href="#DeepLabç³»åˆ—-V1" class="headerlink" title="DeepLabç³»åˆ—-V1"></a><a href="https://arxiv.org/abs/1412.7062">DeepLabç³»åˆ—-V1</a></h3><p>ä¸»è¦ç‰¹ç‚¹ï¼š </p><p>å­”æ´å·ç§¯ï¼šå€ŸåŠ©å­”æ´å·ç§¯ï¼Œå¢å¤§æ„Ÿå—é‡</p><p>CRFï¼šé‡‡ç”¨CRFè¿›è¡Œmaskåå¤„ç†</p><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hatwc3jaj20zk0e2jsd.jpg"></p><h3 id="DeepLabç³»åˆ—â€”V2"><a href="#DeepLabç³»åˆ—â€”V2" class="headerlink" title="DeepLabç³»åˆ—â€”V2"></a><a href="https://arxiv.org/abs/1606.00915">DeepLabç³»åˆ—â€”V2</a></h3><p>ä¸»è¦ç‰¹ç‚¹ï¼š</p><p>ASPP(Atrous spatial pyramid pooling)â€”â€”è§£å†³å¤šå°ºåº¦é—®é¢˜</p><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hb6wq507j20zk0imq54.jpg"></p><h3 id="DeepLabç³»åˆ—â€”V3"><a href="#DeepLabç³»åˆ—â€”V3" class="headerlink" title="DeepLabç³»åˆ—â€”V3"></a><a href="https://arxiv.org/abs/1706.05587">DeepLabç³»åˆ—â€”V3</a></h3><p>ä¸»è¦ç‰¹ç‚¹æœ‰ï¼šå­”æ´å·ç§¯çš„ä¸²è¡Œ  ASPPçš„å¹¶è¡Œ</p><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hbbjgk1mj20zk0am3zy.jpg"></p><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hbc0gaatj20zk0dv76f.jpg"></p><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hbcbfssoj20zk0af3zt.jpg"></p><h3 id="DeepLabç³»åˆ—â€”V3-1"><a href="#DeepLabç³»åˆ—â€”V3-1" class="headerlink" title="DeepLabç³»åˆ—â€”V3+"></a><a href="https://arxiv.org/abs/1802.02611">DeepLabç³»åˆ—â€”V3+</a></h3><p>ä¸»è¦ç‰¹ç‚¹ï¼š  åœ¨deeplabv3åŸºç¡€ä¸ŠåŠ ä¸ŠEncoder-Decoderæ€æƒ³</p><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hbe6jxkfj20zk0i640v.jpg"></p><h3 id="SegNet"><a href="#SegNet" class="headerlink" title="SegNet"></a><a href="https://arxiv.org/abs/1511.00561">SegNet</a></h3><p>ä¸»è¦ç‰¹ç‚¹ï¼š</p><p>Backboneï¼švgg16</p><p>Encoder-Decoderç»“æ„</p><p>å¸¦ç´¢å¼•çš„æœ€å¤§æ± åŒ–ä¸Šé‡‡æ ·</p><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hcl21zxaj20zk0bkdig.jpg"></p><h2 id="å®è·µ"><a href="#å®è·µ" class="headerlink" title="å®è·µ"></a>å®è·µ</h2><h3 id="U-Netç½‘ç»œä¸­çš„æ•°æ®å½¢çŠ¶å˜åŒ–-ã€ŒBatch-size-x3D-1ã€"><a href="#U-Netç½‘ç»œä¸­çš„æ•°æ®å½¢çŠ¶å˜åŒ–-ã€ŒBatch-size-x3D-1ã€" class="headerlink" title="U-Netç½‘ç»œä¸­çš„æ•°æ®å½¢çŠ¶å˜åŒ– ã€ŒBatch_size&#x3D;1ã€"></a>U-Netç½‘ç»œä¸­çš„æ•°æ®å½¢çŠ¶å˜åŒ– ã€ŒBatch_size&#x3D;1ã€</h3><table><thead><tr><th>æ­¥éª¤</th><th>ç±»å±æ€§</th><th>å…·ä½“ç½‘ç»œå±‚</th><th>æ•°æ®è¾“å…¥å½¢çŠ¶</th><th>æ•°æ®è¾“å‡ºå½¢çŠ¶</th></tr></thead><tbody><tr><td>1</td><td>self.start_conv</td><td>(Conv+BN+ReLU)*2</td><td>x &#x3D; [1, 3, 360, 480]</td><td>x1 &#x3D; [1, 3, 360, 480]</td></tr><tr><td>2</td><td>self.down1</td><td>(Conv+BN+ReLU)*2+pool</td><td>x1 &#x3D; [1, 3, 360, 480]</td><td>x2 &#x3D; [1,128,180,240]</td></tr><tr><td>3</td><td>self.down2</td><td>(Conv+BN+ReLU)*2+pool</td><td>x2 &#x3D; [1,128,180,240]</td><td>x3 &#x3D; [1,256,90,120]</td></tr><tr><td>4</td><td>self.down3</td><td>(Conv+BN+ReLU)*2+pool</td><td>x3 &#x3D; [1,256,90,120]</td><td>x4 &#x3D; [1,512,45,60]</td></tr><tr><td>5</td><td>self.down4</td><td>(Conv+BN+ReLU)*2+pool</td><td>x4 &#x3D; [1,512,45,60]</td><td>x_ &#x3D; [1,1024,23,30]</td></tr><tr><td>6</td><td>self.middle_conv</td><td>(Conv+BN+ReLU)*2</td><td>x_ &#x3D; [1,1024,23,30]</td><td>x &#x3D; [1,1024,23,30]</td></tr><tr><td>7</td><td>self.up1</td><td>ConvT +(Conv+BN+ReLU)*2</td><td>x4 &#x3D; [1,512,45,60]x &#x3D; [1,1024,23,30]</td><td>x &#x3D; [1,512,45,60]</td></tr><tr><td>8</td><td>self.up2</td><td>ConvT +(Conv+BN+ReLU)*2</td><td>x3 &#x3D; [1,256,90,120]x &#x3D; [1,512,45,60]</td><td>x &#x3D; [1,256,90,120]</td></tr><tr><td>9</td><td>self.up3</td><td>ConvT +(Conv+BN+ReLU)*2</td><td>x2 &#x3D; [1,128,180,240]x &#x3D; [1,256,90,120]</td><td>x &#x3D; [1,128,180,240]</td></tr><tr><td>10</td><td>self.up4</td><td>ConvT +(Conv+BN+ReLU)*2</td><td>x1&#x3D; [1,64,360,480]x &#x3D; [1,128,180,240]</td><td>x &#x3D; [1,64,360,480]</td></tr><tr><td>11</td><td>self.final_conv</td><td>Conv2d</td><td>x &#x3D; [1,64,360,480]</td><td>x &#x3D; [1,12,360,480]</td></tr></tbody></table>]]></content>
      
      
      
        <tags>
            
            <tag> åˆ†å‰²é¡¹ç›® </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Œç›®æ ‡è¿½è¸ªç³»åˆ—ã€ï¼ˆå››ï¼‰è®­ç»ƒDeepSortç›®æ ‡è¿½è¸ªç®—æ³•</title>
      <link href="/2022/05/22/%E3%80%8C%E7%9B%AE%E6%A0%87%E8%BF%BD%E8%B8%AA%E7%B3%BB%E5%88%97%E3%80%8D%EF%BC%88%E5%9B%9B%EF%BC%89%E8%AE%AD%E7%BB%83DeepSort%E7%9B%AE%E6%A0%87%E8%BF%BD%E8%B8%AA%E7%AE%97%E6%B3%95/"/>
      <url>/2022/05/22/%E3%80%8C%E7%9B%AE%E6%A0%87%E8%BF%BD%E8%B8%AA%E7%B3%BB%E5%88%97%E3%80%8D%EF%BC%88%E5%9B%9B%EF%BC%89%E8%AE%AD%E7%BB%83DeepSort%E7%9B%AE%E6%A0%87%E8%BF%BD%E8%B8%AA%E7%AE%97%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<h2 id="æ•°æ®é›†-ã€ŒMOT17-Tinyã€"><a href="#æ•°æ®é›†-ã€ŒMOT17-Tinyã€" class="headerlink" title="æ•°æ®é›† ã€ŒMOT17 Tinyã€"></a>æ•°æ®é›† ã€ŒMOT17 Tinyã€</h2><h3 id="ä¸‹è½½æ•°æ®é›†"><a href="#ä¸‹è½½æ•°æ®é›†" class="headerlink" title="ä¸‹è½½æ•°æ®é›†"></a>ä¸‹è½½æ•°æ®é›†</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># ä¸‹è½½ MOT17 æ•°æ®é›†å‹ç¼©åŒ…</span><br><span class="line">wget https://download.openmmlab.com/mmtracking/data/MOT17_tiny.zip -P ./data</span><br><span class="line"></span><br><span class="line"># è§£å‹</span><br><span class="line">rm -rf data/MOT17_tiny</span><br><span class="line">unzip ./data/MOT17_tiny.zip -d ./data</span><br></pre></td></tr></table></figure><h3 id="å°†-txt-æ ¼å¼çš„æ ‡æ³¨æ–‡ä»¶ï¼Œè½¬æ¢ä¸º-coco-æ ¼å¼çš„-json-æ–‡ä»¶"><a href="#å°†-txt-æ ¼å¼çš„æ ‡æ³¨æ–‡ä»¶ï¼Œè½¬æ¢ä¸º-coco-æ ¼å¼çš„-json-æ–‡ä»¶" class="headerlink" title="å°† txt æ ¼å¼çš„æ ‡æ³¨æ–‡ä»¶ï¼Œè½¬æ¢ä¸º coco æ ¼å¼çš„ json æ–‡ä»¶"></a>å°† txt æ ¼å¼çš„æ ‡æ³¨æ–‡ä»¶ï¼Œè½¬æ¢ä¸º coco æ ¼å¼çš„ json æ–‡ä»¶</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python ./tools/convert_datasets/mot/mot2coco.py -i ./data/MOT17_tiny/ -o ./data/MOT17_tiny/annotations --split-train --convert-det</span><br></pre></td></tr></table></figure><h3 id="ä»æ•°æ®é›†ä¸­æŠŠè¡Œäººçš„å›¾å—è£å‰ªå‡ºæ¥ï¼Œç”¨äºè®­ç»ƒ-ReID-é‡è¯†åˆ«æ¨¡å‹"><a href="#ä»æ•°æ®é›†ä¸­æŠŠè¡Œäººçš„å›¾å—è£å‰ªå‡ºæ¥ï¼Œç”¨äºè®­ç»ƒ-ReID-é‡è¯†åˆ«æ¨¡å‹" class="headerlink" title="ä»æ•°æ®é›†ä¸­æŠŠè¡Œäººçš„å›¾å—è£å‰ªå‡ºæ¥ï¼Œç”¨äºè®­ç»ƒ ReID é‡è¯†åˆ«æ¨¡å‹"></a>ä»æ•°æ®é›†ä¸­æŠŠè¡Œäººçš„å›¾å—è£å‰ªå‡ºæ¥ï¼Œç”¨äºè®­ç»ƒ ReID é‡è¯†åˆ«æ¨¡å‹</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># åˆ é™¤å·²æœ‰çš„ reid ç›®å½•ï¼ˆå¦‚æœ‰ï¼‰</span><br><span class="line">rm -rf ./data/MOT17_tiny/reid</span><br><span class="line"></span><br><span class="line"># å¤§æ¦‚éœ€è¦ 20 åˆ†é’Ÿ</span><br><span class="line">python ./tools/convert_datasets/mot/mot2reid.py -i ./data/MOT17_tiny/ -o ./data/MOT17_tiny/reid --val-split 0.9 --vis-threshold 0.8</span><br></pre></td></tr></table></figure><span id="more"></span><h2 id="åˆ†åˆ«è®­ç»ƒ-DeepSORT-æ¨¡å‹ä¸­çš„ä¸åŒæ¨¡å—"><a href="#åˆ†åˆ«è®­ç»ƒ-DeepSORT-æ¨¡å‹ä¸­çš„ä¸åŒæ¨¡å—" class="headerlink" title="åˆ†åˆ«è®­ç»ƒ DeepSORT æ¨¡å‹ä¸­çš„ä¸åŒæ¨¡å—"></a>åˆ†åˆ«è®­ç»ƒ DeepSORT æ¨¡å‹ä¸­çš„ä¸åŒæ¨¡å—</h2><h3 id="é…ç½®-DeepSORT-ä¸­çš„ç›®æ ‡æ£€æµ‹ç®—æ³•æ¨¡å—"><a href="#é…ç½®-DeepSORT-ä¸­çš„ç›®æ ‡æ£€æµ‹ç®—æ³•æ¨¡å—" class="headerlink" title="é…ç½® DeepSORT ä¸­çš„ç›®æ ‡æ£€æµ‹ç®—æ³•æ¨¡å—"></a>é…ç½® DeepSORT ä¸­çš„ç›®æ ‡æ£€æµ‹ç®—æ³•æ¨¡å—</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> mmcv</span><br><span class="line"><span class="keyword">from</span> mmdet.apis <span class="keyword">import</span> set_random_seed</span><br><span class="line"></span><br><span class="line">cfg = mmcv.Config.fromfile(<span class="string">&#x27;./configs/det/faster-rcnn_r50_fpn_4e_mot17-half.py&#x27;</span>)</span><br><span class="line">cfg.data_root = <span class="string">&#x27;data/MOT17_tiny/&#x27;</span></span><br><span class="line">cfg.data.test.ann_file = cfg.data.test.ann_file.replace(<span class="string">&#x27;data/MOT17/&#x27;</span>,<span class="string">&#x27;data/MOT17_tiny/&#x27;</span>)</span><br><span class="line">cfg.data.train.ann_file = cfg.data.train.ann_file.replace(<span class="string">&#x27;data/MOT17/&#x27;</span>,<span class="string">&#x27;data/MOT17_tiny/&#x27;</span>)</span><br><span class="line">cfg.data.val.ann_file = cfg.data.val.ann_file.replace(<span class="string">&#x27;data/MOT17/&#x27;</span>,<span class="string">&#x27;data/MOT17_tiny/&#x27;</span>)</span><br><span class="line"></span><br><span class="line">cfg.data.test.img_prefix = cfg.data.test.img_prefix.replace(<span class="string">&#x27;data/MOT17/&#x27;</span>,<span class="string">&#x27;data/MOT17_tiny/&#x27;</span>)</span><br><span class="line">cfg.data.train.img_prefix = cfg.data.train.img_prefix.replace(<span class="string">&#x27;data/MOT17/&#x27;</span>,<span class="string">&#x27;data/MOT17_tiny/&#x27;</span>)</span><br><span class="line">cfg.data.val.img_prefix = cfg.data.val.img_prefix.replace(<span class="string">&#x27;data/MOT17/&#x27;</span>,<span class="string">&#x27;data/MOT17_tiny/&#x27;</span>)</span><br><span class="line"></span><br><span class="line">cfg.work_dir = <span class="string">&#x27;./tutorial_exps/detector&#x27;</span></span><br><span class="line">cfg.seed = <span class="number">0</span></span><br><span class="line">set_random_seed(<span class="number">0</span>, deterministic=<span class="literal">False</span>)</span><br><span class="line">cfg.gpu_ids = <span class="built_in">range</span>(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(cfg.pretty_text)</span><br></pre></td></tr></table></figure><h3 id="è®­ç»ƒ-DeepSORT-ä¸­çš„ç›®æ ‡æ£€æµ‹ç®—æ³•æ¨¡å—"><a href="#è®­ç»ƒ-DeepSORT-ä¸­çš„ç›®æ ‡æ£€æµ‹ç®—æ³•æ¨¡å—" class="headerlink" title="è®­ç»ƒ DeepSORT ä¸­çš„ç›®æ ‡æ£€æµ‹ç®—æ³•æ¨¡å—"></a>è®­ç»ƒ DeepSORT ä¸­çš„ç›®æ ‡æ£€æµ‹ç®—æ³•æ¨¡å—</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># model.init_weights()</span></span><br><span class="line">train_model(model, datasets, cfg)</span><br></pre></td></tr></table></figure><h3 id="é…ç½®-DeepSORT-ä¸­çš„-ReID-é‡è¯†åˆ«ç®—æ³•æ¨¡å—"><a href="#é…ç½®-DeepSORT-ä¸­çš„-ReID-é‡è¯†åˆ«ç®—æ³•æ¨¡å—" class="headerlink" title="é…ç½® DeepSORT ä¸­çš„ ReID é‡è¯†åˆ«ç®—æ³•æ¨¡å—"></a>é…ç½® DeepSORT ä¸­çš„ ReID é‡è¯†åˆ«ç®—æ³•æ¨¡å—</h3><p>ReID é‡è¯†åˆ«ç®—æ³•æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå¤šåˆ†ç±»å›¾åƒåˆ†ç±»æ¨¡å‹ï¼Œè¾“å…¥è¡Œäººçš„ patch å›¾ï¼Œæå–å›¾ä¸­ç‰¹å¾ï¼Œè¾“å‡º ID å·</p><p>ç”¨æ¥ä»å›¾åƒç‰¹å¾ä¸­åˆ¤æ–­å½“å‰è¡Œäººæ˜¯å¦æ˜¯æ–°äºº</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> mmcv</span><br><span class="line"><span class="keyword">from</span> mmdet.apis <span class="keyword">import</span> set_random_seed</span><br><span class="line"></span><br><span class="line">cfg = mmcv.Config.fromfile(<span class="string">&#x27;./configs/reid/resnet50_b32x8_MOT17.py&#x27;</span>)</span><br><span class="line">cfg.data_root = <span class="string">&#x27;data/MOT17_tiny/&#x27;</span></span><br><span class="line">cfg.data.test.ann_file = cfg.data.test.ann_file.replace(<span class="string">&#x27;data/MOT17/&#x27;</span>,<span class="string">&#x27;data/MOT17_tiny/&#x27;</span>)</span><br><span class="line">cfg.data.train.ann_file = <span class="string">&#x27;data/MOT17_tiny/reid/meta/train_9.txt&#x27;</span></span><br><span class="line">cfg.data.val.ann_file = cfg.data.val.ann_file.replace(<span class="string">&#x27;data/MOT17/&#x27;</span>,<span class="string">&#x27;data/MOT17_tiny/&#x27;</span>)</span><br><span class="line"></span><br><span class="line">cfg.data.test.data_prefix = cfg.data.test.data_prefix.replace(<span class="string">&#x27;data/MOT17/&#x27;</span>,<span class="string">&#x27;data/MOT17_tiny/&#x27;</span>)</span><br><span class="line">cfg.data.train.data_prefix = cfg.data.train.data_prefix.replace(<span class="string">&#x27;data/MOT17/&#x27;</span>,<span class="string">&#x27;data/MOT17_tiny/&#x27;</span>)</span><br><span class="line">cfg.data.val.data_prefix = cfg.data.val.data_prefix.replace(<span class="string">&#x27;data/MOT17/&#x27;</span>,<span class="string">&#x27;data/MOT17_tiny/&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å­¦ä¹ ç‡ç­–ç•¥</span></span><br><span class="line">cfg.lr_config = <span class="built_in">dict</span>(</span><br><span class="line">    policy=<span class="string">&#x27;step&#x27;</span>,</span><br><span class="line">    warmup=<span class="string">&#x27;linear&#x27;</span>,</span><br><span class="line">    warmup_iters=<span class="number">200</span>,</span><br><span class="line">    warmup_ratio=<span class="number">1.0</span> / <span class="number">200</span>,</span><br><span class="line">    step=[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">cfg.total_epochs = <span class="number">2</span></span><br><span class="line"></span><br><span class="line">cfg.work_dir = <span class="string">&#x27;./tutorial_exps/reid&#x27;</span></span><br><span class="line">cfg.seed = <span class="number">0</span></span><br><span class="line">set_random_seed(<span class="number">0</span>, deterministic=<span class="literal">False</span>)</span><br><span class="line">cfg.gpu_ids = <span class="built_in">range</span>(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(cfg.pretty_text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> mmtrack.datasets <span class="keyword">import</span> build_dataset</span><br><span class="line"><span class="keyword">from</span> mmdet.apis <span class="keyword">import</span> train_detector <span class="keyword">as</span> train_model</span><br><span class="line"><span class="keyword">from</span> mmtrack.models <span class="keyword">import</span> build_reid <span class="keyword">as</span> build_model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">model = build_model(cfg.model.reid)</span><br><span class="line">model.init_weights()</span><br><span class="line">datasets = [build_dataset(cfg.data.train)]</span><br><span class="line">model.CLASSES = datasets[<span class="number">0</span>].CLASSES</span><br></pre></td></tr></table></figure><h3 id="è®­ç»ƒ-DeepSORT-ä¸­çš„-ReID-é‡è¯†åˆ«ç®—æ³•æ¨¡å—"><a href="#è®­ç»ƒ-DeepSORT-ä¸­çš„-ReID-é‡è¯†åˆ«ç®—æ³•æ¨¡å—" class="headerlink" title="è®­ç»ƒ DeepSORT ä¸­çš„ ReID é‡è¯†åˆ«ç®—æ³•æ¨¡å—"></a>è®­ç»ƒ DeepSORT ä¸­çš„ ReID é‡è¯†åˆ«ç®—æ³•æ¨¡å—</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">train_model(model, datasets, cfg)</span><br></pre></td></tr></table></figure><h2 id="æµ‹è¯•è®­ç»ƒå¾—åˆ°çš„-DeepSORT-å¤šç›®æ ‡è¿½è¸ªç®—æ³•"><a href="#æµ‹è¯•è®­ç»ƒå¾—åˆ°çš„-DeepSORT-å¤šç›®æ ‡è¿½è¸ªç®—æ³•" class="headerlink" title="æµ‹è¯•è®­ç»ƒå¾—åˆ°çš„ DeepSORT å¤šç›®æ ‡è¿½è¸ªç®—æ³•"></a>æµ‹è¯•è®­ç»ƒå¾—åˆ°çš„ DeepSORT å¤šç›®æ ‡è¿½è¸ªç®—æ³•</h2><h3 id="ç”Ÿæˆ-config-é…ç½®æ–‡ä»¶"><a href="#ç”Ÿæˆ-config-é…ç½®æ–‡ä»¶" class="headerlink" title="ç”Ÿæˆ config é…ç½®æ–‡ä»¶"></a>ç”Ÿæˆ config é…ç½®æ–‡ä»¶</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> mmcv</span><br><span class="line"><span class="keyword">from</span> mmdet.apis <span class="keyword">import</span> set_random_seed</span><br><span class="line"></span><br><span class="line">cfg = mmcv.Config.fromfile(<span class="string">&#x27;./configs/mot/deepsort/deepsort_faster-rcnn_fpn_4e_mot17-private-half.py&#x27;</span>)</span><br><span class="line">cfg.data_root = <span class="string">&#x27;data/MOT17_tiny/&#x27;</span></span><br><span class="line">cfg.data.test.ann_file = cfg.data.test.ann_file.replace(<span class="string">&#x27;data/MOT17/&#x27;</span>,<span class="string">&#x27;data/MOT17_tiny/&#x27;</span>)</span><br><span class="line">cfg.data.train.ann_file = cfg.data.test.ann_file.replace(<span class="string">&#x27;data/MOT17/&#x27;</span>,<span class="string">&#x27;data/MOT17_tiny/&#x27;</span>)</span><br><span class="line">cfg.data.val.ann_file = cfg.data.val.ann_file.replace(<span class="string">&#x27;data/MOT17/&#x27;</span>,<span class="string">&#x27;data/MOT17_tiny/&#x27;</span>)</span><br><span class="line"></span><br><span class="line">cfg.data.test.img_prefix = cfg.data.test.img_prefix.replace(<span class="string">&#x27;data/MOT17/&#x27;</span>,<span class="string">&#x27;data/MOT17_tiny/&#x27;</span>)</span><br><span class="line">cfg.data.train.img_prefix = cfg.data.train.img_prefix.replace(<span class="string">&#x27;data/MOT17/&#x27;</span>,<span class="string">&#x27;data/MOT17_tiny/&#x27;</span>)</span><br><span class="line">cfg.data.val.img_prefix = cfg.data.val.img_prefix.replace(<span class="string">&#x27;data/MOT17/&#x27;</span>,<span class="string">&#x27;data/MOT17_tiny/&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®šè®­ç»ƒå¥½çš„ç›®æ ‡æ£€æµ‹æ¨¡å—å’Œ ReID é‡è¯†åˆ«æ¨¡å—</span></span><br><span class="line">cfg.model.detector.init_cfg.checkpoint = <span class="string">&#x27;./tutorial_exps/detector/epoch_4.pth&#x27;</span></span><br><span class="line">cfg.model.reid.init_cfg.checkpoint = <span class="string">&#x27;./tutorial_exps/reid/epoch_2.pth&#x27;</span></span><br><span class="line"></span><br><span class="line">cfg.work_dir = <span class="string">&#x27;./tutorial_exps&#x27;</span></span><br><span class="line">cfg.seed = <span class="number">0</span></span><br><span class="line">set_random_seed(<span class="number">0</span>, deterministic=<span class="literal">False</span>)</span><br><span class="line">cfg.gpu_ids = <span class="built_in">range</span>(<span class="number">1</span>)</span><br><span class="line">cfg.data.test.test_mode = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(cfg.pretty_text)</span><br></pre></td></tr></table></figure><h3 id="ä¿å­˜configé…ç½®æ–‡ä»¶"><a href="#ä¿å­˜configé…ç½®æ–‡ä»¶" class="headerlink" title="ä¿å­˜configé…ç½®æ–‡ä»¶"></a>ä¿å­˜configé…ç½®æ–‡ä»¶</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://zihao-openmmlab.obs.cn-east-3.myhuaweicloud.com/20220418-mmtracking/deepsort_faster-rcnn_fpn_4e_mot17-new.py -O configs/mot/deepsort/deepsort_faster-rcnn_fpn_4e_mot17-new.py</span><br></pre></td></tr></table></figure><h3 id="æ„å»ºæ¨¡å‹"><a href="#æ„å»ºæ¨¡å‹" class="headerlink" title="æ„å»ºæ¨¡å‹"></a>æ„å»ºæ¨¡å‹</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mmtrack.datasets <span class="keyword">import</span> build_dataloader</span><br><span class="line"><span class="keyword">from</span> mmtrack.models <span class="keyword">import</span> build_model</span><br><span class="line"><span class="keyword">from</span> mmcv.parallel <span class="keyword">import</span> MMDataParallel</span><br><span class="line"><span class="keyword">from</span> mmtrack.apis <span class="keyword">import</span> single_gpu_test</span><br><span class="line"><span class="keyword">from</span> mmtrack.datasets <span class="keyword">import</span> build_dataset</span><br><span class="line"></span><br><span class="line">dataset = build_dataset(cfg.data.test)</span><br><span class="line">data_loader = build_dataloader(</span><br><span class="line">    dataset,</span><br><span class="line">    samples_per_gpu=<span class="number">1</span>,</span><br><span class="line">    workers_per_gpu=cfg.data.workers_per_gpu,</span><br><span class="line">    dist=<span class="literal">False</span>,</span><br><span class="line">    shuffle=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ„å»ºæ¨¡å‹ï¼Œè½½å…¥ checkpoint æƒé‡æ–‡ä»¶</span></span><br><span class="line">model = build_model(cfg.model)</span><br><span class="line">model.init_weights()</span><br><span class="line"></span><br><span class="line">model = MMDataParallel(model, device_ids=cfg.gpu_ids)</span><br></pre></td></tr></table></figure><h3 id="åœ¨æµ‹è¯•é›†ä¸Šé¢„æµ‹"><a href="#åœ¨æµ‹è¯•é›†ä¸Šé¢„æµ‹" class="headerlink" title="åœ¨æµ‹è¯•é›†ä¸Šé¢„æµ‹"></a>åœ¨æµ‹è¯•é›†ä¸Šé¢„æµ‹</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">outputs = single_gpu_test(model, data_loader)</span><br></pre></td></tr></table></figure><h3 id="åœ¨æµ‹è¯•é›†ä¸Šè¯„ä¼°"><a href="#åœ¨æµ‹è¯•é›†ä¸Šè¯„ä¼°" class="headerlink" title="åœ¨æµ‹è¯•é›†ä¸Šè¯„ä¼°"></a>åœ¨æµ‹è¯•é›†ä¸Šè¯„ä¼°</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">eval_kwargs = cfg.get(<span class="string">&#x27;evaluation&#x27;</span>, &#123;&#125;).copy()</span><br><span class="line"><span class="comment"># hard-code way to remove EvalHook args</span></span><br><span class="line">eval_hook_args = [</span><br><span class="line">    <span class="string">&#x27;interval&#x27;</span>, <span class="string">&#x27;tmpdir&#x27;</span>, <span class="string">&#x27;start&#x27;</span>, <span class="string">&#x27;gpu_collect&#x27;</span>, <span class="string">&#x27;save_best&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;rule&#x27;</span>, <span class="string">&#x27;by_epoch&#x27;</span></span><br><span class="line">]</span><br><span class="line"><span class="keyword">for</span> key <span class="keyword">in</span> eval_hook_args:</span><br><span class="line">    eval_kwargs.pop(key, <span class="literal">None</span>)</span><br><span class="line">eval_kwargs.update(<span class="built_in">dict</span>(metric=[<span class="string">&#x27;track&#x27;</span>]))</span><br><span class="line">metric = dataset.evaluate(outputs, **eval_kwargs)</span><br><span class="line"><span class="built_in">print</span>(metric)</span><br></pre></td></tr></table></figure><h3 id="å¯¹æ–°è§†é¢‘é¢„æµ‹"><a href="#å¯¹æ–°è§†é¢‘é¢„æµ‹" class="headerlink" title="å¯¹æ–°è§†é¢‘é¢„æµ‹"></a>å¯¹æ–°è§†é¢‘é¢„æµ‹</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># å‘½ä»¤è¡Œæ–¹å¼å®ç°</span><br><span class="line"># Deepsortç®—æ³•ä»…éœ€æŒ‡å®š config æ–‡ä»¶ï¼Œä¸éœ€æŒ‡å®š checkpoint æ–‡ä»¶</span><br><span class="line">python demo/demo_mot_vis.py \</span><br><span class="line">        configs/mot/deepsort/deepsort_faster-rcnn_fpn_4e_mot17-new.py \</span><br><span class="line">        --input data/mot_people_short.mp4 \</span><br><span class="line">        --output outputs/I1_MOT_people_short.mp4</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Python API æ–¹å¼å®ç°</span></span><br><span class="line"><span class="keyword">import</span> mmcv</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">from</span> mmtrack.apis <span class="keyword">import</span> inference_mot, init_model</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å…¥è¾“å‡ºè§†é¢‘è·¯å¾„</span></span><br><span class="line">input_video = <span class="string">&#x27;data/mot_people_short.mp4&#x27;</span></span><br><span class="line">output = <span class="string">&#x27;outputs/I2_MOT_people_short.mp4&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®š config é…ç½®æ–‡ä»¶ å’Œ æ¨¡å‹æƒé‡æ–‡ä»¶ï¼Œåˆ›å»ºæ¨¡å‹</span></span><br><span class="line">mot_config = <span class="string">&#x27;./configs/mot/deepsort/deepsort_faster-rcnn_fpn_4e_mot17-new.py&#x27;</span></span><br><span class="line"><span class="comment"># åˆå§‹åŒ–æ¨¡å‹</span></span><br><span class="line">mot_model = init_model(mot_config, device=<span class="string">&#x27;cuda:0&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯»å…¥å¾…é¢„æµ‹è§†é¢‘</span></span><br><span class="line">imgs = mmcv.VideoReader(input_video)</span><br><span class="line">prog_bar = mmcv.ProgressBar(<span class="built_in">len</span>(imgs))</span><br><span class="line">out_dir = tempfile.TemporaryDirectory()</span><br><span class="line">out_path = out_dir.name</span><br><span class="line"><span class="comment"># é€å¸§è¾“å…¥æ¨¡å‹é¢„æµ‹</span></span><br><span class="line"><span class="keyword">for</span> i, img <span class="keyword">in</span> <span class="built_in">enumerate</span>(imgs):</span><br><span class="line">    result = inference_mot(mot_model, img, frame_id=i)</span><br><span class="line">    </span><br><span class="line">    mot_model.show_result(</span><br><span class="line">            img,</span><br><span class="line">            result,</span><br><span class="line">            show=<span class="literal">False</span>,</span><br><span class="line">            wait_time=<span class="built_in">int</span>(<span class="number">1000.</span> / imgs.fps),</span><br><span class="line">            out_file=<span class="string">f&#x27;<span class="subst">&#123;out_path&#125;</span>/<span class="subst">&#123;i:06d&#125;</span>.jpg&#x27;</span>)</span><br><span class="line">    prog_bar.update()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;\n making the output video at <span class="subst">&#123;output&#125;</span> with a FPS of <span class="subst">&#123;imgs.fps&#125;</span>&#x27;</span>)</span><br><span class="line">mmcv.frames2video(out_path, output, fps=imgs.fps, fourcc=<span class="string">&#x27;mp4v&#x27;</span>)</span><br><span class="line">out_dir.cleanup()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> ç›®æ ‡è¿½è¸ªç³»åˆ— </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Œç›®æ ‡è¿½è¸ªç³»åˆ—ã€ï¼ˆä¸‰ï¼‰åŸºäºç›®æ ‡è¿½è¸ªçš„äººæµé‡è®¡æ•°ä¸è¶³è¿¹ç»˜åˆ¶</title>
      <link href="/2022/05/22/%E3%80%8C%E7%9B%AE%E6%A0%87%E8%BF%BD%E8%B8%AA%E7%B3%BB%E5%88%97%E3%80%8D%EF%BC%88%E4%B8%89%EF%BC%89%E5%9F%BA%E4%BA%8E%E7%9B%AE%E6%A0%87%E8%BF%BD%E8%B8%AA%E7%9A%84%E4%BA%BA%E6%B5%81%E9%87%8F%E8%AE%A1%E6%95%B0%E4%B8%8E%E8%B6%B3%E8%BF%B9%E7%BB%98%E5%88%B6/"/>
      <url>/2022/05/22/%E3%80%8C%E7%9B%AE%E6%A0%87%E8%BF%BD%E8%B8%AA%E7%B3%BB%E5%88%97%E3%80%8D%EF%BC%88%E4%B8%89%EF%BC%89%E5%9F%BA%E4%BA%8E%E7%9B%AE%E6%A0%87%E8%BF%BD%E8%B8%AA%E7%9A%84%E4%BA%BA%E6%B5%81%E9%87%8F%E8%AE%A1%E6%95%B0%E4%B8%8E%E8%B6%B3%E8%BF%B9%E7%BB%98%E5%88%B6/</url>
      
        <content type="html"><![CDATA[<h2 id="äººæµé‡è®¡æ•°ä¸è¶³è¿¹ç»˜åˆ¶"><a href="#äººæµé‡è®¡æ•°ä¸è¶³è¿¹ç»˜åˆ¶" class="headerlink" title="äººæµé‡è®¡æ•°ä¸è¶³è¿¹ç»˜åˆ¶"></a>äººæµé‡è®¡æ•°ä¸è¶³è¿¹ç»˜åˆ¶</h2><h3 id="å•å¸§ç»˜åˆ¶"><a href="#å•å¸§ç»˜åˆ¶" class="headerlink" title="å•å¸§ç»˜åˆ¶"></a>å•å¸§ç»˜åˆ¶</h3><h4 id="å¯¼å…¥å·¥å…·åŒ…"><a href="#å¯¼å…¥å·¥å…·åŒ…" class="headerlink" title="å¯¼å…¥å·¥å…·åŒ…"></a>å¯¼å…¥å·¥å…·åŒ…</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯¼å…¥ opencv-python</span></span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> mmcv</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> seaborn <span class="keyword">as</span> sns</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¼å…¥å¯è§†åŒ–å·¥å…·åŒ… matplotlibï¼Œå¹¶è®©ç»˜åˆ¶çš„å›¾åƒåµŒå…¥åœ¨ notebook ä¸­</span></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">%matplotlib inline</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">from</span> mmtrack.apis <span class="keyword">import</span> inference_mot, init_model</span><br><span class="line">    </span><br><span class="line"><span class="comment"># å®šä¹‰å¯è§†åŒ–å›¾åƒå‡½æ•°ï¼Œè¾“å…¥å›¾åƒ arrayï¼Œå¯è§†åŒ–å›¾åƒ</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_img_from_array</span>(<span class="params">img</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;è¾“å…¥ arrayï¼Œmatplotlib å¯è§†åŒ–æ ¼å¼ä¸º RGBï¼Œå› æ­¤éœ€å°† BGR è½¬ RGBï¼Œæœ€åå¯è§†åŒ–å‡ºæ¥&#x27;&#x27;&#x27;</span></span><br><span class="line">    img_RGB = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)</span><br><span class="line">    plt.imshow(img_RGB)</span><br><span class="line">    plt.show()</span><br></pre></td></tr></table></figure><span id="more"></span><h4 id="ä»è§†é¢‘ä¸­è·å–æŸä¸€å¸§å›¾åƒ"><a href="#ä»è§†é¢‘ä¸­è·å–æŸä¸€å¸§å›¾åƒ" class="headerlink" title="ä»è§†é¢‘ä¸­è·å–æŸä¸€å¸§å›¾åƒ"></a>ä»è§†é¢‘ä¸­è·å–æŸä¸€å¸§å›¾åƒ</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¾“å…¥è¾“å‡ºè§†é¢‘è·¯å¾„</span></span><br><span class="line">input_video = <span class="string">&#x27;data/mot_people_short.mp4&#x27;</span></span><br><span class="line">output = <span class="string">&#x27;outputs/output_G1_MOT_people_short.mp4&#x27;</span></span><br><span class="line"><span class="comment"># è¯»å…¥è§†é¢‘</span></span><br><span class="line">imgs = mmcv.VideoReader(input_video)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–è§†é¢‘ç¬¬iå¸§ç”»é¢</span></span><br><span class="line">frame_id = <span class="number">0</span></span><br><span class="line">img = imgs[frame_id]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(img.shape)</span><br><span class="line">show_img_from_arrat(img)</span><br></pre></td></tr></table></figure><h4 id="å¯¼å…¥å¤šç›®æ ‡è¿½è¸ªæ¨¡å‹"><a href="#å¯¼å…¥å¤šç›®æ ‡è¿½è¸ªæ¨¡å‹" class="headerlink" title="å¯¼å…¥å¤šç›®æ ‡è¿½è¸ªæ¨¡å‹"></a>å¯¼å…¥å¤šç›®æ ‡è¿½è¸ªæ¨¡å‹</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŒ‡å®š config é…ç½®æ–‡ä»¶ å’Œ æ¨¡å‹æƒé‡æ–‡ä»¶ï¼Œåˆ›å»ºæ¨¡å‹</span></span><br><span class="line">mot_config = <span class="string">&#x27;./configs/mot/bytetrack/bytetrack_yolox_x_crowdhuman_mot17-private-half.py&#x27;</span></span><br><span class="line">mot_checkpoint = <span class="string">&#x27;https://download.openmmlab.com/mmtracking/mot/bytetrack/bytetrack_yolox_x/bytetrack_yolox_x_crowdhuman_mot17-private-half_20211218_205500-1985c9f0.pth&#x27;</span></span><br><span class="line"><span class="comment"># åˆå§‹åŒ–æ¨¡å‹</span></span><br><span class="line">mot_model = init_model(mot_config, mot_checkpoint, device=<span class="string">&#x27;cuda:0&#x27;</span>)</span><br></pre></td></tr></table></figure><h4 id="æ‰§è¡Œå¤šç›®æ ‡è¿½è¸ª"><a href="#æ‰§è¡Œå¤šç›®æ ‡è¿½è¸ª" class="headerlink" title="æ‰§è¡Œå¤šç›®æ ‡è¿½è¸ª"></a>æ‰§è¡Œå¤šç›®æ ‡è¿½è¸ª</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result = inference_mot(mot_model, img, frame_id=frame_id)</span><br></pre></td></tr></table></figure><h4 id="è§£æå¤šç›®æ ‡è¿½è¸ªresultç»“æœ"><a href="#è§£æå¤šç›®æ ‡è¿½è¸ªresultç»“æœ" class="headerlink" title="è§£æå¤šç›®æ ‡è¿½è¸ªresultç»“æœ"></a>è§£æå¤šç›®æ ‡è¿½è¸ªresultç»“æœ</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(result.keys())</span><br><span class="line"><span class="built_in">print</span>(result[<span class="string">&#x27;det_bboxes&#x27;</span>][<span class="number">0</span>][:<span class="number">10</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(result[<span class="string">&#x27;det_bboxes&#x27;</span>][<span class="number">0</span>]),<span class="built_in">len</span>(result[<span class="string">&#x27;track_bboxes&#x27;</span>][<span class="number">0</span>]))</span><br></pre></td></tr></table></figure><p>æ¯ä¸ªç›®æ ‡æ£€æµ‹æ¡†çš„å·¦ä¸Šè§’åæ ‡ã€å³ä¸‹è§’åæ ‡ã€ç½®ä¿¡åº¦</p><p>[0]è¡¨ç¤ºåªçœ‹è¡Œäººç±»åˆ«</p><p>IDã€å·¦ä¸Šè§’xã€å·¦ä¸Šè§’yã€å³ä¸‹è§’xã€å³ä¸‹è§’yã€ç½®ä¿¡åº¦</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(result[<span class="string">&#x27;track_bboxes&#x27;</span>][<span class="number">0</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(result[<span class="string">&#x27;track_bboxes&#x27;</span>][<span class="number">0</span>]))</span><br><span class="line"><span class="comment"># å½“å‰å¸§å„ç›®æ ‡çš„ID</span></span><br><span class="line"><span class="built_in">print</span>(result[<span class="string">&#x27;track_bboxes&#x27;</span>][<span class="number">0</span>][:,<span class="number">0</span>])</span><br></pre></td></tr></table></figure><h4 id="æ•´ç†å¤šç›®æ ‡è¿½è¸ªresultç»“æœ"><a href="#æ•´ç†å¤šç›®æ ‡è¿½è¸ªresultç»“æœ" class="headerlink" title="æ•´ç†å¤šç›®æ ‡è¿½è¸ªresultç»“æœ"></a>æ•´ç†å¤šç›®æ ‡è¿½è¸ªresultç»“æœ</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">from mmtrack.core import imshow_tracks, results2outs</span><br><span class="line">outs_track = results2outs(bbox_results=result.get(&#x27;track_bboxes&#x27;, None))</span><br><span class="line">print(outs_track)</span><br><span class="line"># å–å‡ºç»“æœ</span><br><span class="line">bboxes = outs_track.get(&#x27;bboxes&#x27;, None)</span><br><span class="line">labels = outs_track.get(&#x27;labels&#x27;, None)</span><br><span class="line">ids = outs_track.get(&#x27;ids&#x27;, None)</span><br><span class="line">print(labels, ids)</span><br></pre></td></tr></table></figure><h4 id="å¯è§†åŒ–é…ç½®-è°ƒè‰²æ¿"><a href="#å¯è§†åŒ–é…ç½®-è°ƒè‰²æ¿" class="headerlink" title="å¯è§†åŒ–é…ç½®-è°ƒè‰²æ¿"></a>å¯è§†åŒ–é…ç½®-è°ƒè‰²æ¿</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç”Ÿæˆè°ƒè‰²æ¿</span></span><br><span class="line">palette = sns.color_palette(<span class="string">&#x27;hls&#x27;</span>, <span class="number">25</span>)</span><br><span class="line"><span class="comment"># ä»è°ƒè‰²æ¿ä¸­éšæœºæŒ‘é€‰ä¸€ç§é¢œè‰²</span></span><br><span class="line">random.seed(<span class="number">3</span>)</span><br><span class="line">bbox_color = random.choice(palette)</span><br><span class="line">bbox_color = [<span class="built_in">int</span>(<span class="number">255</span> * c) <span class="keyword">for</span> c <span class="keyword">in</span> bbox_color][::-<span class="number">1</span>]</span><br><span class="line"><span class="built_in">print</span>(bbox_color)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_color</span>(<span class="params">seed</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    ä¼ å…¥è¿½è¸ªIDï¼Œç”Ÿæˆä¸“å±é¢œè‰²</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    random.seed(seed)</span><br><span class="line">    <span class="comment"># ä»è°ƒè‰²æ¿ä¸­éšæœºæŒ‘é€‰ä¸€ç§é¢œè‰²</span></span><br><span class="line">    bbox_color = random.choice(palette)</span><br><span class="line">    bbox_color = [<span class="built_in">int</span>(<span class="number">255</span> * c) <span class="keyword">for</span> c <span class="keyword">in</span> bbox_color][::-<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">return</span> bbox_color</span><br><span class="line"><span class="built_in">print</span>(get_color(<span class="number">3</span>))</span><br></pre></td></tr></table></figure><h4 id="å¯è§†åŒ–é…ç½®-ç›®æ ‡æ£€æµ‹çŸ©å½¢æ¡†"><a href="#å¯è§†åŒ–é…ç½®-ç›®æ ‡æ£€æµ‹çŸ©å½¢æ¡†" class="headerlink" title="å¯è§†åŒ–é…ç½®-ç›®æ ‡æ£€æµ‹çŸ©å½¢æ¡†"></a>å¯è§†åŒ–é…ç½®-ç›®æ ‡æ£€æµ‹çŸ©å½¢æ¡†</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç›®æ ‡æ£€æµ‹æ¡†çº¿å®½</span></span><br><span class="line">thickness = <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è½¨è¿¹çº¿ç²—ç»†</span></span><br><span class="line">trace_radius = <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç›®æ ‡æ£€æµ‹ç½®ä¿¡åº¦é˜ˆå€¼</span></span><br><span class="line">score_thr = <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å­—ä½“å¤§å°</span></span><br><span class="line">font_scale = <span class="number">0.4</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç½®ä¿¡åº¦å’Œ ID å•ä¸ªæ•°å­—çš„å®½é«˜</span></span><br><span class="line">text_width = <span class="number">9</span></span><br><span class="line">text_height = <span class="number">13</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç±»åˆ«ä¿¡æ¯</span></span><br><span class="line">classes = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç›®æ ‡æ£€æµ‹æ¡†çš„ xåæ ‡ ä¸è¶…è¿‡å›¾åƒå®½åº¦</span></span><br><span class="line">bboxes[:, [<span class="number">0</span>,<span class="number">2</span>]] = np.clip(bboxes[:, [<span class="number">0</span>,<span class="number">2</span>]], <span class="number">0</span>, img.shape[<span class="number">1</span>])</span><br><span class="line"><span class="comment"># ç›®æ ‡æ£€æµ‹æ¡†çš„ yåæ ‡ ä¸è¶…è¿‡å›¾åƒé«˜åº¦</span></span><br><span class="line">bboxes[:, [<span class="number">1</span>,<span class="number">3</span>]] = np.clip(bboxes[:, [<span class="number">1</span>,<span class="number">3</span>]], <span class="number">0</span>, img.shape[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç­›é€‰å‡ºç›®æ ‡æ£€æµ‹ç½®ä¿¡åº¦å¤§äºæŒ‡å®šé˜ˆå€¼çš„ç›®æ ‡ï¼Œå¹¶å–å‡ºå…¶ç´¢å¼•ã€ç›®æ ‡æ£€æµ‹ã€ç±»åˆ«ã€IDä¿¡æ¯</span></span><br><span class="line">inds = np.where(bboxes[:, -<span class="number">1</span>] &gt; score_thr)[<span class="number">0</span>]</span><br><span class="line">bboxes = bboxes[inds]</span><br><span class="line">labels = labels[inds]</span><br><span class="line">ids = ids[inds]</span><br><span class="line"></span><br><span class="line"><span class="comment"># éå†å½“å‰å¸§ä¸­çš„æ¯ä¸ªç›®æ ‡ï¼Œå¯è§†åŒ–</span></span><br><span class="line"><span class="keyword">for</span> i, (bbox, label, <span class="built_in">id</span>) <span class="keyword">in</span> <span class="built_in">enumerate</span>(<span class="built_in">zip</span>(bboxes, labels, ids)):</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è·å–ç›®æ ‡æ£€æµ‹æ¡†çš„å·¦ä¸Šè§’ã€å³ä¸‹è§’åæ ‡ï¼ŒåŠç½®ä¿¡åº¦</span></span><br><span class="line">    x1, y1, x2, y2 = bbox[:<span class="number">4</span>].astype(np.int32)</span><br><span class="line">    score = <span class="built_in">float</span>(bbox[-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ç»˜åˆ¶ç›®æ ‡æ£€æµ‹çŸ©å½¢æ¡†</span></span><br><span class="line">    bbox_color = get_color(<span class="built_in">id</span>)</span><br><span class="line">    cv2.rectangle(img, (x1, y1), (x2, y2), bbox_color, thickness=thickness)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ç½®ä¿¡åº¦æ–‡å­—</span></span><br><span class="line">    text = <span class="string">&#x27;&#123;:.02f&#125;&#x27;</span>.<span class="built_in">format</span>(score)</span><br><span class="line">    <span class="keyword">if</span> classes <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>: <span class="comment"># ç±»åˆ«ä¿¡æ¯</span></span><br><span class="line">        text += <span class="string">f&#x27;|<span class="subst">&#123;classes[label]&#125;</span>&#x27;</span></span><br><span class="line">    <span class="comment"># ç»˜åˆ¶ç½®ä¿¡åº¦æ–‡å­—çš„èƒŒæ™¯</span></span><br><span class="line">    width = <span class="built_in">len</span>(text) * text_width</span><br><span class="line">    img[y1:y1 + text_height, x1:x1 + width, :] = bbox_color</span><br><span class="line">    <span class="comment"># å†™ç½®ä¿¡åº¦æ–‡å­—ï¼šå›¾åƒï¼Œæ–‡å­—ï¼Œå·¦ä¸Šè§’åæ ‡ï¼Œå­—ä½“ï¼Œå­—ä½“å¤§å°ï¼Œé¢œè‰²ï¼Œå­—ä½“ç²—ç»†</span></span><br><span class="line">    cv2.putText(img, text, (x1, y1 + text_height - <span class="number">2</span>), cv2.FONT_HERSHEY_COMPLEX, font_scale, color=(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ç›®æ ‡ ID æ–‡å­—</span></span><br><span class="line">    text = <span class="built_in">str</span>(<span class="built_in">id</span>)</span><br><span class="line">    <span class="comment"># ç»˜åˆ¶ ID æ–‡å­—çš„èƒŒæ™¯</span></span><br><span class="line">    width = <span class="built_in">len</span>(text) * text_width</span><br><span class="line">    img[y1 + text_height:y1 + <span class="number">2</span> * text_height, x1:x1 + width, :] = bbox_color</span><br><span class="line">    <span class="comment"># å†™ ID æ–‡å­—ï¼šå›¾åƒï¼Œæ–‡å­—ï¼Œå·¦ä¸Šè§’åæ ‡ï¼Œå­—ä½“ï¼Œå­—ä½“å¤§å°ï¼Œé¢œè‰²ï¼Œå­—ä½“ç²—ç»†</span></span><br><span class="line">    cv2.putText(img, <span class="built_in">str</span>(<span class="built_in">id</span>), (x1, y1 + <span class="number">2</span> * text_height - <span class="number">2</span>), cv2.FONT_HERSHEY_COMPLEX, font_scale, color=(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line">     </span><br><span class="line">show_img_from_array(img)</span><br></pre></td></tr></table></figure><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2h6u851brj20ma0cswfp.jpg"></p><h3 id="å¤šå¸§ç»˜åˆ¶ã€Œå°è£…å‡½æ•°-äººæµé‡è®¡æ•°ä¸è¶³è¿¹ç»˜åˆ¶ã€"><a href="#å¤šå¸§ç»˜åˆ¶ã€Œå°è£…å‡½æ•°-äººæµé‡è®¡æ•°ä¸è¶³è¿¹ç»˜åˆ¶ã€" class="headerlink" title="å¤šå¸§ç»˜åˆ¶ã€Œå°è£…å‡½æ•°-äººæµé‡è®¡æ•°ä¸è¶³è¿¹ç»˜åˆ¶ã€"></a>å¤šå¸§ç»˜åˆ¶ã€Œå°è£…å‡½æ•°-äººæµé‡è®¡æ•°ä¸è¶³è¿¹ç»˜åˆ¶ã€</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯¼å…¥ opencv-python</span></span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> mmcv</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> seaborn <span class="keyword">as</span> sns</span><br><span class="line"><span class="comment"># å¯¼å…¥å¯è§†åŒ–å·¥å…·åŒ… matplotlibï¼Œå¹¶è®©ç»˜åˆ¶çš„å›¾åƒåµŒå…¥åœ¨ notebook ä¸­</span></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">%matplotlib inline</span><br><span class="line"><span class="keyword">import</span> mmcv</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">from</span> mmtrack.apis <span class="keyword">import</span> inference_mot, init_model</span><br><span class="line"><span class="keyword">from</span> mmtrack.core <span class="keyword">import</span> imshow_tracks, results2outs</span><br><span class="line">    </span><br><span class="line"><span class="comment"># å®šä¹‰å¯è§†åŒ–å›¾åƒå‡½æ•°ï¼Œè¾“å…¥å›¾åƒ arrayï¼Œå¯è§†åŒ–å›¾åƒ</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_img_from_array</span>(<span class="params">img</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;è¾“å…¥ arrayï¼Œmatplotlib å¯è§†åŒ–æ ¼å¼ä¸º RGBï¼Œå› æ­¤éœ€å°† BGR è½¬ RGBï¼Œæœ€åå¯è§†åŒ–å‡ºæ¥&#x27;&#x27;&#x27;</span></span><br><span class="line">    img_RGB = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)</span><br><span class="line">    plt.imshow(img_RGB)</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_color</span>(<span class="params">seed</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    ä¼ å…¥è¿½è¸ªIDï¼Œç”Ÿæˆä¸“å±é¢œè‰²</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    random.seed(seed)</span><br><span class="line">    <span class="comment"># ä»è°ƒè‰²æ¿ä¸­éšæœºæŒ‘é€‰ä¸€ç§é¢œè‰²</span></span><br><span class="line">    bbox_color = random.choice(palette)</span><br><span class="line">    bbox_color = [<span class="built_in">int</span>(<span class="number">255</span> * c) <span class="keyword">for</span> c <span class="keyword">in</span> bbox_color][::-<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">return</span> bbox_color</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_result</span>(<span class="params">result</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;å¤„ç†å•å¸§å‡½æ•°ï¼Œè¾“å…¥MOTå¤šç›®æ ‡è¿½è¸ªç»“æœï¼Œè¾“å‡º MOTå¤šç›®æ ‡è¿½è¸ªå¯è§†åŒ–å›¾åƒã€æ‰€æœ‰ç›®æ ‡è½¨è¿¹ä¸­å¿ƒç‚¹åæ ‡&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#######################</span></span><br><span class="line">    <span class="comment"># æ•´ç†å¤šç›®æ ‡è¿½è¸ªç»“æœ</span></span><br><span class="line">    <span class="comment">#######################</span></span><br><span class="line">    <span class="comment"># è¿›ä¸€æ­¥æ•´ç†resultç»“æœ</span></span><br><span class="line">    outs_track = results2outs(bbox_results=result.get(<span class="string">&#x27;track_bboxes&#x27;</span>, <span class="literal">None</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å–å‡ºç»“æœ</span></span><br><span class="line">    bboxes = outs_track.get(<span class="string">&#x27;bboxes&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">    labels = outs_track.get(<span class="string">&#x27;labels&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">    ids = outs_track.get(<span class="string">&#x27;ids&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ç›®æ ‡æ£€æµ‹æ¡†çš„ xåæ ‡ ä¸è¶…è¿‡å›¾åƒå®½åº¦</span></span><br><span class="line">    bboxes[:, [<span class="number">0</span>,<span class="number">2</span>]] = np.clip(bboxes[:, [<span class="number">0</span>,<span class="number">2</span>]], <span class="number">0</span>, img.shape[<span class="number">1</span>])</span><br><span class="line">    <span class="comment"># ç›®æ ‡æ£€æµ‹æ¡†çš„ yåæ ‡ ä¸è¶…è¿‡å›¾åƒé«˜åº¦</span></span><br><span class="line">    bboxes[:, [<span class="number">1</span>,<span class="number">3</span>]] = np.clip(bboxes[:, [<span class="number">1</span>,<span class="number">3</span>]], <span class="number">0</span>, img.shape[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ç­›é€‰å‡ºç›®æ ‡æ£€æµ‹ç½®ä¿¡åº¦å¤§äºæŒ‡å®šé˜ˆå€¼çš„ç›®æ ‡ï¼Œå¹¶å–å‡ºå…¶ç´¢å¼•ã€ç›®æ ‡æ£€æµ‹ã€ç±»åˆ«ã€IDä¿¡æ¯</span></span><br><span class="line">    inds = np.where(bboxes[:, -<span class="number">1</span>] &gt; score_thr)[<span class="number">0</span>]</span><br><span class="line">    bboxes = bboxes[inds]</span><br><span class="line">    labels = labels[inds]</span><br><span class="line">    ids = ids[inds]</span><br><span class="line"></span><br><span class="line">    <span class="comment">#######################</span></span><br><span class="line">    <span class="comment"># éå†æ¯ä¸ªç›®æ ‡ï¼Œå¯è§†åŒ–</span></span><br><span class="line">    <span class="comment">#######################</span></span><br><span class="line">    trace_coords_frame = [] <span class="comment"># å­˜æ”¾å½“å‰å¸§ç”»é¢ä¸­ æ‰€æœ‰ç›®æ ‡è½¨è¿¹ä¸­å¿ƒç‚¹åæ ‡</span></span><br><span class="line">    <span class="keyword">for</span> i, (bbox, label, <span class="built_in">id</span>) <span class="keyword">in</span> <span class="built_in">enumerate</span>(<span class="built_in">zip</span>(bboxes, labels, ids)):</span><br><span class="line">        <span class="comment"># è·å–ç›®æ ‡æ£€æµ‹æ¡†çš„å·¦ä¸Šè§’ã€å³ä¸‹è§’åæ ‡ï¼ŒåŠç½®ä¿¡åº¦</span></span><br><span class="line">        x1, y1, x2, y2 = bbox[:<span class="number">4</span>].astype(np.int32)</span><br><span class="line">        score = <span class="built_in">float</span>(bbox[-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ç»˜åˆ¶ç›®æ ‡æ£€æµ‹çŸ©å½¢æ¡†</span></span><br><span class="line">        bbox_color = get_color(<span class="built_in">id</span>)</span><br><span class="line">        cv2.rectangle(img, (x1, y1), (x2, y2), bbox_color, thickness=thickness)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ç»˜åˆ¶çŸ©å½¢æ¡†ä¸­å¿ƒç‚¹è½¨è¿¹ç‚¹ï¼ŒæŒ‡å®šåœ†å¿ƒåæ ‡å’ŒåŠå¾„ï¼Œçº¢è‰²ï¼Œæœ€åä¸€ä¸ªå‚æ•°ä¸ºçº¿å®½ï¼Œ-1è¡¨ç¤ºå¡«å……</span></span><br><span class="line">        <span class="comment"># trace_coord = &#123;id:[[(x1+x2)//2, (y1+y2)//2], bbox_color]&#125;</span></span><br><span class="line">        <span class="comment"># trace_coord_obj = [id, [(x1+x2)//2, (y1+y2)//2, bbox_color]] # ç›®æ ‡æ£€æµ‹æ¡†ä¸­å¿ƒç‚¹ä½œä¸ºè½¨è¿¹ç‚¹</span></span><br><span class="line">        trace_coord_obj = [<span class="built_in">id</span>, [(x1+x2)//<span class="number">2</span>, y2, bbox_color]]           <span class="comment"># ç›®æ ‡æ£€æµ‹æ¡†åº•è¾¹ä¸­ç‚¹ä½œä¸ºè½¨è¿¹ç‚¹</span></span><br><span class="line">        trace_coords_frame.append(trace_coord_obj)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ç½®ä¿¡åº¦æ–‡å­—</span></span><br><span class="line">        text = <span class="string">&#x27;&#123;:.02f&#125;&#x27;</span>.<span class="built_in">format</span>(score)</span><br><span class="line">        <span class="keyword">if</span> classes <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>: <span class="comment"># ç±»åˆ«ä¿¡æ¯</span></span><br><span class="line">            text += <span class="string">f&#x27;|<span class="subst">&#123;classes[label]&#125;</span>&#x27;</span></span><br><span class="line">        <span class="comment"># ç»˜åˆ¶ç½®ä¿¡åº¦æ–‡å­—çš„èƒŒæ™¯</span></span><br><span class="line">        width = <span class="built_in">len</span>(text) * text_width</span><br><span class="line">        img[y1:y1 + text_height, x1:x1 + width, :] = bbox_color</span><br><span class="line">        <span class="comment"># å†™ç½®ä¿¡åº¦æ–‡å­—ï¼šå›¾åƒï¼Œæ–‡å­—ï¼Œå·¦ä¸Šè§’åæ ‡ï¼Œå­—ä½“ï¼Œå­—ä½“å¤§å°ï¼Œé¢œè‰²ï¼Œå­—ä½“ç²—ç»†</span></span><br><span class="line">        cv2.putText(img, text, (x1, y1 + text_height - <span class="number">2</span>), cv2.FONT_HERSHEY_COMPLEX, font_scale, color=(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ID</span></span><br><span class="line">        text = <span class="built_in">str</span>(<span class="built_in">id</span>)</span><br><span class="line">        <span class="comment"># ç»˜åˆ¶IDæ–‡å­—çš„èƒŒæ™¯</span></span><br><span class="line">        width = <span class="built_in">len</span>(text) * text_width</span><br><span class="line">        img[y1 + text_height:y1 + <span class="number">2</span> * text_height, x1:x1 + width, :] = bbox_color</span><br><span class="line">        <span class="comment"># å†™ IDæ–‡å­—ï¼šå›¾åƒï¼Œæ–‡å­—ï¼Œå·¦ä¸Šè§’åæ ‡ï¼Œå­—ä½“ï¼Œå­—ä½“å¤§å°ï¼Œé¢œè‰²ï¼Œå­—ä½“ç²—ç»†</span></span><br><span class="line">        cv2.putText(img, <span class="built_in">str</span>(<span class="built_in">id</span>), (x1, y1 + <span class="number">2</span> * text_height - <span class="number">2</span>), cv2.FONT_HERSHEY_COMPLEX, font_scale, color=(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> img, trace_coords_frame</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">thickness = <span class="number">2</span>  <span class="comment"># ç›®æ ‡æ£€æµ‹æ¡†çº¿å®½</span></span><br><span class="line">trace_radius = <span class="number">10</span>  <span class="comment"># è½¨è¿¹çº¿ç²—ç»†</span></span><br><span class="line">score_thr = <span class="number">0.0</span>  <span class="comment"># ç›®æ ‡æ£€æµ‹ç½®ä¿¡åº¦é˜ˆå€¼</span></span><br><span class="line">font_scale = <span class="number">0.4</span>  <span class="comment"># å­—ä½“å¤§å°</span></span><br><span class="line">text_width = <span class="number">9</span></span><br><span class="line">text_height = <span class="number">13</span>  <span class="comment"># ç½®ä¿¡åº¦å’Œ ID å•ä¸ªæ•°å­—çš„å®½é«˜</span></span><br><span class="line">classes = <span class="literal">None</span>  <span class="comment"># ç±»åˆ«ä¿¡æ¯</span></span><br><span class="line">palette = sns.color_palette(<span class="string">&#x27;hls&#x27;</span>,<span class="number">30</span>)  <span class="comment"># ç”Ÿæˆè°ƒè‰²æ¿</span></span><br><span class="line">thickness = <span class="number">2</span>  <span class="comment"># ç›®æ ‡æ£€æµ‹æ¡†çº¿å®½</span></span><br><span class="line">trace_radius = <span class="number">10</span>  <span class="comment"># è½¨è¿¹çº¿ç²—ç»†</span></span><br><span class="line">score_thr=<span class="number">0.0</span>  <span class="comment"># ç›®æ ‡æ£€æµ‹ç½®ä¿¡åº¦é˜ˆå€¼</span></span><br><span class="line">font_scale=<span class="number">0.4</span>  <span class="comment"># å­—ä½“å¤§å°</span></span><br><span class="line">text_width = <span class="number">9</span></span><br><span class="line">text_height = <span class="number">13</span>  <span class="comment"># ç½®ä¿¡åº¦å’Œ ID å•ä¸ªæ•°å­—çš„å®½é«˜</span></span><br><span class="line">classes = <span class="literal">None</span>  <span class="comment"># ç±»åˆ«ä¿¡æ¯ </span></span><br><span class="line"><span class="comment"># è¾“å…¥è¾“å‡ºè§†é¢‘è·¯å¾„</span></span><br><span class="line">input_video = <span class="string">&#x27;data/mot_people_short.mp4&#x27;</span></span><br><span class="line">output = <span class="string">&#x27;outputs/G1_MOT_people_short.mp4&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## ByteTrackç®—æ³•</span></span><br><span class="line"><span class="comment"># æŒ‡å®š config é…ç½®æ–‡ä»¶ å’Œ æ¨¡å‹æƒé‡æ–‡ä»¶ï¼Œåˆ›å»ºæ¨¡å‹</span></span><br><span class="line">mot_config = <span class="string">&#x27;./configs/mot/bytetrack/bytetrack_yolox_x_crowdhuman_mot17-private-half.py&#x27;</span></span><br><span class="line">mot_checkpoint = <span class="string">&#x27;https://download.openmmlab.com/mmtracking/mot/bytetrack/bytetrack_yolox_x/bytetrack_yolox_x_crowdhuman_mot17-private-half_20211218_205500-1985c9f0.pth&#x27;</span></span><br><span class="line"><span class="comment"># åˆå§‹åŒ–æ¨¡å‹</span></span><br><span class="line">mot_model = init_model(mot_config, mot_checkpoint, device=<span class="string">&#x27;cuda:0&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## Deepsortç®—æ³•</span></span><br><span class="line"><span class="comment"># # æŒ‡å®š config é…ç½®æ–‡ä»¶ å’Œ æ¨¡å‹æƒé‡æ–‡ä»¶ï¼Œåˆ›å»ºæ¨¡å‹</span></span><br><span class="line"><span class="comment"># mot_config = &#x27;./configs/mot/deepsort/deepsort_faster-rcnn_fpn_4e_mot17-private-half.py&#x27;</span></span><br><span class="line"><span class="comment"># # åˆå§‹åŒ–æ¨¡å‹</span></span><br><span class="line"><span class="comment"># mot_model = init_model(mot_config, device=&#x27;cuda:0&#x27;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯»å…¥å¾…é¢„æµ‹è§†é¢‘</span></span><br><span class="line">imgs = mmcv.VideoReader(input_video)</span><br><span class="line"></span><br><span class="line">prog_bar = mmcv.ProgressBar(<span class="built_in">len</span>(imgs))</span><br><span class="line">out_dir = tempfile.TemporaryDirectory()</span><br><span class="line">out_path = out_dir.name</span><br><span class="line"></span><br><span class="line"><span class="comment"># äººæ•°è®¡æ•°</span></span><br><span class="line">num = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®°å½•æ¯ä¸€å¸§çš„å„ç›®æ ‡è½¨è¿¹ç‚¹åæ ‡</span></span><br><span class="line">trace_coord_video = []</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¹è§†é¢‘é€å¸§å¤„ç†</span></span><br><span class="line"><span class="keyword">for</span> frame_id, img <span class="keyword">in</span> <span class="built_in">enumerate</span>(imgs):</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#######################</span></span><br><span class="line">    <span class="comment"># è¿è¡Œå¤šç›®æ ‡è¿½è¸ª</span></span><br><span class="line">    <span class="comment">#######################</span></span><br><span class="line">    result = inference_mot(mot_model, img, frame_id=frame_id)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è·å–å½“å‰å¸§ç›®æ ‡æ£€æµ‹å¯è§†åŒ–æ•ˆæœï¼ŒåŠå„ç›®æ ‡è½¨è¿¹ç‚¹åæ ‡</span></span><br><span class="line">    img, trace_coord_frame = process_result(result)</span><br><span class="line">    trace_coord_video.append(trace_coord_frame)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#######################</span></span><br><span class="line">    <span class="comment"># ç»˜åˆ¶è½¨è¿¹ç‚¹ï¼šä»ç¬¬ä¸€å¸§åˆ°å½“å‰å¸§ æ‰€æœ‰ç›®æ ‡çš„è½¨è¿¹ç‚¹</span></span><br><span class="line">    <span class="comment">#######################</span></span><br><span class="line">    <span class="keyword">for</span> trace_coord_frame <span class="keyword">in</span> trace_coord_video: <span class="comment"># éå†æ¯ä¸€å¸§</span></span><br><span class="line">        <span class="keyword">for</span> trace_coord_obj <span class="keyword">in</span> trace_coord_frame: <span class="comment"># éå†æ¯ä¸€ä¸ªç›®æ ‡</span></span><br><span class="line">            <span class="comment"># ç»˜åˆ¶åœ†ï¼ŒæŒ‡å®šåœ†å¿ƒåæ ‡å’ŒåŠå¾„ï¼Œé¢œè‰²ï¼Œæœ€åä¸€ä¸ªå‚æ•°ä¸ºçº¿å®½ï¼Œ-1è¡¨ç¤ºå¡«å……</span></span><br><span class="line">            cv2.circle(img, (trace_coord_obj[<span class="number">1</span>][<span class="number">0</span>], trace_coord_obj[<span class="number">1</span>][<span class="number">1</span>]),<span class="number">5</span>, trace_coord_obj[<span class="number">1</span>][<span class="number">2</span>], -<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#######################</span></span><br><span class="line">    <span class="comment">#  è·å–äººæ•°</span></span><br><span class="line">    <span class="comment">#######################</span></span><br><span class="line">    <span class="comment"># ç”¨å½“å‰æœ€å¤§çš„ ID å·ä½œä¸ºäººæ•°å€¼</span></span><br><span class="line">    <span class="keyword">if</span> result[<span class="string">&#x27;track_bboxes&#x27;</span>][<span class="number">0</span>][:,<span class="number">0</span>].<span class="built_in">any</span>(): <span class="comment"># æ£€æµ‹å‡ºè¡Œäºº</span></span><br><span class="line">        num = <span class="built_in">max</span>(num, <span class="number">1</span>+<span class="built_in">max</span>(result[<span class="string">&#x27;track_bboxes&#x27;</span>][<span class="number">0</span>][:,<span class="number">0</span>]))</span><br><span class="line">    <span class="keyword">else</span>: <span class="comment"># æ²¡æœ‰æ£€æµ‹å‡ºè¡Œäºº</span></span><br><span class="line">        num = num</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å¯è§†åŒ–æ€»äººæ•°ï¼šå›¾ç‰‡ï¼Œæ·»åŠ çš„æ–‡å­—ï¼Œå·¦ä¸Šè§’åæ ‡ï¼Œå­—ä½“ï¼Œå­—ä½“å¤§å°ï¼Œé¢œè‰²ï¼Œå­—ä½“ç²—ç»†</span></span><br><span class="line">    img = cv2.putText(img, <span class="built_in">str</span>(<span class="built_in">int</span>(num)), (<span class="number">25</span>, <span class="number">150</span>), cv2.FONT_HERSHEY_SIMPLEX, <span class="number">5</span>, (<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>), <span class="number">3</span>)</span><br><span class="line">    <span class="comment"># å¯è§†åŒ–å½“å‰äººæ•°</span></span><br><span class="line">    img = cv2.putText(img, <span class="built_in">str</span>(<span class="built_in">len</span>(trace_coord_frame)), (<span class="number">25</span>, <span class="number">350</span>), cv2.FONT_HERSHEY_SIMPLEX, <span class="number">5</span>, (<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å°†å¤„ç†åçš„è¯¥å¸§ç”»é¢å›¾åƒæ–‡ä»¶ï¼Œä¿å­˜è‡³ /tmp ç›®å½•ä¸‹</span></span><br><span class="line">    cv2.imwrite(<span class="string">f&#x27;<span class="subst">&#123;out_path&#125;</span>/<span class="subst">&#123;frame_id:06d&#125;</span>.jpg&#x27;</span>, img)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ›´æ–°è¿›åº¦æ¡</span></span><br><span class="line">    prog_bar.update()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”±æ¯ä¸€å¸§çš„å›¾åƒæ–‡ä»¶ï¼Œç”Ÿæˆè§†é¢‘</span></span><br><span class="line">mmcv.frames2video(out_path, output, fps=imgs.fps, fourcc=<span class="string">&#x27;mp4v&#x27;</span>)</span><br><span class="line">out_dir.cleanup()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;å¸§å›¾åƒä¿å­˜è·¯å¾„&#x27;</span>,out_path)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;æ€»äººæ•°&#x27;</span>, <span class="built_in">int</span>(num))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(trace_coord_video))</span><br><span class="line"><span class="comment"># ç¬¬ä¸€å¸§çš„ç›®æ ‡IDã€è½¨è¿¹åæ ‡ã€é¢œè‰²</span></span><br><span class="line"><span class="built_in">print</span>(trace_coord_video[<span class="number">70</span>])</span><br></pre></td></tr></table></figure><h3 id="ç»“æœå±•ç¤º"><a href="#ç»“æœå±•ç¤º" class="headerlink" title="ç»“æœå±•ç¤º"></a>ç»“æœå±•ç¤º</h3><iframe src="//player.bilibili.com/player.html?aid=811756893&bvid=BV1W34y1E7kY&cid=726748462&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe><h2 id="äººæµé‡è®¡æ•°å›¾è¡¨å¯è§†åŒ–ä¸è¶³è¿¹ç»˜åˆ¶"><a href="#äººæµé‡è®¡æ•°å›¾è¡¨å¯è§†åŒ–ä¸è¶³è¿¹ç»˜åˆ¶" class="headerlink" title="äººæµé‡è®¡æ•°å›¾è¡¨å¯è§†åŒ–ä¸è¶³è¿¹ç»˜åˆ¶"></a>äººæµé‡è®¡æ•°å›¾è¡¨å¯è§†åŒ–ä¸è¶³è¿¹ç»˜åˆ¶</h2><h3 id="å¯¼å…¥å·¥å…·åŒ…-1"><a href="#å¯¼å…¥å·¥å…·åŒ…-1" class="headerlink" title="å¯¼å…¥å·¥å…·åŒ…"></a>å¯¼å…¥å·¥å…·åŒ…</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯¼å…¥ opencv-python</span></span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> mmcv</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> seaborn <span class="keyword">as</span> sns</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¼å…¥å¯è§†åŒ–å·¥å…·åŒ… matplotlibï¼Œå¹¶è®©ç»˜åˆ¶çš„å›¾åƒåµŒå…¥åœ¨ notebook ä¸­</span></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">%matplotlib inline</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> mmcv</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">from</span> mmtrack.apis <span class="keyword">import</span> inference_mot, init_model</span><br><span class="line"><span class="keyword">from</span> mmtrack.core <span class="keyword">import</span> imshow_tracks, results2outs</span><br><span class="line">    </span><br><span class="line"><span class="comment"># å®šä¹‰å¯è§†åŒ–å›¾åƒå‡½æ•°ï¼Œè¾“å…¥å›¾åƒ arrayï¼Œå¯è§†åŒ–å›¾åƒ</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_img_from_array</span>(<span class="params">img</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;è¾“å…¥ arrayï¼Œmatplotlib å¯è§†åŒ–æ ¼å¼ä¸º RGBï¼Œå› æ­¤éœ€å°† BGR è½¬ RGBï¼Œæœ€åå¯è§†åŒ–å‡ºæ¥&#x27;&#x27;&#x27;</span></span><br><span class="line">    img_RGB = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)</span><br><span class="line">    plt.imshow(img_RGB)</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_color</span>(<span class="params">seed</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    ä¼ å…¥è¿½è¸ªIDï¼Œç”Ÿæˆä¸“å±é¢œè‰²</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    random.seed(seed)</span><br><span class="line">    <span class="comment"># ä»è°ƒè‰²æ¿ä¸­éšæœºæŒ‘é€‰ä¸€ç§é¢œè‰²</span></span><br><span class="line">    bbox_color = random.choice(palette)</span><br><span class="line">    bbox_color = [<span class="built_in">int</span>(<span class="number">255</span> * c) <span class="keyword">for</span> c <span class="keyword">in</span> bbox_color][::-<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">return</span> bbox_color</span><br></pre></td></tr></table></figure><h3 id="åŸºç¡€å¯è§†åŒ–è®¾ç½®"><a href="#åŸºç¡€å¯è§†åŒ–è®¾ç½®" class="headerlink" title="åŸºç¡€å¯è§†åŒ–è®¾ç½®"></a>åŸºç¡€å¯è§†åŒ–è®¾ç½®</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mmtrack.core <span class="keyword">import</span> imshow_tracks, results2outs</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç›®æ ‡æ£€æµ‹æ¡†çº¿å®½</span></span><br><span class="line">thickness = <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è½¨è¿¹çº¿ç²—ç»†</span></span><br><span class="line">trace_radius = <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç›®æ ‡æ£€æµ‹ç½®ä¿¡åº¦é˜ˆå€¼</span></span><br><span class="line">score_thr = <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å­—ä½“å¤§å°</span></span><br><span class="line">font_scale = <span class="number">0.4</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># ç½®ä¿¡åº¦å’Œ ID å•ä¸ªæ•°å­—çš„å®½é«˜</span></span><br><span class="line">text_width = <span class="number">9</span></span><br><span class="line">text_height = <span class="number">13</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç±»åˆ«ä¿¡æ¯</span></span><br><span class="line">classes = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆè°ƒè‰²æ¿</span></span><br><span class="line">palette = sns.color_palette(<span class="string">&#x27;hls&#x27;</span>,<span class="number">30</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç›®æ ‡æ£€æµ‹æ¡†çº¿å®½</span></span><br><span class="line">thickness = <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è½¨è¿¹çº¿ç²—ç»†</span></span><br><span class="line">trace_radius = <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç›®æ ‡æ£€æµ‹ç½®ä¿¡åº¦é˜ˆå€¼</span></span><br><span class="line">score_thr=<span class="number">0.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å­—ä½“å¤§å°</span></span><br><span class="line">font_scale=<span class="number">0.4</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç½®ä¿¡åº¦å’Œ ID å•ä¸ªæ•°å­—çš„å®½é«˜</span></span><br><span class="line">text_width = <span class="number">9</span></span><br><span class="line">text_height = <span class="number">13</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç±»åˆ«ä¿¡æ¯</span></span><br><span class="line">classes = <span class="literal">None</span></span><br></pre></td></tr></table></figure><h3 id="è¾…åŠ©å‡½æ•°"><a href="#è¾…åŠ©å‡½æ•°" class="headerlink" title="è¾…åŠ©å‡½æ•°"></a>è¾…åŠ©å‡½æ•°</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_color</span>(<span class="params">seed</span>):</span><br><span class="line">    random.seed(seed)</span><br><span class="line">    <span class="comment"># ä»è°ƒè‰²æ¿ä¸­éšæœºæŒ‘é€‰ä¸€ç§é¢œè‰²</span></span><br><span class="line">    bbox_color = random.choice(palette)</span><br><span class="line">    bbox_color = [<span class="built_in">int</span>(<span class="number">255</span> * c) <span class="keyword">for</span> c <span class="keyword">in</span> bbox_color][::-<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">return</span> bbox_color</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_result</span>(<span class="params">result</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;å¤„ç†å•å¸§å‡½æ•°ï¼Œè¾“å…¥MOTå¤šç›®æ ‡è¿½è¸ªç»“æœï¼Œè¾“å‡º MOTå¤šç›®æ ‡è¿½è¸ªå¯è§†åŒ–å›¾åƒã€æ‰€æœ‰ç›®æ ‡è½¨è¿¹ä¸­å¿ƒç‚¹åæ ‡&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#######################</span></span><br><span class="line">    <span class="comment"># æ•´ç†å¤šç›®æ ‡è¿½è¸ªç»“æœ</span></span><br><span class="line">    <span class="comment">#######################</span></span><br><span class="line">    <span class="comment"># è¿›ä¸€æ­¥æ•´ç†resultç»“æœ</span></span><br><span class="line">    outs_track = results2outs(bbox_results=result.get(<span class="string">&#x27;track_bboxes&#x27;</span>, <span class="literal">None</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å–å‡ºç»“æœ</span></span><br><span class="line">    bboxes = outs_track.get(<span class="string">&#x27;bboxes&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">    labels = outs_track.get(<span class="string">&#x27;labels&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">    ids = outs_track.get(<span class="string">&#x27;ids&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ç›®æ ‡æ£€æµ‹æ¡†çš„ xåæ ‡ ä¸è¶…è¿‡å›¾åƒå®½åº¦</span></span><br><span class="line">    bboxes[:, [<span class="number">0</span>,<span class="number">2</span>]] = np.clip(bboxes[:, [<span class="number">0</span>,<span class="number">2</span>]], <span class="number">0</span>, img.shape[<span class="number">1</span>])</span><br><span class="line">    <span class="comment"># ç›®æ ‡æ£€æµ‹æ¡†çš„ yåæ ‡ ä¸è¶…è¿‡å›¾åƒé«˜åº¦</span></span><br><span class="line">    bboxes[:, [<span class="number">1</span>,<span class="number">3</span>]] = np.clip(bboxes[:, [<span class="number">1</span>,<span class="number">3</span>]], <span class="number">0</span>, img.shape[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ç­›é€‰å‡ºç›®æ ‡æ£€æµ‹ç½®ä¿¡åº¦å¤§äºæŒ‡å®šé˜ˆå€¼çš„ç›®æ ‡ï¼Œå¹¶å–å‡ºå…¶ç´¢å¼•ã€ç›®æ ‡æ£€æµ‹ã€ç±»åˆ«ã€IDä¿¡æ¯</span></span><br><span class="line">    inds = np.where(bboxes[:, -<span class="number">1</span>] &gt; score_thr)[<span class="number">0</span>]</span><br><span class="line">    bboxes = bboxes[inds]</span><br><span class="line">    labels = labels[inds]</span><br><span class="line">    ids = ids[inds]</span><br><span class="line"></span><br><span class="line">    <span class="comment">#######################</span></span><br><span class="line">    <span class="comment"># éå†æ¯ä¸ªç›®æ ‡ï¼Œå¯è§†åŒ–</span></span><br><span class="line">    <span class="comment">#######################</span></span><br><span class="line">    trace_coords_frame = [] <span class="comment"># å­˜æ”¾å½“å‰å¸§ç”»é¢ä¸­ æ‰€æœ‰ç›®æ ‡è½¨è¿¹ä¸­å¿ƒç‚¹åæ ‡</span></span><br><span class="line">    <span class="keyword">for</span> i, (bbox, label, <span class="built_in">id</span>) <span class="keyword">in</span> <span class="built_in">enumerate</span>(<span class="built_in">zip</span>(bboxes, labels, ids)):</span><br><span class="line">        <span class="comment"># è·å–ç›®æ ‡æ£€æµ‹æ¡†çš„å·¦ä¸Šè§’ã€å³ä¸‹è§’åæ ‡ï¼ŒåŠç½®ä¿¡åº¦</span></span><br><span class="line">        x1, y1, x2, y2 = bbox[:<span class="number">4</span>].astype(np.int32)</span><br><span class="line">        score = <span class="built_in">float</span>(bbox[-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ç»˜åˆ¶ç›®æ ‡æ£€æµ‹çŸ©å½¢æ¡†</span></span><br><span class="line">        bbox_color = get_color(<span class="built_in">id</span>)</span><br><span class="line">        cv2.rectangle(img, (x1, y1), (x2, y2), bbox_color, thickness=thickness)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ç»˜åˆ¶çŸ©å½¢æ¡†ä¸­å¿ƒç‚¹è½¨è¿¹ç‚¹ï¼ŒæŒ‡å®šåœ†å¿ƒåæ ‡å’ŒåŠå¾„ï¼Œçº¢è‰²ï¼Œæœ€åä¸€ä¸ªå‚æ•°ä¸ºçº¿å®½ï¼Œ-1è¡¨ç¤ºå¡«å……</span></span><br><span class="line">        <span class="comment"># trace_coord = &#123;id:[[(x1+x2)//2, (y1+y2)//2], bbox_color]&#125;</span></span><br><span class="line">        <span class="comment"># trace_coord_obj = [id, [(x1+x2)//2, (y1+y2)//2, bbox_color]] # ç›®æ ‡æ£€æµ‹æ¡†ä¸­å¿ƒç‚¹ä½œä¸ºè½¨è¿¹ç‚¹</span></span><br><span class="line">        trace_coord_obj = [<span class="built_in">id</span>, [(x1+x2)//<span class="number">2</span>, y2, bbox_color]]           <span class="comment"># ç›®æ ‡æ£€æµ‹æ¡†åº•è¾¹ä¸­ç‚¹ä½œä¸ºè½¨è¿¹ç‚¹</span></span><br><span class="line">        trace_coords_frame.append(trace_coord_obj)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ç½®ä¿¡åº¦æ–‡å­—</span></span><br><span class="line">        text = <span class="string">&#x27;&#123;:.02f&#125;&#x27;</span>.<span class="built_in">format</span>(score)</span><br><span class="line">        <span class="keyword">if</span> classes <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>: <span class="comment"># ç±»åˆ«ä¿¡æ¯</span></span><br><span class="line">            text += <span class="string">f&#x27;|<span class="subst">&#123;classes[label]&#125;</span>&#x27;</span></span><br><span class="line">        <span class="comment"># ç»˜åˆ¶ç½®ä¿¡åº¦æ–‡å­—çš„èƒŒæ™¯</span></span><br><span class="line">        width = <span class="built_in">len</span>(text) * text_width</span><br><span class="line">        img[y1:y1 + text_height, x1:x1 + width, :] = bbox_color</span><br><span class="line">        <span class="comment"># å†™ç½®ä¿¡åº¦æ–‡å­—ï¼šå›¾åƒï¼Œæ–‡å­—ï¼Œå·¦ä¸Šè§’åæ ‡ï¼Œå­—ä½“ï¼Œå­—ä½“å¤§å°ï¼Œé¢œè‰²ï¼Œå­—ä½“ç²—ç»†</span></span><br><span class="line">        cv2.putText(img, text, (x1, y1 + text_height - <span class="number">2</span>), cv2.FONT_HERSHEY_COMPLEX, font_scale, color=(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ID</span></span><br><span class="line">        text = <span class="built_in">str</span>(<span class="built_in">id</span>)</span><br><span class="line">        <span class="comment"># ç»˜åˆ¶IDæ–‡å­—çš„èƒŒæ™¯</span></span><br><span class="line">        width = <span class="built_in">len</span>(text) * text_width</span><br><span class="line">        img[y1 + text_height:y1 + <span class="number">2</span> * text_height, x1:x1 + width, :] = bbox_color</span><br><span class="line">        <span class="comment"># å†™ IDæ–‡å­—ï¼šå›¾åƒï¼Œæ–‡å­—ï¼Œå·¦ä¸Šè§’åæ ‡ï¼Œå­—ä½“ï¼Œå­—ä½“å¤§å°ï¼Œé¢œè‰²ï¼Œå­—ä½“ç²—ç»†</span></span><br><span class="line">        cv2.putText(img, <span class="built_in">str</span>(<span class="built_in">id</span>), (x1, y1 + <span class="number">2</span> * text_height - <span class="number">2</span>), cv2.FONT_HERSHEY_COMPLEX, font_scale, color=(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> img, trace_coords_frame</span><br></pre></td></tr></table></figure><h3 id="åˆ›å»ºå­˜æ”¾å›¾åƒçš„ä¸´æ—¶æ–‡ä»¶å¤¹"><a href="#åˆ›å»ºå­˜æ”¾å›¾åƒçš„ä¸´æ—¶æ–‡ä»¶å¤¹" class="headerlink" title="åˆ›å»ºå­˜æ”¾å›¾åƒçš„ä¸´æ—¶æ–‡ä»¶å¤¹"></a>åˆ›å»ºå­˜æ”¾å›¾åƒçš„ä¸´æ—¶æ–‡ä»¶å¤¹</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">temp_dir = time.strftime(<span class="string">&#x27;%Y%m%d%H%M%S&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> os.path.exists(temp_dir):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    os.mkdir(temp_dir)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;åˆ›å»ºæ–‡ä»¶å¤¹ &#123;&#125; ç”¨äºå­˜æ”¾æ¯å¸§å›¾åƒ&#x27;</span>.<span class="built_in">format</span>(temp_dir))</span><br><span class="line">    os.mkdir(temp_dir+<span class="string">&#x27;-plot&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;åˆ›å»ºæ–‡ä»¶å¤¹ &#123;&#125; ç”¨äºå­˜æ”¾æ¯å¸§å›¾åƒ&#x27;</span>.<span class="built_in">format</span>(temp_dir+<span class="string">&#x27;-plot&#x27;</span>))</span><br></pre></td></tr></table></figure><h3 id="å¤šç›®æ ‡è¿½è¸ªè§†é¢‘å¤„ç†"><a href="#å¤šç›®æ ‡è¿½è¸ªè§†é¢‘å¤„ç†" class="headerlink" title="å¤šç›®æ ‡è¿½è¸ªè§†é¢‘å¤„ç†"></a>å¤šç›®æ ‡è¿½è¸ªè§†é¢‘å¤„ç†</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¾“å…¥è¾“å‡ºè§†é¢‘è·¯å¾„</span></span><br><span class="line">input_video = <span class="string">&#x27;data/mot_people_medium.mp4&#x27;</span></span><br><span class="line">output = <span class="string">&#x27;outputs/G2_MOT_people_medium.mp4&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## ByteTrackç®—æ³•</span></span><br><span class="line"><span class="comment"># æŒ‡å®š config é…ç½®æ–‡ä»¶ å’Œ æ¨¡å‹æƒé‡æ–‡ä»¶ï¼Œåˆ›å»ºæ¨¡å‹</span></span><br><span class="line">mot_config = <span class="string">&#x27;./configs/mot/bytetrack/bytetrack_yolox_x_crowdhuman_mot17-private-half.py&#x27;</span></span><br><span class="line">mot_checkpoint = <span class="string">&#x27;https://download.openmmlab.com/mmtracking/mot/bytetrack/bytetrack_yolox_x/bytetrack_yolox_x_crowdhuman_mot17-private-half_20211218_205500-1985c9f0.pth&#x27;</span></span><br><span class="line"><span class="comment"># åˆå§‹åŒ–æ¨¡å‹</span></span><br><span class="line">mot_model = init_model(mot_config, mot_checkpoint, device=<span class="string">&#x27;cuda:0&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## Deepsortç®—æ³•</span></span><br><span class="line"><span class="comment"># # æŒ‡å®š config é…ç½®æ–‡ä»¶ å’Œ æ¨¡å‹æƒé‡æ–‡ä»¶ï¼Œåˆ›å»ºæ¨¡å‹</span></span><br><span class="line"><span class="comment"># mot_config = &#x27;./configs/mot/deepsort/deepsort_faster-rcnn_fpn_4e_mot17-private-half.py&#x27;</span></span><br><span class="line"><span class="comment"># # åˆå§‹åŒ–æ¨¡å‹</span></span><br><span class="line"><span class="comment"># mot_model = init_model(mot_config, device=&#x27;cuda:0&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯»å…¥å¾…é¢„æµ‹è§†é¢‘</span></span><br><span class="line">imgs = mmcv.VideoReader(input_video)</span><br><span class="line"></span><br><span class="line">prog_bar = mmcv.ProgressBar(<span class="built_in">len</span>(imgs))</span><br><span class="line">out_dir = tempfile.TemporaryDirectory()</span><br><span class="line">out_path = temp_dir</span><br><span class="line"></span><br><span class="line"><span class="comment"># äººæ•°è®¡æ•°</span></span><br><span class="line">num = <span class="number">0</span></span><br><span class="line"><span class="comment"># è®°å½•æ¯ä¸€å¸§çš„æ€»äººæ•°ã€å½“å‰äººæ•°</span></span><br><span class="line">num_per_frame = []</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®°å½•æ¯ä¸€å¸§çš„å„ç›®æ ‡è½¨è¿¹ç‚¹åæ ‡</span></span><br><span class="line">trace_coord_video = []</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¹è§†é¢‘é€å¸§å¤„ç†</span></span><br><span class="line"><span class="keyword">for</span> frame_id, img <span class="keyword">in</span> <span class="built_in">enumerate</span>(imgs):</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#######################</span></span><br><span class="line">    <span class="comment"># è¿è¡Œå¤šç›®æ ‡è¿½è¸ª</span></span><br><span class="line">    <span class="comment">#######################</span></span><br><span class="line">    result = inference_mot(mot_model, img, frame_id=frame_id)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è·å–å½“å‰å¸§ç›®æ ‡æ£€æµ‹å¯è§†åŒ–æ•ˆæœï¼ŒåŠå„ç›®æ ‡è½¨è¿¹ç‚¹åæ ‡</span></span><br><span class="line">    img, trace_coord_frame = process_result(result)</span><br><span class="line">    trace_coord_video.append(trace_coord_frame)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#######################</span></span><br><span class="line">    <span class="comment"># ç»˜åˆ¶è½¨è¿¹ç‚¹ï¼šä»ç¬¬ä¸€å¸§åˆ°å½“å‰å¸§ æ‰€æœ‰ç›®æ ‡çš„è½¨è¿¹ç‚¹</span></span><br><span class="line">    <span class="comment">#######################</span></span><br><span class="line">    <span class="keyword">for</span> trace_coord_frame <span class="keyword">in</span> trace_coord_video: <span class="comment"># éå†æ¯ä¸€å¸§</span></span><br><span class="line">        <span class="keyword">for</span> trace_coord_obj <span class="keyword">in</span> trace_coord_frame: <span class="comment"># éå†æ¯ä¸€ä¸ªç›®æ ‡</span></span><br><span class="line">            <span class="comment"># ç»˜åˆ¶åœ†ï¼ŒæŒ‡å®šåœ†å¿ƒåæ ‡å’ŒåŠå¾„ï¼Œé¢œè‰²ï¼Œæœ€åä¸€ä¸ªå‚æ•°ä¸ºçº¿å®½ï¼Œ-1è¡¨ç¤ºå¡«å……</span></span><br><span class="line">            cv2.circle(img, (trace_coord_obj[<span class="number">1</span>][<span class="number">0</span>], trace_coord_obj[<span class="number">1</span>][<span class="number">1</span>]),<span class="number">5</span>, trace_coord_obj[<span class="number">1</span>][<span class="number">2</span>], -<span class="number">1</span>)</span><br><span class="line">            <span class="comment"># continue</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#######################</span></span><br><span class="line">    <span class="comment">#  è·å–äººæ•°</span></span><br><span class="line">    <span class="comment">#######################</span></span><br><span class="line">    <span class="comment"># ç”¨å½“å‰æœ€å¤§çš„ ID å·ä½œä¸ºäººæ•°å€¼</span></span><br><span class="line">    <span class="keyword">if</span> result[<span class="string">&#x27;track_bboxes&#x27;</span>][<span class="number">0</span>][:,<span class="number">0</span>].<span class="built_in">any</span>(): <span class="comment"># æ£€æµ‹å‡ºè¡Œäºº</span></span><br><span class="line">        num = <span class="built_in">max</span>(num, <span class="number">1</span>+<span class="built_in">max</span>(result[<span class="string">&#x27;track_bboxes&#x27;</span>][<span class="number">0</span>][:,<span class="number">0</span>]))</span><br><span class="line">    <span class="keyword">else</span>: <span class="comment"># æ²¡æœ‰æ£€æµ‹å‡ºè¡Œäºº</span></span><br><span class="line">        num = num</span><br><span class="line">    num_per_frame.append([frame_id, num, <span class="built_in">len</span>(trace_coord_frame)])</span><br><span class="line">    <span class="comment"># å¯è§†åŒ–æ€»äººæ•°ï¼šå›¾ç‰‡ï¼Œæ·»åŠ çš„æ–‡å­—ï¼Œå·¦ä¸Šè§’åæ ‡ï¼Œå­—ä½“ï¼Œå­—ä½“å¤§å°ï¼Œé¢œè‰²ï¼Œå­—ä½“ç²—ç»†</span></span><br><span class="line">    img = cv2.putText(img, <span class="built_in">str</span>(<span class="built_in">int</span>(num)), (<span class="number">25</span>, <span class="number">150</span>), cv2.FONT_HERSHEY_SIMPLEX, <span class="number">5</span>, (<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>), <span class="number">3</span>)</span><br><span class="line">    <span class="comment"># å¯è§†åŒ–å½“å‰äººæ•°</span></span><br><span class="line">    img = cv2.putText(img, <span class="built_in">str</span>(<span class="built_in">len</span>(trace_coord_frame)), (<span class="number">25</span>, <span class="number">350</span>), cv2.FONT_HERSHEY_SIMPLEX, <span class="number">5</span>, (<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å°†å¤„ç†åçš„è¯¥å¸§ç”»é¢å›¾åƒæ–‡ä»¶ï¼Œä¿å­˜è‡³ /tmp ç›®å½•ä¸‹</span></span><br><span class="line">    cv2.imwrite(<span class="string">f&#x27;<span class="subst">&#123;out_path&#125;</span>/<span class="subst">&#123;frame_id:06d&#125;</span>.jpg&#x27;</span>, img)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ›´æ–°è¿›åº¦æ¡</span></span><br><span class="line">    prog_bar.update()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”±æ¯ä¸€å¸§çš„å›¾åƒæ–‡ä»¶ï¼Œç”Ÿæˆè§†é¢‘</span></span><br><span class="line">mmcv.frames2video(out_path, output, fps=imgs.fps, fourcc=<span class="string">&#x27;mp4v&#x27;</span>)</span><br><span class="line">out_dir.cleanup()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;å¸§å›¾åƒä¿å­˜è·¯å¾„&#x27;</span>,out_path)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;æ€»äººæ•°&#x27;</span>, <span class="built_in">int</span>(num))</span><br></pre></td></tr></table></figure><h3 id="ç»˜åˆ¶äººæµé‡æŠ˜çº¿å›¾"><a href="#ç»˜åˆ¶äººæµé‡æŠ˜çº¿å›¾" class="headerlink" title="ç»˜åˆ¶äººæµé‡æŠ˜çº¿å›¾"></a>ç»˜åˆ¶äººæµé‡æŠ˜çº¿å›¾</h3><h4 id="è§£æå¤šç›®æ ‡è¿½è¸ªç»“æœ"><a href="#è§£æå¤šç›®æ ‡è¿½è¸ªç»“æœ" class="headerlink" title="è§£æå¤šç›®æ ‡è¿½è¸ªç»“æœ"></a>è§£æå¤šç›®æ ‡è¿½è¸ªç»“æœ</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(num_per_frame[:<span class="number">10</span>])</span><br></pre></td></tr></table></figure><h4 id="å•å¼ æŠ˜çº¿å›¾ç»˜åˆ¶"><a href="#å•å¼ æŠ˜çº¿å›¾ç»˜åˆ¶" class="headerlink" title="å•å¼ æŠ˜çº¿å›¾ç»˜åˆ¶"></a>å•å¼ æŠ˜çº¿å›¾ç»˜åˆ¶</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ—¶é—´</span></span><br><span class="line">X_frames = np.array(num_per_frame)[:,<span class="number">0</span>] / imgs.fps</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ€»äººæµé‡</span></span><br><span class="line">Y_people = np.array(num_per_frame)[:,<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># å½“å‰ç”»é¢äººæ•°</span></span><br><span class="line">Z_people = np.array(num_per_frame)[:,<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">plt.figure(figsize=(<span class="number">10</span>,<span class="number">6</span>))</span><br><span class="line">plt.plot(X_frames[:frame_id+<span class="number">1</span>], Y_people[:frame_id+<span class="number">1</span>], <span class="string">&#x27;r&#x27;</span>, label=<span class="string">&#x27;total&#x27;</span>)</span><br><span class="line">plt.plot(X_frames[:frame_id+<span class="number">1</span>], Z_people[:frame_id+<span class="number">1</span>], <span class="string">&#x27;b&#x27;</span>, label=<span class="string">&#x27;current&#x27;</span>)</span><br><span class="line">plt.ylim(<span class="number">0</span>, <span class="built_in">int</span>(num))</span><br><span class="line">plt.xlim(<span class="number">0</span>, <span class="built_in">int</span>(X_frames.<span class="built_in">max</span>()))</span><br><span class="line">plt.legend(fontsize=<span class="number">20</span>)</span><br><span class="line">plt.tick_params(labelsize=<span class="number">20</span>) <span class="comment"># è®¾ç½®åæ ‡æ–‡å­—å¤§å°</span></span><br><span class="line">plt.xlabel(<span class="string">&#x27;Time&#x27;</span>,fontsize=<span class="number">25</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;Num&#x27;</span>,fontsize=<span class="number">25</span>)</span><br><span class="line">plt.title(<span class="string">&#x27;Pedestrian Count&#x27;</span>,fontsize=<span class="number">30</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2h8ke0gcqj210g0n6abb.jpg" style="zoom:50%;" /><h4 id="ç»˜åˆ¶å•å¼ äººæµé‡æŠ˜çº¿å›¾å åŠ è§†é¢‘å›¾"><a href="#ç»˜åˆ¶å•å¼ äººæµé‡æŠ˜çº¿å›¾å åŠ è§†é¢‘å›¾" class="headerlink" title="ç»˜åˆ¶å•å¼ äººæµé‡æŠ˜çº¿å›¾å åŠ è§†é¢‘å›¾"></a>ç»˜åˆ¶å•å¼ äººæµé‡æŠ˜çº¿å›¾å åŠ è§†é¢‘å›¾</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">os.chdir(temp_dir)</span><br><span class="line"></span><br><span class="line">each = os.listdir()[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">fig = plt.figure(figsize=(<span class="number">18</span>,<span class="number">6</span>))</span><br><span class="line"><span class="comment"># ç»˜åˆ¶å·¦å›¾-æŠ˜çº¿å›¾</span></span><br><span class="line">ax1 = plt.subplot(<span class="number">1</span>,<span class="number">2</span>,<span class="number">1</span>)</span><br><span class="line">ax1.plot(X_frames[:frame_id+<span class="number">1</span>], Y_people[:frame_id+<span class="number">1</span>], <span class="string">&#x27;r&#x27;</span>, label=<span class="string">&#x27;total&#x27;</span>)</span><br><span class="line">ax1.plot(X_frames[:frame_id+<span class="number">1</span>], Z_people[:frame_id+<span class="number">1</span>], <span class="string">&#x27;b&#x27;</span>, label=<span class="string">&#x27;current&#x27;</span>)</span><br><span class="line">plt.ylim(<span class="number">0</span>, <span class="built_in">int</span>(num))</span><br><span class="line">plt.xlim(<span class="number">0</span>, <span class="built_in">int</span>(X_frames.<span class="built_in">max</span>()))</span><br><span class="line">ax1.legend(fontsize=<span class="number">20</span>)</span><br><span class="line">ax1.tick_params(labelsize=<span class="number">20</span>) <span class="comment"># è®¾ç½®åæ ‡æ–‡å­—å¤§å°</span></span><br><span class="line">plt.xlabel(<span class="string">&#x27;Time&#x27;</span>,fontsize=<span class="number">25</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;Num&#x27;</span>,fontsize=<span class="number">25</span>)</span><br><span class="line">plt.title(<span class="string">&#x27;Pedestrian Count&#x27;</span>,fontsize=<span class="number">30</span>)</span><br><span class="line"><span class="comment"># ç»˜åˆ¶å³å›¾-è§†é¢‘å›¾</span></span><br><span class="line">ax2 = plt.subplot(<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>)</span><br><span class="line">im = plt.imread(each)</span><br><span class="line">ax2.imshow(im)</span><br><span class="line">ax2.axis(<span class="string">&#x27;off&#x27;</span>)</span><br><span class="line"></span><br><span class="line">plt.tight_layout()</span><br><span class="line"></span><br><span class="line">fig.savefig(<span class="string">&#x27;../test.jpg&#x27;</span>)</span><br><span class="line"></span><br><span class="line">os.chdir(<span class="string">&#x27;../&#x27;</span>)</span><br></pre></td></tr></table></figure><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2h8lflm97j21b80fo0w8.jpg"></p><h4 id="ç”ŸæˆæŠ˜çº¿å›¾å’Œè§†é¢‘çš„åŒæ­¥è§†é¢‘"><a href="#ç”ŸæˆæŠ˜çº¿å›¾å’Œè§†é¢‘çš„åŒæ­¥è§†é¢‘" class="headerlink" title="ç”ŸæˆæŠ˜çº¿å›¾å’Œè§†é¢‘çš„åŒæ­¥è§†é¢‘"></a>ç”ŸæˆæŠ˜çº¿å›¾å’Œè§†é¢‘çš„åŒæ­¥è§†é¢‘</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">os.chdir(temp_dir)</span><br><span class="line">total_frames = np.array(num_per_frame)[:,<span class="number">0</span>].<span class="built_in">max</span>()</span><br><span class="line"><span class="keyword">with</span> tqdm(total=total_frames) <span class="keyword">as</span> pbar:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> frame_id, each <span class="keyword">in</span> <span class="built_in">enumerate</span>(os.listdir()):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            fig = plt.figure(figsize=(<span class="number">18</span>,<span class="number">6</span>))</span><br><span class="line">            <span class="comment"># ç»˜åˆ¶å·¦å›¾-æŠ˜çº¿å›¾</span></span><br><span class="line">            ax1 = plt.subplot(<span class="number">1</span>,<span class="number">2</span>,<span class="number">1</span>)</span><br><span class="line">            ax1.plot(X_frames[:frame_id+<span class="number">1</span>], Y_people[:frame_id+<span class="number">1</span>], <span class="string">&#x27;r&#x27;</span>, label=<span class="string">&#x27;total&#x27;</span>)</span><br><span class="line">            ax1.plot(X_frames[:frame_id+<span class="number">1</span>], Z_people[:frame_id+<span class="number">1</span>], <span class="string">&#x27;b&#x27;</span>, label=<span class="string">&#x27;current&#x27;</span>)</span><br><span class="line">            plt.ylim(<span class="number">0</span>, <span class="built_in">int</span>(num))</span><br><span class="line">            plt.xlim(<span class="number">0</span>, <span class="built_in">int</span>(X_frames.<span class="built_in">max</span>()))</span><br><span class="line">            ax1.legend(fontsize=<span class="number">20</span>)</span><br><span class="line">            ax1.tick_params(labelsize=<span class="number">20</span>) <span class="comment"># è®¾ç½®åæ ‡æ–‡å­—å¤§å°</span></span><br><span class="line">            plt.xlabel(<span class="string">&#x27;Time&#x27;</span>,fontsize=<span class="number">25</span>)</span><br><span class="line">            plt.ylabel(<span class="string">&#x27;Num&#x27;</span>,fontsize=<span class="number">25</span>)</span><br><span class="line">            plt.title(<span class="string">&#x27;Pedestrian Count&#x27;</span>,fontsize=<span class="number">30</span>)</span><br><span class="line">            <span class="comment"># ç»˜åˆ¶å³å›¾-è§†é¢‘å›¾</span></span><br><span class="line">            ax2 = plt.subplot(<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>)</span><br><span class="line">            im = plt.imread(each)</span><br><span class="line">            ax2.imshow(im)</span><br><span class="line">            ax2.axis(<span class="string">&#x27;off&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            plt.tight_layout()</span><br><span class="line">            fig.savefig(<span class="string">f&quot;../<span class="subst">&#123;temp_dir+<span class="string">&#x27;-plot&#x27;</span>&#125;</span>/<span class="subst">&#123;frame_id:06d&#125;</span>.jpg&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        pbar.update()</span><br><span class="line"></span><br><span class="line">os.chdir(<span class="string">&#x27;../&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”±æ¯ä¸€å¸§çš„å›¾åƒæ–‡ä»¶ï¼Œç”Ÿæˆè§†é¢‘</span></span><br><span class="line">mmcv.frames2video(temp_dir+<span class="string">&#x27;-plot&#x27;</span>, <span class="string">&#x27;outputs/test2_plot.mp4&#x27;</span>, fps=imgs.fps, fourcc=<span class="string">&#x27;mp4v&#x27;</span>)</span><br></pre></td></tr></table></figure><h3 id="ç»“æœå±•ç¤º-1"><a href="#ç»“æœå±•ç¤º-1" class="headerlink" title="ç»“æœå±•ç¤º"></a>ç»“æœå±•ç¤º</h3><iframe src="//player.bilibili.com/player.html?aid=684374174&bvid=BV1xU4y127ka&cid=726776816&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe>]]></content>
      
      
      
        <tags>
            
            <tag> ç›®æ ‡è¿½è¸ªç³»åˆ— </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Œç›®æ ‡è¿½è¸ªç³»åˆ—ã€ï¼ˆäºŒï¼‰åŸºäºmmTrackingçš„ç›®æ ‡è¿½è¸ªå®ç°</title>
      <link href="/2022/05/22/%E3%80%8C%E7%9B%AE%E6%A0%87%E8%BF%BD%E8%B8%AA%E7%B3%BB%E5%88%97%E3%80%8D%EF%BC%88%E4%BA%8C%EF%BC%89%E5%9F%BA%E4%BA%8EmmTracking%E7%9A%84%E7%9B%AE%E6%A0%87%E8%BF%BD%E8%B8%AA%E5%AE%9E%E7%8E%B0/"/>
      <url>/2022/05/22/%E3%80%8C%E7%9B%AE%E6%A0%87%E8%BF%BD%E8%B8%AA%E7%B3%BB%E5%88%97%E3%80%8D%EF%BC%88%E4%BA%8C%EF%BC%89%E5%9F%BA%E4%BA%8EmmTracking%E7%9A%84%E7%9B%AE%E6%A0%87%E8%BF%BD%E8%B8%AA%E5%AE%9E%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<h2 id="mmTrackingä»‹ç»"><a href="#mmTrackingä»‹ç»" class="headerlink" title="mmTrackingä»‹ç»"></a>mmTrackingä»‹ç»</h2><p>MMTrackingæ˜¯ä¸€æ¬¾åŸºäºPyTorchçš„è§†é¢‘ç›®æ ‡æ„ŸçŸ¥å¼€æºå·¥å…·ç®±ï¼Œæ˜¯<a href="http://openmmlab.org/">OpenMMLab</a>é¡¹ç›®çš„ä¸€éƒ¨åˆ†ã€‚</p><p>ä¸»åˆ†æ”¯ä»£ç ç›®å‰æ”¯æŒ<strong>PyTorch 1.5ä»¥ä¸Š</strong>çš„ç‰ˆæœ¬ã€‚</p><p><img src="https://user-images.githubusercontent.com/24663779/103343312-c724f480-4ac6-11eb-9c22-b56f1902584e.gif"></p><h3 id="ä¸»è¦ç‰¹æ€§"><a href="#ä¸»è¦ç‰¹æ€§" class="headerlink" title="ä¸»è¦ç‰¹æ€§"></a>ä¸»è¦ç‰¹æ€§</h3><ul><li><p><strong>é¦–ä¸ªå¼€æºä¸€ä½“åŒ–è§†é¢‘ç›®æ ‡æ„ŸçŸ¥å¹³å°</strong></p><p>MMTracking æ˜¯é¦–ä¸ªå¼€æºä¸€ä½“åŒ–è§†é¢‘ç›®æ ‡æ„ŸçŸ¥å·¥å…·ç®±ï¼ŒåŒæ—¶æ”¯æŒè§†é¢‘ç›®æ ‡æ£€æµ‹ï¼Œå¤šç›®æ ‡è·Ÿè¸ªï¼Œå•ç›®æ ‡è·Ÿè¸ªå’Œè§†é¢‘ä¸ªä¾‹åˆ†å‰²ç­‰å¤šç§ä»»åŠ¡å’Œç®—æ³•ã€‚</p></li><li><p><strong>æ¨¡å—åŒ–è®¾è®¡</strong></p><p>MMTrackingå°†ç»Ÿä¸€çš„è§†é¢‘ç›®æ ‡æ„ŸçŸ¥æ¡†æ¶è§£è€¦æˆä¸åŒçš„æ¨¡å—ç»„ä»¶ï¼Œé€šè¿‡ç»„åˆä¸åŒæ¨¡å—ç»„ä»¶ï¼Œç”¨æˆ·å¯ä»¥ä¾¿æ·åœ°æ„å»ºè‡ªå®šä¹‰è§†é¢‘ç›®æ ‡æ„ŸçŸ¥æ¨¡å‹ã€‚</p></li><li><p><strong>ç®€æ´ã€é«˜æ•ˆã€å¼ºå¤§</strong></p><p><strong>ç®€æ´</strong>ï¼šMMTrackingä¸å…¶ä»–OpenMMLabå¹³å°å……åˆ†äº¤äº’ã€‚MMTrackingå……åˆ†å¤ç”¨<a href="https://github.com/open-mmlab/mmdetection">MMDetection</a>ä¸­çš„å·²æœ‰æ¨¡å—ï¼Œæˆ‘ä»¬åªéœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶å°±å¯ä»¥ä½¿ç”¨ä»»ä½•æ£€æµ‹å™¨ã€‚</p><p><strong>é«˜æ•ˆ</strong>ï¼šMMTrackingæ‰€æœ‰æ“ä½œéƒ½åœ¨GPUä¸Šè¿è¡Œã€‚ç›¸æ¯”å…¶ä»–å¼€æºåº“çš„å®ç°ï¼ŒMMTrackingçš„è®­ç»ƒå’Œæ¨ç†æ›´åŠ é«˜æ•ˆã€‚</p><p><strong>å¼ºå¤§</strong>ï¼šMMTrackingå¤ç°äº†SOTAæ€§èƒ½çš„æ¨¡å‹ã€‚å—ç›Šäº<a href="https://github.com/open-mmlab/mmdetection">MMDetection</a>çš„æŒç»­æ¨è¿›ï¼Œéƒ¨åˆ†å®ç°ç²¾åº¦è¶…å‡ºå®˜æ–¹ç‰ˆæœ¬ã€‚</p></li></ul><span id="more"></span><h3 id="æ¨¡å‹åº“"><a href="#æ¨¡å‹åº“" class="headerlink" title="æ¨¡å‹åº“"></a>æ¨¡å‹åº“</h3><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2h311r24vj20u70eqq50.jpg"></p><h2 id="ç¯å¢ƒé…ç½®"><a href="#ç¯å¢ƒé…ç½®" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h2><h3 id="åœ¨æ’æºäº‘ä¸‹-æ–°å»ºPytorch1-11-CUDA-1-10-0çš„ç¯å¢ƒ"><a href="#åœ¨æ’æºäº‘ä¸‹-æ–°å»ºPytorch1-11-CUDA-1-10-0çš„ç¯å¢ƒ" class="headerlink" title="åœ¨æ’æºäº‘ä¸‹ æ–°å»ºPytorch1.11 CUDA 1.10.0çš„ç¯å¢ƒ"></a>åœ¨æ’æºäº‘ä¸‹ æ–°å»ºPytorch1.11 CUDA 1.10.0çš„ç¯å¢ƒ</h3><h3 id="å®‰è£…VOTæ•°æ®é›†æµ‹è¯•è¯„ä¼°åº“"><a href="#å®‰è£…VOTæ•°æ®é›†æµ‹è¯•è¯„ä¼°åº“" class="headerlink" title="å®‰è£…VOTæ•°æ®é›†æµ‹è¯•è¯„ä¼°åº“"></a>å®‰è£…VOTæ•°æ®é›†æµ‹è¯•è¯„ä¼°åº“</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install git+https://github.com/votchallenge/toolkit.git</span><br></pre></td></tr></table></figure><h3 id="å®‰è£…mmcv-full"><a href="#å®‰è£…mmcv-full" class="headerlink" title="å®‰è£…mmcv-full"></a>å®‰è£…mmcv-full</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install mmcv-full==1.5.0 -f https://download.openmmlab.com/mmcv/dist/cu111/torch1.10.0/index.html</span><br></pre></td></tr></table></figure><h3 id="å®‰è£…mmdet"><a href="#å®‰è£…mmdet" class="headerlink" title="å®‰è£…mmdet"></a>å®‰è£…mmdet</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install mmdet</span><br></pre></td></tr></table></figure><h3 id="å°†mmtrackingå…‹éš†åˆ°æœ¬åœ°"><a href="#å°†mmtrackingå…‹éš†åˆ°æœ¬åœ°" class="headerlink" title="å°†mmtrackingå…‹éš†åˆ°æœ¬åœ°"></a>å°†mmtrackingå…‹éš†åˆ°æœ¬åœ°</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/open-mmlab/mmtracking.git</span><br><span class="line">cd mmtracking</span><br></pre></td></tr></table></figure><h3 id="å®‰è£…å¿…å¤‡ä¾èµ–"><a href="#å®‰è£…å¿…å¤‡ä¾èµ–" class="headerlink" title="å®‰è£…å¿…å¤‡ä¾èµ–"></a>å®‰è£…å¿…å¤‡ä¾èµ–</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pip install -r requirements.txt</span><br><span class="line">pip install setuptools==58.2.0 # è¿™æ­¥éå¸¸é‡è¦ æ–°ç‰ˆæœ¬ä¸å†æ”¯æŒeasy_install </span><br><span class="line">pip install -v -e .  # or &quot;python setup.py develop&quot;</span><br><span class="line">sudo apt-get install libglib2.0-0</span><br></pre></td></tr></table></figure><h3 id="å®‰è£…é¢å¤–çš„ä¾èµ–"><a href="#å®‰è£…é¢å¤–çš„ä¾èµ–" class="headerlink" title="å®‰è£…é¢å¤–çš„ä¾èµ–"></a>å®‰è£…é¢å¤–çš„ä¾èµ–</h3><h4 id="ä¸º-MOTChallenge-è¯„ä¼°"><a href="#ä¸º-MOTChallenge-è¯„ä¼°" class="headerlink" title="ä¸º MOTChallenge è¯„ä¼°"></a>ä¸º MOTChallenge è¯„ä¼°</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install git+https://github.com/JonathonLuiten/TrackEval.git</span><br></pre></td></tr></table></figure><h4 id="ä¸ºLVISè¯„ä¼°"><a href="#ä¸ºLVISè¯„ä¼°" class="headerlink" title="ä¸ºLVISè¯„ä¼°"></a>ä¸ºLVISè¯„ä¼°</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install git+https://github.com/lvis-dataset/lvis-api.git</span><br></pre></td></tr></table></figure><h4 id="ä¸ºTAOè¯„ä¼°"><a href="#ä¸ºTAOè¯„ä¼°" class="headerlink" title="ä¸ºTAOè¯„ä¼°"></a>ä¸ºTAOè¯„ä¼°</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install git+https://github.com/TAO-Dataset/tao.git</span><br></pre></td></tr></table></figure><h3 id="éªŒè¯"><a href="#éªŒè¯" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python demo/demo_mot_vis.py configs/mot/deepsort/sort_faster-rcnn_fpn_4e_mot17-private.py --input demo/demo.mp4 --output mot.mp4</span><br></pre></td></tr></table></figure><h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><p>å¦‚ä¸‹å†…å®¹åŸºäºBç«™upä¸»ã€Œ<a href="https://space.bilibili.com/1900783?spm_id_from=333.337.0.0">åŒæµå­è±ªå…„</a>ã€ç›¸å…³è§†é¢‘</p><iframe src="//player.bilibili.com/player.html?aid=213458941&bvid=BV1za411Y7Zm&cid=582146771&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe><h3 id="æµ‹è¯•è§†é¢‘æºæ–‡ä»¶è·å–"><a href="#æµ‹è¯•è§†é¢‘æºæ–‡ä»¶è·å–" class="headerlink" title="æµ‹è¯•è§†é¢‘æºæ–‡ä»¶è·å–"></a>æµ‹è¯•è§†é¢‘æºæ–‡ä»¶è·å–</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»º checkpoints æ–‡ä»¶å¤¹ï¼Œç”¨äºå­˜æ”¾é¢„è®­ç»ƒæ¨¡å‹æƒé‡æ–‡ä»¶</span></span><br><span class="line">os.mkdir(<span class="string">&#x27;checkpoints&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»º outputs æ–‡ä»¶å¤¹ï¼Œç”¨äºå­˜æ”¾é¢„æµ‹ç»“æœ</span></span><br><span class="line">os.mkdir(<span class="string">&#x27;outputs&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»º data æ–‡ä»¶å¤¹ï¼Œç”¨äºå­˜æ”¾è§†é¢‘</span></span><br><span class="line">os.mkdir(<span class="string">&#x27;data&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ==============================================================================</span></span><br><span class="line"><span class="comment"># èœœèœ‚è§†é¢‘ï¼Œæ¥æºï¼šhttps://www.youtube.com/watch?v=45mKyCpoDBo</span></span><br><span class="line">!wget https://zihao-openmmlab.obs.cn-east-<span class="number">3.</span>myhuaweicloud.com/<span class="number">20220418</span>-mmtracking/data/bee.mp4 -O data/bee.mp4</span><br><span class="line"></span><br><span class="line"><span class="comment"># èŠ±å¼å°çƒè§†é¢‘ï¼Œæ¥æºï¼šhttps://www.youtube.com/watch?v=l1KzjjKxqaA</span></span><br><span class="line">!wget https://zihao-openmmlab.obs.cn-east-<span class="number">3.</span>myhuaweicloud.com/<span class="number">20220418</span>-mmtracking/data/billiards1.mp4 -O data/billiards1.mp4</span><br><span class="line">!wget https://zihao-openmmlab.obs.cn-east-<span class="number">3.</span>myhuaweicloud.com/<span class="number">20220418</span>-mmtracking/data/billiards2.mp4 -O data/billiards2.mp4</span><br><span class="line"><span class="comment"># èŠ±å¼å°çƒè§†é¢‘ï¼Œæ¥æºï¼šhttps://www.youtube.com/watch?v=QfKEyPtbVas</span></span><br><span class="line">!wget https://zihao-openmmlab.obs.cn-east-<span class="number">3.</span>myhuaweicloud.com/<span class="number">20220418</span>-mmtracking/data/billiards3.mp4 -O data/billiards3.mp4</span><br><span class="line"><span class="comment"># èŠ±å¼å°çƒè§†é¢‘ï¼Œæ¥æºï¼šhttps://www.bilibili.com/video/BV1Es41187Y4</span></span><br><span class="line">!wget https://zihao-openmmlab.obs.cn-east-<span class="number">3.</span>myhuaweicloud.com/<span class="number">20220418</span>-mmtracking/data/billiards4.mp4 -O data/billiards4.mp4</span><br><span class="line"></span><br><span class="line"><span class="comment"># äººæµé‡æ£€æµ‹è§†é¢‘ï¼Œæ¥æºï¼šhttps://www.bilibili.com/video/BV1fE411w7ac</span></span><br><span class="line">!wget https://zihao-openmmlab.obs.cn-east-<span class="number">3.</span>myhuaweicloud.com/<span class="number">20220418</span>-mmtracking/data/mot_people_short.mp4 -O data/mot_people_short.mp4</span><br><span class="line">!wget https://zihao-openmmlab.obs.cn-east-<span class="number">3.</span>myhuaweicloud.com/<span class="number">20220418</span>-mmtracking/data/mot_people_medium.mp4 -O data/mot_people_medium.mp4</span><br><span class="line">!wget https://zihao-openmmlab.obs.cn-east-<span class="number">3.</span>myhuaweicloud.com/<span class="number">20220418</span>-mmtracking/data/mot_people_long.mp4 -O data/mot_people_long.mp4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># å•ç›®æ ‡æ£€æµ‹ gt_box_file.txt æ–‡ä»¶</span></span><br><span class="line">!wget https://zihao-openmmlab.obs.cn-east-<span class="number">3.</span>myhuaweicloud.com/<span class="number">20220418</span>-mmtracking/data/gt_box_file.txt -O data/gt_box_file.txt</span><br></pre></td></tr></table></figure><h3 id="å•ç›®æ ‡è¿½è¸ª-ã€ŒSOTã€"><a href="#å•ç›®æ ‡è¿½è¸ª-ã€ŒSOTã€" class="headerlink" title="å•ç›®æ ‡è¿½è¸ª ã€ŒSOTã€"></a>å•ç›®æ ‡è¿½è¸ª ã€ŒSOTã€</h3><h4 id="ç›®æ ‡åæ ‡è·å–"><a href="#ç›®æ ‡åæ ‡è·å–" class="headerlink" title="ç›®æ ‡åæ ‡è·å–"></a>ç›®æ ‡åæ ‡è·å–</h4><p>ä½¿ç”¨Jupyteræœ¬åœ°è¿è¡Œå¦‚ä¸‹æ–‡ä»¶ è·å¾—<strong>è¿½è¸ªæ¡†åæ ‡</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># opencv-python</span></span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¼å…¥pythonç»˜å›¾matplotlib</span></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="comment"># ä½¿ç”¨ipythonçš„é­”æ³•æ–¹æ³•ï¼Œå°†ç»˜åˆ¶å‡ºçš„å›¾åƒç›´æ¥åµŒå…¥åœ¨notebookå•å…ƒæ ¼ä¸­</span></span><br><span class="line">%matplotlib inline</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰å¯è§†åŒ–å›¾åƒå‡½æ•°</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_img_from_array</span>(<span class="params">img</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;opencvè¯»å…¥å›¾åƒæ ¼å¼ä¸ºBGRï¼Œmatplotlibå¯è§†åŒ–æ ¼å¼ä¸ºRGBï¼Œå› æ­¤éœ€å°†BGRè½¬RGB&#x27;&#x27;&#x27;</span></span><br><span class="line">    img_RGB = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)</span><br><span class="line">    plt.imshow(img_RGB)</span><br><span class="line">    plt.show()   </span><br><span class="line"><span class="comment"># è·å–è§†é¢‘ç¬¬ä¸€å¸§</span></span><br><span class="line">input_path = <span class="string">&#x27;bee.mp4&#x27;</span></span><br><span class="line">cap = cv2.VideoCapture(input_path)</span><br><span class="line"><span class="keyword">if</span> cap.isOpened():</span><br><span class="line">    success, frame = cap.read()</span><br><span class="line">cap.release()</span><br><span class="line"></span><br><span class="line"><span class="comment"># =======================================================================</span></span><br><span class="line">frame.shape</span><br><span class="line"></span><br><span class="line"><span class="comment"># =======================================================================</span></span><br><span class="line">show_img_from_array(frame)</span><br><span class="line"></span><br><span class="line"><span class="comment"># =======================================================================</span></span><br><span class="line"><span class="comment"># é€‰å–åˆå§‹æ¡†åŒºåŸŸï¼ŒæŒ‰å›è½¦é”®å®Œæˆ</span></span><br><span class="line">r = cv2.selectROI(<span class="string">&quot;initial_bbox&quot;</span>, frame)</span><br><span class="line">cv2.destroyAllWindows()</span><br><span class="line">cv2.waitKey(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># =======================================================================</span></span><br><span class="line"><span class="comment"># è¾“å…¥ç»“æœ</span></span><br><span class="line">r </span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="è¿½è¸ªå•ä¸ªé£æœºã€Œå•ç›®æ ‡ã€"><a href="#è¿½è¸ªå•ä¸ªé£æœºã€Œå•ç›®æ ‡ã€" class="headerlink" title="è¿½è¸ªå•ä¸ªé£æœºã€Œå•ç›®æ ‡ã€"></a>è¿½è¸ªå•ä¸ªé£æœºã€Œå•ç›®æ ‡ã€</h4><h5 id="Jupyterä¸å‘½ä»¤è¡Œè¿è¡Œ"><a href="#Jupyterä¸å‘½ä»¤è¡Œè¿è¡Œ" class="headerlink" title="Jupyterä¸å‘½ä»¤è¡Œè¿è¡Œ"></a>Jupyterä¸å‘½ä»¤è¡Œè¿è¡Œ</h5><blockquote><p>æ‰€æœ‰ç¨‹åºå…¨ç¨‹åœ¨äº‘ç«¯mmtrackingç›®å½•ä¸‹ æ‰§è¡Œ</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># opencv-python</span></span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¼å…¥pythonç»˜å›¾matplotlib</span></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="comment"># ä½¿ç”¨ipythonçš„é­”æ³•æ–¹æ³•ï¼Œå°†ç»˜åˆ¶å‡ºçš„å›¾åƒç›´æ¥åµŒå…¥åœ¨notebookå•å…ƒæ ¼ä¸­</span></span><br><span class="line">%matplotlib inline</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰å¯è§†åŒ–å›¾åƒå‡½æ•°</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_img_from_array</span>(<span class="params">img</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;opencvè¯»å…¥å›¾åƒæ ¼å¼ä¸ºBGRï¼Œmatplotlibå¯è§†åŒ–æ ¼å¼ä¸ºRGBï¼Œå› æ­¤éœ€å°†BGRè½¬RGB&#x27;&#x27;&#x27;</span></span><br><span class="line">    img_RGB = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)</span><br><span class="line">    plt.imshow(img_RGB)</span><br><span class="line">    plt.show()</span><br></pre></td></tr></table></figure><p>å°†ç»“æœ<strong>r</strong>ä¼ å…¥<strong>gt_box_file.txt</strong>ä¸­</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">python ./demo/demo_sot.py \</span><br><span class="line">        ./configs/sot/siamese_rpn/siamese_rpn_r50_20e_lasot.py \</span><br><span class="line">        --checkpoint https://download.openmmlab.com/mmtracking/sot/siamese_rpn/siamese_rpn_r50_1x_lasot/siamese_rpn_r50_1x_lasot_20211203_151612-da4b3c66.pth \</span><br><span class="line">        --input data/air_edit.mp4 \</span><br><span class="line">        --output outputs/C1_SOT_air.mp4 \</span><br><span class="line">        --thickness 2 \</span><br><span class="line">        --gt_bbox_file data/gt_box_file.txt</span><br></pre></td></tr></table></figure><h5 id="Python-APIè¿è¡Œ"><a href="#Python-APIè¿è¡Œ" class="headerlink" title="Python APIè¿è¡Œ"></a>Python APIè¿è¡Œ</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> mmcv</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">from</span> mmtrack.apis <span class="keyword">import</span> inference_sot, init_model</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å…¥è¾“å‡ºè§†é¢‘è·¯å¾„</span></span><br><span class="line">input_video = <span class="string">&#x27;data/air_eidt.mp4&#x27;</span></span><br><span class="line">output = <span class="string">&#x27;outputs/C2_SOT_air.mp4&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®šå•ç›®æ ‡è¿½è¸ªç®—æ³• config é…ç½®æ–‡ä»¶</span></span><br><span class="line">sot_config = <span class="string">&#x27;./configs/sot/siamese_rpn/siamese_rpn_r50_20e_lasot.py&#x27;</span></span><br><span class="line"><span class="comment"># æŒ‡å®šå•ç›®æ ‡æ£€æµ‹ç®—æ³•çš„æ¨¡å‹æƒé‡æ–‡ä»¶</span></span><br><span class="line">sot_checkpoint = <span class="string">&#x27;https://download.openmmlab.com/mmtracking/sot/siamese_rpn/siamese_rpn_r50_1x_lasot/siamese_rpn_r50_1x_lasot_20211203_151612-da4b3c66.pth&#x27;</span></span><br><span class="line"><span class="comment"># åˆå§‹åŒ–å•ç›®æ ‡è¿½è¸ªæ¨¡å‹</span></span><br><span class="line">sot_model = init_model(sot_config, sot_checkpoint, device=<span class="string">&#x27;cuda:0&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®šåˆå§‹æ¡†çš„åæ ‡ [x, y, w, h]</span></span><br><span class="line">init_bbox = [<span class="number">684</span>, <span class="number">357</span>, <span class="number">92</span>, <span class="number">39</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># è½¬æˆ [x1, y1, x2, y2 ]</span></span><br><span class="line">init_bbox = [init_bbox[<span class="number">0</span>], init_bbox[<span class="number">1</span>], init_bbox[<span class="number">0</span>]+init_bbox[<span class="number">2</span>], init_bbox[<span class="number">1</span>]+init_bbox[<span class="number">3</span>]]</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯»å…¥å¾…é¢„æµ‹è§†é¢‘</span></span><br><span class="line">imgs = mmcv.VideoReader(input_video)</span><br><span class="line">prog_bar = mmcv.ProgressBar(<span class="built_in">len</span>(imgs))</span><br><span class="line">out_dir = tempfile.TemporaryDirectory()</span><br><span class="line">out_path = out_dir.name</span><br><span class="line"><span class="comment"># é€å¸§è¾“å…¥æ¨¡å‹é¢„æµ‹</span></span><br><span class="line"><span class="keyword">for</span> i, img <span class="keyword">in</span> <span class="built_in">enumerate</span>(imgs):</span><br><span class="line">    result = inference_sot(sot_model, img, init_bbox, frame_id=i)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ç»˜åˆ¶çŸ©å½¢æ¡†ä¸­å¿ƒç‚¹æ„æˆçš„è½¨è¿¹</span></span><br><span class="line">    result_int = result[<span class="string">&#x27;track_bboxes&#x27;</span>].astype(<span class="string">&#x27;uint32&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    sot_model.show_result(</span><br><span class="line">            img,</span><br><span class="line">            result,</span><br><span class="line">            wait_time=<span class="built_in">int</span>(<span class="number">1000.</span> / imgs.fps),</span><br><span class="line">            out_file=<span class="string">f&#x27;<span class="subst">&#123;out_path&#125;</span>/<span class="subst">&#123;i:06d&#125;</span>.jpg&#x27;</span>)</span><br><span class="line">    prog_bar.update()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;\n making the output video at <span class="subst">&#123;output&#125;</span> with a FPS of <span class="subst">&#123;imgs.fps&#125;</span>&#x27;</span>)</span><br><span class="line">mmcv.frames2video(out_path, output, fps=imgs.fps, fourcc=<span class="string">&#x27;mp4v&#x27;</span>)</span><br><span class="line">out_dir.cleanup()</span><br></pre></td></tr></table></figure><h5 id="è½¨è¿¹ç»˜åˆ¶"><a href="#è½¨è¿¹ç»˜åˆ¶" class="headerlink" title="è½¨è¿¹ç»˜åˆ¶"></a>è½¨è¿¹ç»˜åˆ¶</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> mmcv</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">from</span> mmtrack.apis <span class="keyword">import</span> inference_sot, init_model</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å…¥è¾“å‡ºè§†é¢‘è·¯å¾„</span></span><br><span class="line">input_video = <span class="string">&#x27;data/air_edit.mp4&#x27;</span></span><br><span class="line">output = <span class="string">&#x27;outputs/C3_SOT_bee_trace.mp4&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®šå•ç›®æ ‡è¿½è¸ªç®—æ³• config é…ç½®æ–‡ä»¶</span></span><br><span class="line">sot_config = <span class="string">&#x27;./configs/sot/siamese_rpn/siamese_rpn_r50_20e_lasot.py&#x27;</span></span><br><span class="line"><span class="comment"># æŒ‡å®šå•ç›®æ ‡æ£€æµ‹ç®—æ³•çš„æ¨¡å‹æƒé‡æ–‡ä»¶</span></span><br><span class="line">sot_checkpoint = <span class="string">&#x27;https://download.openmmlab.com/mmtracking/sot/siamese_rpn/siamese_rpn_r50_1x_lasot/siamese_rpn_r50_1x_lasot_20211203_151612-da4b3c66.pth&#x27;</span></span><br><span class="line"><span class="comment"># åˆå§‹åŒ–å•ç›®æ ‡è¿½è¸ªæ¨¡å‹</span></span><br><span class="line">sot_model = init_model(sot_config, sot_checkpoint, device=<span class="string">&#x27;cuda:0&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®šåˆå§‹æ¡†çš„åæ ‡ [x, y, w, h]</span></span><br><span class="line">init_bbox = [<span class="number">684</span>, <span class="number">357</span>, <span class="number">92</span>, <span class="number">39</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># è½¬æˆ [x1, y1, x2, y2 ]</span></span><br><span class="line">init_bbox = [init_bbox[<span class="number">0</span>], init_bbox[<span class="number">1</span>], init_bbox[<span class="number">0</span>]+init_bbox[<span class="number">2</span>], init_bbox[<span class="number">1</span>]+init_bbox[<span class="number">3</span>]]</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯»å…¥å¾…é¢„æµ‹è§†é¢‘</span></span><br><span class="line">imgs = mmcv.VideoReader(input_video)</span><br><span class="line">prog_bar = mmcv.ProgressBar(<span class="built_in">len</span>(imgs))</span><br><span class="line">out_dir = tempfile.TemporaryDirectory()</span><br><span class="line">out_path = out_dir.name</span><br><span class="line"><span class="comment"># é€å¸§è¾“å…¥æ¨¡å‹é¢„æµ‹</span></span><br><span class="line">circle_coord_list = []</span><br><span class="line"><span class="keyword">for</span> i, img <span class="keyword">in</span> <span class="built_in">enumerate</span>(imgs):</span><br><span class="line">    result = inference_sot(sot_model, img, init_bbox, frame_id=i)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ç»˜åˆ¶çŸ©å½¢æ¡†ä¸­å¿ƒç‚¹æ„æˆçš„è½¨è¿¹</span></span><br><span class="line">    result_int = result[<span class="string">&#x27;track_bboxes&#x27;</span>].astype(<span class="string">&#x27;uint32&#x27;</span>)</span><br><span class="line">    circle_x = <span class="built_in">int</span>((result_int[<span class="number">0</span>] + result_int[<span class="number">2</span>]) / <span class="number">2</span>)</span><br><span class="line">    circle_y = <span class="built_in">int</span>((result_int[<span class="number">1</span>] + result_int[<span class="number">3</span>]) / <span class="number">2</span>)</span><br><span class="line">    circle_coord_list.append([circle_x, circle_y])</span><br><span class="line">    <span class="keyword">for</span> each <span class="keyword">in</span> circle_coord_list:</span><br><span class="line">        <span class="comment"># ç»˜åˆ¶åœ†ï¼ŒæŒ‡å®šåœ†å¿ƒåæ ‡å’ŒåŠå¾„ï¼Œçº¢è‰²ï¼Œæœ€åä¸€ä¸ªå‚æ•°ä¸ºçº¿å®½ï¼Œ-1è¡¨ç¤ºå¡«å……</span></span><br><span class="line">        cv2.circle(img,(each[<span class="number">0</span>],each[<span class="number">1</span>]), <span class="number">5</span>, (<span class="number">0</span>,<span class="number">0</span>,<span class="number">255</span>), -<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    sot_model.show_result(</span><br><span class="line">            img,</span><br><span class="line">            result,</span><br><span class="line">            wait_time=<span class="built_in">int</span>(<span class="number">1000.</span> / imgs.fps),</span><br><span class="line">            out_file=<span class="string">f&#x27;<span class="subst">&#123;out_path&#125;</span>/<span class="subst">&#123;i:06d&#125;</span>.jpg&#x27;</span>)</span><br><span class="line">    prog_bar.update()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;\n making the output video at <span class="subst">&#123;output&#125;</span> with a FPS of <span class="subst">&#123;imgs.fps&#125;</span>&#x27;</span>)</span><br><span class="line">mmcv.frames2video(out_path, output, fps=imgs.fps, fourcc=<span class="string">&#x27;mp4v&#x27;</span>)</span><br><span class="line">out_dir.cleanup()</span><br></pre></td></tr></table></figure><h5 id="è½¨è¿¹ç»˜åˆ¶ã€ŒOpenCVã€"><a href="#è½¨è¿¹ç»˜åˆ¶ã€ŒOpenCVã€" class="headerlink" title="è½¨è¿¹ç»˜åˆ¶ã€ŒOpenCVã€"></a>è½¨è¿¹ç»˜åˆ¶ã€ŒOpenCVã€</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> mmcv</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">from</span> mmtrack.apis <span class="keyword">import</span> inference_sot, init_model</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å…¥è¾“å‡ºè§†é¢‘è·¯å¾„</span></span><br><span class="line">input_video = <span class="string">&#x27;data/air.mp4&#x27;</span></span><br><span class="line">output = <span class="string">&#x27;outputs/C4_SOT_bee_trace.mp4&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®šå•ç›®æ ‡è¿½è¸ªç®—æ³• config é…ç½®æ–‡ä»¶</span></span><br><span class="line">sot_config = <span class="string">&#x27;./configs/sot/siamese_rpn/siamese_rpn_r50_20e_lasot.py&#x27;</span></span><br><span class="line"><span class="comment"># æŒ‡å®šå•ç›®æ ‡æ£€æµ‹ç®—æ³•çš„æ¨¡å‹æƒé‡æ–‡ä»¶</span></span><br><span class="line">sot_checkpoint = <span class="string">&#x27;https://download.openmmlab.com/mmtracking/sot/siamese_rpn/siamese_rpn_r50_1x_lasot/siamese_rpn_r50_1x_lasot_20211203_151612-da4b3c66.pth&#x27;</span></span><br><span class="line"><span class="comment"># åˆå§‹åŒ–å•ç›®æ ‡è¿½è¸ªæ¨¡å‹</span></span><br><span class="line">sot_model = init_model(sot_config, sot_checkpoint, device=<span class="string">&#x27;cuda:0&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®šåˆå§‹ç›®æ ‡çŸ©å½¢æ¡†åæ ‡ [x, y, w, h]</span></span><br><span class="line">init_bbox_xywh = [<span class="number">684</span>, <span class="number">357</span>, <span class="number">92</span>, <span class="number">39</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># è½¬æˆ [x1, y1, x2, y2 ]</span></span><br><span class="line">init_bbox_xyxy = [init_bbox_xywh[<span class="number">0</span>], init_bbox_xywh[<span class="number">1</span>], init_bbox_xywh[<span class="number">0</span>]+init_bbox_xywh[<span class="number">2</span>], init_bbox_xywh[<span class="number">1</span>]+init_bbox_xywh[<span class="number">3</span>]]</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯»å…¥å¾…é¢„æµ‹è§†é¢‘</span></span><br><span class="line">imgs = mmcv.VideoReader(input_video)</span><br><span class="line">prog_bar = mmcv.ProgressBar(<span class="built_in">len</span>(imgs))</span><br><span class="line">out_dir = tempfile.TemporaryDirectory()</span><br><span class="line">out_path = out_dir.name</span><br><span class="line"></span><br><span class="line"><span class="comment"># é€å¸§è¾“å…¥æ¨¡å‹é¢„æµ‹</span></span><br><span class="line">circle_coord_list = []</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;å¼€å§‹é€å¸§å¤„ç†&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i, img <span class="keyword">in</span> <span class="built_in">enumerate</span>(imgs):</span><br><span class="line">    img_draw = img.copy()</span><br><span class="line">    </span><br><span class="line">    result = inference_sot(sot_model, img, init_bbox_xyxy, frame_id=i)</span><br><span class="line">    <span class="comment"># ç›®æ ‡æ£€æµ‹çŸ©å½¢æ¡†åæ ‡</span></span><br><span class="line">    result_bbox = result[<span class="string">&#x27;track_bboxes&#x27;</span>][:<span class="number">4</span>].astype(<span class="string">&#x27;uint32&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ç»˜åˆ¶ç›®æ ‡æ£€æµ‹çŸ©å½¢æ¡†ï¼šå›¾åƒï¼Œå·¦ä¸Šè§’åæ ‡ï¼Œå³ä¸‹è§’åæ ‡ï¼Œé¢œè‰²ï¼Œçº¿å®½</span></span><br><span class="line">    img_draw = cv2.rectangle(img_draw, (result_bbox[<span class="number">0</span>], result_bbox[<span class="number">1</span>]), (result_bbox[<span class="number">2</span>], result_bbox[<span class="number">3</span>]), (<span class="number">0</span>,<span class="number">255</span>,<span class="number">0</span>), <span class="number">2</span>)    </span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è·å–çŸ©å½¢æ¡†ä¸­å¿ƒç‚¹è½¨è¿¹ç‚¹åæ ‡</span></span><br><span class="line">    circle_x = <span class="built_in">int</span>((result_bbox[<span class="number">0</span>] + result_bbox[<span class="number">2</span>]) / <span class="number">2</span>)</span><br><span class="line">    circle_y = <span class="built_in">int</span>((result_bbox[<span class="number">1</span>] + result_bbox[<span class="number">3</span>]) / <span class="number">2</span>)</span><br><span class="line">    circle_coord_list.append([circle_x, circle_y])</span><br><span class="line">    <span class="comment"># ç»˜åˆ¶ä»ç¬¬ä¸€å¸§åˆ°å½“å‰å¸§çš„è½¨è¿¹</span></span><br><span class="line">    <span class="keyword">for</span> each <span class="keyword">in</span> circle_coord_list:</span><br><span class="line">        <span class="comment"># ç»˜åˆ¶åœ†ï¼ŒæŒ‡å®šåœ†å¿ƒåæ ‡å’ŒåŠå¾„ï¼Œçº¢è‰²ï¼Œæœ€åä¸€ä¸ªå‚æ•°ä¸ºçº¿å®½ï¼Œ-1è¡¨ç¤ºå¡«å……</span></span><br><span class="line">        img_draw = cv2.circle(img_draw, (each[<span class="number">0</span>],each[<span class="number">1</span>]), <span class="number">5</span>, (<span class="number">0</span>,<span class="number">0</span>,<span class="number">255</span>), -<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å°†å½“å‰å¸§çš„å¯è§†åŒ–æ•ˆæœä¿å­˜ä¸ºå›¾ç‰‡æ–‡ä»¶</span></span><br><span class="line">    cv2.imwrite(<span class="string">f&#x27;<span class="subst">&#123;out_path&#125;</span>/<span class="subst">&#123;i:06d&#125;</span>.jpg&#x27;</span>, img_draw)</span><br><span class="line">    prog_bar.update()</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†ä¿å­˜ä¸‹æ¥çš„å„å¸§å›¾ç‰‡æ–‡ä»¶ä¸²æˆè§†é¢‘</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;å¯¼å‡ºè§†é¢‘ï¼ŒFPS &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(imgs.fps))</span><br><span class="line">mmcv.frames2video(out_path, output, fps=imgs.fps, fourcc=<span class="string">&#x27;mp4v&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;å·²æˆåŠŸå¯¼å‡ºè§†é¢‘ è‡³ &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(output))</span><br><span class="line">out_dir.cleanup()</span><br></pre></td></tr></table></figure><h5 id="ç»“æœå±•ç¤º"><a href="#ç»“æœå±•ç¤º" class="headerlink" title="ç»“æœå±•ç¤º"></a>ç»“æœå±•ç¤º</h5><blockquote><p>r &#x3D; (684, 357, 92, 39)</p></blockquote><iframe src="//player.bilibili.com/player.html?aid=769371401&bvid=BV13r4y1t7NG&cid=726124186&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe><iframe src="//player.bilibili.com/player.html?aid=596873058&bvid=BV1nB4y1R79k&cid=726124185&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe><h4 id="è¿½è¸ªå¤šä¸ªé£æœºã€Œå¤šä¸ªå•ç›®æ ‡ã€"><a href="#è¿½è¸ªå¤šä¸ªé£æœºã€Œå¤šä¸ªå•ç›®æ ‡ã€" class="headerlink" title="è¿½è¸ªå¤šä¸ªé£æœºã€Œå¤šä¸ªå•ç›®æ ‡ã€"></a>è¿½è¸ªå¤šä¸ªé£æœºã€Œå¤šä¸ªå•ç›®æ ‡ã€</h4><p>å¤šæ¬¡è°ƒç”¨ ã€Œç›®æ ‡åæ ‡è·å–ã€ç¨‹åºæœ¬åœ°è¿è¡Œ è·å¾—<strong>å¤šä¸ªè¿½è¸ªæ¡†åæ ‡</strong>ï¼Œå°†åæ ‡ä¼ å…¥å¦‚ä¸‹ç¨‹åº</p><h5 id="Python-APIè¿è¡Œ-è½¨è¿¹ç»˜åˆ¶"><a href="#Python-APIè¿è¡Œ-è½¨è¿¹ç»˜åˆ¶" class="headerlink" title="Python APIè¿è¡Œ è½¨è¿¹ç»˜åˆ¶"></a>Python APIè¿è¡Œ è½¨è¿¹ç»˜åˆ¶</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> mmcv</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">from</span> mmtrack.apis <span class="keyword">import</span> inference_sot, init_model</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> seaborn <span class="keyword">as</span> sns</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="comment"># ç”Ÿæˆè°ƒè‰²æ¿</span></span><br><span class="line">palette = sns.color_palette(<span class="string">&#x27;hls&#x27;</span>, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_color</span>(<span class="params">seed</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    ä¼ å…¥è¿½è¸ªIDï¼Œç”Ÿæˆä¸“å±é¢œè‰²</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    random.seed(seed)</span><br><span class="line">    <span class="comment"># ä»è°ƒè‰²æ¿ä¸­éšæœºæŒ‘é€‰ä¸€ç§é¢œè‰²</span></span><br><span class="line">    bbox_color = random.choice(palette)</span><br><span class="line">    bbox_color = [<span class="built_in">int</span>(<span class="number">255</span> * c) <span class="keyword">for</span> c <span class="keyword">in</span> bbox_color][::-<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">return</span> bbox_color</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># ===================================================================</span></span><br><span class="line"><span class="comment"># è¾“å…¥è¾“å‡ºè§†é¢‘è·¯å¾„</span></span><br><span class="line">input_video = <span class="string">&#x27;data/air_eidt.mp4&#x27;</span></span><br><span class="line">output = <span class="string">&#x27;outputs/output_C4_SOT_air_edit_trace.mp4&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®šå•ç›®æ ‡è¿½è¸ªç®—æ³• config é…ç½®æ–‡ä»¶</span></span><br><span class="line">sot_config = <span class="string">&#x27;./configs/sot/siamese_rpn/siamese_rpn_r50_20e_lasot.py&#x27;</span></span><br><span class="line"><span class="comment"># æŒ‡å®šå•ç›®æ ‡æ£€æµ‹ç®—æ³•çš„æ¨¡å‹æƒé‡æ–‡ä»¶</span></span><br><span class="line">sot_checkpoint = <span class="string">&#x27;https://download.openmmlab.com/mmtracking/sot/siamese_rpn/siamese_rpn_r50_1x_lasot/siamese_rpn_r50_1x_lasot_20211203_151612-da4b3c66.pth&#x27;</span></span><br><span class="line"><span class="comment"># åˆå§‹åŒ–å•ç›®æ ‡è¿½è¸ªæ¨¡å‹</span></span><br><span class="line">sot_model = init_model(sot_config, sot_checkpoint, device=<span class="string">&#x27;cuda:0&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ===================================================================</span></span><br><span class="line"><span class="comment"># æŒ‡å®šå¤šä¸ªç›®æ ‡çš„åˆå§‹çŸ©å½¢æ¡†åæ ‡ [x, y, w, h]</span></span><br><span class="line">init_bbox_xywh = [[<span class="number">871</span>, <span class="number">355</span>, <span class="number">94</span>, <span class="number">46</span>], [<span class="number">684</span>, <span class="number">357</span>, <span class="number">92</span>, <span class="number">39</span>]]</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç›®æ ‡ä¸ªæ•°</span></span><br><span class="line">ID_num = <span class="built_in">len</span>(init_bbox_xywh)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;å…±æœ‰&#123;&#125;ä¸ªå¾…è¿½è¸ªç›®æ ‡&#x27;</span>.<span class="built_in">format</span>(ID_num))</span><br><span class="line"></span><br><span class="line"><span class="comment"># è½¬æˆ [x1, y1, x2, y2 ]</span></span><br><span class="line">init_bbox_xyxy = []</span><br><span class="line"><span class="keyword">for</span> each <span class="keyword">in</span> init_bbox_xywh:</span><br><span class="line">    init_bbox_xyxy.append([each[<span class="number">0</span>], each[<span class="number">1</span>], each[<span class="number">0</span>]+each[<span class="number">2</span>], each[<span class="number">1</span>]+each[<span class="number">3</span>]])</span><br><span class="line">    </span><br><span class="line"><span class="comment"># ===================================================================</span></span><br><span class="line"><span class="comment"># è¯»å…¥å¾…é¢„æµ‹è§†é¢‘</span></span><br><span class="line">imgs = mmcv.VideoReader(input_video)</span><br><span class="line"><span class="comment"># prog_bar = mmcv.ProgressBar(len(imgs))</span></span><br><span class="line">out_dir = tempfile.TemporaryDirectory()</span><br><span class="line">out_path = out_dir.name</span><br><span class="line"></span><br><span class="line"><span class="comment">## è·å–æ¯å¸§çš„è¿½è¸ªç»“æœ</span></span><br><span class="line"><span class="comment"># é€å¸§è¾“å…¥æ¨¡å‹é¢„æµ‹</span></span><br><span class="line">circle_coord_list = &#123;&#125;</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;å¼€å§‹é€å¸§å¤„ç†&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ID <span class="keyword">in</span> <span class="built_in">range</span>(ID_num): <span class="comment"># éå†æ¯ä¸ªå¾…è¿½è¸ªç›®æ ‡</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;è¿½è¸ªç¬¬&#123;&#125;ä¸ªç›®æ ‡&#x27;</span>.<span class="built_in">format</span>(ID+<span class="number">1</span>))</span><br><span class="line">    circle_coord_list[ID] = &#123;&#125;</span><br><span class="line">    circle_coord_list[ID][<span class="string">&#x27;bbox&#x27;</span>] = []</span><br><span class="line">    circle_coord_list[ID][<span class="string">&#x27;trace&#x27;</span>] = []</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å¯åŠ¨è¿›åº¦æ¡</span></span><br><span class="line">    prog_bar = mmcv.ProgressBar(<span class="built_in">len</span>(imgs))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i, img <span class="keyword">in</span> <span class="built_in">enumerate</span>(imgs): <span class="comment"># éå†è§†é¢‘æ¯ä¸€å¸§</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ‰§è¡Œå•ç›®æ ‡è¿½è¸ª</span></span><br><span class="line">        result = inference_sot(sot_model, img, init_bbox_xyxy[ID], frame_id=i)</span><br><span class="line">        <span class="comment"># ç›®æ ‡æ£€æµ‹çŸ©å½¢æ¡†åæ ‡</span></span><br><span class="line">        result_bbox = np.array(result[<span class="string">&#x27;track_bboxes&#x27;</span>][:<span class="number">4</span>].astype(<span class="string">&#x27;uint32&#x27;</span>))</span><br><span class="line">        <span class="comment"># ä¿å­˜çŸ©å½¢æ¡†åæ ‡</span></span><br><span class="line">        circle_coord_list[ID][<span class="string">&#x27;bbox&#x27;</span>].append(result_bbox)</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        <span class="comment"># è·å–çŸ©å½¢æ¡†ä¸­å¿ƒç‚¹è½¨è¿¹ç‚¹åæ ‡</span></span><br><span class="line">        circle_x = <span class="built_in">int</span>((result_bbox[<span class="number">0</span>] + result_bbox[<span class="number">2</span>]) / <span class="number">2</span>)</span><br><span class="line">        circle_y = <span class="built_in">int</span>((result_bbox[<span class="number">1</span>] + result_bbox[<span class="number">3</span>]) / <span class="number">2</span>)</span><br><span class="line">        <span class="comment"># ä¿å­˜è½¨è¿¹ç‚¹åæ ‡</span></span><br><span class="line">        circle_coord_list[ID][<span class="string">&#x27;trace&#x27;</span>].append(np.array([circle_x, circle_y]))</span><br><span class="line">        </span><br><span class="line">        prog_bar.update()</span><br><span class="line"><span class="comment"># ===================================================================</span></span><br><span class="line"><span class="comment">## å¯è§†åŒ–</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨è¿›åº¦æ¡</span></span><br><span class="line">prog_bar = mmcv.ProgressBar(<span class="built_in">len</span>(imgs))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i, img <span class="keyword">in</span> <span class="built_in">enumerate</span>(imgs): <span class="comment"># éå†è§†é¢‘æ¯ä¸€å¸§</span></span><br><span class="line">    img_draw = img.copy()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> ID <span class="keyword">in</span> <span class="built_in">range</span>(ID_num): <span class="comment"># éå†æ¯ä¸ªå¾…è¿½è¸ªç›®æ ‡</span></span><br><span class="line">        <span class="comment"># è·å–è¯¥ç›®æ ‡çš„ä¸“å±é¢œè‰²</span></span><br><span class="line">        ID_color = get_color(ID)</span><br><span class="line">        </span><br><span class="line">        result_bbox = circle_coord_list[ID][<span class="string">&#x27;bbox&#x27;</span>][i]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ç»˜åˆ¶ç›®æ ‡æ£€æµ‹çŸ©å½¢æ¡†ï¼šå›¾åƒï¼Œå·¦ä¸Šè§’åæ ‡ï¼Œå³ä¸‹è§’åæ ‡ï¼Œé¢œè‰²ï¼Œçº¿å®½</span></span><br><span class="line">        img_draw = cv2.rectangle(img_draw, (result_bbox[<span class="number">0</span>], result_bbox[<span class="number">1</span>]), (result_bbox[<span class="number">2</span>], result_bbox[<span class="number">3</span>]), ID_color, <span class="number">2</span>)  </span><br><span class="line"></span><br><span class="line">        <span class="comment"># ç»˜åˆ¶ä»ç¬¬ä¸€å¸§åˆ°å½“å‰å¸§çš„è½¨è¿¹</span></span><br><span class="line">        <span class="keyword">for</span> each <span class="keyword">in</span> circle_coord_list[ID][<span class="string">&#x27;trace&#x27;</span>][:i]:</span><br><span class="line">            <span class="comment"># ç»˜åˆ¶åœ†ï¼ŒæŒ‡å®šåœ†å¿ƒåæ ‡å’ŒåŠå¾„ï¼Œçº¢è‰²ï¼Œæœ€åä¸€ä¸ªå‚æ•°ä¸ºçº¿å®½ï¼Œ-1è¡¨ç¤ºå¡«å……</span></span><br><span class="line">            img_draw = cv2.circle(img_draw, (each[<span class="number">0</span>],each[<span class="number">1</span>]), <span class="number">2</span>,  ID_color, -<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å°†å½“å‰å¸§çš„å¯è§†åŒ–æ•ˆæœä¿å­˜ä¸ºå›¾ç‰‡æ–‡ä»¶</span></span><br><span class="line">    cv2.imwrite(<span class="string">f&#x27;<span class="subst">&#123;out_path&#125;</span>/<span class="subst">&#123;i:06d&#125;</span>.jpg&#x27;</span>, img_draw)</span><br><span class="line">    prog_bar.update()</span><br><span class="line">    </span><br><span class="line"><span class="comment"># å°†ä¿å­˜ä¸‹æ¥çš„å„å¸§å›¾ç‰‡æ–‡ä»¶ä¸²æˆè§†é¢‘</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;å¯¼å‡ºè§†é¢‘ï¼ŒFPS &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(imgs.fps))</span><br><span class="line">mmcv.frames2video(out_path, output, fps=imgs.fps, fourcc=<span class="string">&#x27;mp4v&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;å·²æˆåŠŸå¯¼å‡ºè§†é¢‘ è‡³ &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(output))</span><br><span class="line">out_dir.cleanup()</span><br></pre></td></tr></table></figure><h5 id="ç»“æœå±•ç¤º-1"><a href="#ç»“æœå±•ç¤º-1" class="headerlink" title="ç»“æœå±•ç¤º"></a>ç»“æœå±•ç¤º</h5><blockquote><p>å³ä¾§ &#x3D; (684, 357, 92, 39)</p><p>å·¦ä¾§&#x3D; (871, 355, 94, 46)</p></blockquote><iframe src="//player.bilibili.com/player.html?aid=426819833&bvid=BV113411G7Yv&cid=726189994&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe><h3 id="å¤šç›®æ ‡è¿½è¸ªã€ŒMOTã€"><a href="#å¤šç›®æ ‡è¿½è¸ªã€ŒMOTã€" class="headerlink" title="å¤šç›®æ ‡è¿½è¸ªã€ŒMOTã€"></a>å¤šç›®æ ‡è¿½è¸ªã€ŒMOTã€</h3><blockquote><p>ä¸éœ€è¦äººå»æ¡†é€‰å’Œæ ‡æ³¨ä»»ä½•ç›®æ ‡ ï½œ ç®—æ³•çŸ¥é“æ¯ä¸ªäººçš„ç±»åˆ« ç›®å‰åªèƒ½ä¸€ä¸ªç±»åˆ«è¿›è¡Œè®¡æ•° ï½œ æ¯ä¸ªç›®æ ‡åˆ†é…ä¸€ä¸ªIDå· </p><p>å åŠ é€Ÿåº¦ä¿¡æ¯ å¡å°”æ›¼æ»¤æ³¢+åŒˆç‰™åˆ©åŒ¹é…å®ç° ä»£è¡¨æ–¹æ³•æœ‰ã€Œ<a href="https://arxiv.org/abs/1703.07402">DeepSort</a>ã€ã€Œ<a href="https://arxiv.org/abs/2110.06864">ByteTrack</a>ã€</p></blockquote><h4 id="DeepSort-å‘½ä»¤è¡Œå®ç°"><a href="#DeepSort-å‘½ä»¤è¡Œå®ç°" class="headerlink" title="DeepSort å‘½ä»¤è¡Œå®ç°"></a>DeepSort å‘½ä»¤è¡Œå®ç°</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Deepsortç®—æ³•ä»…éœ€æŒ‡å®š config æ–‡ä»¶ï¼Œä¸éœ€æŒ‡å®š checkpoint æ–‡ä»¶</span><br><span class="line">!python demo/demo_mot_vis.py \</span><br><span class="line">        configs/mot/deepsort/sort_faster-rcnn_fpn_4e_mot17-private.py \</span><br><span class="line">        --input data/mot_people_short.mp4 \</span><br><span class="line">        --output outputs/F2_MOT_people_short.mp4</span><br></pre></td></tr></table></figure><h4 id="DeepSort-Python-APIå®ç°"><a href="#DeepSort-Python-APIå®ç°" class="headerlink" title="DeepSort Python APIå®ç°"></a>DeepSort Python APIå®ç°</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> mmcv</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">from</span> mmtrack.apis <span class="keyword">import</span> inference_mot, init_model</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å…¥è¾“å‡ºè§†é¢‘è·¯å¾„</span></span><br><span class="line">input_video = <span class="string">&#x27;data/mot_people_short.mp4&#x27;</span></span><br><span class="line">output = <span class="string">&#x27;outputs/F4_MOT_people_short.mp4&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®š config é…ç½®æ–‡ä»¶ å’Œ æ¨¡å‹æƒé‡æ–‡ä»¶ï¼Œåˆ›å»ºæ¨¡å‹</span></span><br><span class="line">mot_config = <span class="string">&#x27;./configs/mot/deepsort/deepsort_faster-rcnn_fpn_4e_mot17-private-half.py&#x27;</span></span><br><span class="line"><span class="comment"># åˆå§‹åŒ–æ¨¡å‹</span></span><br><span class="line">mot_model = init_model(mot_config, device=<span class="string">&#x27;cuda:0&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯»å…¥å¾…é¢„æµ‹è§†é¢‘</span></span><br><span class="line">imgs = mmcv.VideoReader(input_video)</span><br><span class="line">prog_bar = mmcv.ProgressBar(<span class="built_in">len</span>(imgs))</span><br><span class="line">out_dir = tempfile.TemporaryDirectory()</span><br><span class="line">out_path = out_dir.name</span><br><span class="line"><span class="comment"># é€å¸§è¾“å…¥æ¨¡å‹é¢„æµ‹</span></span><br><span class="line"><span class="keyword">for</span> i, img <span class="keyword">in</span> <span class="built_in">enumerate</span>(imgs):</span><br><span class="line">    result = inference_mot(mot_model, img, frame_id=i)</span><br><span class="line">    mot_model.show_result(</span><br><span class="line">            img,</span><br><span class="line">            result,</span><br><span class="line">            show=<span class="literal">False</span>,</span><br><span class="line">            wait_time=<span class="built_in">int</span>(<span class="number">1000.</span> / imgs.fps),</span><br><span class="line">            out_file=<span class="string">f&#x27;<span class="subst">&#123;out_path&#125;</span>/<span class="subst">&#123;i:06d&#125;</span>.jpg&#x27;</span>)</span><br><span class="line">    prog_bar.update()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;\n making the output video at <span class="subst">&#123;output&#125;</span> with a FPS of <span class="subst">&#123;imgs.fps&#125;</span>&#x27;</span>)</span><br><span class="line">mmcv.frames2video(out_path, output, fps=imgs.fps, fourcc=<span class="string">&#x27;mp4v&#x27;</span>)</span><br><span class="line">out_dir.cleanup()</span><br></pre></td></tr></table></figure><h4 id="ByteTrack-å‘½ä»¤è¡Œå®ç°"><a href="#ByteTrack-å‘½ä»¤è¡Œå®ç°" class="headerlink" title="ByteTrack å‘½ä»¤è¡Œå®ç°"></a>ByteTrack å‘½ä»¤è¡Œå®ç°</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">python demo/demo_mot_vis.py \</span><br><span class="line">        configs/mot/bytetrack/bytetrack_yolox_x_crowdhuman_mot17-private-half.py \</span><br><span class="line">        --checkpoint https://download.openmmlab.com/mmtracking/mot/bytetrack/bytetrack_yolox_x/bytetrack_yolox_x_crowdhuman_mot17-private-half_20211218_205500-1985c9f0.pth \</span><br><span class="line">        --input data/mot_people_short.mp4 \</span><br><span class="line">        --output outputs/F1_MOT_people_short.mp4</span><br></pre></td></tr></table></figure><h4 id="ByteTrack-Python-APIå®ç°"><a href="#ByteTrack-Python-APIå®ç°" class="headerlink" title="ByteTrack Python APIå®ç°"></a>ByteTrack Python APIå®ç°</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> mmcv</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">from</span> mmtrack.apis <span class="keyword">import</span> inference_mot, init_model</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å…¥è¾“å‡ºè§†é¢‘è·¯å¾„</span></span><br><span class="line">input_video = <span class="string">&#x27;data/mot_people_short.mp4&#x27;</span></span><br><span class="line">output = <span class="string">&#x27;outputs/F3_MOT_people_short.mp4&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®š config é…ç½®æ–‡ä»¶ å’Œ æ¨¡å‹æƒé‡æ–‡ä»¶ï¼Œåˆ›å»ºæ¨¡å‹</span></span><br><span class="line">mot_config = <span class="string">&#x27;./configs/mot/bytetrack/bytetrack_yolox_x_crowdhuman_mot17-private-half.py&#x27;</span></span><br><span class="line">mot_checkpoint = <span class="string">&#x27;https://download.openmmlab.com/mmtracking/mot/bytetrack/bytetrack_yolox_x/bytetrack_yolox_x_crowdhuman_mot17-private-half_20211218_205500-1985c9f0.pth&#x27;</span></span><br><span class="line"><span class="comment"># åˆå§‹åŒ–å¤šç›®æ ‡è¿½è¸ªæ¨¡å‹</span></span><br><span class="line">mot_model = init_model(mot_config, mot_checkpoint, device=<span class="string">&#x27;cuda:0&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯»å…¥å¾…é¢„æµ‹è§†é¢‘</span></span><br><span class="line">imgs = mmcv.VideoReader(input_video)</span><br><span class="line">prog_bar = mmcv.ProgressBar(<span class="built_in">len</span>(imgs))</span><br><span class="line">out_dir = tempfile.TemporaryDirectory()</span><br><span class="line">out_path = out_dir.name</span><br><span class="line"><span class="comment"># é€å¸§è¾“å…¥æ¨¡å‹é¢„æµ‹</span></span><br><span class="line"><span class="keyword">for</span> i, img <span class="keyword">in</span> <span class="built_in">enumerate</span>(imgs):</span><br><span class="line">    result = inference_mot(mot_model, img, frame_id=i)</span><br><span class="line">    </span><br><span class="line">    mot_model.show_result(</span><br><span class="line">            img,</span><br><span class="line">            result,</span><br><span class="line">            show=<span class="literal">False</span>,</span><br><span class="line">            wait_time=<span class="built_in">int</span>(<span class="number">1000.</span> / imgs.fps),</span><br><span class="line">            out_file=<span class="string">f&#x27;<span class="subst">&#123;out_path&#125;</span>/<span class="subst">&#123;i:06d&#125;</span>.jpg&#x27;</span>)</span><br><span class="line">    prog_bar.update()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;\n making the output video at <span class="subst">&#123;output&#125;</span> with a FPS of <span class="subst">&#123;imgs.fps&#125;</span>&#x27;</span>)</span><br><span class="line">mmcv.frames2video(out_path, output, fps=imgs.fps, fourcc=<span class="string">&#x27;mp4v&#x27;</span>)</span><br><span class="line">out_dir.cleanup()</span><br></pre></td></tr></table></figure><h2 id="mmtrackingçš„å…¶ä»–åŠŸèƒ½"><a href="#mmtrackingçš„å…¶ä»–åŠŸèƒ½" class="headerlink" title="mmtrackingçš„å…¶ä»–åŠŸèƒ½"></a>mmtrackingçš„å…¶ä»–åŠŸèƒ½</h2><h3 id="è§†é¢‘ç›®æ ‡æ£€æµ‹ã€ŒVIDã€"><a href="#è§†é¢‘ç›®æ ‡æ£€æµ‹ã€ŒVIDã€" class="headerlink" title="è§†é¢‘ç›®æ ‡æ£€æµ‹ã€ŒVIDã€"></a>è§†é¢‘ç›®æ ‡æ£€æµ‹ã€ŒVIDã€</h3><p><strong>è§†é¢‘ç›®æ ‡æ£€æµ‹ç›¸æ¯”äºå•å¸§ç›®æ ‡æ£€æµ‹ï¼Œåœ¨æ—¶é—´ç»´åº¦æ•è·æ›´å¤šä¿¡æ¯ç”¨äºæ£€æµ‹ä»»åŠ¡ï¼Œæ¯”å¦‚ç”¨ä¸Šä¸€å¸§çš„ç‰¹å¾è¾…åŠ©é¢„æµ‹ä¸‹ä¸€å¸§ï¼Œä½†æœ€åå®é™…æ•ˆæœå¹¶ä¸æ¯”å•å¸§ç›®æ ‡æ£€æµ‹æ›´å¥½ã€‚åŸå› ä¹‹ä¸€æ˜¯æ•°æ®é›†æ ‡æ³¨éš¾åº¦æ›´å¤§</strong></p><p><a href="https://github.com/open-mmlab/mmtracking/blob/master/docs/en/quick_run.md">å‚è€ƒæ–‡æ¡£</a> mmtrackingé¢„è®­ç»ƒæ¨¡å‹åº“<a href="https://mmtracking.readthedocs.io/en/latest/model_zoo.html">Model Zoo</a></p><p>æ¨¡å‹çš„ config æ–‡ä»¶éœ€å’Œ checkpoint æƒé‡æ–‡ä»¶ä¸€ä¸€å¯¹åº”ï¼Œæ¯”å¦‚ä¸‹é¢è¿™æ ·ï¼š</p><table><thead><tr><th align="center">æ¨¡å‹</th><th align="left">configæ–‡ä»¶</th><th align="left">checkpointæƒé‡æ–‡ä»¶</th></tr></thead><tbody><tr><td align="center">SELSA (ICCV 2019)</td><td align="left">configs&#x2F;vid&#x2F;selsa&#x2F;selsa_faster_rcnn_r101_dc5_1x_imagenetvid.py</td><td align="left"><a href="https://download.openmmlab.com/mmtracking/vid/selsa/selsa_faster_rcnn_r101_dc5_1x_imagenetvid/selsa_faster_rcnn_r101_dc5_1x_imagenetvid_20201218_172724-aa961bcc.pth">https://download.openmmlab.com/mmtracking/vid/selsa/selsa_faster_rcnn_r101_dc5_1x_imagenetvid/selsa_faster_rcnn_r101_dc5_1x_imagenetvid_20201218_172724-aa961bcc.pth</a></td></tr><tr><td align="center">Temporal RoI Align (AAAI 2021)</td><td align="left">configs&#x2F;vid&#x2F;temporal_roi_align&#x2F;selsa_troialign_faster_rcnn_x101_dc5_7e_imagenetvid.py</td><td align="left"><a href="https://download.openmmlab.com/mmtracking/vid/temporal_roi_align/selsa_troialign_faster_rcnn_x101_dc5_7e_imagenetvid/selsa_troialign_faster_rcnn_x101_dc5_7e_imagenetvid_20210822_164036-4471ac42.pth">https://download.openmmlab.com/mmtracking/vid/temporal_roi_align/selsa_troialign_faster_rcnn_x101_dc5_7e_imagenetvid/selsa_troialign_faster_rcnn_x101_dc5_7e_imagenetvid_20210822_164036-4471ac42.pth</a></td></tr></tbody></table><h4 id="å‘½ä»¤è¡Œè¿è¡Œ"><a href="#å‘½ä»¤è¡Œè¿è¡Œ" class="headerlink" title="å‘½ä»¤è¡Œè¿è¡Œ"></a>å‘½ä»¤è¡Œè¿è¡Œ</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">python ./demo/demo_vid.py \</span><br><span class="line">    ./configs/vid/selsa/selsa_faster_rcnn_r101_dc5_1x_imagenetvid.py \</span><br><span class="line">    --checkpoint https://download.openmmlab.com/mmtracking/vid/selsa/selsa_faster_rcnn_r101_dc5_1x_imagenetvid/selsa_faster_rcnn_r101_dc5_1x_imagenetvid_20201218_172724-aa961bcc.pth \</span><br><span class="line">    --input data/mot_people_short.mp4 \</span><br><span class="line">    --output outputs/B1_VID_SELSA.mp4 \</span><br><span class="line">    --score-thr 0.4 \</span><br><span class="line">    --thickness 2</span><br></pre></td></tr></table></figure><h4 id="Python-APIè¿è¡Œ-1"><a href="#Python-APIè¿è¡Œ-1" class="headerlink" title="Python APIè¿è¡Œ"></a>Python APIè¿è¡Œ</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> mmcv</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">from</span> mmtrack.apis <span class="keyword">import</span> inference_vid, init_model</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å…¥è¾“å‡ºè§†é¢‘è·¯å¾„</span></span><br><span class="line">input_video = <span class="string">&#x27;data/mot_people_short.mp4&#x27;</span></span><br><span class="line">output = <span class="string">&#x27;outputs/B2_VID_SELSA.mp4&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®š config é…ç½®æ–‡ä»¶ å’Œ æ¨¡å‹æƒé‡æ–‡ä»¶ï¼Œåˆ›å»ºæ¨¡å‹</span></span><br><span class="line">vid_config = <span class="string">&#x27;./configs/vid/selsa/selsa_faster_rcnn_r101_dc5_1x_imagenetvid.py&#x27;</span></span><br><span class="line">vid_checkpoint = <span class="string">&#x27;https://download.openmmlab.com/mmtracking/vid/selsa/selsa_faster_rcnn_r101_dc5_1x_imagenetvid/selsa_faster_rcnn_r101_dc5_1x_imagenetvid_20201218_172724-aa961bcc.pth&#x27;</span></span><br><span class="line">vid_model = init_model(vid_config, vid_checkpoint, device=<span class="string">&#x27;cuda:0&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯»å…¥å¾…é¢„æµ‹è§†é¢‘</span></span><br><span class="line">imgs = mmcv.VideoReader(input_video)</span><br><span class="line">prog_bar = mmcv.ProgressBar(<span class="built_in">len</span>(imgs))</span><br><span class="line">out_dir = tempfile.TemporaryDirectory()</span><br><span class="line">out_path = out_dir.name</span><br><span class="line"></span><br><span class="line"><span class="comment"># é€å¸§è¾“å…¥æ¨¡å‹é¢„æµ‹</span></span><br><span class="line"><span class="keyword">for</span> i, img <span class="keyword">in</span> <span class="built_in">enumerate</span>(imgs):</span><br><span class="line">    result = inference_vid(vid_model, img, frame_id=i)</span><br><span class="line">    vid_model.show_result(</span><br><span class="line">            img,</span><br><span class="line">            result,</span><br><span class="line">            wait_time=<span class="built_in">int</span>(<span class="number">1000.</span> / imgs.fps),</span><br><span class="line">            out_file=<span class="string">f&#x27;<span class="subst">&#123;out_path&#125;</span>/<span class="subst">&#123;i:06d&#125;</span>.jpg&#x27;</span>)</span><br><span class="line">    prog_bar.update()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆé¢„æµ‹è§†é¢‘</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;\n making the output video at <span class="subst">&#123;output&#125;</span> with a FPS of <span class="subst">&#123;imgs.fps&#125;</span>&#x27;</span>)</span><br><span class="line">mmcv.frames2video(out_path, output, fps=imgs.fps, fourcc=<span class="string">&#x27;mp4v&#x27;</span>)</span><br><span class="line">out_dir.cleanup()</span><br></pre></td></tr></table></figure><h3 id="è§†é¢‘å®ä¾‹åˆ†å‰²ã€ŒVISã€"><a href="#è§†é¢‘å®ä¾‹åˆ†å‰²ã€ŒVISã€" class="headerlink" title="è§†é¢‘å®ä¾‹åˆ†å‰²ã€ŒVISã€"></a>è§†é¢‘å®ä¾‹åˆ†å‰²ã€ŒVISã€</h3><p><strong>å’Œè§†é¢‘ç›®æ ‡æ£€æµ‹ç±»ä¼¼çš„ï¼Œç›¸æ¯”äºå•å¸§å®ä¾‹åˆ†å‰²ï¼Œè§†é¢‘å®ä¾‹åˆ†å‰²åœ¨æ—¶é—´ç»´åº¦æ•è·æ›´å¤šä¿¡æ¯ç”¨äºåˆ†å‰²ä»»åŠ¡ï¼Œä½†å®é™…æ•ˆæœå¹¶ä¸æ¯”å•å¸§å®ä¾‹åˆ†å‰²æ›´å¥½ã€Œç”šè‡³æ›´å·®ã€ã€‚åŸå› ä¹‹ä¸€æ˜¯æ•°æ®é›†æ ‡æ³¨éš¾åº¦æ›´å¤§</strong></p><h4 id="å‘½ä»¤è¡Œè¿è¡Œ-1"><a href="#å‘½ä»¤è¡Œè¿è¡Œ-1" class="headerlink" title="å‘½ä»¤è¡Œè¿è¡Œ"></a>å‘½ä»¤è¡Œè¿è¡Œ</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">python demo/demo_mot_vis.py \</span><br><span class="line">        configs/vis/masktrack_rcnn/masktrack_rcnn_r50_fpn_12e_youtubevis2019.py \</span><br><span class="line">        --checkpoint https://download.openmmlab.com/mmtracking/vis/masktrack_rcnn/masktrack_rcnn_r50_fpn_12e_youtubevis2019/masktrack_rcnn_r50_fpn_12e_youtubevis2019_20211022_194830-6ca6b91e.pth \</span><br><span class="line">        --input data/mot_people_short.mp4 \</span><br><span class="line">        --output outputs/B3_VIS_masktrack_rcnn.mp4</span><br></pre></td></tr></table></figure><h4 id="Python-APIè¿è¡Œ-2"><a href="#Python-APIè¿è¡Œ-2" class="headerlink" title="Python APIè¿è¡Œ"></a>Python APIè¿è¡Œ</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> mmcv</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">from</span> mmtrack.apis <span class="keyword">import</span> inference_mot, init_model</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å…¥è¾“å‡ºè§†é¢‘è·¯å¾„</span></span><br><span class="line">input_video = <span class="string">&#x27;data/mot_people_short.mp4&#x27;</span></span><br><span class="line">output = <span class="string">&#x27;outputs/B4_VIS_masktrack_rcnn.mp4&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®š config é…ç½®æ–‡ä»¶ å’Œ æ¨¡å‹æƒé‡æ–‡ä»¶ï¼Œåˆ›å»ºæ¨¡å‹</span></span><br><span class="line">vis_config = <span class="string">&#x27;./configs/vis/masktrack_rcnn/masktrack_rcnn_r50_fpn_12e_youtubevis2019.py&#x27;</span></span><br><span class="line">vis_checkpoint = <span class="string">&#x27;https://download.openmmlab.com/mmtracking/vis/masktrack_rcnn/masktrack_rcnn_r50_fpn_12e_youtubevis2019/masktrack_rcnn_r50_fpn_12e_youtubevis2019_20211022_194830-6ca6b91e.pth&#x27;</span></span><br><span class="line">vis_model = init_model(vis_config, vis_checkpoint, device=<span class="string">&#x27;cuda:0&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯»å…¥å¾…é¢„æµ‹è§†é¢‘</span></span><br><span class="line">imgs = mmcv.VideoReader(input_video)</span><br><span class="line">prog_bar = mmcv.ProgressBar(<span class="built_in">len</span>(imgs))</span><br><span class="line">out_dir = tempfile.TemporaryDirectory()</span><br><span class="line">out_path = out_dir.name</span><br><span class="line"></span><br><span class="line"><span class="comment"># é€å¸§è¾“å…¥æ¨¡å‹é¢„æµ‹</span></span><br><span class="line"><span class="keyword">for</span> i, img <span class="keyword">in</span> <span class="built_in">enumerate</span>(imgs):</span><br><span class="line">    result = inference_mot(vis_model, img, frame_id=i)</span><br><span class="line">    vis_model.show_result(</span><br><span class="line">            img,</span><br><span class="line">            result,</span><br><span class="line">            wait_time=<span class="built_in">int</span>(<span class="number">1000.</span> / imgs.fps),</span><br><span class="line">            out_file=<span class="string">f&#x27;<span class="subst">&#123;out_path&#125;</span>/<span class="subst">&#123;i:06d&#125;</span>.jpg&#x27;</span>)</span><br><span class="line">    prog_bar.update()</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;\n making the output video at <span class="subst">&#123;output&#125;</span> with a FPS of <span class="subst">&#123;imgs.fps&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆé¢„æµ‹è§†é¢‘</span></span><br><span class="line">mmcv.frames2video(out_path, output, fps=imgs.fps, fourcc=<span class="string">&#x27;mp4v&#x27;</span>)</span><br><span class="line">out_dir.cleanup()</span><br></pre></td></tr></table></figure><h3 id="æ•°æ®é›†ä¸Šè¯„ä¼°æ¨¡å‹æ•ˆæœ"><a href="#æ•°æ®é›†ä¸Šè¯„ä¼°æ¨¡å‹æ•ˆæœ" class="headerlink" title="æ•°æ®é›†ä¸Šè¯„ä¼°æ¨¡å‹æ•ˆæœ"></a>æ•°æ®é›†ä¸Šè¯„ä¼°æ¨¡å‹æ•ˆæœ</h3><h4 id="æµ‹è¯•VIDæ¨¡å‹"><a href="#æµ‹è¯•VIDæ¨¡å‹" class="headerlink" title="æµ‹è¯•VIDæ¨¡å‹"></a>æµ‹è¯•VIDæ¨¡å‹</h4><p>åœ¨ImageNet VIDæ•°æ®é›†ä¸Šï¼Œè¯„ä¼°DFFæ¨¡å‹çš„bbox mAP</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">python tools/test.py  \</span><br><span class="line">    configs/vid/dff/dff_faster_rcnn_r101_dc5_1x_imagenetvid.py \</span><br><span class="line">    --checkpoint checkpoints/dff_faster_rcnn_r101_dc5_1x_imagenetvid_20201218_172720-ad732e17.pth \</span><br><span class="line">    --out results.pkl \</span><br><span class="line">    --eval bbox</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> ç›®æ ‡è¿½è¸ªç³»åˆ— </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Œç¯å¢ƒé…ç½®ã€ï¼ˆäºŒï¼‰åœ¨äº‘æœåŠ¡å™¨ä¸Šé…ç½®mmtrackingç¯å¢ƒ</title>
      <link href="/2022/05/22/%E3%80%8C%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E3%80%8D%EF%BC%88%E4%BA%8C%EF%BC%89%E5%9C%A8%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E9%85%8D%E7%BD%AEmmtracking%E7%8E%AF%E5%A2%83/"/>
      <url>/2022/05/22/%E3%80%8C%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E3%80%8D%EF%BC%88%E4%BA%8C%EF%BC%89%E5%9C%A8%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E9%85%8D%E7%BD%AEmmtracking%E7%8E%AF%E5%A2%83/</url>
      
        <content type="html"><![CDATA[<p>å‚è€ƒæ–‡ç« ã€Œ<a href="https://mmtracking.readthedocs.io/zh_CN/latest/"><strong>mmtrackæ–‡æ¡£</strong></a>ã€</p><h3 id="åœ¨æ’æºäº‘ä¸‹-æ–°å»ºPytorch1-11-CUDA-1-10-0çš„ç¯å¢ƒ"><a href="#åœ¨æ’æºäº‘ä¸‹-æ–°å»ºPytorch1-11-CUDA-1-10-0çš„ç¯å¢ƒ" class="headerlink" title="åœ¨æ’æºäº‘ä¸‹ æ–°å»ºPytorch1.11 CUDA 1.10.0çš„ç¯å¢ƒ"></a>åœ¨æ’æºäº‘ä¸‹ æ–°å»ºPytorch1.11 CUDA 1.10.0çš„ç¯å¢ƒ</h3><h3 id="å®‰è£…VOTæ•°æ®é›†æµ‹è¯•è¯„ä¼°åº“"><a href="#å®‰è£…VOTæ•°æ®é›†æµ‹è¯•è¯„ä¼°åº“" class="headerlink" title="å®‰è£…VOTæ•°æ®é›†æµ‹è¯•è¯„ä¼°åº“"></a>å®‰è£…VOTæ•°æ®é›†æµ‹è¯•è¯„ä¼°åº“</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install git+https://github.com/votchallenge/toolkit.git</span><br></pre></td></tr></table></figure><h3 id="å®‰è£…mmcv-full"><a href="#å®‰è£…mmcv-full" class="headerlink" title="å®‰è£…mmcv-full"></a>å®‰è£…mmcv-full</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install mmcv-full==1.5.0 -f https://download.openmmlab.com/mmcv/dist/cu111/torch1.10.0/index.html</span><br></pre></td></tr></table></figure><h3 id="å®‰è£…mmdet"><a href="#å®‰è£…mmdet" class="headerlink" title="å®‰è£…mmdet"></a>å®‰è£…mmdet</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install mmdet</span><br></pre></td></tr></table></figure><h3 id="å°†mmtrackingå…‹éš†åˆ°æœ¬åœ°"><a href="#å°†mmtrackingå…‹éš†åˆ°æœ¬åœ°" class="headerlink" title="å°†mmtrackingå…‹éš†åˆ°æœ¬åœ°"></a>å°†mmtrackingå…‹éš†åˆ°æœ¬åœ°</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/open-mmlab/mmtracking.git</span><br><span class="line">cd mmtracking</span><br></pre></td></tr></table></figure><h3 id="å®‰è£…å¿…å¤‡ä¾èµ–"><a href="#å®‰è£…å¿…å¤‡ä¾èµ–" class="headerlink" title="å®‰è£…å¿…å¤‡ä¾èµ–"></a>å®‰è£…å¿…å¤‡ä¾èµ–</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pip install -r requirements.txt</span><br><span class="line">pip install setuptools==58.2.0 # è¿™æ­¥éå¸¸é‡è¦ æ–°ç‰ˆæœ¬ä¸å†æ”¯æŒeasy_install </span><br><span class="line">pip install -v -e .  # or &quot;python setup.py develop&quot;</span><br><span class="line">sudo apt-get install libglib2.0-0</span><br></pre></td></tr></table></figure><span id="more"></span><h3 id="å®‰è£…é¢å¤–çš„ä¾èµ–"><a href="#å®‰è£…é¢å¤–çš„ä¾èµ–" class="headerlink" title="å®‰è£…é¢å¤–çš„ä¾èµ–"></a>å®‰è£…é¢å¤–çš„ä¾èµ–</h3><h4 id="ä¸º-MOTChallenge-è¯„ä¼°"><a href="#ä¸º-MOTChallenge-è¯„ä¼°" class="headerlink" title="ä¸º MOTChallenge è¯„ä¼°"></a>ä¸º MOTChallenge è¯„ä¼°</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install git+https://github.com/JonathonLuiten/TrackEval.git</span><br></pre></td></tr></table></figure><h4 id="ä¸ºLVISè¯„ä¼°"><a href="#ä¸ºLVISè¯„ä¼°" class="headerlink" title="ä¸ºLVISè¯„ä¼°"></a>ä¸ºLVISè¯„ä¼°</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install git+https://github.com/lvis-dataset/lvis-api.git</span><br></pre></td></tr></table></figure><h4 id="ä¸ºTAOè¯„ä¼°"><a href="#ä¸ºTAOè¯„ä¼°" class="headerlink" title="ä¸ºTAOè¯„ä¼°"></a>ä¸ºTAOè¯„ä¼°</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install git+https://github.com/TAO-Dataset/tao.git</span><br></pre></td></tr></table></figure><h3 id="éªŒè¯"><a href="#éªŒè¯" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python demo/demo_mot_vis.py configs/mot/deepsort/sort_faster-rcnn_fpn_4e_mot17-private.py --input demo/demo.mp4 --output mot.mp4</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> ç¯å¢ƒé…ç½® </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Œç›®æ ‡è¿½è¸ªç³»åˆ—ã€ï¼ˆä¸€ï¼‰åˆè¯†ç›®æ ‡è¿½è¸ª</title>
      <link href="/2022/05/22/%E3%80%8C%E7%9B%AE%E6%A0%87%E8%BF%BD%E8%B8%AA%E7%B3%BB%E5%88%97%E3%80%8D%EF%BC%88%E4%B8%80%EF%BC%89%E5%88%9D%E8%AF%86%E7%9B%AE%E6%A0%87%E8%BF%BD%E8%B8%AA/"/>
      <url>/2022/05/22/%E3%80%8C%E7%9B%AE%E6%A0%87%E8%BF%BD%E8%B8%AA%E7%B3%BB%E5%88%97%E3%80%8D%EF%BC%88%E4%B8%80%EF%BC%89%E5%88%9D%E8%AF%86%E7%9B%AE%E6%A0%87%E8%BF%BD%E8%B8%AA/</url>
      
        <content type="html"><![CDATA[<h2 id="ä»€ä¹ˆæ˜¯ç›®æ ‡è¿½è¸ª"><a href="#ä»€ä¹ˆæ˜¯ç›®æ ‡è¿½è¸ª" class="headerlink" title="ä»€ä¹ˆæ˜¯ç›®æ ‡è¿½è¸ª"></a>ä»€ä¹ˆæ˜¯ç›®æ ‡è¿½è¸ª</h2><blockquote><p>è½¬è‡ªçŸ¥ä¹ã€Œ<a href="https://zhuanlan.zhihu.com/p/148516834">é“¾æ¥</a>ã€ã€Œ<a href="https://kns.cnki.net/KCMS/detail/11.2109.TP.20190104.1506.016.html?uid=WEEvREcwSlJHSldRa1FhdXNXaEd1OFVOaDdwQ0tCckFuaHBIcFFIbUxkbz0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!&v=MDU3Nzk0WXc5TXptUm42ajU3VDNmbHFXTTBDTEw3UjdxZWJ1WnNGaUhrVzd6QkpGWT1LQ0xmWWJHNEg5ak1ybzlHWk90">è®ºæ–‡åŸæ–‡</a>ã€</p></blockquote><p>ç›®æ ‡è¿½è¸ªæ˜¯è®¡ç®—æœºè§†è§‰é¢†åŸŸçš„ä¸€ä¸ªé‡è¦é—®é¢˜ï¼Œç›®å‰å¹¿æ³›åº”ç”¨åœ¨ä½“è‚²èµ›äº‹è½¬æ’­ã€å®‰é˜²ç›‘æ§å’Œæ— äººæœºã€æ— äººè½¦ã€æœºå™¨äººç­‰é¢†åŸŸã€‚ä¸‹é¢æ˜¯ä¸€äº›åº”ç”¨çš„ä¾‹å­</p><p><img src="https://pic1.zhimg.com/80/v2-531de42fb6687921041aa8a8e6cd2ce8_720w.jpg" alt="ç”°å¾„æ¯”èµ›"></p><p><img src="https://pic3.zhimg.com/80/v2-9b8f472d7c98a1a91b4b93d0d8886b36_720w.jpg" alt="è¶³çƒæ¯”èµ›"></p><p><img src="https://pic1.zhimg.com/80/v2-deee3ca02a16a4ac0d098acb2390cfac_720w.jpg" alt="è½¦è¾†è¿½è¸ª"></p><h2 id="ç›®æ ‡è¿½è¸ªä»»åŠ¡åˆ†ç±»"><a href="#ç›®æ ‡è¿½è¸ªä»»åŠ¡åˆ†ç±»" class="headerlink" title="ç›®æ ‡è¿½è¸ªä»»åŠ¡åˆ†ç±»"></a>ç›®æ ‡è¿½è¸ªä»»åŠ¡åˆ†ç±»</h2><h3 id="ä»ç›®æ ‡è¿½è¸ªçš„ç”¨é€”å‡ºå‘ï¼Œç›®æ ‡è¿½è¸ªå¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ç§ä»»åŠ¡"><a href="#ä»ç›®æ ‡è¿½è¸ªçš„ç”¨é€”å‡ºå‘ï¼Œç›®æ ‡è¿½è¸ªå¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ç§ä»»åŠ¡" class="headerlink" title="ä»ç›®æ ‡è¿½è¸ªçš„ç”¨é€”å‡ºå‘ï¼Œç›®æ ‡è¿½è¸ªå¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ç§ä»»åŠ¡"></a>ä»ç›®æ ‡è¿½è¸ªçš„ç”¨é€”å‡ºå‘ï¼Œç›®æ ‡è¿½è¸ªå¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ç§ä»»åŠ¡</h3><p><strong>å•ç›®æ ‡è¿½è¸ª</strong> - ç»™å®šä¸€ä¸ªç›®æ ‡ï¼Œè¿½è¸ªè¿™ä¸ªç›®æ ‡çš„ä½ç½®ã€‚</p><p><strong>å¤šç›®æ ‡è¿½è¸ª</strong> - è¿½è¸ªå¤šä¸ªç›®æ ‡çš„ä½ç½®</p><p><strong>Person Re-ID</strong> - è¡Œäººé‡è¯†åˆ«ï¼Œæ˜¯åˆ©ç”¨è®¡ç®—æœºè§†è§‰æŠ€æœ¯åˆ¤æ–­å›¾åƒæˆ–è€…è§†é¢‘åºåˆ—ä¸­æ˜¯å¦å­˜åœ¨ç‰¹å®šè¡Œäººçš„æŠ€æœ¯ã€‚å¹¿æ³›è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªå›¾åƒæ£€ç´¢çš„å­é—®é¢˜ã€‚ç»™å®šä¸€ä¸ªç›‘æ§è¡Œäººå›¾åƒï¼Œæ£€ç´¢è·¨è®¾å¤‡ä¸‹çš„è¯¥è¡Œäººå›¾åƒã€‚æ—¨åœ¨å¼¥è¡¥å›ºå®šçš„æ‘„åƒå¤´çš„è§†è§‰å±€é™ï¼Œå¹¶å¯ä¸è¡Œäººæ£€æµ‹&#x2F;è¡Œäººè¿½è¸ªæŠ€æœ¯ç›¸ç»“åˆã€‚</p><p><strong>MTMCT</strong> - å¤šç›®æ ‡å¤šæ‘„åƒå¤´è¿½è¸ªï¼ˆMulti-target Multi-camera Trackingï¼‰ï¼Œè¿½è¸ªå¤šä¸ªæ‘„åƒå¤´æ‹æ‘„çš„å¤šä¸ªäºº</p><p><strong>å§¿æ€è¿½è¸ª</strong> - è¿½è¸ªäººçš„å§¿æ€</p><h3 id="æŒ‰ç…§ä»»åŠ¡è®¡ç®—ç±»å‹åˆå¯ä»¥åˆ†ä¸ºä»¥ä¸‹2ç±»"><a href="#æŒ‰ç…§ä»»åŠ¡è®¡ç®—ç±»å‹åˆå¯ä»¥åˆ†ä¸ºä»¥ä¸‹2ç±»" class="headerlink" title="æŒ‰ç…§ä»»åŠ¡è®¡ç®—ç±»å‹åˆå¯ä»¥åˆ†ä¸ºä»¥ä¸‹2ç±»"></a>æŒ‰ç…§ä»»åŠ¡è®¡ç®—ç±»å‹åˆå¯ä»¥åˆ†ä¸ºä»¥ä¸‹2ç±»</h3><p><strong>åœ¨çº¿è¿½è¸ª</strong> - åœ¨çº¿è¿½è¸ªéœ€è¦å®æ—¶å¤„ç†ä»»åŠ¡ï¼Œé€šè¿‡è¿‡å»å’Œç°åœ¨å¸§æ¥è¿½è¸ªæœªæ¥å¸§ä¸­ç‰©ä½“çš„ä½ç½®ã€‚</p><p><strong>ç¦»çº¿è¿½è¸ª</strong> - ç¦»çº¿è¿½è¸ªæ˜¯ç¦»çº¿å¤„ç†ä»»åŠ¡ï¼Œå¯ä»¥é€šè¿‡è¿‡å»ã€ç°åœ¨å’Œæœªæ¥çš„å¸§æ¥æ¨æ–­ç‰©ä½“çš„ä½ç½®ï¼Œå› æ­¤å‡†ç¡®ç‡ä¼šåœ¨çº¿è¿½è¸ªé«˜ã€‚</p><span id="more"></span><h2 id="ç›®æ ‡è¿½è¸ªçš„å›°éš¾ç‚¹"><a href="#ç›®æ ‡è¿½è¸ªçš„å›°éš¾ç‚¹" class="headerlink" title="ç›®æ ‡è¿½è¸ªçš„å›°éš¾ç‚¹"></a>ç›®æ ‡è¿½è¸ªçš„å›°éš¾ç‚¹</h2><h3 id="å½¢æ€å˜åŒ–"><a href="#å½¢æ€å˜åŒ–" class="headerlink" title="å½¢æ€å˜åŒ–"></a><strong>å½¢æ€å˜åŒ–</strong></h3><p> å§¿æ€å˜åŒ–æ˜¯ç›®æ ‡è¿½è¸ªä¸­å¸¸è§çš„å¹²æ‰°é—®é¢˜ã€‚è¿åŠ¨ç›®æ ‡å‘ç”Ÿå§¿æ€å˜åŒ–æ—¶, ä¼šå¯¼è‡´å®ƒçš„ç‰¹å¾ä»¥åŠå¤–è§‚æ¨¡å‹å‘ç”Ÿæ”¹å˜, å®¹æ˜“å¯¼è‡´è¿½è¸ªå¤±è´¥ã€‚ä¾‹å¦‚:ä½“è‚²æ¯”èµ›ä¸­çš„è¿åŠ¨å‘˜ã€é©¬è·¯ä¸Šçš„è¡Œäººã€‚</p><h3 id="å°ºåº¦å˜åŒ–"><a href="#å°ºåº¦å˜åŒ–" class="headerlink" title="å°ºåº¦å˜åŒ–"></a><strong>å°ºåº¦å˜åŒ–</strong></h3><p>å°ºåº¦çš„è‡ªé€‚åº”ä¹Ÿæ˜¯ç›®æ ‡è¿½è¸ªä¸­çš„å…³é”®é—®é¢˜ã€‚å½“ç›®æ ‡å°ºåº¦ç¼©å°æ—¶, ç”±äºè¿½è¸ªæ¡†ä¸èƒ½è‡ªé€‚åº”è¿½è¸ª, ä¼šå°†å¾ˆå¤šèƒŒæ™¯ä¿¡æ¯åŒ…å«åœ¨å†…, å¯¼è‡´ç›®æ ‡æ¨¡å‹çš„æ›´æ–°é”™è¯¯:å½“ç›®æ ‡å°ºåº¦å¢å¤§æ—¶, ç”±äºè¿½è¸ªæ¡†ä¸èƒ½å°†ç›®æ ‡å®Œå…¨åŒ…æ‹¬åœ¨å†…, è¿½è¸ªæ¡†å†…ç›®æ ‡ä¿¡æ¯ä¸å…¨, ä¹Ÿä¼šå¯¼è‡´ç›®æ ‡æ¨¡å‹çš„æ›´æ–°é”™è¯¯ã€‚å› æ­¤, å®ç°å°ºåº¦è‡ªé€‚åº”è¿½è¸ªæ˜¯ååˆ†å¿…è¦çš„ã€‚</p><h3 id="é®æŒ¡ä¸æ¶ˆå¤±"><a href="#é®æŒ¡ä¸æ¶ˆå¤±" class="headerlink" title="é®æŒ¡ä¸æ¶ˆå¤±"></a><strong>é®æŒ¡ä¸æ¶ˆå¤±</strong></h3><p>ç›®æ ‡åœ¨è¿åŠ¨è¿‡ç¨‹ä¸­å¯èƒ½å‡ºç°è¢«é®æŒ¡æˆ–è€…çŸ­æš‚çš„æ¶ˆå¤±æƒ…å†µã€‚å½“è¿™ç§æƒ…å†µå‘ç”Ÿæ—¶, è¿½è¸ªæ¡†å®¹æ˜“å°†é®æŒ¡ç‰©ä»¥åŠèƒŒæ™¯ä¿¡æ¯åŒ…å«åœ¨è¿½è¸ªæ¡†å†…, ä¼šå¯¼è‡´åç»­å¸§ä¸­çš„è¿½è¸ªç›®æ ‡æ¼‚ç§»åˆ°é®æŒ¡ç‰©ä¸Šé¢ã€‚è‹¥ç›®æ ‡è¢«å®Œå…¨é®æŒ¡æ—¶, ç”±äºæ‰¾ä¸åˆ°ç›®æ ‡çš„å¯¹åº”æ¨¡å‹, ä¼šå¯¼è‡´è¿½è¸ªå¤±è´¥ã€‚</p><h3 id="å›¾åƒæ¨¡ç³Š"><a href="#å›¾åƒæ¨¡ç³Š" class="headerlink" title="å›¾åƒæ¨¡ç³Š"></a><strong>å›¾åƒæ¨¡ç³Š</strong></h3><p>å…‰ç…§å¼ºåº¦å˜åŒ–, ç›®æ ‡å¿«é€Ÿè¿åŠ¨, ä½åˆ†è¾¨ç‡ç­‰æƒ…å†µä¼šå¯¼è‡´å›¾åƒæ¨¡å‹, å°¤å…¶æ˜¯åœ¨è¿åŠ¨ç›®æ ‡ä¸èƒŒæ™¯ç›¸ä¼¼çš„æƒ…å†µä¸‹æ›´ä¸ºæ˜æ˜¾ã€‚å› æ­¤, é€‰æ‹©æœ‰æ•ˆçš„ç‰¹å¾å¯¹ç›®æ ‡å’ŒèƒŒæ™¯è¿›è¡ŒåŒºåˆ†éå¸¸å¿…è¦ã€‚</p><h3 id="å®ä¾‹å›¾"><a href="#å®ä¾‹å›¾" class="headerlink" title="å®ä¾‹å›¾"></a>å®ä¾‹å›¾</h3><p><img src="https://pic1.zhimg.com/80/v2-522e7bad45da314edb03ea3c7b26f260_720w.jpg" alt="å…‰ç…§ä»¥åŠæ¨¡ç³Š"></p><p><img src="https://pic3.zhimg.com/80/v2-46f38d9ee2dd149639774ee598e4456a_720w.jpg" alt="å½¢å˜ä»¥åŠé®æŒ¡"></p><h2 id="ç›®æ ‡è¿½è¸ªæ–¹æ³•"><a href="#ç›®æ ‡è¿½è¸ªæ–¹æ³•" class="headerlink" title="ç›®æ ‡è¿½è¸ªæ–¹æ³•"></a>ç›®æ ‡è¿½è¸ªæ–¹æ³•</h2><h3 id="æŒ‰ç…§æ¨¡å¼åˆ’åˆ†å¯ä»¥åˆ†ä¸º2ç±»"><a href="#æŒ‰ç…§æ¨¡å¼åˆ’åˆ†å¯ä»¥åˆ†ä¸º2ç±»" class="headerlink" title="æŒ‰ç…§æ¨¡å¼åˆ’åˆ†å¯ä»¥åˆ†ä¸º2ç±»"></a>æŒ‰ç…§æ¨¡å¼åˆ’åˆ†å¯ä»¥åˆ†ä¸º2ç±»</h3><h4 id="ç”Ÿæˆå¼æ¨¡å‹"><a href="#ç”Ÿæˆå¼æ¨¡å‹" class="headerlink" title="ç”Ÿæˆå¼æ¨¡å‹"></a><strong>ç”Ÿæˆå¼æ¨¡å‹</strong></h4><p>æ—©æœŸçš„å·¥ä½œä¸»è¦é›†ä¸­äºç”Ÿæˆå¼æ¨¡å‹è¿½è¸ªç®—æ³•çš„ç ”ç©¶, å¦‚å…‰æµæ³•ã€ç²’å­æ»¤æ³¢ã€Meanshiftç®—æ³•ã€Camshiftç®—æ³•ç­‰.<strong>æ­¤ç±»æ–¹æ³•é¦–å…ˆå»ºç«‹ç›®æ ‡æ¨¡å‹æˆ–è€…æå–ç›®æ ‡ç‰¹å¾, åœ¨åç»­å¸§ä¸­è¿›è¡Œç›¸ä¼¼ç‰¹å¾æœç´¢.é€æ­¥è¿­ä»£å®ç°ç›®æ ‡å®šä½</strong>.ä½†æ˜¯è¿™ç±»æ–¹æ³•ä¹Ÿå­˜åœ¨æ˜æ˜¾çš„ç¼ºç‚¹, å°±æ˜¯å›¾åƒçš„èƒŒæ™¯ä¿¡æ¯æ²¡æœ‰å¾—åˆ°å…¨é¢çš„åˆ©ç”¨.ä¸”ç›®æ ‡æœ¬èº«çš„å¤–è§‚å˜åŒ–æœ‰éšæœºæ€§å’Œå¤šæ ·æ€§ç‰¹ç‚¹, å› æ­¤, é€šè¿‡å•ä¸€çš„æ•°å­¦æ¨¡å‹æè¿°å¾…è¿½è¸ªç›®æ ‡å…·æœ‰å¾ˆå¤§çš„å±€é™æ€§.å…·ä½“è¡¨ç°ä¸ºåœ¨å…‰ç…§å˜åŒ–, è¿åŠ¨æ¨¡ç³Š, åˆ†è¾¨ç‡ä½, ç›®æ ‡æ—‹è½¬å½¢å˜ç­‰æƒ…å†µä¸‹, æ¨¡å‹çš„å»ºç«‹ä¼šå—åˆ°å·¨å¤§çš„å½±å“, ä»è€Œå½±å“è¿½è¸ªçš„å‡†ç¡®æ€§; æ¨¡å‹çš„å»ºç«‹æ²¡æœ‰æœ‰æ•ˆåœ°é¢„æµ‹æœºåˆ¶, å½“å‡ºç°ç›®æ ‡é®æŒ¡æƒ…å†µæ—¶, ä¸èƒ½å¤Ÿå¾ˆå¥½åœ°è§£å†³ã€‚</p><h4 id="é‰´åˆ«å¼æ¨¡å‹"><a href="#é‰´åˆ«å¼æ¨¡å‹" class="headerlink" title="é‰´åˆ«å¼æ¨¡å‹"></a><strong>é‰´åˆ«å¼æ¨¡å‹</strong></h4><p>é‰´åˆ«å¼æ¨¡å‹æ˜¯æŒ‡, å°†ç›®æ ‡æ¨¡å‹å’ŒèƒŒæ™¯ä¿¡æ¯åŒæ—¶è€ƒè™‘åœ¨å†…, é€šè¿‡å¯¹æ¯”ç›®æ ‡æ¨¡å‹å’ŒèƒŒæ™¯ä¿¡æ¯çš„å·®å¼‚, å°†ç›®æ ‡æ¨¡å‹æå–å‡ºæ¥, ä»è€Œå¾—åˆ°å½“å‰å¸§ä¸­çš„ç›®æ ‡ä½ç½®,åœ¨å¯¹è¿½è¸ªç®—æ³•çš„è¯„ä¼°ä¸­å‘ç°, é€šè¿‡å°†èƒŒæ™¯ä¿¡æ¯å¼•å…¥è¿½è¸ªæ¨¡å‹, å¯ä»¥å¾ˆå¥½åœ°å®ç°ç›®æ ‡è¿½è¸ª.å› æ­¤é‰´åˆ«å¼æ¨¡å‹å…·æœ‰å¾ˆå¤§çš„ä¼˜åŠ¿. 2000å¹´ä»¥æ¥, äººä»¬é€æ¸å°è¯•ä½¿ç”¨ç»å…¸çš„æœºå™¨å­¦ä¹ æ–¹æ³•è®­ç»ƒåˆ†ç±»å™¨, ä¾‹å¦‚MILã€TLDã€æ”¯æŒå‘é‡æœºã€ç»“æ„åŒ–å­¦ä¹ ã€éšæœºæ£®æ—ã€å¤šå®ä¾‹å­¦ä¹ ã€åº¦é‡å­¦ä¹ . 2010å¹´, é¦–æ¬¡å°†é€šä¿¡é¢†åŸŸçš„ç›¸å…³æ»¤æ³¢æ–¹æ³•å¼•å…¥åˆ°ç›®æ ‡è¿½è¸ªä¸­.ä½œä¸ºé‰´åˆ«å¼æ–¹æ³•çš„ä¸€ç§, ç›¸å…³æ»¤æ³¢æ— è®ºåœ¨é€Ÿåº¦ä¸Šè¿˜æ˜¯å‡†ç¡®ç‡ä¸Š, éƒ½æ˜¾ç¤ºå‡ºæ›´ä¼˜è¶Šçš„æ€§èƒ½.ç„¶è€Œ, ç›¸å…³æ»¤æ³¢å™¨ç”¨äºç›®æ ‡è¿½è¸ªæ˜¯åœ¨2014å¹´ä¹‹å.è‡ª2015å¹´ä»¥å, éšç€æ·±åº¦å­¦ä¹ æŠ€æœ¯çš„å¹¿æ³›åº”ç”¨, äººä»¬å¼€å§‹å°†æ·±åº¦å­¦ä¹ æŠ€æœ¯ç”¨äºç›®æ ‡è¿½è¸ªã€‚</p><h3 id="æŒ‰ç…§æ—¶é—´é¡ºåº"><a href="#æŒ‰ç…§æ—¶é—´é¡ºåº" class="headerlink" title="æŒ‰ç…§æ—¶é—´é¡ºåº"></a>æŒ‰ç…§æ—¶é—´é¡ºåº</h3><p>ç›®æ ‡è¿½è¸ªçš„æ–¹æ³•ç»å†äº†ä»<strong>ç»å…¸è¿½è¸ªç®—æ³•</strong>åˆ°<strong>åŸºäºæ ¸ç›¸å…³æ»¤æ³¢ç®—æ³•</strong>ï¼Œå†åˆ°<strong>åŸºäºæ·±åº¦å­¦ä¹ çš„è¿½è¸ªç®—æ³•</strong>çš„è¿‡ç¨‹</p><h4 id="ç»å…¸è¿½è¸ªç®—æ³•"><a href="#ç»å…¸è¿½è¸ªç®—æ³•" class="headerlink" title="ç»å…¸è¿½è¸ªç®—æ³•"></a>ç»å…¸è¿½è¸ªç®—æ³•</h4><p>æ—©æœŸçš„ç›®æ ‡è¿½è¸ªç®—æ³•ä¸»è¦æ˜¯æ ¹æ®ç›®æ ‡å»ºæ¨¡æˆ–è€…å¯¹ç›®æ ‡ç‰¹å¾è¿›è¡Œè¿½è¸ª</p><ol><li>åŸºäºç›®æ ‡æ¨¡å‹å»ºæ¨¡çš„æ–¹æ³• é€šè¿‡å¯¹ç›®æ ‡å¤–è§‚æ¨¡å‹è¿›è¡Œå»ºæ¨¡, ç„¶ååœ¨ä¹‹åçš„å¸§ä¸­æ‰¾åˆ°ç›®æ ‡.ä¾‹å¦‚, åŒºåŸŸåŒ¹é…ã€ç‰¹å¾ç‚¹è¿½è¸ªã€åŸºäºä¸»åŠ¨è½®å»“çš„è¿½è¸ªç®—æ³•ã€å…‰æµæ³•ç­‰.æœ€å¸¸ç”¨çš„æ˜¯ç‰¹å¾åŒ¹é…æ³•, é¦–å…ˆæå–ç›®æ ‡ç‰¹å¾, ç„¶ååœ¨åç»­çš„å¸§ä¸­æ‰¾åˆ°æœ€ç›¸ä¼¼çš„ç‰¹å¾è¿›è¡Œç›®æ ‡å®šä½, å¸¸ç”¨çš„ç‰¹å¾æœ‰: SIFTç‰¹å¾ã€SURFç‰¹å¾ã€Harrisè§’ç‚¹ç­‰ã€‚</li><li>åŸºäºæœç´¢çš„æ–¹æ³• éšç€ç ”ç©¶çš„æ·±å…¥, äººä»¬å‘ç°åŸºäºç›®æ ‡æ¨¡å‹å»ºæ¨¡çš„æ–¹æ³•å¯¹æ•´å¼ å›¾ç‰‡è¿›è¡Œå¤„ç†, å®æ—¶æ€§å·®.äººä»¬å°†é¢„æµ‹ç®—æ³•åŠ å…¥è¿½è¸ªä¸­, åœ¨é¢„æµ‹å€¼é™„è¿‘è¿›è¡Œç›®æ ‡æœç´¢, å‡å°‘äº†æœç´¢çš„èŒƒå›´.å¸¸è§ä¸€ç±»çš„é¢„æµ‹ç®—æ³•æœ‰Kalmanæ»¤æ³¢ã€ç²’å­æ»¤æ³¢[8]æ–¹æ³•.å¦ä¸€ç§å‡å°æœç´¢èŒƒå›´çš„æ–¹æ³•æ˜¯å†…æ ¸æ–¹æ³•:è¿ç”¨æœ€é€Ÿä¸‹é™æ³•çš„åŸç†, å‘æ¢¯åº¦ä¸‹é™æ–¹å‘å¯¹ç›®æ ‡æ¨¡æ¿é€æ­¥è¿­ä»£, ç›´åˆ°è¿­ä»£åˆ°æœ€ä¼˜ä½ç½®.è¯¸å¦‚, Meanshiftã€Camshiftç®—æ³•</li></ol><h5 id="å…‰æµæ³•"><a href="#å…‰æµæ³•" class="headerlink" title="å…‰æµæ³•"></a><strong>å…‰æµæ³•</strong></h5><p>å…‰æµæ³•(Lucas-Kanade)çš„æ¦‚å¿µé¦–å…ˆåœ¨1950å¹´æå‡º, å®ƒæ˜¯é’ˆå¯¹å¤–è§‚æ¨¡å‹å¯¹è§†é¢‘åºåˆ—ä¸­çš„åƒç´ è¿›è¡Œæ“ä½œ.é€šè¿‡åˆ©ç”¨è§†é¢‘åºåˆ—åœ¨ç›¸é‚»å¸§ä¹‹é—´çš„åƒç´ å…³ç³», å¯»æ‰¾åƒç´ çš„ä½ç§»å˜åŒ–æ¥åˆ¤æ–­ç›®æ ‡çš„è¿åŠ¨çŠ¶æ€, å®ç°å¯¹è¿åŠ¨ç›®æ ‡çš„è¿½è¸ª.ä½†æ˜¯, å…‰æµæ³•é€‚ç”¨çš„èŒƒå›´è¾ƒå°, éœ€è¦æ»¡è¶³ä¸‰ç§å‡è®¾:å›¾åƒçš„å…‰ç…§å¼ºåº¦ä¿æŒä¸å˜; ç©ºé—´ä¸€è‡´æ€§, å³æ¯ä¸ªåƒç´ åœ¨ä¸åŒå¸§ä¸­ç›¸é‚»ç‚¹çš„ä½ç½®ä¸å˜, è¿™æ ·ä¾¿äºæ±‚å¾—æœ€ç»ˆçš„è¿åŠ¨çŸ¢é‡; æ—¶é—´è¿ç»­.å…‰æµæ³•é€‚ç”¨äºç›®æ ‡è¿åŠ¨ç›¸å¯¹äºå¸§ç‡æ˜¯ç¼“æ…¢çš„, ä¹Ÿå°±æ˜¯ä¸¤å¸§ä¹‹é—´çš„ç›®æ ‡ä½ç§»ä¸èƒ½å¤ªå¤§.</p><h5 id="Meanshift"><a href="#Meanshift" class="headerlink" title="Meanshift"></a><strong>Meanshift</strong></h5><p>Meanshift æ–¹æ³•æ˜¯ä¸€ç§åŸºäºæ¦‚ç‡å¯†åº¦åˆ†å¸ƒçš„è¿½è¸ªæ–¹æ³•ï¼Œä½¿ç›®æ ‡çš„æœç´¢ä¸€ç›´æ²¿ç€æ¦‚ç‡æ¢¯åº¦ä¸Šå‡çš„æ–¹å‘ï¼Œè¿­ä»£æ”¶æ•›åˆ°æ¦‚ç‡å¯†åº¦åˆ†å¸ƒçš„å±€éƒ¨å³°å€¼ä¸Šã€‚é¦–å…ˆ Meanshift ä¼šå¯¹ç›®æ ‡è¿›è¡Œå»ºæ¨¡ï¼Œæ¯”å¦‚åˆ©ç”¨ç›®æ ‡çš„é¢œè‰²åˆ†å¸ƒæ¥æè¿°ç›®æ ‡ï¼Œç„¶åè®¡ç®—ç›®æ ‡åœ¨ä¸‹ä¸€å¸§å›¾åƒä¸Šçš„æ¦‚ç‡åˆ†å¸ƒï¼Œä»è€Œè¿­ä»£å¾—åˆ°å±€éƒ¨æœ€å¯†é›†çš„åŒºåŸŸã€‚Meanshift é€‚ç”¨äºç›®æ ‡çš„è‰²å½©æ¨¡å‹å’ŒèƒŒæ™¯å·®å¼‚æ¯”è¾ƒå¤§çš„æƒ…å½¢ï¼Œæ—©æœŸä¹Ÿç”¨äºäººè„¸è¿½è¸ªã€‚ç”±äº Meanshift æ–¹æ³•çš„å¿«é€Ÿè®¡ç®—ï¼Œå®ƒçš„å¾ˆå¤šæ”¹è¿›æ–¹æ³•ä¹Ÿä¸€ç›´é€‚ç”¨è‡³ä»Šã€‚</p><h5 id="ç²’å­æ»¤æ³¢"><a href="#ç²’å­æ»¤æ³¢" class="headerlink" title="ç²’å­æ»¤æ³¢"></a><strong>ç²’å­æ»¤æ³¢</strong></h5><p>ç²’å­æ»¤æ³¢ï¼ˆParticle Filterï¼‰æ–¹æ³•æ˜¯ä¸€ç§åŸºäºç²’å­åˆ†å¸ƒç»Ÿè®¡çš„æ–¹æ³•ã€‚ä»¥è¿½è¸ªä¸ºä¾‹ï¼Œé¦–å…ˆå¯¹è¿½è¸ªç›®æ ‡è¿›è¡Œå»ºæ¨¡ï¼Œå¹¶å®šä¹‰ä¸€ç§ç›¸ä¼¼åº¦åº¦é‡ç¡®å®šç²’å­ä¸ç›®æ ‡çš„åŒ¹é…ç¨‹åº¦ã€‚åœ¨ç›®æ ‡æœç´¢çš„è¿‡ç¨‹ä¸­ï¼Œå®ƒä¼šæŒ‰ç…§ä¸€å®šçš„åˆ†å¸ƒï¼ˆæ¯”å¦‚å‡åŒ€åˆ†å¸ƒæˆ–é«˜æ–¯åˆ†å¸ƒï¼‰æ’’ä¸€äº›ç²’å­ï¼Œç»Ÿè®¡è¿™äº›ç²’å­çš„ç›¸ä¼¼åº¦ï¼Œç¡®å®šç›®æ ‡å¯èƒ½çš„ä½ç½®ã€‚åœ¨è¿™äº›ä½ç½®ä¸Šï¼Œä¸‹ä¸€å¸§åŠ å…¥æ›´å¤šæ–°çš„ç²’å­ï¼Œç¡®ä¿åœ¨æ›´å¤§æ¦‚ç‡ä¸Šè¿½è¸ªä¸Šç›®æ ‡ã€‚Kalman Filter å¸¸è¢«ç”¨äºæè¿°ç›®æ ‡çš„è¿åŠ¨æ¨¡å‹ï¼Œå®ƒä¸å¯¹ç›®æ ‡çš„ç‰¹å¾å»ºæ¨¡ï¼Œè€Œæ˜¯å¯¹ç›®æ ‡çš„è¿åŠ¨æ¨¡å‹è¿›è¡Œäº†å»ºæ¨¡ï¼Œå¸¸ç”¨äºä¼°è®¡ç›®æ ‡åœ¨ä¸‹ä¸€å¸§çš„ä½ç½®ã€‚</p><p>å¯ä»¥çœ‹åˆ°ï¼Œä¼ ç»Ÿçš„ç›®æ ‡è¿½è¸ªç®—æ³•å­˜åœ¨ä¸¤ä¸ªè‡´å‘½çš„ç¼ºé™·:</p><ol><li>æ²¡æœ‰å°†èƒŒæ™¯ä¿¡æ¯è€ƒè™‘åœ¨å†…, å¯¼è‡´åœ¨ç›®æ ‡é®æŒ¡, å…‰ç…§å˜åŒ–ä»¥åŠè¿åŠ¨æ¨¡ç³Šç­‰å¹²æ‰°ä¸‹å®¹æ˜“å‡ºç°è¿½è¸ªå¤±è´¥.</li><li>è¿½è¸ªç®—æ³•æ‰§è¡Œé€Ÿåº¦æ…¢(æ¯ç§’10å¸§å·¦å³), æ— æ³•æ»¡è¶³å®æ—¶æ€§çš„è¦æ±‚.</li></ol><h4 id="åŸºäºæ ¸ç›¸å…³æ»¤æ³¢çš„è¿½è¸ªç®—æ³•"><a href="#åŸºäºæ ¸ç›¸å…³æ»¤æ³¢çš„è¿½è¸ªç®—æ³•" class="headerlink" title="åŸºäºæ ¸ç›¸å…³æ»¤æ³¢çš„è¿½è¸ªç®—æ³•"></a>åŸºäºæ ¸ç›¸å…³æ»¤æ³¢çš„è¿½è¸ªç®—æ³•</h4><p>æ¥ç€ï¼Œ<strong>äººä»¬å°†é€šä¿¡é¢†åŸŸçš„ç›¸å…³æ»¤æ³¢(è¡¡é‡ä¸¤ä¸ªä¿¡å·çš„ç›¸ä¼¼ç¨‹åº¦)å¼•å…¥åˆ°äº†ç›®æ ‡è¿½è¸ªä¸­</strong>.ä¸€äº›åŸºäºç›¸å…³æ»¤æ³¢çš„è¿½è¸ªç®—æ³•(MOSSEã€CSKã€KCFã€BACFã€SAMF)ç­‰, ä¹Ÿéšä¹‹äº§ç”Ÿ, é€Ÿåº¦å¯ä»¥è¾¾åˆ°æ•°ç™¾å¸§æ¯ç§’, å¯ä»¥å¹¿æ³›åœ°åº”ç”¨äºå®æ—¶è¿½è¸ªç³»ç»Ÿä¸­.å…¶ä¸­ä¸ä¹ä¸€äº›è¿½è¸ªæ€§èƒ½ä¼˜è‰¯çš„è¿½è¸ªå™¨, è¯¸å¦‚SAMFã€BACFåœ¨OTBæ•°æ®é›†å’ŒVOT2015ç«èµ›ä¸­å–å¾—ä¼˜å¼‚æˆç»©ã€‚</p><h5 id="MOSSE"><a href="#MOSSE" class="headerlink" title="MOSSE"></a><strong>MOSSE</strong></h5><p>æœ¬æ–‡æå‡ºçš„ç›¸å…³æ»¤æ³¢å™¨ï¼ˆCorrelation Filterï¼‰é€šè¿‡MOSSEï¼ˆMinimum Output Sum of Squared Error (MOSSE) filterï¼‰ç®—æ³•å®ç°ï¼ŒåŸºæœ¬æ€æƒ³ï¼šè¶Šæ˜¯ç›¸ä¼¼çš„ä¸¤ä¸ªç›®æ ‡ç›¸å…³å€¼è¶Šå¤§ï¼Œä¹Ÿå°±æ˜¯è§†é¢‘å¸§ä¸­ä¸åˆå§‹åŒ–ç›®æ ‡è¶Šç›¸ä¼¼ï¼Œå¾—åˆ°çš„ç›¸åº”ä¹Ÿå°±è¶Šå¤§ã€‚ä¸‹å›¾æ‰€ç¤ºé€šè¿‡å¯¹æ¯”UMACE,ASEFï¼ŒMOSSEç­‰ç›¸å…³æ»¤æ³¢ç®—æ³•ï¼Œä½¿è¾“å‡ºç›®æ ‡ä¸­å¿ƒæœ€å¤§åŒ–ã€‚</p><h4 id="åŸºäºæ·±åº¦å­¦ä¹ çš„è¿½è¸ªç®—æ³•"><a href="#åŸºäºæ·±åº¦å­¦ä¹ çš„è¿½è¸ªç®—æ³•" class="headerlink" title="åŸºäºæ·±åº¦å­¦ä¹ çš„è¿½è¸ªç®—æ³•"></a><strong>åŸºäºæ·±åº¦å­¦ä¹ çš„è¿½è¸ªç®—æ³•</strong></h4><p>éšç€æ·±åº¦å­¦ä¹ æ–¹æ³•çš„å¹¿æ³›åº”ç”¨, äººä»¬å¼€å§‹è€ƒè™‘å°†å…¶åº”ç”¨åˆ°ç›®æ ‡è¿½è¸ªä¸­.äººä»¬å¼€å§‹ä½¿ç”¨æ·±åº¦ç‰¹å¾å¹¶å–å¾—äº†å¾ˆå¥½çš„æ•ˆæœ.ä¹‹å, äººä»¬å¼€å§‹è€ƒè™‘ç”¨æ·±åº¦å­¦ä¹ å»ºç«‹å…¨æ–°çš„è¿½è¸ªæ¡†æ¶, è¿›è¡Œç›®æ ‡è¿½è¸ª.</p><p>åœ¨å¤§æ•°æ®èƒŒæ™¯ä¸‹ï¼Œåˆ©ç”¨æ·±åº¦å­¦ä¹ è®­ç»ƒç½‘ç»œæ¨¡å‹ï¼Œå¾—åˆ°çš„å·ç§¯ç‰¹å¾è¾“å‡ºè¡¨è¾¾èƒ½åŠ›æ›´å¼ºã€‚åœ¨ç›®æ ‡è¿½è¸ªä¸Šï¼ŒåˆæœŸçš„åº”ç”¨æ–¹å¼æ˜¯æŠŠç½‘ç»œå­¦ä¹ åˆ°çš„ç‰¹å¾ï¼Œç›´æ¥åº”ç”¨åˆ°ç›¸å…³æ»¤æ³¢æˆ– Struck çš„è¿½è¸ªæ¡†æ¶é‡Œé¢ï¼Œä»è€Œå¾—åˆ°æ›´å¥½çš„è¿½è¸ªç»“æœï¼Œæ¯”å¦‚å‰é¢æåˆ°çš„ DeepSRDCF æ–¹æ³•ã€‚æœ¬è´¨ä¸Šå·ç§¯è¾“å‡ºå¾—åˆ°çš„ç‰¹å¾è¡¨è¾¾ï¼Œæ›´ä¼˜äº HOG æˆ– CN ç‰¹å¾ï¼Œè¿™ä¹Ÿæ˜¯æ·±åº¦å­¦ä¹ çš„ä¼˜åŠ¿ä¹‹ä¸€ï¼Œä½†åŒæ—¶ä¹Ÿå¸¦æ¥äº†è®¡ç®—é‡çš„å¢åŠ ã€‚</p><h2 id="ç›®æ ‡è¿½è¸ªæ–¹æ³•æ€»ç»“"><a href="#ç›®æ ‡è¿½è¸ªæ–¹æ³•æ€»ç»“" class="headerlink" title="ç›®æ ‡è¿½è¸ªæ–¹æ³•æ€»ç»“"></a>ç›®æ ‡è¿½è¸ªæ–¹æ³•æ€»ç»“</h2><p>ç›®æ ‡è¿½è¸ªçš„æ–¹æ³•ä¸»è¦åˆ†ä¸º2å¤§ç±»ï¼Œä¸€ç±»æ˜¯ç›¸å…³æ»¤æ³¢ã€ä¸€ç±»æ˜¯æ·±åº¦å­¦ä¹ ã€‚</p><p><img src="https://pic2.zhimg.com/80/v2-632a3a08c0f30f0abcdb8b06afbe346d_720w.jpg"></p><ol><li>ç›¸æ¯”äºå…‰æµæ³•ã€Kalmanã€Meanshiftç­‰ä¼ ç»Ÿç®—æ³•ï¼Œç›¸å…³æ»¤æ³¢ç±»ç®—æ³•è¿½è¸ªé€Ÿåº¦æ›´å¿«ï¼Œæ·±åº¦å­¦ä¹ ç±»æ–¹æ³•ç²¾åº¦é«˜.</li><li>å…·æœ‰å¤šç‰¹å¾èåˆä»¥åŠæ·±åº¦ç‰¹å¾çš„è¿½è¸ªå™¨åœ¨è¿½è¸ªç²¾åº¦æ–¹é¢çš„æ•ˆæœæ›´å¥½.</li><li>ä½¿ç”¨å¼ºå¤§çš„åˆ†ç±»å™¨æ˜¯å®ç°è‰¯å¥½è¿½è¸ªçš„åŸºç¡€.</li><li>å°ºåº¦çš„è‡ªé€‚åº”ä»¥åŠæ¨¡å‹çš„æ›´æ–°æœºåˆ¶ä¹Ÿå½±å“ç€è¿½è¸ªçš„ç²¾åº¦.</li></ol><h2 id="æ•°æ®é›†"><a href="#æ•°æ®é›†" class="headerlink" title="æ•°æ®é›†"></a>æ•°æ®é›†</h2><p>ä¸»è¦çš„æ•°æ®é›†æ•°æ®å¯¹æ¯”å¦‚ä¸‹</p><p><img src="https://pic2.zhimg.com/80/v2-469a0d48774e9346242a5fa8e5bd1a39_720w.jpg" alt="æ•°æ®é›†å¯¹æ¯”"></p>]]></content>
      
      
      
        <tags>
            
            <tag> ç›®æ ‡è¿½è¸ªç³»åˆ— </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€ŒèŠ±æœµåˆ†ç±»é¡¹ç›®ã€ï¼ˆäº”ï¼‰é•¿å°¾åˆ†å¸ƒæƒ…å†µå¤„ç†</title>
      <link href="/2022/05/19/%E3%80%8C%E8%8A%B1%E6%9C%B5%E5%88%86%E7%B1%BB%E9%A1%B9%E7%9B%AE%E3%80%8D%EF%BC%88%E4%BA%94%EF%BC%89%E9%95%BF%E5%B0%BE%E5%88%86%E5%B8%83%E6%83%85%E5%86%B5%E5%A4%84%E7%90%86/"/>
      <url>/2022/05/19/%E3%80%8C%E8%8A%B1%E6%9C%B5%E5%88%86%E7%B1%BB%E9%A1%B9%E7%9B%AE%E3%80%8D%EF%BC%88%E4%BA%94%EF%BC%89%E9%95%BF%E5%B0%BE%E5%88%86%E5%B8%83%E6%83%85%E5%86%B5%E5%A4%84%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h2 id="é•¿å°¾åˆ†å¸ƒ-ä¸å‡è¡¡æ•°æ®é›†"><a href="#é•¿å°¾åˆ†å¸ƒ-ä¸å‡è¡¡æ•°æ®é›†" class="headerlink" title="é•¿å°¾åˆ†å¸ƒ-ä¸å‡è¡¡æ•°æ®é›†"></a>é•¿å°¾åˆ†å¸ƒ-ä¸å‡è¡¡æ•°æ®é›†</h2><p>é•¿å°¾æ•ˆåº”ï¼šæºè‡ªç»Ÿè®¡å­¦æ¦‚å¿µï¼Œå…¶ä¸­æœ‰å¤´(Head)å’Œå°¾(Tail)ä¸¤ä¸ªç»Ÿè®¡å­¦åè¯ï¼Œçªèµ·éƒ¨åˆ†å«â€œå¤´â€ï¼›ä¸¤è¾¹ç›¸å¯¹å¹³ç¼“çš„éƒ¨åˆ†å«â€œå°¾â€ã€‚äºŒå…«æ³•åˆ™å°±æ˜¯å…¸å‹çš„é•¿å°¾æ•ˆåº”ï¼Œ20%çš„å“ç‰Œå æ®äº†80%çš„å¸‚åœº</p><p>çœŸå®ä¸–ç•Œä¸­çš„ç‰©ä½“ç±»åˆ«æ˜¯ç¬¦åˆé•¿å°¾åˆ†å¸ƒçš„ ï¼Œæ›´å¹¿ä¹‰çš„è¯´ï¼Œæ˜¯æ•°æ®ä¸å‡è¡¡</p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2f7dgbe7vj20zk0eit9j.jpg" style="zoom: 50%;" /><p>é’ˆå¯¹æ•°æ®ä¸å‡è¡¡é—®é¢˜ï¼Œå¸¸é€šè¿‡é‡‡æ ·æ–¹æ³•æ”¹å–„å…¶ä¸­æœ‰ï¼šã€Œ<strong>è¿‡é‡‡æ ·</strong>ï¼šæ ·æœ¬å°‘çš„å¤šé‡‡æ ·å‡ æ¬¡ã€ã€Œ<strong>æ¬ é‡‡æ ·</strong>ï¼šæ ·æœ¬å¤šçš„å°‘é‡‡æ ·å‡ æ¬¡ã€</p><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2f7gfivx3j20zk0awjs0.jpg"></p><p>è¿™é‡Œé‡‡ç”¨Cifar-10çš„é•¿å°¾æ•°æ®é›†ç‰ˆæœ¬ã€ŒCifarLTDatasetã€<a href="https://www.cs.toronto.edu/~kriz/cifar.html">ä¸‹è½½é“¾æ¥</a></p><h2 id="PB-Sampling"><a href="#PB-Sampling" class="headerlink" title="PB Sampling"></a>PB Sampling</h2><p>ã€Œ<a href="https://arxiv.org/abs/1910.09217">Decoupling Representation and Classifier for Long-Tailed Recognition</a>ã€</p><p>Progressively-Balanced Sampling ï¼ˆæ¸è¿›å¼é‡‡æ ·ç­–ç•¥ï¼‰ï¼šé‡‡æ ·æƒé‡éšç€$Epoch$çš„å¢åŠ æ¸è¿›å¼çš„å˜åŒ–</p><span id="more"></span><p>ä»åŸå§‹åˆ†å¸ƒé€æ¸å˜ä¸ºåˆ†ç±»å‡è¡¡ï¼Œæœ‰æ•ˆæå‡ä¸å‡è¡¡åˆ†ç±»ç²¾åº¦<br>$$<br>p_j &#x3D; \frac{n_j^q}{\sum_{i&#x3D;1}^Cn_i^q}<br>$$</p><p>$$<br>p_j^{PB}(t) &#x3D; (1 - \frac{t}{T})p_j^{IB} + \frac{t}{T}p_j^{CB}<br>$$</p><p>$p_j$ï¼šç¬¬ $j$ç±»é‡‡æ ·æ¦‚ç‡ï¼Œ$n_j$ï¼šç¬¬ $j$ç±»æ ·æœ¬æ•°é‡ï¼Œ$C$ï¼šæ€»ç±»åˆ«æ•°ï¼Œ$q$ï¼šè¶…å‚æ•°ï¼Œç”¨äºæ§åˆ¶æ¦‚ç‡$p_j$ï¼Œå€¼åŸŸ$[0, 1]$</p><p>$t, T$ï¼šç¬¬$t$ä¸ª$Epoch$ï¼Œ$T$è¡¨ç¤ºæ€»å…±æœ‰å¤šå°‘ä¸ª$Epoch$</p><p>$P_j^{IB}$ï¼šå½“ç¬¬ä¸€ä¸ªå…¬å¼çš„$q$å–1æ—¶å¾—åˆ°çš„ç­–ç•¥ï¼›æ ·æœ¬å¤šï¼Œé‡‡æ ·æ¦‚ç‡é«˜</p><p>$P_j^{CB}$ï¼šå½“ç¬¬ä¸€ä¸ªå…¬å¼çš„$q$å–0æ—¶å¾—åˆ°çš„ç­–ç•¥ï¼›$p_j$å…¨éƒ½ç›¸ç­‰ï¼Œéƒ½æ˜¯$1&#x2F;C$</p><p>$P_j^{IB}$æ˜¯åŸå§‹åˆ†å¸ƒã€Œ$IB(Instance-Balanced)$ã€ï¼Œ$P_j^{CB}$æ˜¯å‡è¡¡åˆ†å¸ƒã€Œ$CB(Class-Balanced)$ã€</p><p>ç¬¬äºŒä¸ªå…¬å¼è¡¨ç¤ºã€Œä¸€å¼€å§‹æ˜¯åŸå§‹åˆ†å¸ƒï¼Œéšç€$t$å¢åŠ é€æ¸å‡è¡¡ã€</p><h2 id="Dataset-ä¸-Dataloader"><a href="#Dataset-ä¸-Dataloader" class="headerlink" title="Dataset ä¸ Dataloader"></a>Dataset ä¸ Dataloader</h2><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2f8jhk5stj20ib0bkjrw.jpg"></p><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2f8mzha9dj20g5070aac.jpg"></p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2f99551p8j20of0h5t9k.jpg" style="zoom:67%;" /><h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><h3 id="datasets-x2F-cifar-longtail-py"><a href="#datasets-x2F-cifar-longtail-py" class="headerlink" title="datasets&#x2F;cifar_longtail.py"></a>datasets&#x2F;cifar_longtail.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"># @file name    :cifar_longtail.py</span></span><br><span class="line"><span class="string"># @author       :zz0320</span></span><br><span class="line"><span class="string"># @data         :2022-4-11</span></span><br><span class="line"><span class="string"># @brief        :cifar-10é•¿å°¾æ•°æ®é›†çš„è¯»å–</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> Dataset</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CifarDataset</span>(<span class="title class_ inherited__">Dataset</span>):</span><br><span class="line">    names = (<span class="string">&#x27;plane&#x27;</span>, <span class="string">&#x27;car&#x27;</span>, <span class="string">&#x27;bird&#x27;</span>, <span class="string">&#x27;cat&#x27;</span>, <span class="string">&#x27;deer&#x27;</span>, <span class="string">&#x27;dog&#x27;</span>, <span class="string">&#x27;frog&#x27;</span>, <span class="string">&#x27;horse&#x27;</span>, <span class="string">&#x27;ship&#x27;</span>, <span class="string">&#x27;truck&#x27;</span>)</span><br><span class="line">    cls_num = <span class="built_in">len</span>(names)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, root_dir, transform=<span class="literal">None</span></span>):</span><br><span class="line">        self.root_dir = root_dir</span><br><span class="line">        self.transform = transform</span><br><span class="line">        self.img_info = []      <span class="comment"># å®šä¹‰listç”¨äºå­˜å‚¨æ ·æœ¬è·¯å¾„ã€æ ‡ç­¾</span></span><br><span class="line">        self._get_img_info()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, index</span>):</span><br><span class="line">        path_img, label = self.img_info[index]</span><br><span class="line">        img = Image.<span class="built_in">open</span>(path_img).convert(<span class="string">&#x27;RGB&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.transform <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            img = self.transform(img)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> img, label, path_img</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(self.img_info) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">&quot;\ndata_dir:&#123;&#125; is a empty dir! Please checkout your path to images!&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">                self.root_dir))   <span class="comment"># ä»£ç å…·æœ‰å‹å¥½çš„æç¤ºåŠŸèƒ½ï¼Œä¾¿äºdebug</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(self.img_info)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_img_info</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">for</span> root, dirs, _ <span class="keyword">in</span> os.walk(self.root_dir):</span><br><span class="line">            <span class="comment"># éå†ç±»åˆ«</span></span><br><span class="line">            <span class="keyword">for</span> sub_dir <span class="keyword">in</span> dirs:</span><br><span class="line">                img_names = os.listdir(os.path.join(root, sub_dir))</span><br><span class="line">                img_names = <span class="built_in">list</span>(<span class="built_in">filter</span>(<span class="keyword">lambda</span> x: x.endswith(<span class="string">&#x27;.png&#x27;</span>), img_names))</span><br><span class="line">                <span class="comment"># éå†å›¾ç‰‡</span></span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(img_names)):</span><br><span class="line">                    img_name = img_names[i]</span><br><span class="line">                    path_img = os.path.abspath(os.path.join(root, sub_dir, img_name))</span><br><span class="line">                    label = <span class="built_in">int</span>(sub_dir)</span><br><span class="line">                    self.img_info.append((path_img, <span class="built_in">int</span>(label)))</span><br><span class="line">        random.shuffle(self.img_info)   <span class="comment"># å°†æ•°æ®é¡ºåºæ‰“ä¹±</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CifarLTDataset</span>(<span class="title class_ inherited__">CifarDataset</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, root_dir, transform=<span class="literal">None</span>, imb_factor=<span class="number">0.01</span>, isTrain=<span class="literal">True</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        :param root_dir:</span></span><br><span class="line"><span class="string">        :param transform:</span></span><br><span class="line"><span class="string">        :param imb_type:</span></span><br><span class="line"><span class="string">        :param imb_factor: float, å€¼è¶Šå°ï¼Œæ•°é‡ä¸‹é™è¶Šå¿«,0.1è¡¨ç¤ºæœ€å°‘çš„ç±»æ˜¯æœ€å¤šçš„ç±»çš„0.1å€ï¼Œå¦‚500ï¼š5000</span></span><br><span class="line"><span class="string">        :param isTrain:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">super</span>(CifarLTDataset, self).__init__(root_dir, transform=transform)</span><br><span class="line">        self.imb_factor = imb_factor</span><br><span class="line">        <span class="keyword">if</span> isTrain:</span><br><span class="line">            self.nums_per_cls = self._get_img_num_per_cls()     <span class="comment"># è®¡ç®—æ¯ä¸ªç±»çš„æ ·æœ¬æ•°</span></span><br><span class="line">            self._select_img()      <span class="comment"># é‡‡æ ·è·å¾—ç¬¦åˆé•¿å°¾åˆ†å¸ƒçš„æ•°æ®é‡</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># éè®­ç»ƒçŠ¶æ€ï¼Œå¯é‡‡ç”¨å‡è¡¡æ•°æ®é›†æµ‹è¯•</span></span><br><span class="line">            self.nums_per_cls = []</span><br><span class="line">            <span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(self.cls_num):</span><br><span class="line">                label_list = [label <span class="keyword">for</span> p, label <span class="keyword">in</span> self.img_info]  <span class="comment"># è·å–æ¯ä¸ªæ ‡ç­¾</span></span><br><span class="line">                self.nums_per_cls.append(label_list.count(n))       <span class="comment"># ç»Ÿè®¡æ¯ä¸ªç±»åˆ«æ•°é‡</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_select_img</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        æ ¹æ®æ¯ä¸ªç±»éœ€è¦çš„æ ·æœ¬æ•°è¿›è¡ŒæŒ‘é€‰</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        new_lst = []</span><br><span class="line">        <span class="keyword">for</span> n, img_num <span class="keyword">in</span> <span class="built_in">enumerate</span>(self.nums_per_cls):</span><br><span class="line">            lst_tmp = [info <span class="keyword">for</span> info <span class="keyword">in</span> self.img_info <span class="keyword">if</span> info[<span class="number">1</span>] == n]  <span class="comment"># è·å–ç¬¬nç±»åˆ«æ•°æ®ä¿¡æ¯</span></span><br><span class="line">            random.shuffle(lst_tmp)</span><br><span class="line">            lst_tmp = lst_tmp[:img_num]</span><br><span class="line">            new_lst.extend(lst_tmp)</span><br><span class="line">        random.shuffle(new_lst)</span><br><span class="line">        self.img_info = new_lst</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_img_num_per_cls</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        ä¾é•¿å°¾åˆ†å¸ƒè®¡ç®—æ¯ä¸ªç±»åˆ«åº”æœ‰å¤šå°‘å¼ æ ·æœ¬</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        img_max = <span class="built_in">len</span>(self.img_info) / self.cls_num</span><br><span class="line">        img_num_per_cls = []</span><br><span class="line">        <span class="keyword">for</span> cls_idx <span class="keyword">in</span> <span class="built_in">range</span>(self.cls_num):</span><br><span class="line">            num = img_max * (self.imb_factor ** (cls_idx / (self.cls_num - <span class="number">1.0</span>)))  <span class="comment"># åˆ—å‡ºå…¬å¼å°±çŸ¥é“äº†</span></span><br><span class="line">            img_num_per_cls.append(<span class="built_in">int</span>(num))</span><br><span class="line">        <span class="keyword">return</span> img_num_per_cls</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    root_dir = <span class="string">r&quot;/Users/kenton/Downloads/deeplearning_dataset/cifar-10/cifar10_train&quot;</span></span><br><span class="line">    train_dataset = CifarLTDataset(root_dir, imb_factor=<span class="number">0.01</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">len</span>(train_dataset))</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">next</span>(<span class="built_in">iter</span>(train_dataset)))</span><br><span class="line">    <span class="built_in">print</span>(train_dataset.nums_per_cls)</span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    y = train_dataset.nums_per_cls</span><br><span class="line">    x = <span class="built_in">range</span>(<span class="built_in">len</span>(y))</span><br><span class="line">    <span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">    plt.plot(x, y)</span><br><span class="line">    <span class="comment"># plt.show()</span></span><br></pre></td></tr></table></figure><h3 id="bins-x2F-parse-cifar-to-png-py"><a href="#bins-x2F-parse-cifar-to-png-py" class="headerlink" title="bins&#x2F;parse_cifar_to_png.py"></a>bins&#x2F;parse_cifar_to_png.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"># @file name  : parse_cifar10_to_png.py</span></span><br><span class="line"><span class="string"># @author     : zz0320</span></span><br><span class="line"><span class="string"># @date       : 2021-04-11</span></span><br><span class="line"><span class="string"># @brief      : å°†cifar10æ•°æ®pickleå½¢å¼è§£ææˆpngæ ¼å¼</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">from</span> imageio <span class="keyword">import</span> imwrite</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">unpickle</span>(<span class="params">file</span>):</span><br><span class="line">    fo = <span class="built_in">open</span>(file, <span class="string">&#x27;rb&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> sys.version_info &lt; (<span class="number">3</span>, <span class="number">0</span>):</span><br><span class="line">        dict_ = pickle.load(fo)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        dict_ = pickle.load(fo, encoding=<span class="string">&#x27;bytes&#x27;</span>)</span><br><span class="line">    fo.close()</span><br><span class="line">    <span class="keyword">return</span> dict_</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_mkdir</span>(<span class="params">my_dir</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.isdir(my_dir):</span><br><span class="line">        os.makedirs(my_dir)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pasre_pickle_img</span>(<span class="params">pkl_data</span>):</span><br><span class="line">    img = np.reshape(pkl_data[<span class="string">b&#x27;data&#x27;</span>][i], (<span class="number">3</span>, <span class="number">32</span>, <span class="number">32</span>))</span><br><span class="line">    label_n = <span class="built_in">str</span>(pkl_data[<span class="string">b&#x27;labels&#x27;</span>][i])</span><br><span class="line">    img = img.transpose((<span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>))  <span class="comment"># c*h*w --&gt; h*w*c</span></span><br><span class="line">    <span class="keyword">return</span> img, label_n</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_data_dir</span>(<span class="params">path_data</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(path_data):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;æ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥æ•°æ®æ˜¯å¦å­˜æ”¾åˆ°data_dirå˜é‡:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(path_data))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    BASE_DIR = os.path.dirname(__file__)</span><br><span class="line">    cifar_dir = <span class="string">r&quot;/Users/kenton/Downloads/deeplearning_dataset/cifar-10&quot;</span>    <span class="comment"># æ•°æ®ç›®å½•</span></span><br><span class="line">    data_dir = os.path.join(cifar_dir, <span class="string">&quot;cifar-10-batches-py&quot;</span>)           <span class="comment"># æºæ•°æ®ç›®å½•</span></span><br><span class="line">    check_data_dir(data_dir)</span><br><span class="line">    train_o_dir = os.path.join(cifar_dir, <span class="string">&quot;cifar10_train&quot;</span>)              <span class="comment"># è¾“å‡ºçš„ç›®å½•</span></span><br><span class="line">    test_o_dir = os.path.join(cifar_dir, <span class="string">&quot;cifar10_test&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># train data</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">6</span>):</span><br><span class="line">        data_path = os.path.join(data_dir,  <span class="string">&quot;data_batch_&quot;</span> + <span class="built_in">str</span>(j))  <span class="comment"># data_batch_12345</span></span><br><span class="line">        train_data = unpickle(data_path)</span><br><span class="line">        <span class="built_in">print</span>(data_path + <span class="string">&quot; is loading...&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">10000</span>):</span><br><span class="line">            <span class="comment"># è§£æå›¾ç‰‡åŠæ ‡ç­¾</span></span><br><span class="line">            img, label_num = pasre_pickle_img(train_data)</span><br><span class="line">            <span class="comment"># åˆ›å»ºæ–‡ä»¶å¤¹</span></span><br><span class="line">            o_dir = os.path.join(train_o_dir, label_num)</span><br><span class="line">            my_mkdir(o_dir)</span><br><span class="line">            <span class="comment"># ä¿å­˜å›¾ç‰‡</span></span><br><span class="line">            img_name = label_num + <span class="string">&#x27;_&#x27;</span> + <span class="built_in">str</span>(i + (j - <span class="number">1</span>)*<span class="number">10000</span>) + <span class="string">&#x27;.png&#x27;</span></span><br><span class="line">            img_path = os.path.join(o_dir, img_name)</span><br><span class="line">            imwrite(img_path, img)</span><br><span class="line">        <span class="built_in">print</span>(data_path + <span class="string">&quot; loaded.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># test data</span></span><br><span class="line">    test_data_path = os.path.join(data_dir, <span class="string">&quot;test_batch&quot;</span>)</span><br><span class="line">    test_data = unpickle(test_data_path)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">10000</span>):</span><br><span class="line">        <span class="comment"># è§£æå›¾ç‰‡åŠæ ‡ç­¾</span></span><br><span class="line">        img, label_num = pasre_pickle_img(test_data)</span><br><span class="line">        <span class="comment"># åˆ›å»ºæ–‡ä»¶å¤¹</span></span><br><span class="line">        o_dir = os.path.join(test_o_dir, label_num)</span><br><span class="line">        my_mkdir(o_dir)</span><br><span class="line">        <span class="comment"># ä¿å­˜å›¾ç‰‡</span></span><br><span class="line">        img_name = label_num + <span class="string">&#x27;_&#x27;</span> + <span class="built_in">str</span>(i) + <span class="string">&#x27;.png&#x27;</span></span><br><span class="line">        img_path = os.path.join(o_dir, img_name)</span><br><span class="line">        imwrite(img_path, img)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;done.&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="models-x2F-resnet-cifar10-py"><a href="#models-x2F-resnet-cifar10-py" class="headerlink" title="models&#x2F;resnet_cifar10.py"></a>models&#x2F;resnet_cifar10.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Properly implemented ResNet-s for CIFAR10 as described in paper [1].</span></span><br><span class="line"><span class="string">The implementation and structure of this file is hugely influenced by [2]</span></span><br><span class="line"><span class="string">which is implemented for ImageNet and doesn&#x27;t have option A for identity.</span></span><br><span class="line"><span class="string">Moreover, most of the implementations on the web is copy-paste from</span></span><br><span class="line"><span class="string">torchvision&#x27;s resnet and has wrong number of params.</span></span><br><span class="line"><span class="string">Proper ResNet-s for CIFAR10 (for fair comparision and etc.) has following</span></span><br><span class="line"><span class="string">number of layers and parameters:</span></span><br><span class="line"><span class="string">name      | layers | params</span></span><br><span class="line"><span class="string">ResNet20  |    20  | 0.27M</span></span><br><span class="line"><span class="string">ResNet32  |    32  | 0.46M</span></span><br><span class="line"><span class="string">ResNet44  |    44  | 0.66M</span></span><br><span class="line"><span class="string">ResNet56  |    56  | 0.85M</span></span><br><span class="line"><span class="string">ResNet110 |   110  |  1.7M</span></span><br><span class="line"><span class="string">ResNet1202|  1202  | 19.4m</span></span><br><span class="line"><span class="string">which this implementation indeed has.</span></span><br><span class="line"><span class="string">Reference:</span></span><br><span class="line"><span class="string">[1] Kaiming He, Xiangyu Zhang, Shaoqing Ren, Jian Sun</span></span><br><span class="line"><span class="string">    Deep Residual Learning for Image Recognition. arXiv:1512.03385</span></span><br><span class="line"><span class="string">[2] https://github.com/pytorch/vision/blob/master/torchvision/models/resnet.py</span></span><br><span class="line"><span class="string">If you use this implementation in you work, please don&#x27;t forget to mention the</span></span><br><span class="line"><span class="string">author, Yerlan Idelbayev.</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"><span class="keyword">import</span> torch.nn.init <span class="keyword">as</span> init</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">__all__ = [<span class="string">&#x27;ResNet&#x27;</span>, <span class="string">&#x27;resnet20&#x27;</span>, <span class="string">&#x27;resnet32&#x27;</span>, <span class="string">&#x27;resnet44&#x27;</span>, <span class="string">&#x27;resnet56&#x27;</span>, <span class="string">&#x27;resnet110&#x27;</span>, <span class="string">&#x27;resnet1202&#x27;</span>]</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">__all__ æ˜¯é’ˆå¯¹æ¨¡å—å…¬å¼€æ¥å£çš„ä¸€ç§çº¦å®šï¼Œä»¥æä¾›äº†â€ç™½åå•â€œçš„å½¢å¼æš´éœ²æ¥å£</span></span><br><span class="line"><span class="string">ä½¿ç”¨from xxx import *å¯¼å…¥è¯¥æ–‡ä»¶æ—¶ï¼Œåªä¼šå¯¼å…¥ __all__ åˆ—å‡ºçš„æˆå‘˜</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_weights_init</span>(<span class="params">m</span>):</span><br><span class="line">    classname = m.__class__.__name__</span><br><span class="line">    <span class="comment">#print(classname)</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(m, nn.Linear) <span class="keyword">or</span> <span class="built_in">isinstance</span>(m, nn.Conv2d):</span><br><span class="line">        init.kaiming_normal_(m.weight)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LambdaLayer</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, lambd</span>):</span><br><span class="line">        <span class="built_in">super</span>(LambdaLayer, self).__init__()</span><br><span class="line">        self.lambd = lambd</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="keyword">return</span> self.lambd(x)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BasicBlock</span>(nn.Module):</span><br><span class="line">    expansion = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, in_planes, planes, stride=<span class="number">1</span>, option=<span class="string">&#x27;A&#x27;</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(BasicBlock, self).__init__()</span><br><span class="line">        self.conv1 = nn.Conv2d(in_planes, planes, kernel_size=<span class="number">3</span>, stride=stride, padding=<span class="number">1</span>, bias=<span class="literal">False</span>)</span><br><span class="line">        self.bn1 = nn.BatchNorm2d(planes)</span><br><span class="line">        self.conv2 = nn.Conv2d(planes, planes, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">1</span>, bias=<span class="literal">False</span>)</span><br><span class="line">        self.bn2 = nn.BatchNorm2d(planes)</span><br><span class="line"></span><br><span class="line">        self.shortcut = nn.Sequential()</span><br><span class="line">        <span class="keyword">if</span> stride != <span class="number">1</span> <span class="keyword">or</span> in_planes != planes:</span><br><span class="line">            <span class="keyword">if</span> option == <span class="string">&#x27;A&#x27;</span>:</span><br><span class="line">                <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                For CIFAR10 ResNet paper uses option A.</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span></span><br><span class="line">                self.shortcut = LambdaLayer(<span class="keyword">lambda</span> x:</span><br><span class="line">                                            F.pad(x[:, :, ::<span class="number">2</span>, ::<span class="number">2</span>], (<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, planes//<span class="number">4</span>, planes//<span class="number">4</span>), <span class="string">&quot;constant&quot;</span>, <span class="number">0</span>))</span><br><span class="line">            <span class="keyword">elif</span> option == <span class="string">&#x27;B&#x27;</span>:</span><br><span class="line">                self.shortcut = nn.Sequential(</span><br><span class="line">                     nn.Conv2d(in_planes, self.expansion * planes, kernel_size=<span class="number">1</span>, stride=stride, bias=<span class="literal">False</span>),</span><br><span class="line">                     nn.BatchNorm2d(self.expansion * planes)</span><br><span class="line">                )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        out = F.relu(self.bn1(self.conv1(x)))</span><br><span class="line">        out = self.bn2(self.conv2(out))</span><br><span class="line">        out += self.shortcut(x)</span><br><span class="line">        out = F.relu(out)</span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ResNet</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, block, num_blocks, num_classes=<span class="number">10</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(ResNet, self).__init__()</span><br><span class="line">        self.in_planes = <span class="number">16</span></span><br><span class="line"></span><br><span class="line">        self.conv1 = nn.Conv2d(<span class="number">3</span>, <span class="number">16</span>, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">1</span>, bias=<span class="literal">False</span>)</span><br><span class="line">        self.bn1 = nn.BatchNorm2d(<span class="number">16</span>)</span><br><span class="line">        self.layer1 = self._make_layer(block, <span class="number">16</span>, num_blocks[<span class="number">0</span>], stride=<span class="number">1</span>)  <span class="comment"># åŸç‰ˆ16</span></span><br><span class="line">        self.layer2 = self._make_layer(block, <span class="number">32</span>, num_blocks[<span class="number">1</span>], stride=<span class="number">2</span>)  <span class="comment"># åŸç‰ˆ32</span></span><br><span class="line">        self.layer3 = self._make_layer(block, <span class="number">64</span>, num_blocks[<span class="number">2</span>], stride=<span class="number">2</span>)  <span class="comment"># åŸç‰ˆ64</span></span><br><span class="line">        self.linear = nn.Linear(<span class="number">64</span>, num_classes)</span><br><span class="line"></span><br><span class="line">        self.apply(_weights_init)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_make_layer</span>(<span class="params">self, block, planes, num_blocks, stride</span>):</span><br><span class="line">        strides = [stride] + [<span class="number">1</span>]*(num_blocks-<span class="number">1</span>)</span><br><span class="line">        layers = []</span><br><span class="line">        <span class="keyword">for</span> stride <span class="keyword">in</span> strides:</span><br><span class="line">            layers.append(block(self.in_planes, planes, stride))</span><br><span class="line">            self.in_planes = planes * block.expansion</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> nn.Sequential(*layers)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        out = F.relu(self.bn1(self.conv1(x)))</span><br><span class="line">        out = self.layer1(out)</span><br><span class="line">        out = self.layer2(out)</span><br><span class="line">        out = self.layer3(out)</span><br><span class="line">        out = F.avg_pool2d(out, out.size()[<span class="number">3</span>])</span><br><span class="line">        out = out.view(out.size(<span class="number">0</span>), -<span class="number">1</span>)</span><br><span class="line">        out = self.linear(out)</span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">resnet8</span>(<span class="params">num_classes=<span class="number">10</span></span>):</span><br><span class="line">    <span class="keyword">return</span> ResNet(BasicBlock, [<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>], num_classes)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">resnet20</span>(<span class="params">num_classes=<span class="number">10</span></span>):</span><br><span class="line">    <span class="keyword">return</span> ResNet(BasicBlock, [<span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>], num_classes)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">resnet32</span>(<span class="params">num_classes=<span class="number">10</span></span>):</span><br><span class="line">    <span class="keyword">return</span> ResNet(BasicBlock, [<span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>], num_classes)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">resnet44</span>():</span><br><span class="line">    <span class="keyword">return</span> ResNet(BasicBlock, [<span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">resnet56</span>(<span class="params">num_classes=<span class="number">10</span></span>):</span><br><span class="line">    <span class="keyword">return</span> ResNet(BasicBlock, [<span class="number">9</span>, <span class="number">9</span>, <span class="number">9</span>], num_classes)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">resnet110</span>():</span><br><span class="line">    <span class="keyword">return</span> ResNet(BasicBlock, [<span class="number">18</span>, <span class="number">18</span>, <span class="number">18</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">resnet1202</span>():</span><br><span class="line">    <span class="keyword">return</span> ResNet(BasicBlock, [<span class="number">200</span>, <span class="number">200</span>, <span class="number">200</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    fake_img = torch.randn((<span class="number">1</span>, <span class="number">3</span>, <span class="number">32</span>, <span class="number">32</span>))</span><br><span class="line">    <span class="keyword">for</span> net_name <span class="keyword">in</span> __all__:</span><br><span class="line">        <span class="keyword">if</span> net_name.startswith(<span class="string">&#x27;resnet&#x27;</span>):</span><br><span class="line">            model = <span class="built_in">globals</span>()[net_name]()  <span class="comment"># globals()ä»¥å­—å…¸å½¢å¼è¿”å›å…¨å±€å˜é‡</span></span><br><span class="line">            output = model(fake_img)</span><br><span class="line">            <span class="built_in">print</span>(net_name, output.shape)</span><br></pre></td></tr></table></figure><h3 id="tools-x2F-progressively-balance-py"><a href="#tools-x2F-progressively-balance-py" class="headerlink" title="tools&#x2F;progressively_balance.py"></a>tools&#x2F;progressively_balance.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"># @file name    :progressively_balance.py</span></span><br><span class="line"><span class="string"># @author       :zz0320</span></span><br><span class="line"><span class="string"># @data         :2022-4-12</span></span><br><span class="line"><span class="string"># @brief        :æ¸è¿›å¼å¹³è¡¡é‡‡æ · progressive_balanceåŠŸèƒ½å®ç°</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> matplotlib</span><br><span class="line"><span class="comment"># matplotlib.use(&#x27;agg&#x27;)</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">BASE_DIR = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">sys.path.append(os.path.join(BASE_DIR, <span class="string">&#x27;..&#x27;</span>))</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> Counter</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> DataLoader, WeightedRandomSampler</span><br><span class="line"><span class="keyword">from</span> datasets.cifar_longtail <span class="keyword">import</span> CifarLTDataset</span><br><span class="line"><span class="keyword">from</span> tools.common_tools <span class="keyword">import</span> check_data_dir</span><br><span class="line"><span class="keyword">from</span> config.cifar_config <span class="keyword">import</span> cfg</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ProgressiveSampler</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, dataset, max_epoch</span>):</span><br><span class="line">        self.max_epoch = max_epoch</span><br><span class="line">        self.dataset = dataset      <span class="comment"># dataset</span></span><br><span class="line">        self.train_targets = [<span class="built_in">int</span>(info[<span class="number">1</span>]) <span class="keyword">for</span> info <span class="keyword">in</span> dataset.img_info]    <span class="comment">#  hard codeï¼Œè®°å½•å„ä¸ªæ ·æœ¬çš„æ ‡ç­¾</span></span><br><span class="line">        self.nums_per_cls = dataset.nums_per_cls        <span class="comment"># è®°å½•æ¯ä¸ªç±»åˆ«çš„æ ·æœ¬æ•°é‡</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_cal_class_prob</span>(<span class="params">self, q</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        æ ¹æ®qå€¼è®¡ç®—æ¯ä¸ªç±»çš„é‡‡æ ·æ¦‚ç‡ï¼Œå…¬å¼ä¸­çš„ p_j</span></span><br><span class="line"><span class="string">        :param q: float , [0, 1]</span></span><br><span class="line"><span class="string">        :return: list,</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        num_pow = <span class="built_in">list</span>(<span class="built_in">map</span>(<span class="keyword">lambda</span> x: <span class="built_in">pow</span>(x, q), self.nums_per_cls))</span><br><span class="line">        sigma_num_pow = <span class="built_in">sum</span>(num_pow)</span><br><span class="line">        cls_prob = <span class="built_in">list</span>(<span class="built_in">map</span>(<span class="keyword">lambda</span> x: x/sigma_num_pow, num_pow))</span><br><span class="line">        <span class="keyword">return</span> cls_prob</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_cal_pb_prob</span>(<span class="params">self, t</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        progressively-balanced æ¦‚ç‡è®¡ç®—</span></span><br><span class="line"><span class="string">        :param t: å½“å‰epochæ•°</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        p_ib = self._cal_class_prob(q=<span class="number">1</span>)</span><br><span class="line">        p_cb = self._cal_class_prob(q=<span class="number">0</span>)</span><br><span class="line">        p_pb = (<span class="number">1</span> - t/self.max_epoch) * np.array(p_ib) + (t/self.max_epoch) * np.array(p_cb)</span><br><span class="line"></span><br><span class="line">        p_pb /= np.array(self.nums_per_cls)  <span class="comment"># very importantï¼ç”±äºpytorchçš„sampleræœºåˆ¶æ˜¯æŒ‰æ¯ä¸ªæ ·æœ¬é‡‡æ ·ï¼Œæ‰€ä»¥è¦é™¤ä»¥æ ·æœ¬æ€»æ•°</span></span><br><span class="line">        <span class="keyword">return</span> p_pb.tolist()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self, epoch</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        ç”Ÿæˆsampler</span></span><br><span class="line"><span class="string">        :param epoch:</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        p_pb = self._cal_pb_prob(t=epoch)</span><br><span class="line">        p_pb = torch.tensor(p_pb, dtype=torch.<span class="built_in">float</span>)</span><br><span class="line">        samples_weights = p_pb[self.train_targets]  <span class="comment"># è®¡ç®—æ¯ä¸ªæ ·æœ¬è¢«é‡‡æ ·çš„æƒé‡ï¼Œè¿™é‡Œæ˜¯ä¾æ®æ ·æœ¬çš„ç±»åˆ«æ¥èµ‹æƒï¼Œself.train_targetsæ˜¯æ ‡ç­¾</span></span><br><span class="line">        <span class="comment"># weightsï¼šè¦æ±‚æ˜¯æ¯ä¸ªæ ·æœ¬èµ‹äºˆweight</span></span><br><span class="line">        <span class="comment"># num_samplesï¼šè¯¥samplerä¸€ä¸ªepoché‡‡æ ·æ•°é‡</span></span><br><span class="line">        sampler = WeightedRandomSampler(weights=samples_weights, num_samples=<span class="built_in">len</span>(samples_weights))</span><br><span class="line">        <span class="comment"># sampler = WeightedRandomSampler(weights=samples_weights, num_samples=1000)</span></span><br><span class="line">        <span class="keyword">return</span> sampler, p_pb</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">plot_line</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(self.max_epoch):</span><br><span class="line">            _, weights = self(i)</span><br><span class="line">            <span class="keyword">if</span> i % <span class="number">20</span> == <span class="number">19</span>:</span><br><span class="line">                x = <span class="built_in">range</span>(<span class="built_in">len</span>(weights))</span><br><span class="line">                plt.plot(x, weights, label=<span class="string">&quot;t=&quot;</span>+<span class="built_in">str</span>(i))</span><br><span class="line">        plt.legend()</span><br><span class="line">        plt.title(<span class="string">&quot;max epoch=&quot;</span>+<span class="built_in">str</span>(self.max_epoch))</span><br><span class="line">        plt.xlabel(<span class="string">&quot;class index sorted by numbers&quot;</span>)</span><br><span class="line">        plt.ylabel(<span class="string">&quot;weights&quot;</span>)</span><br><span class="line">        <span class="comment"># plt.show()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># è®¾ç½®è·¯å¾„</span></span><br><span class="line">    train_dir = <span class="string">r&quot;/Users/kenton/Downloads/deeplearning_dataset/cifar-10/cifar10_train&quot;</span></span><br><span class="line">    check_data_dir(train_dir)</span><br><span class="line">    train_data = CifarLTDataset(root_dir=train_dir, transform=cfg.transforms_train, isTrain=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    max_epoch = <span class="number">200</span></span><br><span class="line">    sampler_generator = ProgressiveSampler(train_data, max_epoch)</span><br><span class="line">    sampler_generator.plot_line()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(max_epoch):</span><br><span class="line">        <span class="keyword">if</span> epoch % <span class="number">20</span> != <span class="number">19</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        sampler, _ = sampler_generator(epoch)</span><br><span class="line">        train_loader = DataLoader(dataset=train_data, batch_size=cfg.train_bs, shuffle=<span class="literal">False</span>, num_workers=cfg.workers,</span><br><span class="line">                                  sampler=sampler)</span><br><span class="line">        labels = []</span><br><span class="line">        <span class="keyword">for</span> data <span class="keyword">in</span> train_loader:</span><br><span class="line">            _, label, _ = data</span><br><span class="line">            labels.extend(label.tolist())</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Epoch:&#123;&#125;, Counter:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(epoch, Counter(labels)))</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="config-x2F-cifar-config-py"><a href="#config-x2F-cifar-config-py" class="headerlink" title="config&#x2F;cifar_config.py"></a>config&#x2F;cifar_config.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"># @file name    :cifar_config.py</span></span><br><span class="line"><span class="string"># @author       :zz0320</span></span><br><span class="line"><span class="string"># @data         :2022-4-12</span></span><br><span class="line"><span class="string"># @brief        :cifarç½‘ç»œå‚æ•°é…ç½®</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> datasets.flower102 <span class="keyword">import</span> FlowerDataset</span><br><span class="line"><span class="keyword">import</span> torchvision.transforms <span class="keyword">as</span> transforms</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> easydict <span class="keyword">import</span> EasyDict</span><br><span class="line">BASE_DIR = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">sys.path.append(os.path.join(BASE_DIR, <span class="string">&#x27;..&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cfg = EasyDict() <span class="comment"># è®¿é—®å±æ€§çš„æ–¹å¼å»ä½¿ç”¨key-value å³é€šè¿‡key æˆ–è€… value</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cfg.model_name = &quot;resnet&quot;</span></span><br><span class="line"><span class="comment"># cfg.model_name = &quot;vgg16_bn&quot;</span></span><br><span class="line"><span class="comment"># cfg.model_name = &quot;se_resnet50&quot;</span></span><br><span class="line"></span><br><span class="line">cfg.pb = <span class="literal">True</span></span><br><span class="line">cfg.mixup = <span class="literal">False</span>  <span class="comment"># æ˜¯å¦é‡‡ç”¨mixup</span></span><br><span class="line">cfg.mixup_alpha = <span class="number">1.</span>  <span class="comment"># betaåˆ†å¸ƒçš„å‚æ•°. betaåˆ†å¸ƒæ˜¯ä¸€ç»„å®šä¹‰åœ¨(0,1) åŒºé—´çš„è¿ç»­æ¦‚ç‡åˆ†å¸ƒã€‚</span></span><br><span class="line">cfg.label_smooth = <span class="literal">False</span>  <span class="comment"># æ˜¯å¦é‡‡ç”¨æ ‡ç­¾å¹³æ»‘</span></span><br><span class="line">cfg.label_smooth_eps = <span class="number">0.01</span>  <span class="comment"># æ ‡ç­¾å¹³æ»‘è¶…å‚æ•° eps</span></span><br><span class="line"></span><br><span class="line">data_dir = <span class="string">&quot;/Users/kenton/Downloads/deeplearning_dataset&quot;</span></span><br><span class="line">cfg.path_resnet18 = os.path.join(data_dir, <span class="string">&quot;pretrained_model&quot;</span>, <span class="string">&quot;resnet18-f37072fd.pth&quot;</span>)</span><br><span class="line">cfg.path_vgg16bn = os.path.join(data_dir, <span class="string">&quot;pretrained_model&quot;</span>, <span class="string">&quot;vgg16_bn-6c64b313.pth&quot;</span>)</span><br><span class="line">cfg.path_se_res50 = os.path.join(data_dir, <span class="string">&quot;pretrained_model&quot;</span>, <span class="string">&quot;seresnet50-60a8950a85b2b.pkl&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®­ç»ƒå‚æ•°</span></span><br><span class="line">cfg.train_bs = <span class="number">128</span> <span class="comment"># batchsize</span></span><br><span class="line">cfg.valid_bs = <span class="number">128</span></span><br><span class="line">cfg.workers = <span class="number">4</span> <span class="comment">#çº¿ç¨‹ä¸ªæ•°</span></span><br><span class="line"></span><br><span class="line">cfg.lr_init = <span class="number">0.1</span></span><br><span class="line">cfg.momentum = <span class="number">0.9</span></span><br><span class="line">cfg.weight_decay = <span class="number">1e-4</span> <span class="comment"># æƒé‡è¡°å‡</span></span><br><span class="line"></span><br><span class="line">cfg.factor = <span class="number">0.1</span>  <span class="comment"># æƒé‡æ›´æ–°çš„æ¯”ä¾‹</span></span><br><span class="line">cfg.milestones = [<span class="number">160</span>, <span class="number">180</span>]  <span class="comment"># ä»€ä¹ˆæ—¶å€™ä¸‹é™å­¦ä¹ ç‡</span></span><br><span class="line">cfg.max_epoch = <span class="number">200</span></span><br><span class="line"></span><br><span class="line">cfg.log_interval = <span class="number">20</span>  <span class="comment"># æ—¥å¿—æ‰“å°é—´éš”</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. æ•°æ®é›†</span></span><br><span class="line">norm_mean = [<span class="number">0.4914</span>, <span class="number">0.4822</span>, <span class="number">0.4465</span>]</span><br><span class="line">norm_std = [<span class="number">0.2023</span>, <span class="number">0.1994</span>, <span class="number">0.2010</span>] <span class="comment"># cifar-10ç»Ÿè®¡å¾—åˆ°çš„</span></span><br><span class="line">normTransform = transforms.Normalize(norm_mean, norm_std)</span><br><span class="line"></span><br><span class="line">cfg.transforms_train = transforms.Compose([</span><br><span class="line">    transforms.Resize((<span class="number">32</span>)),</span><br><span class="line">    <span class="comment"># transforms.CenterCrop(256),</span></span><br><span class="line">    transforms.RandomHorizontalFlip(p=<span class="number">0.5</span>),</span><br><span class="line">    transforms.RandomCrop(<span class="number">32</span>, padding=<span class="number">4</span>),</span><br><span class="line">    transforms.ToTensor(),</span><br><span class="line">    normTransform,</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">cfg.transforms_valid = transforms.Compose([</span><br><span class="line">    transforms.Resize((<span class="number">32</span>, <span class="number">32</span>)),</span><br><span class="line">    transforms.ToTensor(),</span><br><span class="line">    normTransform,</span><br><span class="line">])</span><br></pre></td></tr></table></figure><h3 id="src-x2F-cifar-train-py"><a href="#src-x2F-cifar-train-py" class="headerlink" title="src&#x2F;cifar_train.py"></a>src&#x2F;cifar_train.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"># @file name    :cifar_train.py</span></span><br><span class="line"><span class="string"># @author       :zz0320</span></span><br><span class="line"><span class="string"># @data         :2022-4-12</span></span><br><span class="line"><span class="string"># @brief        :cifar-10è®­ç»ƒä»£ç </span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line">BASE_DIR = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">sys.path.append(os.path.join(BASE_DIR, <span class="string">&#x27;..&#x27;</span>))</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> torch.optim <span class="keyword">as</span> optim</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> DataLoader</span><br><span class="line"><span class="keyword">from</span> tools.model_trainer <span class="keyword">import</span> ModelTrainer</span><br><span class="line"><span class="keyword">from</span> tools.mixup <span class="keyword">import</span> mixup_data, mixup_criterion</span><br><span class="line"><span class="keyword">from</span> tools.common_tools <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tools.my_loss <span class="keyword">import</span> LabelSmoothLoss</span><br><span class="line"><span class="keyword">from</span> models.resnet_cifar10 <span class="keyword">import</span> resnet20</span><br><span class="line"><span class="keyword">from</span> config.cifar_config <span class="keyword">import</span> cfg</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> datasets.cifar_longtail <span class="keyword">import</span> CifarLTDataset</span><br><span class="line"><span class="keyword">from</span> tools.progressively_balance <span class="keyword">import</span> ProgressiveSampler</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">setup_seed(<span class="number">12345</span>) <span class="comment"># å…ˆå›ºå®šéšæœºç§å­</span></span><br><span class="line">device = torch.device(<span class="string">&quot;cuda&quot;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&#x27;cpu&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è§£æå‘½ä»¤è¡Œçš„å‚æ•°</span></span><br><span class="line">parser = argparse.ArgumentParser(description=<span class="string">&#x27;Training&#x27;</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;--lr&#x27;</span>,default=<span class="literal">None</span>, <span class="built_in">type</span>=<span class="built_in">float</span>, <span class="built_in">help</span>=<span class="string">&#x27;learning rate&#x27;</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;--bs&#x27;</span>,default=<span class="literal">None</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, <span class="built_in">help</span>=<span class="string">&#x27;training batch size&#x27;</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;--max_epoch&#x27;</span>,default=<span class="literal">None</span>, <span class="built_in">type</span>=<span class="built_in">int</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;--data_root_dir&#x27;</span>,default=<span class="string">r&quot;/Users/kenton/Downloads/deeplearning_dataset/cifar-10&quot;</span>,</span><br><span class="line">                    <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&#x27;path to your dataset&#x27;</span>)</span><br><span class="line"></span><br><span class="line">args = parser.parse_args()</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¥æ”¶å‚æ•°</span></span><br><span class="line">cfg.lr_init = args.lr <span class="keyword">if</span> args.lr <span class="keyword">else</span> cfg.lr_init</span><br><span class="line">cfg.train_bs = args.bs <span class="keyword">if</span> args.bs <span class="keyword">else</span> cfg.train_bs</span><br><span class="line">cfg.max_epoch = args.max_epoch <span class="keyword">if</span> args.bs <span class="keyword">else</span> cfg.max_epoch</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># step 0: config</span></span><br><span class="line">    <span class="comment"># æ•°æ®è·¯å¾„</span></span><br><span class="line">    train_dir = os.path.join(args.data_root_dir, <span class="string">&quot;cifar10_train&quot;</span>)</span><br><span class="line">    valid_dir = os.path.join(args.data_root_dir, <span class="string">&quot;cifar10_test&quot;</span>)</span><br><span class="line">    <span class="comment"># path_state_dict = &quot;/Users/kenton/Downloads/deeplearning_dataset/pretrain_model/resnet18-f37072fd.pth&quot; # é¢„è®­ç»ƒæ¨¡å‹æ‰€åœ¨ä½ç½®</span></span><br><span class="line">    check_data_dir(train_dir) <span class="comment"># éªŒè¯è·¯å¾„æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    check_data_dir(valid_dir)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆ›å»ºlogger</span></span><br><span class="line">    res_dir = os.path.join(BASE_DIR, <span class="string">&quot;..&quot;</span>, <span class="string">&quot;..&quot;</span>, <span class="string">&quot;results&quot;</span>)</span><br><span class="line">    logger, log_dir = make_logger(res_dir)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># step 1: æ•°æ®é›†</span></span><br><span class="line">    <span class="comment"># æ„å»ºDatasetå®ä¾‹ï¼Œæ„å»ºDataLoader</span></span><br><span class="line">    train_data = CifarLTDataset(root_dir=train_dir, transform=cfg.transforms_train,isTrain=<span class="literal">True</span>)</span><br><span class="line">    valid_data = CifarLTDataset(root_dir=valid_dir, transform=cfg.transforms_valid,isTrain=<span class="literal">False</span>)</span><br><span class="line">    train_loader = DataLoader(dataset=train_data, batch_size=cfg.train_bs, shuffle=<span class="literal">True</span>, num_workers=cfg.workers)</span><br><span class="line">    valid_loader = DataLoader(dataset=valid_data, batch_size=cfg.valid_bs, num_workers=cfg.workers)</span><br><span class="line">    <span class="keyword">if</span> cfg.pb:</span><br><span class="line">        sampler_generator = ProgressiveSampler(train_data, cfg.max_epoch)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. æ¨¡å‹</span></span><br><span class="line">    model = resnet20()</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    # åŠ è½½é¢„è®­ç»ƒæ¨¡å‹çš„å‚æ•° state_dict</span></span><br><span class="line"><span class="string">    if os.path.exists(path_state_dict):</span></span><br><span class="line"><span class="string">        pretrained_state_dict = torch.load(path_state_dict, map_location=&#x27;cpu&#x27;)</span></span><br><span class="line"><span class="string">        model.load_state_dict(pretrained_state_dict)</span></span><br><span class="line"><span class="string">        logger.info(&quot;Load pretrained model&quot;)</span></span><br><span class="line"><span class="string">    else:</span></span><br><span class="line"><span class="string">        logger.info(&quot;The pretrained model path &#123;&#125; is not exists&quot;.format(path_state_dict))</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    # ä¿®æ”¹æœ€åä¸€å±‚</span></span><br><span class="line"><span class="string">    num_ftrs = model.fc.in_features</span></span><br><span class="line"><span class="string">    model.fc = nn.Linear(num_ftrs, train_data.cls_num)</span></span><br><span class="line"><span class="string">    # to device</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    model.to(device)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3. æŸå¤±å‡½æ•° ä¼˜åŒ–å™¨ ç­‰</span></span><br><span class="line">    loss_f = nn.CrossEntropyLoss()</span><br><span class="line">    optimizer = optim.SGD(model.parameters(), lr=cfg.lr_init, momentum=cfg.momentum, weight_decay=cfg.weight_decay)</span><br><span class="line">    scheduler = optim.lr_scheduler.MultiStepLR(optimizer, gamma=cfg.factor, milestones=cfg.milestones)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 4. è¿­ä»£è®­ç»ƒ</span></span><br><span class="line">    loss_rec = &#123;<span class="string">&#x27;train&#x27;</span>:[], <span class="string">&quot;valid&quot;</span>:[]&#125;</span><br><span class="line">    acc_rec = &#123;<span class="string">&#x27;train&#x27;</span>:[], <span class="string">&quot;valid&quot;</span>:[]&#125;</span><br><span class="line">    best_acc, best_epoch = <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(cfg.max_epoch):</span><br><span class="line">        <span class="keyword">if</span> cfg.pb:</span><br><span class="line">            sampler, _ = sampler_generator(epoch)</span><br><span class="line">            train_loader = DataLoader(dataset=train_data, batch_size=cfg.train_bs, shuffle=<span class="literal">False</span>,</span><br><span class="line">                                      num_workers=cfg.workers, sampler=sampler)</span><br><span class="line">        <span class="comment"># dataloader</span></span><br><span class="line">        loss_train, acc_train, mat_train, path_error_train = ModelTrainer.train(</span><br><span class="line">            train_loader, model, loss_f, optimizer, scheduler, epoch, device, cfg, logger)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># valid</span></span><br><span class="line">        loss_valid, acc_valid, mat_valid, path_error_valid = ModelTrainer.valid(</span><br><span class="line">            valid_loader, model, loss_f, device)</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">&quot;Epoch[&#123;:0&gt;3&#125;/&#123;:0&gt;3&#125;] Train Acc:&#123;:.2%&#125; Valid Acc:&#123;:.2%&#125; Train loss:&#123;:.4f&#125; Valid loss:&#123;:.4f&#125; LR:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(epoch + <span class="number">1</span>,</span><br><span class="line">                cfg.max_epoch, acc_train, acc_valid, loss_train, loss_valid,</span><br><span class="line">                optimizer.param_groups[<span class="number">0</span>][<span class="string">&quot;lr&quot;</span>]))</span><br><span class="line"></span><br><span class="line">        scheduler.step() <span class="comment"># å­¦ä¹ ç‡è¿›è¡Œæ›´æ–°ï¼ï¼ï¼</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># è®°å½•è®­ç»ƒä¿¡æ¯</span></span><br><span class="line">        loss_rec[<span class="string">&quot;train&quot;</span>].append(loss_train), loss_rec[<span class="string">&quot;valid&quot;</span>].append(loss_valid)</span><br><span class="line">        acc_rec[<span class="string">&quot;train&quot;</span>].append(acc_train), acc_rec[<span class="string">&quot;valid&quot;</span>].append(acc_valid)</span><br><span class="line">        <span class="comment"># ä¿å­˜æ··æ·†çŸ©é˜µå›¾</span></span><br><span class="line">        show_confMat(mat_train, train_data.names, <span class="string">&quot;train&quot;</span>, log_dir, epoch=epoch, verbose=epoch == cfg.max_epoch - <span class="number">1</span>)</span><br><span class="line">        show_confMat(mat_valid, valid_data.names, <span class="string">&quot;valid&quot;</span>, log_dir, epoch=epoch, verbose=epoch == cfg.max_epoch - <span class="number">1</span>)</span><br><span class="line">        <span class="comment"># ä¿å­˜lossæ›²çº¿ accæ›²çº¿</span></span><br><span class="line">        plt_x = np.arange(<span class="number">1</span>, epoch + <span class="number">2</span>)</span><br><span class="line">        plot_line(plt_x, loss_rec[<span class="string">&quot;train&quot;</span>], plt_x, loss_rec[<span class="string">&quot;valid&quot;</span>], mode=<span class="string">&quot;loss&quot;</span>, out_dir=log_dir)</span><br><span class="line">        plot_line(plt_x, acc_rec[<span class="string">&quot;train&quot;</span>], plt_x, acc_rec[<span class="string">&quot;valid&quot;</span>], mode=<span class="string">&quot;acc&quot;</span>, out_dir=log_dir)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ä¿å­˜æ¨¡å‹</span></span><br><span class="line">        <span class="keyword">if</span> best_acc &lt; acc_valid <span class="keyword">or</span> epoch == cfg.max_epoch - <span class="number">1</span>:</span><br><span class="line">            best_epoch = epoch <span class="keyword">if</span> best_acc &lt; acc_valid <span class="keyword">else</span> best_epoch</span><br><span class="line">            best_acc = acc_valid <span class="keyword">if</span> best_acc &lt; acc_valid <span class="keyword">else</span> best_acc</span><br><span class="line">            checkpoint = &#123;<span class="string">&quot;model_state_dict&quot;</span>: model.state_dict(),</span><br><span class="line">                          <span class="string">&quot;optimizer_state_dict&quot;</span>: optimizer.state_dict(),</span><br><span class="line">                          <span class="string">&quot;epoch&quot;</span>: epoch,</span><br><span class="line">                          <span class="string">&quot;best_acc&quot;</span>: best_acc&#125;</span><br><span class="line">            pkl_name = <span class="string">&quot;checkpoint_&#123;&#125;.pkl&quot;</span>.<span class="built_in">format</span>(epoch) <span class="keyword">if</span> epoch == cfg.max_epoch - <span class="number">1</span> <span class="keyword">else</span> <span class="string">&quot;checkpoint_best.pkl&quot;</span></span><br><span class="line">            path_checkpoint = os.path.join(log_dir, pkl_name)</span><br><span class="line">            torch.save(checkpoint, path_checkpoint)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># ä¿å­˜é”™è¯¯å›¾ç‰‡çš„è·¯å¾„</span></span><br><span class="line">            err_ims_name = <span class="string">&quot;error_imgs_&#123;&#125;.pkl&quot;</span>.<span class="built_in">format</span>(epoch) <span class="keyword">if</span> epoch == cfg.max_epoch - <span class="number">1</span> <span class="keyword">else</span> <span class="string">&quot;error_imgs_best.pkl&quot;</span></span><br><span class="line">            path_err_img = os.path.join(log_dir, err_ims_name)</span><br><span class="line">            error_info = &#123;&#125;</span><br><span class="line">            error_info[<span class="string">&quot;train&quot;</span>] = path_error_train</span><br><span class="line">            error_info[<span class="string">&quot;valid&quot;</span>] = path_error_valid</span><br><span class="line">            pickle.dump(error_info, <span class="built_in">open</span>(path_err_img, <span class="string">&quot;wb&quot;</span>))</span><br><span class="line">    logger.info(<span class="string">&quot;&#123;&#125; done, best acc:&#123;&#125; in: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">        datetime.strftime(datetime.now(), <span class="string">&quot;%m-%d_%H-%M&quot;</span>), best_acc, best_epoch))</span><br></pre></td></tr></table></figure><h2 id="å®éªŒå®è·µ"><a href="#å®éªŒå®è·µ" class="headerlink" title="å®éªŒå®è·µ"></a>å®éªŒå®è·µ</h2><p>é‡‡ç”¨PB Samplingå’Œä¸é‡‡ç”¨PB Samplingæ—¶ï¼Œæ¨¡å‹ç²¾åº¦çš„å˜åŒ–ï¼Œè¡¨æ ¼å¦‚ä¸‹ï¼š</p><table><thead><tr><th></th><th>Train Acc</th><th>Valid Acc</th><th>Train loss</th><th>Valid loss</th></tr></thead><tbody><tr><td>æœ‰PB Sampling</td><td>96.78%</td><td>71.25%</td><td>0.0920</td><td>1.3972</td></tr><tr><td>æ— PB Sampling</td><td>97.19%</td><td>68.87%</td><td>0.0821</td><td>1.6085</td></tr></tbody></table>]]></content>
      
      
      
        <tags>
            
            <tag> èŠ±æœµåˆ†ç±»é¡¹ç›® </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€ŒèŠ±æœµåˆ†ç±»é¡¹ç›®ã€ï¼ˆå››ï¼‰æ¨¡å‹æ¶¨ç‚¹æŠ€å·§</title>
      <link href="/2022/05/19/%E3%80%8C%E8%8A%B1%E6%9C%B5%E5%88%86%E7%B1%BB%E9%A1%B9%E7%9B%AE%E3%80%8D%EF%BC%88%E5%9B%9B%EF%BC%89%E6%A8%A1%E5%9E%8B%E6%B6%A8%E7%82%B9%E6%8A%80%E5%B7%A7/"/>
      <url>/2022/05/19/%E3%80%8C%E8%8A%B1%E6%9C%B5%E5%88%86%E7%B1%BB%E9%A1%B9%E7%9B%AE%E3%80%8D%EF%BC%88%E5%9B%9B%EF%BC%89%E6%A8%A1%E5%9E%8B%E6%B6%A8%E7%82%B9%E6%8A%80%E5%B7%A7/</url>
      
        <content type="html"><![CDATA[<h2 id="æ•°æ®å¢å¼ºã€Œå¢å¹¿ã€"><a href="#æ•°æ®å¢å¼ºã€Œå¢å¹¿ã€" class="headerlink" title="æ•°æ®å¢å¼ºã€Œå¢å¹¿ã€"></a>æ•°æ®å¢å¼ºã€Œå¢å¹¿ã€</h2><p>æ•°æ®å¢å¼ºæŒ‡é€šè¿‡å›¾åƒå¤„ç†æ–¹æ³•å¯¹è®­ç»ƒé›†æ•°æ®è¿›è¡Œä¸°å¯ŒåŒ–</p><p>æ•°æ®å¢å¼ºä½¿ç”¨åŸåˆ™ï¼šè®©è®­ç»ƒé›†é€¼è¿‘éªŒè¯é›†ã€æµ‹è¯•é›† </p><h3 id="PyTorch-Transformsçš„äºŒåäºŒä¸ªæ–¹æ³•"><a href="#PyTorch-Transformsçš„äºŒåäºŒä¸ªæ–¹æ³•" class="headerlink" title="PyTorch.Transformsçš„äºŒåäºŒä¸ªæ–¹æ³•"></a>PyTorch.Transformsçš„äºŒåäºŒä¸ªæ–¹æ³•</h3><table><thead><tr><th>åç§°</th><th>ä»£ç æ“ä½œ</th></tr></thead><tbody><tr><td><strong>è£å‰ª</strong></td><td><strong>Crop</strong></td></tr><tr><td>ä¸­å¿ƒè£å‰ª</td><td>transforms.CenterCrop</td></tr><tr><td>éšæœºè£å‰ª</td><td>transforms.RandomCrop</td></tr><tr><td>éšæœºé•¿å®½æ¯”è£å‰ª</td><td>transforms.RandomResizedCrop</td></tr><tr><td>ä¸Šä¸‹å·¦å³ä¸­å¿ƒè£å‰ª</td><td>transforms.FiveCrop</td></tr><tr><td>ä¸Šä¸‹å·¦å³ä¸­å¿ƒè£å‰ªåç¿»è½¬</td><td>transforms.TenCrop</td></tr><tr><td><strong>ç¿»è½¬å’Œæ—‹è½¬</strong></td><td><strong>Flip and Rotation</strong></td></tr><tr><td>ä¾æ¦‚ç‡ p æ°´å¹³ç¿»è½¬</td><td>transforms.RandomHorizontalFlip(p&#x3D;0.5)</td></tr><tr><td>ä¾æ¦‚ç‡ p å‚ç›´ç¿»è½¬</td><td>transforms.RandomVerticalFlip(p&#x3D;0.5)</td></tr><tr><td>éšæœºæ—‹è½¬</td><td>transforms.RandomRotation</td></tr><tr><td><strong>å›¾åƒå˜æ¢</strong></td><td></td></tr><tr><td>resize</td><td>transforms.Resize</td></tr><tr><td>æ ‡å‡†åŒ–</td><td>transforms.Normalize</td></tr><tr><td>è½¬ä¸º tensorï¼Œå¹¶å½’ä¸€åŒ–è‡³[0-1]</td><td>transforms.ToTensor</td></tr><tr><td>å¡«å……</td><td>transforms.Pad</td></tr><tr><td>ä¿®æ”¹äº®åº¦ã€å¯¹æ¯”åº¦å’Œé¥±å’Œåº¦</td><td>transforms.ColorJitter</td></tr><tr><td>è½¬ç°åº¦å›¾</td><td>transforms.Grayscale</td></tr><tr><td>çº¿æ€§å˜æ¢</td><td>transforms.LinearTransformation()</td></tr><tr><td>ä»¿å°„å˜æ¢</td><td>transforms.RandomAffine</td></tr><tr><td>ä¾æ¦‚ç‡ p è½¬ä¸ºç°åº¦å›¾</td><td>transforms.RandomGrayscale</td></tr><tr><td>å°†æ•°æ®è½¬æ¢ä¸º PILImage</td><td>transforms.ToPILImage</td></tr><tr><td>Apply a user-defined lambda as a transform</td><td>transforms.Lambda</td></tr><tr><td><strong>å¯¹ transforms æ“ä½œï¼Œä½¿æ•°æ®å¢å¼ºæ›´çµæ´»</strong></td><td></td></tr><tr><td>ä»ç»™å®šçš„ä¸€ç³»åˆ— transforms ä¸­é€‰ä¸€ä¸ªè¿›è¡Œæ“ä½œ</td><td>transforms.RandomChoice(transforms)</td></tr><tr><td>ç»™ä¸€ä¸ª transform åŠ ä¸Šæ¦‚ç‡ï¼Œä¾æ¦‚ç‡è¿›è¡Œæ“ä½œ</td><td>transforms.RandomApply(transforms, p&#x3D;0.5)</td></tr><tr><td>å°† transforms ä¸­çš„æ“ä½œéšæœºæ‰“ä¹±</td><td>transforms.RandomOrder</td></tr></tbody></table><span id="more"></span><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2f55c3j74j20kg0k0q3s.jpg" alt="" style="zoom: 25%;" /><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2f3we9uimj20k00k0gq2.jpg"></p><h3 id="Mixup"><a href="#Mixup" class="headerlink" title="Mixup"></a>Mixup</h3><p>ã€Œ<a href="https://arxiv.org/abs/1710.09412">mixup: Beyond Empirical Risk Minimization</a>ã€</p><p>Mixupä»ç»éªŒé£é™©æœ€å°åŒ–æ–¹æ³•(Empirical Risk Minimization, ERM)è§’åº¦æ€è€ƒï¼Œå‘ç°é—®é¢˜ï¼š</p><p>ç½‘ç»œå€¾å‘äºè®°å¿†è®­ç»ƒæ ·æœ¬ï¼Œè€Œä¸æ˜¯æ³›åŒ–ï¼›</p><p>éš¾ä»¥æŠµå¾¡åˆ†å¸ƒå¤–æ ·æœ¬ï¼Œå¦‚è‚‰çœ¼æ„Ÿå®˜æ²¡æœ‰åŒºåˆ«çš„å¯¹æŠ—æ ·æœ¬</p><p>æå‡ºä½¿ç”¨é‚»åŸŸé£é™©æœ€å°åŒ–åŸåˆ™(Vicinal Risk Minimization, VRM)æ¥è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œå…·ä½“æ“ä½œæ–¹æ³•ç§°ä¸ºMixup</p><p><strong>å¤§é“è‡³ç®€</strong>ï¼šå°†ä¸¤å¼ å›¾ç‰‡æŒ‰æ¯”ä¾‹æ··åˆåœ¨ä¸€èµ·å¾—åˆ°æ–°å›¾ç‰‡ï¼Œä»è€Œæ‰©å……æ•°æ®ä¸°å¯Œåº¦Lambdaï¼šä»Betaåˆ†å¸ƒä¸­éšæœºé‡‡æ ·</p><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2f5yt7nlqj20zk04bdgp.jpg"></p><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2f60zmhl6j20vk07dgmu.jpg"></p><h2 id="Label-Smoothingã€Œæ­£åˆ™åŒ–ã€"><a href="#Label-Smoothingã€Œæ­£åˆ™åŒ–ã€" class="headerlink" title="Label Smoothingã€Œæ­£åˆ™åŒ–ã€"></a>Label Smoothingã€Œæ­£åˆ™åŒ–ã€</h2><p>ã€Œ<a href="https://arxiv.org/abs/1512.00567">Rethinking the Inception Architecture for Computer Vision</a>ã€</p><p>äº¤å‰ç†µ $CrossEntropy$: $H(p, q)&#x3D; - \sum_{K-1}^Klog(p_k)q_k{}$è¡¡é‡ä¸¤ä¸ªæ¦‚ç‡åˆ†å¸ƒä¹‹é—´çš„å·®å¼‚</p><p>æ¦‚ç‡æœ‰ä¸¤ä¸ªæ€§è´¨ï¼š<strong>æ¦‚ç‡å€¼éè´Ÿ</strong> å’Œ <strong>æ¦‚ç‡å€¼å’Œä¸º1</strong></p><p>æ‰€ä»¥å¾—åˆ°çš„æ•°æ®å¯ä»¥å®Œå…¨ä¾é $Softmax$å‡½æ•°è½¬åŒ–åˆ°æ¦‚ç‡åˆ†å¸ƒçš„å½¢å¼</p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2f6fqcch7j20zk079wep.jpg" style="zoom:25%;" /><table><thead><tr><th>æ¦‚ç‡ä¸¤ä¸ªæ€§è´¨</th><th>Softmaxæ“ä½œ</th></tr></thead><tbody><tr><td>æ¦‚ç‡å€¼æ˜¯éè´Ÿçš„</td><td>å–æŒ‡æ•°ï¼Œå®ç°éè´Ÿ</td></tr><tr><td>æ¦‚ç‡ä¹‹å’Œç­‰äº1</td><td>é™¤ä»¥æŒ‡æ•°ä¹‹å’Œï¼Œå®ç°å’Œä¸º1</td></tr></tbody></table><p>ä¼ ç»Ÿçš„One-hotç¼–ç å­˜åœ¨è¿‡åº¦è‡ªä¿¡çš„é—®é¢˜ï¼Œå¯¼è‡´è¿‡æ‹Ÿåˆ</p><p> $q$ä¸º $one-hot$å‘é‡ $(0,1,0,0)$</p><p>$H(p, q) &#x3D; -\sum_{K&#x3D;1}^{K}log(p_k)q_k &#x3D; -log(p_2)q_2 &#x3D; -log(p_2) * 1$</p><p>æ ‡ç­¾å¹³æ»‘ï¼ŒæŠŠOne-hotä¸­æ¦‚ç‡ä¸º1çš„é‚£ä¸€é¡¹è¿›è¡Œè¡°å‡ï¼Œé¿å…è¿‡åº¦è‡ªä¿¡ï¼Œè¡°å‡çš„é‚£éƒ¨åˆ†confienceå¹³å‡åˆ†åˆ°å…¶å®ƒçš„æ¯ä¸€ä¸ªç±»åˆ«ä¸­</p><p>$label &#x3D; (0, 1, 0, 0)$  $label Smoothing&#x3D;(0.00033, 0.999, 0.00033, 0.00033)$</p><p>$H(p, q) &#x3D; -\sum_{K&#x3D;1}^{K}log(p_k)q_k &#x3D; -[log(p_1)q_1 + log(p_2)q_2 + log(p_3)q_3 + log(p_4)q_4]$</p><h2 id="ä»£ç è¡¥å……"><a href="#ä»£ç è¡¥å……" class="headerlink" title="ä»£ç è¡¥å……"></a>ä»£ç è¡¥å……</h2><h3 id="tools-x2F-mixup-py"><a href="#tools-x2F-mixup-py" class="headerlink" title="tools&#x2F;mixup.py"></a>tools&#x2F;mixup.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"># @file name    :mixup.py</span></span><br><span class="line"><span class="string"># @author       :zz0320</span></span><br><span class="line"><span class="string"># @data         :2022-4-10</span></span><br><span class="line"><span class="string"># @brief        :mixupåŠŸèƒ½å®ç° å†…å«æµ‹è¯•æ ·ä¾‹</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mixup_data</span>(<span class="params">x, y, alpha=<span class="number">1.0</span>, device=<span class="literal">True</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Return mixed inputs, pairs of targets, and lambda&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># é€šè¿‡betaåˆ†å¸ƒè·å¾—lambda betaåˆ†å¸ƒçš„å‚æ•°alpha == beta å› æ­¤éƒ½æ˜¯alpha</span></span><br><span class="line">    lam = np.random.beta(alpha, alpha) <span class="keyword">if</span> alpha &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># è·å–éœ€è¦é‡å çš„å›¾ç‰‡çš„æ ‡å·</span></span><br><span class="line">    batch_size = x.size()[<span class="number">0</span>]</span><br><span class="line">    index = torch.randperm(batch_size).to(device)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># mixup</span></span><br><span class="line">    mixed_x = lam * x + (<span class="number">1</span> - lam) * x[index, :]</span><br><span class="line">    y_a, y_b = y, y[index]</span><br><span class="line">    <span class="keyword">return</span> mixed_x, y_a, y_b, lam</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mixup_criterion</span>(<span class="params">criterion, pred, y_a, y_b, lam</span>):</span><br><span class="line">    <span class="keyword">return</span> lam * criterion(pred, y_a) + (<span class="number">1</span> - lam) * criterion(pred, y_b)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">import</span> cv2</span><br><span class="line">    <span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">    path_1 = <span class="string">r&quot;/Users/kenton/Downloads/deeplearning_dataset/flower102/jpg/image_00001.jpg&quot;</span></span><br><span class="line">    path_2 = <span class="string">r&quot;/Users/kenton/Downloads/deeplearning_dataset/flower102/jpg/image_00002.jpg&quot;</span></span><br><span class="line"></span><br><span class="line">    img1 = cv2.imread(path_1)</span><br><span class="line">    img2 = cv2.imread(path_2)</span><br><span class="line">    img1 = cv2.resize(img1, (<span class="number">224</span>, <span class="number">224</span>))</span><br><span class="line">    img2 = cv2.resize(img2, (<span class="number">224</span>, <span class="number">224</span>))</span><br><span class="line"></span><br><span class="line">    alpha = <span class="number">1</span></span><br><span class="line">    figsize = <span class="number">15</span></span><br><span class="line">    plt.figure(figsize=(<span class="built_in">int</span>(figsize), <span class="built_in">int</span>(figsize)))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>):</span><br><span class="line">        <span class="comment"># lam = i * 0.1</span></span><br><span class="line">        lam = np.random.beta(alpha, alpha)</span><br><span class="line">        im_mixup = (img1 * lam + img2 * (<span class="number">1</span> - lam)).astype(np.uint8)</span><br><span class="line">        im_mixup = cv2.cvtColor(im_mixup, cv2.COLOR_BGR2RGB)</span><br><span class="line">        plt.subplot(<span class="number">3</span>, <span class="number">3</span>, i)</span><br><span class="line">        plt.title(<span class="string">&quot;lamda_&#123;:.2f&#125;&quot;</span>.<span class="built_in">format</span>(lam))</span><br><span class="line">        plt.imshow(im_mixup)</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="tools-x2F-my-loss-py"><a href="#tools-x2F-my-loss-py" class="headerlink" title="tools&#x2F;my_loss.py"></a>tools&#x2F;my_loss.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"># @file name    :my_loss.py</span></span><br><span class="line"><span class="string"># @author       :zz0320</span></span><br><span class="line"><span class="string"># @data         :2022-4-10</span></span><br><span class="line"><span class="string"># @brief        :é‡å†™çš„losså‡½æ•°</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABC</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LabelSmoothLoss</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, smoothing = <span class="number">0.0</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(LabelSmoothLoss, self).__init__()</span><br><span class="line">        self.smoothing = smoothing</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, <span class="built_in">input</span>, target</span>):</span><br><span class="line">        log_prob = F.log_softmax(<span class="built_in">input</span>, dim=-<span class="number">1</span>)</span><br><span class="line">        weight = <span class="built_in">input</span>.new_ones(<span class="built_in">input</span>.size()) * self.smoothing / (<span class="built_in">input</span>.size(-<span class="number">1</span>) - <span class="number">1.</span>)</span><br><span class="line">        weight.scatter_(-<span class="number">1</span>, target.unsqueeze(-<span class="number">1</span>), (<span class="number">1</span> - self.smoothing))</span><br><span class="line">        loss = (-weight * log_prob).<span class="built_in">sum</span>(dim=-<span class="number">1</span>).mean()</span><br><span class="line">        <span class="keyword">return</span> loss</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line">    output = torch.tensor([[<span class="number">4.0</span>, <span class="number">5.0</span>, <span class="number">10.0</span>], [<span class="number">1.0</span>, <span class="number">5.0</span>, <span class="number">4.0</span>], [<span class="number">1.0</span>, <span class="number">15.0</span>, <span class="number">4.0</span>]])</span><br><span class="line">    label = torch.tensor([<span class="number">2</span>, <span class="number">1</span>, <span class="number">1</span>], dtype=torch.int64)</span><br><span class="line"></span><br><span class="line">    criterion = LabelSmoothLoss(<span class="number">0.001</span>)</span><br><span class="line">    loss = criterion(output, label)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;CrossEntropy:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(loss))</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> èŠ±æœµåˆ†ç±»é¡¹ç›® </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€ŒèŠ±æœµåˆ†ç±»é¡¹ç›®ã€ï¼ˆä¸‰ï¼‰å·ç§¯ç¥ç»ç½‘ç»œæ¨¡å‹</title>
      <link href="/2022/05/19/%E3%80%8C%E8%8A%B1%E6%9C%B5%E5%88%86%E7%B1%BB%E9%A1%B9%E7%9B%AE%E3%80%8D%EF%BC%88%E4%B8%89%EF%BC%89%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B/"/>
      <url>/2022/05/19/%E3%80%8C%E8%8A%B1%E6%9C%B5%E5%88%86%E7%B1%BB%E9%A1%B9%E7%9B%AE%E3%80%8D%EF%BC%88%E4%B8%89%EF%BC%89%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B/</url>
      
        <content type="html"><![CDATA[<h2 id="VGG-ResNet-SENetä»‹ç»"><a href="#VGG-ResNet-SENetä»‹ç»" class="headerlink" title="VGG ResNet SENetä»‹ç»"></a>VGG ResNet SENetä»‹ç»</h2><h2 id="è¾“å…¥å°ºå¯¸çš„é€‰æ‹©"><a href="#è¾“å…¥å°ºå¯¸çš„é€‰æ‹©" class="headerlink" title="è¾“å…¥å°ºå¯¸çš„é€‰æ‹©"></a>è¾“å…¥å°ºå¯¸çš„é€‰æ‹©</h2><h3 id="æ–¹æ³•ä¸€ï¼šè®©æ•°æ®é€‚åº”æ¨¡å‹"><a href="#æ–¹æ³•ä¸€ï¼šè®©æ•°æ®é€‚åº”æ¨¡å‹" class="headerlink" title="æ–¹æ³•ä¸€ï¼šè®©æ•°æ®é€‚åº”æ¨¡å‹"></a>æ–¹æ³•ä¸€ï¼šè®©æ•°æ®é€‚åº”æ¨¡å‹</h3><p>ç›´æ¥å°†å›¾åƒç¼©æ”¾&#x2F;è£å‰ªåˆ°æ¨¡å‹è¦æ±‚çš„è¾“å…¥å°ºå¯¸ï¼Œå¸¸è§çš„å°ºå¯¸å¦‚åŸºäºImageNetè®¾è®¡çš„å¦‚224*224ç³»åˆ—ã€åŸºäºCifarè®¾è®¡çš„32*32ç³»åˆ—</p><h3 id="æ–¹æ³•äºŒï¼šä¿®æ”¹æ¨¡å‹é€‚åº”å‚æ•°"><a href="#æ–¹æ³•äºŒï¼šä¿®æ”¹æ¨¡å‹é€‚åº”å‚æ•°" class="headerlink" title="æ–¹æ³•äºŒï¼šä¿®æ”¹æ¨¡å‹é€‚åº”å‚æ•°"></a>æ–¹æ³•äºŒï¼šä¿®æ”¹æ¨¡å‹é€‚åº”å‚æ•°</h3><p>ä¿®æ”¹åˆ†è¾¨ç‡ä¸‹é™çš„åœ°æ–¹ï¼Œä»¥æ”¹å˜æ¨¡å‹å¯¹è¾“å…¥å°ºå¯¸çš„è¦æ±‚åˆ é™¤ä¸€ä¸ªPoolingï¼Œä½¿224*224å˜ä¸ºå¯æ¥æ”¶112*112å¢åŠ ä¸€ä¸ªPoolingï¼Œä½¿224*224å˜ä¸ºå¯æ¥æ”¶448*448å·ç§¯æ­¥é•¿stride&#x3D;2çš„ï¼Œæ”¹ä¸ºstide&#x3D;1ï¼Œä½¿è¾“å…¥å¯å˜ä¸º112*112å·ç§¯æ­¥é•¿stride&#x3D;1çš„ï¼Œæ”¹ä¸ºstide&#x3D;2ï¼Œä½¿è¾“å…¥å¯å˜ä¸º448*448è‡ªè¡Œè®¾è®¡å·ç§¯æ ¸å¤§å°ï¼Œstrideï¼Œæ± åŒ–å±‚æ•°é‡</p><span id="more"></span><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2f0prhgq1j208w0zkmza.jpg" style="zoom:25%;" /><h3 id="æ–¹æ³•ä¸‰ï¼šåˆ’åˆ†æˆPatchå½¢å¼ï¼Œåˆ†åˆ«å¤„ç†ï¼Œå¦‚é¥æ„Ÿå½±åƒã€æ•°å­—ç—…ç†å›¾åƒ"><a href="#æ–¹æ³•ä¸‰ï¼šåˆ’åˆ†æˆPatchå½¢å¼ï¼Œåˆ†åˆ«å¤„ç†ï¼Œå¦‚é¥æ„Ÿå½±åƒã€æ•°å­—ç—…ç†å›¾åƒ" class="headerlink" title="æ–¹æ³•ä¸‰ï¼šåˆ’åˆ†æˆPatchå½¢å¼ï¼Œåˆ†åˆ«å¤„ç†ï¼Œå¦‚é¥æ„Ÿå½±åƒã€æ•°å­—ç—…ç†å›¾åƒ"></a>æ–¹æ³•ä¸‰ï¼šåˆ’åˆ†æˆPatchå½¢å¼ï¼Œåˆ†åˆ«å¤„ç†ï¼Œå¦‚é¥æ„Ÿå½±åƒã€æ•°å­—ç—…ç†å›¾åƒ</h3><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2f0pbom0jj20zk0by769.jpg"></p><h2 id="ä»£ç ä¼˜åŒ–"><a href="#ä»£ç ä¼˜åŒ–" class="headerlink" title="ä»£ç ä¼˜åŒ–"></a>ä»£ç ä¼˜åŒ–</h2><h3 id="models-x2F-vgg-tv-py"><a href="#models-x2F-vgg-tv-py" class="headerlink" title="models&#x2F;vgg_tv.py"></a>models&#x2F;vgg_tv.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.utils.model_zoo <span class="keyword">as</span> model_zoo</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">__all__ = [</span><br><span class="line">    <span class="string">&#x27;VGG&#x27;</span>, <span class="string">&#x27;vgg11&#x27;</span>, <span class="string">&#x27;vgg11_bn&#x27;</span>, <span class="string">&#x27;vgg13&#x27;</span>, <span class="string">&#x27;vgg13_bn&#x27;</span>, <span class="string">&#x27;vgg16&#x27;</span>, <span class="string">&#x27;vgg16_bn&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;vgg19_bn&#x27;</span>, <span class="string">&#x27;vgg19&#x27;</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">model_urls = &#123;</span><br><span class="line">    <span class="string">&#x27;vgg11&#x27;</span>: <span class="string">&#x27;https://download.pytorch.org/models/vgg11-bbd30ac9.pth&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;vgg13&#x27;</span>: <span class="string">&#x27;https://download.pytorch.org/models/vgg13-c768596a.pth&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;vgg16&#x27;</span>: <span class="string">&#x27;https://download.pytorch.org/models/vgg16-397923af.pth&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;vgg19&#x27;</span>: <span class="string">&#x27;https://download.pytorch.org/models/vgg19-dcbb9e9d.pth&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;vgg11_bn&#x27;</span>: <span class="string">&#x27;https://download.pytorch.org/models/vgg11_bn-6002323d.pth&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;vgg13_bn&#x27;</span>: <span class="string">&#x27;https://download.pytorch.org/models/vgg13_bn-abd245e5.pth&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;vgg16_bn&#x27;</span>: <span class="string">&#x27;https://download.pytorch.org/models/vgg16_bn-6c64b313.pth&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;vgg19_bn&#x27;</span>: <span class="string">&#x27;https://download.pytorch.org/models/vgg19_bn-c79401a0.pth&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VGG</span>(nn.Module):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, features, num_classes=<span class="number">1000</span>, init_weights=<span class="literal">True</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(VGG, self).__init__()</span><br><span class="line">        self.features = features</span><br><span class="line">        self.avgpool = nn.AdaptiveAvgPool2d((<span class="number">7</span>, <span class="number">7</span>))</span><br><span class="line">        self.classifier = nn.Sequential(</span><br><span class="line">            nn.Linear(<span class="number">512</span> * <span class="number">7</span> * <span class="number">7</span>, <span class="number">4096</span>),</span><br><span class="line">            nn.ReLU(<span class="literal">True</span>),</span><br><span class="line">            nn.Dropout(),</span><br><span class="line">            nn.Linear(<span class="number">4096</span>, <span class="number">4096</span>),</span><br><span class="line">            nn.ReLU(<span class="literal">True</span>),</span><br><span class="line">            nn.Dropout(),</span><br><span class="line">            nn.Linear(<span class="number">4096</span>, num_classes),</span><br><span class="line">        )</span><br><span class="line">        <span class="comment"># self.xxx = nn.XXXX</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> init_weights:</span><br><span class="line">            self._initialize_weights()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        x = self.features(x)</span><br><span class="line">        x = self.avgpool(x)</span><br><span class="line">        x = x.view(x.size(<span class="number">0</span>), -<span class="number">1</span>)</span><br><span class="line">        x = self.classifier(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_initialize_weights</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">for</span> m <span class="keyword">in</span> self.modules():</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(m, nn.Conv2d):</span><br><span class="line">                nn.init.kaiming_normal_(m.weight, mode=<span class="string">&#x27;fan_out&#x27;</span>, nonlinearity=<span class="string">&#x27;relu&#x27;</span>)</span><br><span class="line">                <span class="keyword">if</span> m.bias <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                    nn.init.constant_(m.bias, <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">isinstance</span>(m, nn.BatchNorm2d):</span><br><span class="line">                nn.init.constant_(m.weight, <span class="number">1</span>)</span><br><span class="line">                nn.init.constant_(m.bias, <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">isinstance</span>(m, nn.Linear):</span><br><span class="line">                nn.init.normal_(m.weight, <span class="number">0</span>, <span class="number">0.01</span>)</span><br><span class="line">                nn.init.constant_(m.bias, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_layers</span>(<span class="params">cfg, batch_norm=<span class="literal">False</span></span>):</span><br><span class="line">    layers = []</span><br><span class="line">    in_channels = <span class="number">3</span></span><br><span class="line">    <span class="keyword">for</span> v <span class="keyword">in</span> cfg:</span><br><span class="line">        <span class="keyword">if</span> v == <span class="string">&#x27;M&#x27;</span>:</span><br><span class="line">            layers += [nn.MaxPool2d(kernel_size=<span class="number">2</span>, stride=<span class="number">2</span>)]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            conv2d = nn.Conv2d(in_channels, v, kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span> batch_norm:</span><br><span class="line">                layers += [conv2d, nn.BatchNorm2d(v), nn.ReLU(inplace=<span class="literal">True</span>)]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                layers += [conv2d, nn.ReLU(inplace=<span class="literal">True</span>)]</span><br><span class="line">            in_channels = v</span><br><span class="line">    <span class="keyword">return</span> nn.Sequential(*layers)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cfg = &#123;</span><br><span class="line">    <span class="string">&#x27;A&#x27;</span>: [<span class="number">64</span>, <span class="string">&#x27;M&#x27;</span>, <span class="number">128</span>, <span class="string">&#x27;M&#x27;</span>, <span class="number">256</span>, <span class="number">256</span>, <span class="string">&#x27;M&#x27;</span>, <span class="number">512</span>, <span class="number">512</span>, <span class="string">&#x27;M&#x27;</span>, <span class="number">512</span>, <span class="number">512</span>, <span class="string">&#x27;M&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;B&#x27;</span>: [<span class="number">64</span>, <span class="number">64</span>, <span class="string">&#x27;M&#x27;</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="string">&#x27;M&#x27;</span>, <span class="number">256</span>, <span class="number">256</span>, <span class="string">&#x27;M&#x27;</span>, <span class="number">512</span>, <span class="number">512</span>, <span class="string">&#x27;M&#x27;</span>, <span class="number">512</span>, <span class="number">512</span>, <span class="string">&#x27;M&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;D&#x27;</span>: [<span class="number">64</span>, <span class="number">64</span>, <span class="string">&#x27;M&#x27;</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="string">&#x27;M&#x27;</span>, <span class="number">256</span>, <span class="number">256</span>, <span class="number">256</span>, <span class="string">&#x27;M&#x27;</span>, <span class="number">512</span>, <span class="number">512</span>, <span class="number">512</span>, <span class="string">&#x27;M&#x27;</span>, <span class="number">512</span>, <span class="number">512</span>, <span class="number">512</span>, <span class="string">&#x27;M&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;E&#x27;</span>: [<span class="number">64</span>, <span class="number">64</span>, <span class="string">&#x27;M&#x27;</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="string">&#x27;M&#x27;</span>, <span class="number">256</span>, <span class="number">256</span>, <span class="number">256</span>, <span class="number">256</span>, <span class="string">&#x27;M&#x27;</span>, <span class="number">512</span>, <span class="number">512</span>, <span class="number">512</span>, <span class="number">512</span>, <span class="string">&#x27;M&#x27;</span>, <span class="number">512</span>, <span class="number">512</span>, <span class="number">512</span>, <span class="number">512</span>, <span class="string">&#x27;M&#x27;</span>],</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">vgg11</span>(<span class="params">pretrained=<span class="literal">False</span>, **kwargs</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;VGG 11-layer model (configuration &quot;A&quot;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        pretrained (bool): If True, returns a model pre-trained on ImageNet</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> pretrained:</span><br><span class="line">        kwargs[<span class="string">&#x27;init_weights&#x27;</span>] = <span class="literal">False</span></span><br><span class="line">    model = VGG(make_layers(cfg[<span class="string">&#x27;A&#x27;</span>]), **kwargs)</span><br><span class="line">    <span class="keyword">if</span> pretrained:</span><br><span class="line">        model.load_state_dict(model_zoo.load_url(model_urls[<span class="string">&#x27;vgg11&#x27;</span>]))</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">vgg11_bn</span>(<span class="params">pretrained=<span class="literal">False</span>, **kwargs</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;VGG 11-layer model (configuration &quot;A&quot;) with batch normalization</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        pretrained (bool): If True, returns a model pre-trained on ImageNet</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> pretrained:</span><br><span class="line">        kwargs[<span class="string">&#x27;init_weights&#x27;</span>] = <span class="literal">False</span></span><br><span class="line">    model = VGG(make_layers(cfg[<span class="string">&#x27;A&#x27;</span>], batch_norm=<span class="literal">True</span>), **kwargs)</span><br><span class="line">    <span class="keyword">if</span> pretrained:</span><br><span class="line">        model.load_state_dict(model_zoo.load_url(model_urls[<span class="string">&#x27;vgg11_bn&#x27;</span>]))</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">vgg13</span>(<span class="params">pretrained=<span class="literal">False</span>, **kwargs</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;VGG 13-layer model (configuration &quot;B&quot;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        pretrained (bool): If True, returns a model pre-trained on ImageNet</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> pretrained:</span><br><span class="line">        kwargs[<span class="string">&#x27;init_weights&#x27;</span>] = <span class="literal">False</span></span><br><span class="line">    model = VGG(make_layers(cfg[<span class="string">&#x27;B&#x27;</span>]), **kwargs)</span><br><span class="line">    <span class="keyword">if</span> pretrained:</span><br><span class="line">        model.load_state_dict(model_zoo.load_url(model_urls[<span class="string">&#x27;vgg13&#x27;</span>]))</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">vgg13_bn</span>(<span class="params">pretrained=<span class="literal">False</span>, **kwargs</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;VGG 13-layer model (configuration &quot;B&quot;) with batch normalization</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        pretrained (bool): If True, returns a model pre-trained on ImageNet</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> pretrained:</span><br><span class="line">        kwargs[<span class="string">&#x27;init_weights&#x27;</span>] = <span class="literal">False</span></span><br><span class="line">    model = VGG(make_layers(cfg[<span class="string">&#x27;B&#x27;</span>], batch_norm=<span class="literal">True</span>), **kwargs)</span><br><span class="line">    <span class="keyword">if</span> pretrained:</span><br><span class="line">        model.load_state_dict(model_zoo.load_url(model_urls[<span class="string">&#x27;vgg13_bn&#x27;</span>]))</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">vgg16</span>(<span class="params">pretrained=<span class="literal">False</span>, **kwargs</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;VGG 16-layer model (configuration &quot;D&quot;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        pretrained (bool): If True, returns a model pre-trained on ImageNet</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> pretrained:</span><br><span class="line">        kwargs[<span class="string">&#x27;init_weights&#x27;</span>] = <span class="literal">False</span></span><br><span class="line">    model = VGG(make_layers(cfg[<span class="string">&#x27;D&#x27;</span>]), **kwargs)</span><br><span class="line">    <span class="keyword">if</span> pretrained:</span><br><span class="line">        model.load_state_dict(model_zoo.load_url(model_urls[<span class="string">&#x27;vgg16&#x27;</span>]))</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">vgg16_bn</span>(<span class="params">pretrained=<span class="literal">False</span>, **kwargs</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;VGG 16-layer model (configuration &quot;D&quot;) with batch normalization</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        pretrained (bool): If True, returns a model pre-trained on ImageNet</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> pretrained:</span><br><span class="line">        kwargs[<span class="string">&#x27;init_weights&#x27;</span>] = <span class="literal">False</span></span><br><span class="line">    model = VGG(make_layers(cfg[<span class="string">&#x27;D&#x27;</span>], batch_norm=<span class="literal">True</span>), **kwargs)</span><br><span class="line">    <span class="keyword">if</span> pretrained:</span><br><span class="line">        model.load_state_dict(model_zoo.load_url(model_urls[<span class="string">&#x27;vgg16_bn&#x27;</span>]))</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">vgg19</span>(<span class="params">pretrained=<span class="literal">False</span>, **kwargs</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;VGG 19-layer model (configuration &quot;E&quot;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        pretrained (bool): If True, returns a model pre-trained on ImageNet</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> pretrained:</span><br><span class="line">        kwargs[<span class="string">&#x27;init_weights&#x27;</span>] = <span class="literal">False</span></span><br><span class="line">    model = VGG(make_layers(cfg[<span class="string">&#x27;E&#x27;</span>]), **kwargs)</span><br><span class="line">    <span class="keyword">if</span> pretrained:</span><br><span class="line">        model.load_state_dict(model_zoo.load_url(model_urls[<span class="string">&#x27;vgg19&#x27;</span>]))</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">vgg19_bn</span>(<span class="params">pretrained=<span class="literal">False</span>, **kwargs</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;VGG 19-layer model (configuration &#x27;E&#x27;) with batch normalization</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        pretrained (bool): If True, returns a model pre-trained on ImageNet</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> pretrained:</span><br><span class="line">        kwargs[<span class="string">&#x27;init_weights&#x27;</span>] = <span class="literal">False</span></span><br><span class="line">    model = VGG(make_layers(cfg[<span class="string">&#x27;E&#x27;</span>], batch_norm=<span class="literal">True</span>), **kwargs)</span><br><span class="line">    <span class="keyword">if</span> pretrained:</span><br><span class="line">        model.load_state_dict(model_zoo.load_url(model_urls[<span class="string">&#x27;vgg19_bn&#x27;</span>]))</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line"></span><br><span class="line">    model = vgg16_bn()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ›¿æ¢ç½‘ç»œå±‚</span></span><br><span class="line">    <span class="keyword">for</span> name, module <span class="keyword">in</span> model.named_modules():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;layer name:&#123;&#125;, layer instance:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(name, module))</span><br><span class="line">    in_feat_num = model.classifier[<span class="number">6</span>].in_features</span><br><span class="line">    model.classifier[<span class="number">6</span>] = nn.Linear(in_feat_num, <span class="number">102</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># forward</span></span><br><span class="line">    fake_img = torch.randn((<span class="number">1</span>, <span class="number">3</span>, <span class="number">224</span>, <span class="number">224</span>))  <span class="comment"># batchsize * channel * height * width</span></span><br><span class="line">    output = model(fake_img)</span><br><span class="line">    <span class="built_in">print</span>(output.shape)</span><br></pre></td></tr></table></figure><h3 id="models-x2F-resnet-tv-py"><a href="#models-x2F-resnet-tv-py" class="headerlink" title="models&#x2F;resnet_tv.py"></a>models&#x2F;resnet_tv.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.utils.model_zoo <span class="keyword">as</span> model_zoo</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">__all__ = [<span class="string">&#x27;ResNet&#x27;</span>, <span class="string">&#x27;resnet18&#x27;</span>, <span class="string">&#x27;resnet34&#x27;</span>, <span class="string">&#x27;resnet50&#x27;</span>, <span class="string">&#x27;resnet101&#x27;</span>,</span><br><span class="line">           <span class="string">&#x27;resnet152&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">model_urls = &#123;</span><br><span class="line">    <span class="string">&#x27;resnet18&#x27;</span>: <span class="string">&#x27;https://download.pytorch.org/models/resnet18-5c106cde.pth&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;resnet34&#x27;</span>: <span class="string">&#x27;https://download.pytorch.org/models/resnet34-333f7ec4.pth&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;resnet50&#x27;</span>: <span class="string">&#x27;https://download.pytorch.org/models/resnet50-19c8e357.pth&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;resnet101&#x27;</span>: <span class="string">&#x27;https://download.pytorch.org/models/resnet101-5d3b4d8f.pth&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;resnet152&#x27;</span>: <span class="string">&#x27;https://download.pytorch.org/models/resnet152-b121ed2d.pth&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">conv3x3</span>(<span class="params">in_planes, out_planes, stride=<span class="number">1</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;3x3 convolution with padding&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> nn.Conv2d(in_planes, out_planes, kernel_size=<span class="number">3</span>, stride=stride,</span><br><span class="line">                     padding=<span class="number">1</span>, bias=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">conv1x1</span>(<span class="params">in_planes, out_planes, stride=<span class="number">1</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;1x1 convolution&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> nn.Conv2d(in_planes, out_planes, kernel_size=<span class="number">1</span>, stride=stride, bias=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BasicBlock</span>(nn.Module):</span><br><span class="line">    expansion = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, inplanes, planes, stride=<span class="number">1</span>, downsample=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(BasicBlock, self).__init__()</span><br><span class="line">        self.conv1 = conv3x3(inplanes, planes, stride)</span><br><span class="line">        self.bn1 = nn.BatchNorm2d(planes)</span><br><span class="line">        self.relu = nn.ReLU(inplace=<span class="literal">True</span>)</span><br><span class="line">        self.conv2 = conv3x3(planes, planes)</span><br><span class="line">        self.bn2 = nn.BatchNorm2d(planes)</span><br><span class="line">        self.downsample = downsample</span><br><span class="line">        self.stride = stride</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        identity = x</span><br><span class="line"></span><br><span class="line">        out = self.conv1(x)</span><br><span class="line">        out = self.bn1(out)</span><br><span class="line">        out = self.relu(out)</span><br><span class="line"></span><br><span class="line">        out = self.conv2(out)</span><br><span class="line">        out = self.bn2(out)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.downsample <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            identity = self.downsample(x)</span><br><span class="line"></span><br><span class="line">        out += identity</span><br><span class="line">        out = self.relu(out)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Bottleneck</span>(nn.Module):</span><br><span class="line">    expansion = <span class="number">4</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, inplanes, planes, stride=<span class="number">1</span>, downsample=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(Bottleneck, self).__init__()</span><br><span class="line">        self.conv1 = conv1x1(inplanes, planes)</span><br><span class="line">        self.bn1 = nn.BatchNorm2d(planes)</span><br><span class="line">        self.conv2 = conv3x3(planes, planes, stride)</span><br><span class="line">        self.bn2 = nn.BatchNorm2d(planes)</span><br><span class="line">        self.conv3 = conv1x1(planes, planes * self.expansion)</span><br><span class="line">        self.bn3 = nn.BatchNorm2d(planes * self.expansion)</span><br><span class="line">        self.relu = nn.ReLU(inplace=<span class="literal">True</span>)</span><br><span class="line">        self.downsample = downsample</span><br><span class="line">        self.stride = stride</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        identity = x</span><br><span class="line"></span><br><span class="line">        out = self.conv1(x)</span><br><span class="line">        out = self.bn1(out)</span><br><span class="line">        out = self.relu(out)</span><br><span class="line"></span><br><span class="line">        out = self.conv2(out)</span><br><span class="line">        out = self.bn2(out)</span><br><span class="line">        out = self.relu(out)</span><br><span class="line"></span><br><span class="line">        out = self.conv3(out)</span><br><span class="line">        out = self.bn3(out)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.downsample <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            identity = self.downsample(x)</span><br><span class="line"></span><br><span class="line">        out += identity</span><br><span class="line">        out = self.relu(out)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ResNet</span>(nn.Module):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, block, layers, num_classes=<span class="number">1000</span>, zero_init_residual=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(ResNet, self).__init__()</span><br><span class="line">        self.inplanes = <span class="number">64</span></span><br><span class="line">        self.conv1 = nn.Conv2d(<span class="number">3</span>, <span class="number">64</span>, kernel_size=<span class="number">7</span>, stride=<span class="number">2</span>, padding=<span class="number">3</span>,</span><br><span class="line">                               bias=<span class="literal">False</span>)</span><br><span class="line">        self.bn1 = nn.BatchNorm2d(<span class="number">64</span>)</span><br><span class="line">        self.relu = nn.ReLU(inplace=<span class="literal">True</span>)</span><br><span class="line">        self.maxpool = nn.MaxPool2d(kernel_size=<span class="number">3</span>, stride=<span class="number">2</span>, padding=<span class="number">1</span>)</span><br><span class="line">        self.layer1 = self._make_layer(block, <span class="number">64</span>, layers[<span class="number">0</span>])</span><br><span class="line">        self.layer2 = self._make_layer(block, <span class="number">128</span>, layers[<span class="number">1</span>], stride=<span class="number">2</span>)</span><br><span class="line">        self.layer3 = self._make_layer(block, <span class="number">256</span>, layers[<span class="number">2</span>], stride=<span class="number">2</span>)</span><br><span class="line">        self.layer4 = self._make_layer(block, <span class="number">512</span>, layers[<span class="number">3</span>], stride=<span class="number">2</span>)</span><br><span class="line">        self.avgpool = nn.AdaptiveAvgPool2d((<span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line">        self.fc = nn.Linear(<span class="number">512</span> * block.expansion, num_classes)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> m <span class="keyword">in</span> self.modules():</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(m, nn.Conv2d):</span><br><span class="line">                nn.init.kaiming_normal_(m.weight, mode=<span class="string">&#x27;fan_out&#x27;</span>, nonlinearity=<span class="string">&#x27;relu&#x27;</span>)</span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">isinstance</span>(m, nn.BatchNorm2d):</span><br><span class="line">                nn.init.constant_(m.weight, <span class="number">1</span>)</span><br><span class="line">                nn.init.constant_(m.bias, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Zero-initialize the last BN in each residual branch,</span></span><br><span class="line">        <span class="comment"># so that the residual branch starts with zeros, and each residual block behaves like an identity.</span></span><br><span class="line">        <span class="comment"># This improves the model by 0.2~0.3% according to https://arxiv.org/abs/1706.02677</span></span><br><span class="line">        <span class="keyword">if</span> zero_init_residual:</span><br><span class="line">            <span class="keyword">for</span> m <span class="keyword">in</span> self.modules():</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">isinstance</span>(m, Bottleneck):</span><br><span class="line">                    nn.init.constant_(m.bn3.weight, <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">elif</span> <span class="built_in">isinstance</span>(m, BasicBlock):</span><br><span class="line">                    nn.init.constant_(m.bn2.weight, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_make_layer</span>(<span class="params">self, block, planes, blocks, stride=<span class="number">1</span></span>):</span><br><span class="line">        downsample = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">if</span> stride != <span class="number">1</span> <span class="keyword">or</span> self.inplanes != planes * block.expansion:</span><br><span class="line">            downsample = nn.Sequential(</span><br><span class="line">                conv1x1(self.inplanes, planes * block.expansion, stride),</span><br><span class="line">                nn.BatchNorm2d(planes * block.expansion),</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">        layers = []</span><br><span class="line">        layers.append(block(self.inplanes, planes, stride, downsample))</span><br><span class="line">        self.inplanes = planes * block.expansion</span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, blocks):</span><br><span class="line">            layers.append(block(self.inplanes, planes))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> nn.Sequential(*layers)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        x = self.conv1(x)</span><br><span class="line">        x = self.bn1(x)</span><br><span class="line">        x = self.relu(x)</span><br><span class="line">        x = self.maxpool(x)</span><br><span class="line"></span><br><span class="line">        x = self.layer1(x)</span><br><span class="line">        x = self.layer2(x)</span><br><span class="line">        x = self.layer3(x)</span><br><span class="line">        x = self.layer4(x)</span><br><span class="line"></span><br><span class="line">        x = self.avgpool(x)</span><br><span class="line">        x = x.view(x.size(<span class="number">0</span>), -<span class="number">1</span>)</span><br><span class="line">        x = self.fc(x)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">resnet18</span>(<span class="params">pretrained=<span class="literal">False</span>, **kwargs</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Constructs a ResNet-18 model.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        pretrained (bool): If True, returns a model pre-trained on ImageNet</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    model = ResNet(BasicBlock, [<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>], **kwargs)</span><br><span class="line">    <span class="keyword">if</span> pretrained:</span><br><span class="line">        model.load_state_dict(model_zoo.load_url(model_urls[<span class="string">&#x27;resnet18&#x27;</span>]))</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">resnet34</span>(<span class="params">pretrained=<span class="literal">False</span>, **kwargs</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Constructs a ResNet-34 model.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        pretrained (bool): If True, returns a model pre-trained on ImageNet</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    model = ResNet(BasicBlock, [<span class="number">3</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">3</span>], **kwargs)</span><br><span class="line">    <span class="keyword">if</span> pretrained:</span><br><span class="line">        model.load_state_dict(model_zoo.load_url(model_urls[<span class="string">&#x27;resnet34&#x27;</span>]))</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">resnet50</span>(<span class="params">pretrained=<span class="literal">False</span>, **kwargs</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Constructs a ResNet-50 model.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        pretrained (bool): If True, returns a model pre-trained on ImageNet</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    model = ResNet(Bottleneck, [<span class="number">3</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">3</span>], **kwargs)</span><br><span class="line">    <span class="keyword">if</span> pretrained:</span><br><span class="line">        model.load_state_dict(model_zoo.load_url(model_urls[<span class="string">&#x27;resnet50&#x27;</span>]))</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">resnet101</span>(<span class="params">pretrained=<span class="literal">False</span>, **kwargs</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Constructs a ResNet-101 model.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        pretrained (bool): If True, returns a model pre-trained on ImageNet</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    model = ResNet(Bottleneck, [<span class="number">3</span>, <span class="number">4</span>, <span class="number">23</span>, <span class="number">3</span>], **kwargs)</span><br><span class="line">    <span class="keyword">if</span> pretrained:</span><br><span class="line">        model.load_state_dict(model_zoo.load_url(model_urls[<span class="string">&#x27;resnet101&#x27;</span>]))</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">resnet152</span>(<span class="params">pretrained=<span class="literal">False</span>, **kwargs</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Constructs a ResNet-152 model.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        pretrained (bool): If True, returns a model pre-trained on ImageNet</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    model = ResNet(Bottleneck, [<span class="number">3</span>, <span class="number">8</span>, <span class="number">36</span>, <span class="number">3</span>], **kwargs)</span><br><span class="line">    <span class="keyword">if</span> pretrained:</span><br><span class="line">        model.load_state_dict(model_zoo.load_url(model_urls[<span class="string">&#x27;resnet152&#x27;</span>]))</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">import</span> torch</span><br><span class="line">    model = resnet18(pretrained=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ›¿æ¢ç½‘ç»œå±‚</span></span><br><span class="line">    <span class="keyword">for</span> name, module <span class="keyword">in</span> model.named_modules():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;layer name:&#123;&#125;, layer instance:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(name, module))</span><br><span class="line">    in_feat_num = model.fc.in_features</span><br><span class="line">    model.fc = nn.Linear(in_feat_num, <span class="number">102</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># forward</span></span><br><span class="line">    fake_img = torch.randn((<span class="number">1</span>, <span class="number">3</span>, <span class="number">224</span>, <span class="number">224</span>))  <span class="comment"># batchsize * channel * height * width</span></span><br><span class="line">    output = model(fake_img)</span><br><span class="line">    <span class="built_in">print</span>(output.shape)</span><br></pre></td></tr></table></figure><h3 id="models-x2F-se-resnet-py"><a href="#models-x2F-se-resnet-py" class="headerlink" title="models&#x2F;se_resnet.py"></a>models&#x2F;se_resnet.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">from</span> torch.hub <span class="keyword">import</span> load_state_dict_from_url</span><br><span class="line"><span class="keyword">from</span> torchvision.models <span class="keyword">import</span> ResNet</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SELayer</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, channel, reduction=<span class="number">16</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(SELayer, self).__init__()</span><br><span class="line">        self.avg_pool = nn.AdaptiveAvgPool2d(<span class="number">1</span>)     <span class="comment"># squeeze</span></span><br><span class="line">        self.fc = nn.Sequential(                    <span class="comment"># excitation</span></span><br><span class="line">            nn.Linear(channel, channel // reduction, bias=<span class="literal">False</span>),</span><br><span class="line">            nn.ReLU(inplace=<span class="literal">True</span>),</span><br><span class="line">            nn.Linear(channel // reduction, channel, bias=<span class="literal">False</span>),</span><br><span class="line">            nn.Sigmoid()</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        b, c, _, _ = x.size()</span><br><span class="line">        y = self.avg_pool(x).view(b, c)</span><br><span class="line">        y = self.fc(y).view(b, c, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> x * y.expand_as(x)  <span class="comment"># expand_asæŠŠä¸€ä¸ªtensorå˜æˆå’Œå‡½æ•°æ‹¬å·å†…ä¸€æ ·å½¢çŠ¶çš„tensor</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">conv3x3</span>(<span class="params">in_planes, out_planes, stride=<span class="number">1</span></span>):</span><br><span class="line">    <span class="keyword">return</span> nn.Conv2d(in_planes, out_planes, kernel_size=<span class="number">3</span>, stride=stride, padding=<span class="number">1</span>, bias=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SEBasicBlock</span>(nn.Module):</span><br><span class="line">    expansion = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, inplanes, planes, stride=<span class="number">1</span>, downsample=<span class="literal">None</span>, groups=<span class="number">1</span>,</span></span><br><span class="line"><span class="params">                 base_width=<span class="number">64</span>, dilation=<span class="number">1</span>, norm_layer=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                 *, reduction=<span class="number">16</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(SEBasicBlock, self).__init__()</span><br><span class="line">        self.conv1 = conv3x3(inplanes, planes, stride)</span><br><span class="line">        self.bn1 = nn.BatchNorm2d(planes)</span><br><span class="line">        self.relu = nn.ReLU(inplace=<span class="literal">True</span>)</span><br><span class="line">        self.conv2 = conv3x3(planes, planes, <span class="number">1</span>)</span><br><span class="line">        self.bn2 = nn.BatchNorm2d(planes)</span><br><span class="line">        self.se = SELayer(planes, reduction)</span><br><span class="line">        self.downsample = downsample</span><br><span class="line">        self.stride = stride</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        residual = x</span><br><span class="line">        out = self.conv1(x)</span><br><span class="line">        out = self.bn1(out)</span><br><span class="line">        out = self.relu(out)</span><br><span class="line"></span><br><span class="line">        out = self.conv2(out)</span><br><span class="line">        out = self.bn2(out)</span><br><span class="line">        out = self.se(out)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.downsample <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            residual = self.downsample(x)</span><br><span class="line"></span><br><span class="line">        out += residual</span><br><span class="line">        out = self.relu(out)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SEBottleneck</span>(nn.Module):</span><br><span class="line">    expansion = <span class="number">4</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, inplanes, planes, stride=<span class="number">1</span>, downsample=<span class="literal">None</span>, groups=<span class="number">1</span>,</span></span><br><span class="line"><span class="params">                 base_width=<span class="number">64</span>, dilation=<span class="number">1</span>, norm_layer=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                 *, reduction=<span class="number">16</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(SEBottleneck, self).__init__()</span><br><span class="line">        self.conv1 = nn.Conv2d(inplanes, planes, kernel_size=<span class="number">1</span>, bias=<span class="literal">False</span>)</span><br><span class="line">        self.bn1 = nn.BatchNorm2d(planes)</span><br><span class="line">        self.conv2 = nn.Conv2d(planes, planes, kernel_size=<span class="number">3</span>, stride=stride,</span><br><span class="line">                               padding=<span class="number">1</span>, bias=<span class="literal">False</span>)</span><br><span class="line">        self.bn2 = nn.BatchNorm2d(planes)</span><br><span class="line">        self.conv3 = nn.Conv2d(planes, planes * <span class="number">4</span>, kernel_size=<span class="number">1</span>, bias=<span class="literal">False</span>)</span><br><span class="line">        self.bn3 = nn.BatchNorm2d(planes * <span class="number">4</span>)</span><br><span class="line">        self.relu = nn.ReLU(inplace=<span class="literal">True</span>)</span><br><span class="line">        self.se = SELayer(planes * <span class="number">4</span>, reduction)</span><br><span class="line">        self.downsample = downsample</span><br><span class="line">        self.stride = stride</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        residual = x</span><br><span class="line"></span><br><span class="line">        out = self.conv1(x)</span><br><span class="line">        out = self.bn1(out)</span><br><span class="line">        out = self.relu(out)</span><br><span class="line"></span><br><span class="line">        out = self.conv2(out)</span><br><span class="line">        out = self.bn2(out)</span><br><span class="line">        out = self.relu(out)</span><br><span class="line"></span><br><span class="line">        out = self.conv3(out)</span><br><span class="line">        out = self.bn3(out)</span><br><span class="line">        out = self.se(out)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.downsample <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            residual = self.downsample(x)</span><br><span class="line"></span><br><span class="line">        out += residual</span><br><span class="line">        out = self.relu(out)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">se_resnet18</span>(<span class="params">num_classes=<span class="number">1_000</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Constructs a ResNet-18 model.</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        pretrained (bool): If True, returns a model pre-trained on ImageNet</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    model = ResNet(SEBasicBlock, [<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>], num_classes=num_classes)</span><br><span class="line">    model.avgpool = nn.AdaptiveAvgPool2d(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">se_resnet34</span>(<span class="params">num_classes=<span class="number">1_000</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Constructs a ResNet-34 model.</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        pretrained (bool): If True, returns a model pre-trained on ImageNet</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    model = ResNet(SEBasicBlock, [<span class="number">3</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">3</span>], num_classes=num_classes)</span><br><span class="line">    model.avgpool = nn.AdaptiveAvgPool2d(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">se_resnet50</span>(<span class="params">num_classes=<span class="number">1_000</span>, pretrained=<span class="literal">False</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Constructs a ResNet-50 model.</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        pretrained (bool): If True, returns a model pre-trained on ImageNet</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    model = ResNet(SEBottleneck, [<span class="number">3</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">3</span>], num_classes=num_classes)</span><br><span class="line">    model.avgpool = nn.AdaptiveAvgPool2d(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span> pretrained:</span><br><span class="line">        model.load_state_dict(load_state_dict_from_url(</span><br><span class="line">            <span class="string">&quot;https://github.com/moskomule/senet.pytorch/releases/download/archive/seresnet50-60a8950a85b2b.pkl&quot;</span>))</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">se_resnet101</span>(<span class="params">num_classes=<span class="number">1_000</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Constructs a ResNet-101 model.</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        pretrained (bool): If True, returns a model pre-trained on ImageNet</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    model = ResNet(SEBottleneck, [<span class="number">3</span>, <span class="number">4</span>, <span class="number">23</span>, <span class="number">3</span>], num_classes=num_classes)</span><br><span class="line">    model.avgpool = nn.AdaptiveAvgPool2d(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">se_resnet152</span>(<span class="params">num_classes=<span class="number">1_000</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Constructs a ResNet-152 model.</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        pretrained (bool): If True, returns a model pre-trained on ImageNet</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    model = ResNet(SEBottleneck, [<span class="number">3</span>, <span class="number">8</span>, <span class="number">36</span>, <span class="number">3</span>], num_classes=num_classes)</span><br><span class="line">    model.avgpool = nn.AdaptiveAvgPool2d(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">import</span> torch</span><br><span class="line">    model = se_resnet50()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ›¿æ¢ç½‘ç»œå±‚</span></span><br><span class="line">    <span class="keyword">for</span> name, module <span class="keyword">in</span> model.named_modules():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;layer name:&#123;&#125;, layer instance:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(name, module))</span><br><span class="line">    in_feat_num = model.fc.in_features</span><br><span class="line">    model.fc = nn.Linear(in_feat_num, <span class="number">102</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># forward</span></span><br><span class="line">    fake_img = torch.randn((<span class="number">1</span>, <span class="number">3</span>, <span class="number">224</span>, <span class="number">224</span>))  <span class="comment"># batchsize * channel * height * width</span></span><br><span class="line">    output = model(fake_img)</span><br><span class="line">    <span class="built_in">print</span>(output.shape)</span><br></pre></td></tr></table></figure><h2 id="å›¾ç‰‡å¤„ç†å±•ç¤ºã€ŒResNetã€"><a href="#å›¾ç‰‡å¤„ç†å±•ç¤ºã€ŒResNetã€" class="headerlink" title="å›¾ç‰‡å¤„ç†å±•ç¤ºã€ŒResNetã€"></a>å›¾ç‰‡å¤„ç†å±•ç¤ºã€ŒResNetã€</h2><table><thead><tr><th>æ­¥éª¤</th><th>ç»è¿‡ä½•ç§æ“ä½œ</th><th>æ•°æ®ç±»å‹</th><th>æ•°æ®å½¢çŠ¶ã€Œbatch_size&#x3D;16ã€</th></tr></thead><tbody><tr><td>1</td><td>Image.open</td><td>PIL.image</td><td>(666,500,3)</td></tr><tr><td>2</td><td>Transforms.Compose</td><td>tensor</td><td>(3,224,224)</td></tr><tr><td>3</td><td>Model(inputs):è¾“å…¥æ¨¡å‹</td><td>tensor</td><td>(16,3,224,224)</td></tr><tr><td>4</td><td>Resnet: conv1</td><td>tensor</td><td>(16,64,112,112)</td></tr><tr><td>5</td><td>Resnet: bn1</td><td>tensor</td><td>(16,64,112,112)</td></tr><tr><td>6</td><td>Resnet:relu</td><td>tensor</td><td>(16,64,112,112)</td></tr><tr><td>7</td><td>Resnet:maxpool</td><td>tensor</td><td>(16,64,56,56)</td></tr><tr><td>5</td><td>Resnet: layer1</td><td>tensor</td><td>(16,64,56,56)</td></tr><tr><td>6</td><td>Resnet: layer2</td><td>tensor</td><td>(16,128,28,28)</td></tr><tr><td>7</td><td>Resnet: layer3</td><td>tensor</td><td>(16,256,14,14)</td></tr><tr><td>8</td><td>Resnet: layer4</td><td>tensor</td><td>(16,512,7,7)</td></tr><tr><td>9</td><td>Resnet: avgpool</td><td>tensor</td><td>(16,512,1,1)</td></tr><tr><td>10</td><td>Resnet: flatten</td><td>tensor</td><td>(16,512)</td></tr><tr><td>11</td><td>Resnet: fc</td><td>tensor</td><td>(16,102)</td></tr><tr><td>12</td><td>x</td><td>tensor</td><td>(16,102)</td></tr></tbody></table>]]></content>
      
      
      
        <tags>
            
            <tag> èŠ±æœµåˆ†ç±»é¡¹ç›® </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€ŒèŠ±æœµåˆ†ç±»é¡¹ç›®ã€ï¼ˆäºŒï¼‰åŠŸèƒ½å‡½æ•°</title>
      <link href="/2022/05/19/%E3%80%8C%E8%8A%B1%E6%9C%B5%E5%88%86%E7%B1%BB%E9%A1%B9%E7%9B%AE%E3%80%8D%EF%BC%88%E4%BA%8C%EF%BC%89%E5%8A%9F%E8%83%BD%E5%87%BD%E6%95%B0%E4%BB%8B%E7%BB%8D/"/>
      <url>/2022/05/19/%E3%80%8C%E8%8A%B1%E6%9C%B5%E5%88%86%E7%B1%BB%E9%A1%B9%E7%9B%AE%E3%80%8D%EF%BC%88%E4%BA%8C%EF%BC%89%E5%8A%9F%E8%83%BD%E5%87%BD%E6%95%B0%E4%BB%8B%E7%BB%8D/</url>
      
        <content type="html"><![CDATA[<h2 id="æ¨¡å‹è®­ç»ƒæŒ‡æ ‡"><a href="#æ¨¡å‹è®­ç»ƒæŒ‡æ ‡" class="headerlink" title="æ¨¡å‹è®­ç»ƒæŒ‡æ ‡"></a>æ¨¡å‹è®­ç»ƒæŒ‡æ ‡</h2><table><thead><tr><th>æŒ‡æ ‡</th><th>å†…å®¹</th></tr></thead><tbody><tr><td>æ­£ç¡®ç‡(Accuracy)</td><td>è¡¡é‡æ¨¡å‹åœ¨æ•´ä¸ªæ•°æ®é›†ä¸Šåˆ†ç±»æ­£ç¡®çš„æ¯”ä¾‹</td></tr><tr><td>å¬å›ç‡(Recall)</td><td>è¯¥ç±»æ ·æœ¬ä¸­ï¼Œå¬å›ï¼ˆæ‰¾å›ï¼‰å‡ºäº†å¤šå°‘</td></tr><tr><td>ç²¾ç¡®åº¦(Precision)</td><td>åˆ¤åˆ«ä¸ºè¯¥ç±»çš„æ ·æœ¬ä¸­ï¼Œæ­£ç¡®çš„æœ‰å¤šå°‘</td></tr><tr><td>æ··æ·†çŸ©é˜µ(Confusion Matrix)</td><td>æ··æ·†çŸ©é˜µçš„<strong>è¡Œ</strong>è¡¨ç¤ºçœŸå®ç±»åˆ«ï¼Œ<strong>åˆ—</strong>è¡¨ç¤ºé¢„æµ‹ç±»åˆ«</td></tr></tbody></table><table><thead><tr><th>ã€Œæ··æ·†çŸ©é˜µã€</th><th>çŒ«ã€Œé¢„æµ‹ç±»åˆ«ã€</th><th>ç‹—ã€Œé¢„æµ‹ç±»åˆ«ã€</th></tr></thead><tbody><tr><td><strong>çŒ«ã€ŒçœŸå®ç±»åˆ«ã€</strong></td><td>7</td><td>3</td></tr><tr><td><strong>ç‹—ã€ŒçœŸå®ç±»åˆ«ã€</strong></td><td>10</td><td>20</td></tr></tbody></table><table><thead><tr><th>å¬å›ç‡</th><th>ç²¾ç¡®åº¦</th></tr></thead><tbody><tr><td>çŒ«ã€Œ7&#x2F;(7+3)&#x3D;70%ã€ç‹—ã€Œ20&#x2F;(10+20)&#x3D;66.7%ã€</td><td>çŒ«ã€Œ7&#x2F;(7+10)&#x3D;41.17%ã€ç‹—ã€Œ20&#x2F;(3+20)&#x3D;86.96%ã€</td></tr></tbody></table><span id="more"></span><h2 id="æ¨¡å‹é€‰æ‹©æ–¹æ³•"><a href="#æ¨¡å‹é€‰æ‹©æ–¹æ³•" class="headerlink" title="æ¨¡å‹é€‰æ‹©æ–¹æ³•"></a>æ¨¡å‹é€‰æ‹©æ–¹æ³•</h2><p>æ¨¡å‹é€‰æ‹©æ³›åŒ–æ€§èƒ½å¥½çš„ã€Œ<strong>æ–¹å·®ä½ã€åå·®ä¹Ÿå°</strong>ã€</p><p>è¯¯å·®åˆ†è§£ä¸ºï¼š<strong>åå·®</strong>ï¼Œ<strong>æ–¹å·®</strong>å’Œ<strong>å™ªå£°</strong>ä¹‹å’Œ</p><p><strong>åå·®</strong>åº¦é‡ç®—æ³•çš„<strong>æœŸæœ›é¢„æµ‹</strong>ä¸<strong>çœŸå®ç»“æœ</strong>çš„<strong>åç¦»ç¨‹åº¦</strong>ï¼Œå³åˆ»ç”»äº†ç®—æ³•æœ¬èº«çš„<strong>æ‹Ÿåˆèƒ½åŠ›</strong></p><p><strong>æ–¹å·®</strong>åº¦é‡åŒæ ·å¤§å°çš„<strong>è®­ç»ƒé›†çš„å˜åŠ¨</strong>æ‰€å¯¼è‡´çš„<strong>å­¦ä¹ æ€§èƒ½çš„å˜åŒ–</strong>ï¼Œå³åˆ»ç”»äº†<strong>æ•°æ®æ‰°åŠ¨æ‰€é€ æˆçš„å½±å“</strong></p><p><strong>å™ªå£°</strong>åˆ™è¡¨è¾¾äº†åœ¨å½“å‰ä»»åŠ¡ä¸Šä»»ä½•å­¦ä¹ ç®—æ³•æ‰€èƒ½è¾¾åˆ°çš„<strong>æœŸæœ›æ³›åŒ–è¯¯å·®çš„ä¸‹ç•Œ</strong></p><h2 id="ä»£ç ä¼˜åŒ–"><a href="#ä»£ç ä¼˜åŒ–" class="headerlink" title="ä»£ç ä¼˜åŒ–"></a>ä»£ç ä¼˜åŒ–</h2><h3 id="tools-x2F-common-tool-py"><a href="#tools-x2F-common-tool-py" class="headerlink" title="tools&#x2F;common_tool.py"></a>tools&#x2F;common_tool.py</h3><p>éšæœºç§å­ï¼šsetup_seed()</p><p>loggingï¼šé‡‡ç”¨loggingæ¨¡å—è¿›è¡Œæ—¥å¿—ä¿¡æ¯è®°å½•</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"># @file name    :common_tools.py</span></span><br><span class="line"><span class="string"># @author       :zz0320</span></span><br><span class="line"><span class="string"># @data         :2022-4-2</span></span><br><span class="line"><span class="string"># @brief        :å¸¸ç”¨æ–‡ä»¶ åŒ…å«éšæœºç§å­å›ºå®š/æ£€æŸ¥æ•°æ®ç›®å½•/Loggerç±»/ç»˜åˆ¶æ··æ·†çŸ©é˜µ/ç»˜åˆ¶losså’Œaccæ›²çº¿</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> torchvision.transforms <span class="keyword">as</span> transforms</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> Counter</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> psutil</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> models.vgg_tv <span class="keyword">import</span> vgg16_bn</span><br><span class="line"><span class="keyword">from</span> models.se_resnet <span class="keyword">import</span> se_resnet50</span><br><span class="line"><span class="keyword">from</span> torchvision.models <span class="keyword">import</span> resnet18</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">setup_seed</span>(<span class="params">seed = <span class="number">12345</span></span>):</span><br><span class="line">    np.random.seed(seed)</span><br><span class="line">    random.seed(seed)</span><br><span class="line">    torch.manual_seed(seed) <span class="comment"># cpu</span></span><br><span class="line">    <span class="keyword">if</span> torch.cuda.is_available():</span><br><span class="line">        torch.cuda.manual_seed_all(seed) <span class="comment"># cudaä¹Ÿæœ‰ä¸€ä¸ªrandom</span></span><br><span class="line">        torch.backends.cudnn.determinstic = <span class="literal">True</span></span><br><span class="line">        torch.backends.cudnn.benchmark = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_data_dir</span>(<span class="params">path_tmp</span>):</span><br><span class="line">    <span class="keyword">assert</span> os.path.exists(path_tmp), \</span><br><span class="line">        <span class="string">&quot;\n\nè·¯å¾„ä¸å­˜åœ¨ï¼Œå½“å‰å˜é‡ä¸­æŒ‡å®šçš„è·¯å¾„æ˜¯ï¼š\n&#123;&#125;\nè¯·æ£€æŸ¥ç›¸å¯¹è·¯å¾„çš„è®¾ç½®ï¼Œæˆ–è€…æ–‡ä»¶æ˜¯å¦å­˜åœ¨&quot;</span>.<span class="built_in">format</span>(os.path.abspath)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Logger</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, path_log</span>):</span><br><span class="line">        log_name = os.path.basename(path_log)</span><br><span class="line">        self.log_name = log_name <span class="keyword">if</span> log_name <span class="keyword">else</span> <span class="string">&quot;root&quot;</span></span><br><span class="line">        self.out_path = path_log</span><br><span class="line"></span><br><span class="line">        log_dir = os.path.dirname(self.out_path)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(log_dir):</span><br><span class="line">            os.makedirs(log_dir)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">init_logger</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># åˆå§‹åŒ–</span></span><br><span class="line">        logger = logging.getLogger(self.log_name)</span><br><span class="line">        logger.setLevel(level=logging.INFO)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># é…ç½®æ–‡ä»¶Header è¾“å‡ºåˆ°ç¡¬ç›˜å½“ä¸­</span></span><br><span class="line">        file_handler = logging.FileHandler(self.out_path, <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">        file_handler.setLevel(logging.INFO)</span><br><span class="line">        formatter = logging.Formatter(<span class="string">&#x27;%(asctime)s - %(name)s - %(levelname)s - %(message)s&#x27;</span>)</span><br><span class="line">        file_handler.setFormatter(formatter)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># é…ç½®æ–‡ä»¶Header è¾“å‡ºåˆ°å±å¹•æµä¸Š</span></span><br><span class="line">        console_handler = logging.StreamHandler()</span><br><span class="line">        console_handler.setLevel(logging.INFO)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ·»åŠ handler</span></span><br><span class="line">        logger.addHandler(file_handler)</span><br><span class="line">        logger.addHandler(console_handler)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> logger</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_logger</span>(<span class="params">out_dir</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    åœ¨out_diræ–‡ä»¶å¤¹ä¸‹ä»¥å½“å‰æ—¶é—´å‘½åï¼Œåˆ›å»ºæ—¥å¿—æ–‡ä»¶å¤¹ï¼Œå¹¶åˆ›å»ºloggerç”¨äºè®°å½•ä¿¡æ¯</span></span><br><span class="line"><span class="string">    :param out_dir:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># åˆ›å»ºlogæ–‡ä»¶å¤¹</span></span><br><span class="line">    now_time = datetime.now()</span><br><span class="line">    time_str = datetime.strftime(now_time, <span class="string">&#x27;%m-%d_%H-%M&#x27;</span>)</span><br><span class="line">    log_dir = os.path.join(out_dir, <span class="string">&quot;..&quot;</span>, <span class="string">&quot;..&quot;</span>, <span class="string">&quot;results&quot;</span>, time_str) <span class="comment"># ä¸ºäº†ç›¸å¯¹è·¯å¾„ä¸€å®šæ‰¾çš„å‡†ç¡®</span></span><br><span class="line">        <span class="comment"># æ ¹æ®configä¸­çš„åˆ›å»ºæ—¶é—´ä½œä¸ºæ–‡ä»¶å¤¹åå­—</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(log_dir):</span><br><span class="line">        os.makedirs((log_dir))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆ›å»ºlogger</span></span><br><span class="line">    path_log = os.path.join(log_dir, <span class="string">&quot;log.log&quot;</span>)</span><br><span class="line">    logger = Logger(path_log)</span><br><span class="line">    logger = logger.init_logger()</span><br><span class="line">    <span class="keyword">return</span> logger,log_dir</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_model</span>(<span class="params">cfg, cls_num, logger</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    åˆ›å»ºæ¨¡å‹</span></span><br><span class="line"><span class="string">    :param cfg:</span></span><br><span class="line"><span class="string">    :param cls_num:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> cfg.model_name == <span class="string">&quot;resnet18&quot;</span>:</span><br><span class="line">        model = resnet18()</span><br><span class="line">        <span class="keyword">if</span> os.path.exists(cfg.path_resnet18):</span><br><span class="line">            pretrained_state_dict = torch.load(cfg.path_resnet18, map_location=<span class="string">&quot;cpu&quot;</span>)</span><br><span class="line">            model.load_state_dict(pretrained_state_dict)    <span class="comment"># load pretrain model</span></span><br><span class="line">            logger.info(<span class="string">&quot;load pretrained model!&quot;</span>)</span><br><span class="line">        <span class="comment"># ä¿®æ”¹æœ€åä¸€å±‚</span></span><br><span class="line">        num_ftrs = model.fc.in_features</span><br><span class="line">        model.fc = nn.Linear(num_ftrs, cls_num)  <span class="comment"># 102</span></span><br><span class="line">    <span class="keyword">elif</span> cfg.model_name == <span class="string">&quot;vgg16_bn&quot;</span>:</span><br><span class="line">        model = vgg16_bn()</span><br><span class="line">        <span class="keyword">if</span> os.path.exists(cfg.path_vgg16bn):</span><br><span class="line">            pretrained_state_dict = torch.load(cfg.path_vgg16bn, map_location=<span class="string">&quot;cpu&quot;</span>)</span><br><span class="line">            model.load_state_dict(pretrained_state_dict)    <span class="comment"># load pretrain model</span></span><br><span class="line">            logger.info(<span class="string">&quot;load pretrained model!&quot;</span>)</span><br><span class="line">        <span class="comment"># æ›¿æ¢ç½‘ç»œå±‚</span></span><br><span class="line">        in_feat_num = model.classifier[<span class="number">6</span>].in_features</span><br><span class="line">        model.classifier[<span class="number">6</span>] = nn.Linear(in_feat_num, cls_num)</span><br><span class="line">    <span class="keyword">elif</span> cfg.model_name == <span class="string">&quot;se_resnet50&quot;</span>:</span><br><span class="line">        model = se_resnet50()</span><br><span class="line">        <span class="keyword">if</span> os.path.exists(cfg.path_se_res50):</span><br><span class="line">            model.load_state_dict(torch.load(cfg.path_se_res50))    <span class="comment"># load pretrain model</span></span><br><span class="line">            logger.info(<span class="string">&quot;load pretrained model!&quot;</span>)</span><br><span class="line">        in_feat_num = model.fc.in_features</span><br><span class="line">        model.fc = nn.Linear(in_feat_num, cls_num)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&quot;Invalid model name. got &#123;&#125;&quot;</span>.<span class="built_in">format</span>(cfg.model_name))</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_confMat</span>(<span class="params">confusion_mat, classes, set_name, out_dir, epoch=<span class="number">999</span>, verbose=<span class="literal">False</span>, figsize=<span class="literal">None</span>, perc=<span class="literal">False</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    æ··æ·†çŸ©é˜µç»˜åˆ¶å¹¶ä¿å­˜å›¾ç‰‡</span></span><br><span class="line"><span class="string">    :param confusion_mat: np.array</span></span><br><span class="line"><span class="string">    :param classes: list or tuple, ç±»åˆ«åç§°</span></span><br><span class="line"><span class="string">    :param set_name: str æ•°æ®é›†åç§° train or valid or test</span></span><br><span class="line"><span class="string">    :param out_dir: str å›¾ç‰‡è¦ä¿å­˜çš„æ–‡ä»¶å¤¹</span></span><br><span class="line"><span class="string">    :param epoch: int ç¬¬å‡ ä¸ªepoch</span></span><br><span class="line"><span class="string">    :param verbose: bool æ˜¯å¦æ‰“å°ç²¾åº¦ä¿¡æ¯</span></span><br><span class="line"><span class="string">    :param figsize:</span></span><br><span class="line"><span class="string">    :param perc:æ˜¯å¦é‡‡ç”¨ç™¾åˆ†æ¯”ï¼Œå›¾åƒåˆ†å‰²æ—¶ä½¿ç”¨ å› åˆ†ç±»æ•°ç›®è¿‡å¤§</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    cls_num = <span class="built_in">len</span>(classes)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å½’ä¸€åŒ–</span></span><br><span class="line">    confusion_mat_tmp = confusion_mat.copy()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(classes)):</span><br><span class="line">        confusion_mat_tmp[i, :] = confusion_mat[i, :] / confusion_mat[i, :].<span class="built_in">sum</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¾ç½®å›¾åƒå¤§å°</span></span><br><span class="line">    <span class="keyword">if</span> cls_num &lt; <span class="number">10</span>:</span><br><span class="line">        figsize = <span class="number">6</span></span><br><span class="line">    <span class="keyword">elif</span> cls_num &gt;= <span class="number">100</span>:</span><br><span class="line">        figsize = <span class="number">30</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        figsize = np.linspace(<span class="number">6</span>, <span class="number">30</span>, <span class="number">91</span>)[cls_num-<span class="number">10</span>]</span><br><span class="line">    plt.figure(figsize=(<span class="built_in">int</span>(figsize), <span class="built_in">int</span>(figsize*<span class="number">1.3</span>)))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è·å–é¢œè‰²</span></span><br><span class="line">    cmap = plt.cm.get_cmap(<span class="string">&#x27;Greys&#x27;</span>) <span class="comment"># æ›´å¤šé¢œè‰²: http://matplotlib.org/examples/color/colormaps_reference.html</span></span><br><span class="line">    plt.imshow(confusion_mat_tmp, cmap=cmap)</span><br><span class="line">    plt.colorbar(fraction=<span class="number">0.03</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¾ç½®æ–‡å­—</span></span><br><span class="line">    xlocations = np.array(<span class="built_in">range</span>(<span class="built_in">len</span>(classes)))</span><br><span class="line">    plt.xticks(xlocations, <span class="built_in">list</span>(classes), rotation=<span class="number">60</span>)</span><br><span class="line">    plt.yticks(xlocations, <span class="built_in">list</span>(classes))</span><br><span class="line">    plt.xlabel(<span class="string">&#x27;Predict label&#x27;</span>)</span><br><span class="line">    plt.ylabel(<span class="string">&#x27;True label&#x27;</span>)</span><br><span class="line">    plt.title(<span class="string">&quot;Confusion_Matrix_&#123;&#125;_&#123;&#125;&quot;</span>.<span class="built_in">format</span>(set_name, epoch))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ‰“å°æ•°å­—</span></span><br><span class="line">    <span class="keyword">if</span> perc:</span><br><span class="line">        cls_per_nums = confusion_mat.<span class="built_in">sum</span>(axis=<span class="number">0</span>)</span><br><span class="line">        conf_mat_per = confusion_mat / cls_per_nums</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(confusion_mat_tmp.shape[<span class="number">0</span>]):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(confusion_mat_tmp.shape[<span class="number">1</span>]):</span><br><span class="line">                plt.text(x=j, y=i, s=<span class="string">&quot;&#123;:.0%&#125;&quot;</span>.<span class="built_in">format</span>(conf_mat_per[i, j]), va=<span class="string">&#x27;center&#x27;</span>, ha=<span class="string">&#x27;center&#x27;</span>, color=<span class="string">&#x27;red&#x27;</span>,</span><br><span class="line">                         fontsize=<span class="number">10</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(confusion_mat_tmp.shape[<span class="number">0</span>]):</span><br><span class="line">                <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(confusion_mat_tmp.shape[<span class="number">1</span>]):</span><br><span class="line">                    plt.text(x=j, y=i, s=<span class="built_in">int</span>(confusion_mat[i, j]), va=<span class="string">&#x27;center&#x27;</span>, ha=<span class="string">&#x27;center&#x27;</span>, color=<span class="string">&#x27;red&#x27;</span>, fontsize=<span class="number">10</span>)</span><br><span class="line">    <span class="comment"># ä¿å­˜</span></span><br><span class="line">    plt.savefig(os.path.join(out_dir, <span class="string">&quot;Confusion_Matrix_&#123;&#125;.png&quot;</span>).<span class="built_in">format</span>(set_name))</span><br><span class="line">    plt.close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> verbose:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(cls_num):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;class:&#123;:&lt;10&#125;, total num:&#123;:&lt;6&#125;, correct num:&#123;:&lt;5&#125;  Recall: &#123;:.2%&#125; Precision: &#123;:.2%&#125;&#x27;</span>.<span class="built_in">format</span>(</span><br><span class="line">                classes[i], np.<span class="built_in">sum</span>(confusion_mat[i, :]), confusion_mat[i, i],</span><br><span class="line">                confusion_mat[i, i] / (<span class="number">1e-9</span> + np.<span class="built_in">sum</span>(confusion_mat[i, :])),</span><br><span class="line">                confusion_mat[i, i] / (<span class="number">1e-9</span> + np.<span class="built_in">sum</span>(confusion_mat[:, i]))))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">plot_line</span>(<span class="params">train_x, train_y, valid_x, valid_y, mode, out_dir</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    ç»˜åˆ¶è®­ç»ƒå’ŒéªŒè¯é›†çš„lossæ›²çº¿å’Œaccæ›²çº¿</span></span><br><span class="line"><span class="string">    :param train_x: epoch</span></span><br><span class="line"><span class="string">    :param train_y: æ ‡é‡å€¼</span></span><br><span class="line"><span class="string">    :param valid_x:</span></span><br><span class="line"><span class="string">    :param valid_y:</span></span><br><span class="line"><span class="string">    :param mode: &#x27;loss&#x27; or &#x27;acc&#x27;</span></span><br><span class="line"><span class="string">    :param out_dir:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    plt.plot(train_x, train_y, label=<span class="string">&#x27;Train&#x27;</span>)</span><br><span class="line">    plt.plot(valid_x, valid_y, label=<span class="string">&#x27;Valid&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    plt.ylabel(<span class="built_in">str</span>(mode))</span><br><span class="line">    plt.xlabel(<span class="string">&#x27;Epoch&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    location = <span class="string">&#x27;upper right&#x27;</span> <span class="keyword">if</span> mode == <span class="string">&#x27;loss&#x27;</span> <span class="keyword">else</span> <span class="string">&#x27;upper left&#x27;</span></span><br><span class="line">    plt.legend(loc=location)</span><br><span class="line"></span><br><span class="line">    plt.title(<span class="string">&#x27;_&#x27;</span>.join([mode]))</span><br><span class="line">    plt.savefig(os.path.join(out_dir, mode + <span class="string">&#x27;.png&#x27;</span>))</span><br><span class="line">    plt.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># setup_seed(2)</span></span><br><span class="line">    <span class="comment"># print(np.random.randint(0, 10, 1))</span></span><br><span class="line">    logger = Logger(<span class="string">&#x27;./logtest.log&#x27;</span>)</span><br><span class="line">    logger = logger.init_logger()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        logger.info(<span class="string">&#x27;test:&#x27;</span> + <span class="built_in">str</span>(i))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">from</span> config.flower_config <span class="keyword">import</span> cfg</span><br><span class="line">    logger.info(cfg)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="config-x2F-flower-config-py"><a href="#config-x2F-flower-config-py" class="headerlink" title="config&#x2F;flower_config.py"></a>config&#x2F;flower_config.py</h3><p>æå–è¦é…ç½®çš„å‚æ•°ï¼Œç»Ÿä¸€æ”¾ç½®ï¼šconfig&#x2F;flower_config.pyä¸­çš„å­—å…¸</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"># @file name    :flower_config.py</span></span><br><span class="line"><span class="string"># @author       :zz0320</span></span><br><span class="line"><span class="string"># @data         :2022-4-5</span></span><br><span class="line"><span class="string"># @brief        :èŠ±æœµåˆ†ç±»ç½‘ç»œå‚æ•°é…ç½®</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> datasets.flower102 <span class="keyword">import</span> FlowerDataset</span><br><span class="line"><span class="keyword">import</span> torchvision.transforms <span class="keyword">as</span> transforms</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> easydict <span class="keyword">import</span> EasyDict</span><br><span class="line">BASE_DIR = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">sys.path.append(os.path.join(BASE_DIR, <span class="string">&#x27;..&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cfg = EasyDict() <span class="comment"># è®¿é—®å±æ€§çš„æ–¹å¼å»ä½¿ç”¨key-value å³é€šè¿‡key æˆ–è€… value</span></span><br><span class="line"></span><br><span class="line">cfg.model_name = <span class="string">&quot;resnet18&quot;</span></span><br><span class="line"><span class="comment"># cfg.model_name = &quot;vgg16_bn&quot;</span></span><br><span class="line"><span class="comment"># cfg.model_name = &quot;se_resnet50&quot;</span></span><br><span class="line"></span><br><span class="line">cfg.mixup = <span class="literal">True</span>  <span class="comment"># æ˜¯å¦é‡‡ç”¨mixup</span></span><br><span class="line">cfg.mixup_alpha = <span class="number">1.</span>  <span class="comment"># betaåˆ†å¸ƒçš„å‚æ•°. betaåˆ†å¸ƒæ˜¯ä¸€ç»„å®šä¹‰åœ¨(0,1) åŒºé—´çš„è¿ç»­æ¦‚ç‡åˆ†å¸ƒã€‚</span></span><br><span class="line">cfg.label_smooth = <span class="literal">True</span>  <span class="comment"># æ˜¯å¦é‡‡ç”¨æ ‡ç­¾å¹³æ»‘</span></span><br><span class="line">cfg.label_smooth_eps = <span class="number">0.01</span>  <span class="comment"># æ ‡ç­¾å¹³æ»‘è¶…å‚æ•° eps</span></span><br><span class="line"></span><br><span class="line">data_dir = <span class="string">&quot;/Users/kenton/Downloads/deeplearning_dataset&quot;</span></span><br><span class="line">cfg.path_resnet18 = os.path.join(data_dir, <span class="string">&quot;pretrained_model&quot;</span>, <span class="string">&quot;resnet18-f37072fd.pth&quot;</span>)</span><br><span class="line">cfg.path_vgg16bn = os.path.join(data_dir, <span class="string">&quot;pretrained_model&quot;</span>, <span class="string">&quot;vgg16_bn-6c64b313.pth&quot;</span>)</span><br><span class="line">cfg.path_se_res50 = os.path.join(data_dir, <span class="string">&quot;pretrained_model&quot;</span>, <span class="string">&quot;seresnet50-60a8950a85b2b.pkl&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®­ç»ƒå‚æ•°</span></span><br><span class="line">cfg.train_bs = <span class="number">16</span> <span class="comment"># batchsize</span></span><br><span class="line">cfg.valid_bs = <span class="number">16</span></span><br><span class="line">cfg.workers = <span class="number">0</span> <span class="comment">#çº¿ç¨‹ä¸ªæ•°</span></span><br><span class="line"></span><br><span class="line">cfg.lr_init = <span class="number">0.01</span></span><br><span class="line">cfg.momentum = <span class="number">0.9</span></span><br><span class="line">cfg.weight_decay = <span class="number">1e-4</span> <span class="comment"># æƒé‡è¡°å‡</span></span><br><span class="line"></span><br><span class="line">cfg.factor = <span class="number">0.1</span> <span class="comment"># æƒé‡æ›´æ–°çš„æ¯”ä¾‹</span></span><br><span class="line">cfg.milestones = [<span class="number">30</span>, <span class="number">45</span>] <span class="comment"># ä»€ä¹ˆæ—¶å€™ä¸‹é™å­¦ä¹ ç‡</span></span><br><span class="line">cfg.max_epoch = <span class="number">50</span></span><br><span class="line"></span><br><span class="line">cfg.log_interval = <span class="number">10</span> <span class="comment"># æ—¥å¿—æ‰“å°é—´éš”</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. æ•°æ®é›†</span></span><br><span class="line">norm_mean = [<span class="number">0.485</span>, <span class="number">0.456</span>, <span class="number">0.406</span>]</span><br><span class="line">norm_std = [<span class="number">0.229</span>, <span class="number">0.224</span>, <span class="number">0.225</span>] <span class="comment"># imageNetç»Ÿè®¡å¾—åˆ°çš„</span></span><br><span class="line">normTransform = transforms.Normalize(norm_mean, norm_std)</span><br><span class="line"></span><br><span class="line">cfg.transforms_train = transforms.Compose([</span><br><span class="line">    transforms.Resize((<span class="number">256</span>)),</span><br><span class="line">    transforms.CenterCrop(<span class="number">256</span>),</span><br><span class="line">    transforms.RandomCrop(<span class="number">224</span>),</span><br><span class="line">    transforms.RandomHorizontalFlip(p=<span class="number">0.5</span>),</span><br><span class="line">    transforms.ToTensor(),</span><br><span class="line">    normTransform,</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">cfg.transforms_valid = transforms.Compose([</span><br><span class="line">    transforms.Resize((<span class="number">224</span>, <span class="number">224</span>)),</span><br><span class="line">    transforms.ToTensor(),</span><br><span class="line">    normTransform,</span><br><span class="line">])</span><br></pre></td></tr></table></figure><h3 id="bin-x2F-evaluate-flower-py"><a href="#bin-x2F-evaluate-flower-py" class="headerlink" title="bin&#x2F;evaluate_flower.py"></a>bin&#x2F;evaluate_flower.py</h3><p>æ¨¡å‹è¯„ä¼°ï¼Œåœ¨testæ•°æ®é›†ä¸Šè·‘æ¨¡å‹å¾—åˆ°æœ€åçš„æŒ‡æ ‡</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"># @file name    :evaluate_flower.py</span></span><br><span class="line"><span class="string"># @author       :zz0320</span></span><br><span class="line"><span class="string"># @data         :2022-4-5</span></span><br><span class="line"><span class="string"># @brief        :æ¨¡å‹åœ¨testä¸Šè¿›è¡ŒæŒ‡æ ‡è®¡ç®— è¾“å‡ºç»“æœä¸ºtest acc ã€Œ0%ï½100%ã€</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">from</span> datasets.flower102 <span class="keyword">import</span> FlowerDataset</span><br><span class="line"><span class="keyword">import</span> torchvision.transforms <span class="keyword">as</span> transforms</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> DataLoader</span><br><span class="line"><span class="keyword">from</span> torchvision.models <span class="keyword">import</span> resnet18</span><br><span class="line"></span><br><span class="line">device = torch.device(<span class="string">&quot;cuda&quot;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&quot;cpu&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># 0. config</span></span><br><span class="line">    data_dir = <span class="string">&quot;/Users/kenton/Downloads/deeplearning_dataset/flower102/test&quot;</span></span><br><span class="line">    path_state_dir = <span class="string">&quot;/Users/kenton/PycharmProjects/results/04-05_23-40/checkpoint_best.pkl&quot;</span></span><br><span class="line"></span><br><span class="line">    norm_mean = [<span class="number">0.485</span>, <span class="number">0.456</span>, <span class="number">0.406</span>]  <span class="comment"># imagenet 120ä¸‡å›¾åƒç»Ÿè®¡å¾—æ¥</span></span><br><span class="line">    norm_std = [<span class="number">0.229</span>, <span class="number">0.224</span>, <span class="number">0.225</span>]</span><br><span class="line">    normTransform = transforms.Normalize(norm_mean, norm_std)</span><br><span class="line">    transforms_valid = transforms.Compose([</span><br><span class="line">        transforms.Resize((<span class="number">224</span>, <span class="number">224</span>)),</span><br><span class="line">        transforms.ToTensor(),</span><br><span class="line">        normTransform,</span><br><span class="line">    ])</span><br><span class="line">    valid_bs = <span class="number">64</span></span><br><span class="line">    workers = <span class="number">4</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># step1: dataset</span></span><br><span class="line">    test_data = FlowerDataset(root_dir=data_dir, transform=transforms_valid)</span><br><span class="line">    test_loader = DataLoader(dataset=test_data, batch_size=valid_bs, num_workers=workers)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># step2: model</span></span><br><span class="line">    model = resnet18()</span><br><span class="line">    num_ftrs = model.fc.in_features</span><br><span class="line">    model.fc = nn.Linear(num_ftrs, test_data.cls_num)  <span class="comment"># 102</span></span><br><span class="line">    <span class="comment"># load pretrain model</span></span><br><span class="line">    ckpt = torch.load(path_state_dir)</span><br><span class="line">    model.load_state_dict(ckpt[<span class="string">&quot;model_state_dict&quot;</span>])</span><br><span class="line">    model.to(device)</span><br><span class="line">    model.<span class="built_in">eval</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># step 3:inference</span></span><br><span class="line">    class_num = test_loader.dataset.cls_num</span><br><span class="line">    conf_mat = np.zeros((class_num, class_num))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, data <span class="keyword">in</span> <span class="built_in">enumerate</span>(test_loader):</span><br><span class="line">        inputs, labels, path_imgs = data</span><br><span class="line">        <span class="comment"># inputs, labels = data</span></span><br><span class="line">        inputs, labels = inputs.to(device), labels.to(device)</span><br><span class="line">        outputs = model(inputs)</span><br><span class="line"></span><br><span class="line">        _, predicted = torch.<span class="built_in">max</span>(outputs.data, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(labels)):</span><br><span class="line">            cate_i = labels[j].cpu().numpy()</span><br><span class="line">            pre_i = predicted[j].cpu().numpy()</span><br><span class="line">            conf_mat[cate_i, pre_i] += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    acc_avg = conf_mat.trace() / conf_mat.<span class="built_in">sum</span>()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;test acc: &#123;:.2%&#125;&quot;</span>.<span class="built_in">format</span>(acc_avg))</span><br></pre></td></tr></table></figure><h2 id="è®­ç»ƒç»“æœ"><a href="#è®­ç»ƒç»“æœ" class="headerlink" title="è®­ç»ƒç»“æœ"></a>è®­ç»ƒç»“æœ</h2><table><thead><tr><th>çŠ¶æ€</th><th>æŒ‡æ ‡</th></tr></thead><tbody><tr><td>æ¨¡å‹ä½¿ç”¨ç½‘ç»œ</td><td>Res-18</td></tr><tr><td>æ€»Epoch</td><td>50</td></tr><tr><td>è®­ç»ƒé›†acc</td><td>100%</td></tr><tr><td>éªŒè¯é›†best acc</td><td>0.9731379731379731 in 30</td></tr><tr><td>æµ‹è¯•é›†acc</td><td>97.19%</td></tr><tr><td>Train loss</td><td>0.0018</td></tr><tr><td>Valid loss</td><td>0.1196</td></tr></tbody></table><table><thead><tr><th>Accæ›²çº¿å›¾</th><th>Lossæ›²çº¿å›¾</th></tr></thead><tbody><tr><td><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2h2xxs6hbj21400u0abg.jpg"></td><td><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2h2xyeqq7j21400u0abg.jpg"></td></tr></tbody></table><h2 id="Badcaseåˆ†æ"><a href="#Badcaseåˆ†æ" class="headerlink" title="Badcaseåˆ†æ"></a>Badcaseåˆ†æ</h2><p>é™äºç¯‡å¹…ç§»åˆ°äº†é‡‘å±±æ–‡æ¡£ä¸Šã€Œ<a href="https://kdocs.cn/l/cpYKYpFmjKy1">ç‚¹å‡»é“¾æ¥</a>ã€ğŸ”—</p>]]></content>
      
      
      
        <tags>
            
            <tag> èŠ±æœµåˆ†ç±»é¡¹ç›® </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€ŒèŠ±æœµåˆ†ç±»é¡¹ç›®ã€ï¼ˆä¸€ï¼‰ä»£ç æ¡†æ¶ä¸Flower102æ•°æ®é›†ä»‹ç»</title>
      <link href="/2022/05/19/%E3%80%8C%E8%8A%B1%E6%9C%B5%E5%88%86%E7%B1%BB%E9%A1%B9%E7%9B%AE%E3%80%8D%EF%BC%88%E4%B8%80%EF%BC%89%E4%BB%A3%E7%A0%81%E6%A1%86%E6%9E%B6%E4%B8%8EFlower102%E6%95%B0%E6%8D%AE%E9%9B%86%E4%BB%8B%E7%BB%8D/"/>
      <url>/2022/05/19/%E3%80%8C%E8%8A%B1%E6%9C%B5%E5%88%86%E7%B1%BB%E9%A1%B9%E7%9B%AE%E3%80%8D%EF%BC%88%E4%B8%80%EF%BC%89%E4%BB%A3%E7%A0%81%E6%A1%86%E6%9E%B6%E4%B8%8EFlower102%E6%95%B0%E6%8D%AE%E9%9B%86%E4%BB%8B%E7%BB%8D/</url>
      
        <content type="html"><![CDATA[<h2 id="ä»£ç æ¡†æ¶"><a href="#ä»£ç æ¡†æ¶" class="headerlink" title="ä»£ç æ¡†æ¶"></a>ä»£ç æ¡†æ¶</h2><h3 id="æ¨¡å‹è®­ç»ƒä»£ç æ¡†æ¶"><a href="#æ¨¡å‹è®­ç»ƒä»£ç æ¡†æ¶" class="headerlink" title="æ¨¡å‹è®­ç»ƒä»£ç æ¡†æ¶"></a>æ¨¡å‹è®­ç»ƒä»£ç æ¡†æ¶</h3><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2ev6kbvcqj20jw0lb3zz.jpg" style="zoom: 50%;" /><h3 id="å‚æ•°é…ç½®"><a href="#å‚æ•°é…ç½®" class="headerlink" title="å‚æ•°é…ç½®"></a>å‚æ•°é…ç½®</h3><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2evasitcfj20vg0u0go9.jpg" style="zoom: 33%;" /><h3 id="ä»£ç ç»“æ„"><a href="#ä»£ç ç»“æ„" class="headerlink" title="ä»£ç ç»“æ„"></a>ä»£ç ç»“æ„</h3><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2evkpc7e0j219f0mf771.jpg" style="zoom: 33%;" /><h2 id="Flower102æ•°æ®é›†ä»‹ç»"><a href="#Flower102æ•°æ®é›†ä»‹ç»" class="headerlink" title="Flower102æ•°æ®é›†ä»‹ç»"></a>Flower102æ•°æ®é›†ä»‹ç»</h2><p>å…±æœ‰102ç±»èŠ±æœµï¼Œæ¯ä¸ªç±»åˆ«æ•°é‡40åˆ°258ä¸ç­‰ ã€Œ<a href="https://www.robots.ox.ac.uk/~vgg/data/flowers/102/"><strong>ä¸‹è½½åœ°å€</strong></a>ã€</p><p>ä¸‹è½½ã€Œ<strong>Datasetå›¾ç‰‡</strong>ã€å’Œã€Œ<strong>å›¾åƒæ ‡ç­¾æ–‡ä»¶</strong>ã€</p><span id="more"></span><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2evvnzeogj20v00i0acs.jpg"></p><p>ç±»åˆ«ç»Ÿè®¡å±•ç¤ºç•Œé¢ã€Œ<a href="https://www.robots.ox.ac.uk/~vgg/data/flowers/102/categories.html"><strong>é“¾æ¥</strong></a>ã€</p><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2evsrbro2j20u00x378z.jpg"></p><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2evssoatgj20u00wotd8.jpg"></p><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2evstaypyj20u00w042o.jpg"></p><h2 id="ç›¸å…³ä»£ç ä¹¦å†™"><a href="#ç›¸å…³ä»£ç ä¹¦å†™" class="headerlink" title="ç›¸å…³ä»£ç ä¹¦å†™"></a>ç›¸å…³ä»£ç ä¹¦å†™</h2><h3 id="bins-x2F-split-flower-dataset-py-åˆ’åˆ†æ•°æ®é›†"><a href="#bins-x2F-split-flower-dataset-py-åˆ’åˆ†æ•°æ®é›†" class="headerlink" title="bins&#x2F;split_flower_dataset.py åˆ’åˆ†æ•°æ®é›†"></a>bins&#x2F;split_flower_dataset.py åˆ’åˆ†æ•°æ®é›†</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"># @file name    :split_flower_dataset.py</span></span><br><span class="line"><span class="string"># @author       :zz0320</span></span><br><span class="line"><span class="string"># @data         :2022-3-30</span></span><br><span class="line"><span class="string"># @brief        :åˆ’åˆ†floweræ•°æ®é›†</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_mkdir</span>(<span class="params">my_dir</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.isdir(my_dir):</span><br><span class="line">        os.makedirs(my_dir)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">move_img</span>(<span class="params">imgs, root_dir, setname</span>):</span><br><span class="line">    data_dir = os.path.join(root_dir, setname)</span><br><span class="line">    my_mkdir(data_dir)</span><br><span class="line">    <span class="keyword">for</span> idx, path_imgs <span class="keyword">in</span> <span class="built_in">enumerate</span>(imgs):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125; / &#123;&#125;&quot;</span>.<span class="built_in">format</span>(idx, <span class="built_in">len</span>(imgs)))</span><br><span class="line">        shutil.copy(path_imgs, data_dir) <span class="comment"># å…³é”®æ˜¯è¿™ä¸€è¡Œä»£ç  ç§»åŠ¨å›¾ç‰‡åˆ°æ–°æ–‡ä»¶å¤¹</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125; dataset, copy &#123;&#125; img to &#123;&#125;&quot;</span>.<span class="built_in">format</span>(setname, <span class="built_in">len</span>(imgs), data_dir))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># 0. config</span></span><br><span class="line">    random_seed = <span class="number">20210309</span></span><br><span class="line">    train_ratio = <span class="number">0.8</span></span><br><span class="line">    valid_ratio = <span class="number">0.1</span></span><br><span class="line">    test_ratio = <span class="number">0.1</span></span><br><span class="line">    root_dir = <span class="string">r&#x27;/Users/kenton/Downloads/deeplearning_dataset/flower102&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1. read list, shuffle</span></span><br><span class="line">    data_dir = os.path.join(root_dir, <span class="string">&quot;jpg&quot;</span>)</span><br><span class="line">    name_imgs = [p <span class="keyword">for</span> p <span class="keyword">in</span> os.listdir(data_dir) <span class="keyword">if</span> p.endswith(<span class="string">&quot;.jpg&quot;</span>)] <span class="comment"># åˆ—è¡¨ç”Ÿæˆå¼</span></span><br><span class="line">    path_imgs = [os.path.join(data_dir, name) <span class="keyword">for</span> name <span class="keyword">in</span> name_imgs]</span><br><span class="line">    random.seed(random_seed)</span><br><span class="line">    random.shuffle(path_imgs)</span><br><span class="line">    <span class="built_in">print</span>(path_imgs[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. split</span></span><br><span class="line">    train_breakpoints = <span class="built_in">int</span>(<span class="built_in">len</span>(path_imgs) * train_ratio)</span><br><span class="line">    valid_breakpoints = <span class="built_in">int</span>(<span class="built_in">len</span>(path_imgs) * (train_ratio + valid_ratio))</span><br><span class="line">    test_breakpoints = <span class="built_in">int</span>(<span class="built_in">len</span>(path_imgs) * <span class="number">1</span>) <span class="comment"># å¯ä»¥çœç•¥</span></span><br><span class="line"></span><br><span class="line">    train_img = path_imgs[: train_breakpoints]</span><br><span class="line">    valid_img = path_imgs[train_breakpoints: valid_breakpoints]</span><br><span class="line">    test_img = path_imgs[valid_breakpoints:]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3. copy and save</span></span><br><span class="line">    move_img(train_img, root_dir, <span class="string">&quot;train&quot;</span>)</span><br><span class="line">    move_img(valid_img, root_dir, <span class="string">&quot;valid&quot;</span>)</span><br><span class="line">    move_img(test_img, root_dir, <span class="string">&quot;test&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="datasets-x2F-flower102-py-è¯»å–æ•°æ®é›†"><a href="#datasets-x2F-flower102-py-è¯»å–æ•°æ®é›†" class="headerlink" title="datasets&#x2F;flower102.py è¯»å–æ•°æ®é›†"></a>datasets&#x2F;flower102.py è¯»å–æ•°æ®é›†</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"># @file name    :flower102.py</span></span><br><span class="line"><span class="string"># @author       :zz0320</span></span><br><span class="line"><span class="string"># @data         :2022-3-30</span></span><br><span class="line"><span class="string"># @brief        :DataSetsç±» æ•°æ®è¯»å–</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> Dataset</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FlowerDataset</span>(<span class="title class_ inherited__">Dataset</span>):</span><br><span class="line">    cls_num = <span class="number">102</span> <span class="comment"># ç±»çš„ä¸€äº›å±æ€§</span></span><br><span class="line">    names = <span class="built_in">tuple</span>([i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(cls_num)])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, root_dir, transform=<span class="literal">None</span></span>): <span class="comment">#å®šä¹‰æ ¸å¿ƒå˜é‡ æ¯”å¦‚è·¯å¾„ å’Œ Transformé¢„å¤„ç†</span></span><br><span class="line">        self.root_dir = root_dir</span><br><span class="line">        self.transform = transform</span><br><span class="line">        self.img_info = [] <span class="comment"># [(path, label),(),...]</span></span><br><span class="line">        self.label_array = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        self._get_img_info()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, index</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        è¾“å…¥æ ‡é‡indexï¼Œä»ç¡¬ç›˜ä¸­è¯»å–æ•°æ®ï¼Œå¹¶é¢„å¤„ç† to tensor</span></span><br><span class="line"><span class="string">        :param index:</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        path_img, label = self.img_info[index]</span><br><span class="line">        img = Image.<span class="built_in">open</span>(path_img).convert(<span class="string">&#x27;RGB&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.transform <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            img = self.transform(img)</span><br><span class="line">        <span class="keyword">return</span> img, label, path_img</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(self.img_info) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">&quot;\ndata_dir:&#123;&#125; is a empty dir!&quot;</span>.<span class="built_in">format</span>(self.root_dir))</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(self.img_info)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_img_info</span>(<span class="params">self</span>): <span class="comment"># è¯»å–æ•°æ®çš„è·¯å¾„å’Œæ ‡ç­¾ å­˜åœ¨ä¸€ä¸ªåˆ—è¡¨å½“ä¸­ ç»™__getitem__ä½¿ç”¨</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        å®ç°æ•°æ®é›†çš„è¯»å–ï¼Œå°†ç¡¬ç›˜ä¸­çš„æ•°æ®è·¯å¾„å’Œæ ‡ç­¾ è¯»å–è¿›æ¥ å­˜åœ¨ä¸€ä¸ªlistä¸­</span></span><br><span class="line"><span class="string">        path, label</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        names_imgs = os.listdir(self.root_dir)</span><br><span class="line">        names_imgs = [n <span class="keyword">for</span> n <span class="keyword">in</span> names_imgs <span class="keyword">if</span> n.endswith(<span class="string">&#x27;.jpg&#x27;</span>)] <span class="comment"># pythonic åˆ—è¡¨æ¨å¯¼å¼</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># è¯»å–matå½¢å¼label</span></span><br><span class="line">        label_file = <span class="string">&quot;imagelabels.mat&quot;</span></span><br><span class="line">        path_label_file = os.path.join(self.root_dir,<span class="string">&quot;..&quot;</span>,label_file)</span><br><span class="line">        <span class="keyword">from</span> scipy.io <span class="keyword">import</span> loadmat</span><br><span class="line">        label_array = loadmat(path_label_file)[<span class="string">&quot;labels&quot;</span>].squeeze()</span><br><span class="line">        self.label_array = label_array</span><br><span class="line"></span><br><span class="line">        <span class="comment"># åŒ¹é…label</span></span><br><span class="line">        idx_imgs = [<span class="built_in">int</span>(n[<span class="number">6</span>:<span class="number">11</span>]) <span class="keyword">for</span> n <span class="keyword">in</span> names_imgs] <span class="comment"># æ ‡å·</span></span><br><span class="line">        path_imgs = [os.path.join(self.root_dir, n) <span class="keyword">for</span> n <span class="keyword">in</span> names_imgs] <span class="comment">#  è·¯å¾„ é€šè¿‡åç§°æ‹¼ä¸Šæ ¹ç›®å½• åˆ—è¡¨æ¨å¯¼å¼</span></span><br><span class="line">        self.img_info = [(p, <span class="built_in">int</span>(label_array[idx - <span class="number">1</span>] - <span class="number">1</span>)) <span class="keyword">for</span> p, idx <span class="keyword">in</span> <span class="built_in">zip</span>(path_imgs, idx_imgs)]</span><br><span class="line">        <span class="comment"># è·å–æ•´ä¸ªå›¾ç‰‡çš„info åŒ…å« path å’Œ label</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># test part</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    root_dir = <span class="string">r&#x27;/Users/kenton/Downloads/deeplearning_dataset/flower102/train&#x27;</span></span><br><span class="line">    test_dataset = FlowerDataset(root_dir)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">len</span>(test_dataset))</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">next</span>(<span class="built_in">iter</span>(test_dataset))) <span class="comment">#è¿­ä»£å™¨</span></span><br></pre></td></tr></table></figure><h3 id="scr-x2F-flower-train-py-è®­ç»ƒä»£ç "><a href="#scr-x2F-flower-train-py-è®­ç»ƒä»£ç " class="headerlink" title="scr&#x2F;flower_train.py è®­ç»ƒä»£ç "></a>scr&#x2F;flower_train.py è®­ç»ƒä»£ç </h3><p>argparseï¼šæ¥æ”¶å‘½ä»¤è¡Œå‚æ•°ï¼Œåº”ç”¨åœºæ™¯ï¼šæœåŠ¡å™¨è®­ç»ƒæ—¶ä¾¿äºè°ƒå‚</p><p>è®­ç»ƒä¿¡æ¯ä¿å­˜ï¼šæ··æ·†çŸ©é˜µå¯è§†åŒ–ï¼Œlossæ›²çº¿ç»˜åˆ¶ä¾¿äºè§‚å¯Ÿæ¨¡å‹è®­ç»ƒè¶‹åŠ¿</p><p>path_errorsè®°å½•ï¼šç”¨äºåˆ†ææ¨¡å‹badcase</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"># @file name    :model_trainer.py</span></span><br><span class="line"><span class="string"># @author       :zz0320</span></span><br><span class="line"><span class="string"># @data         :2022-4-5</span></span><br><span class="line"><span class="string"># @brief        :è®­ç»ƒä»£ç </span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> datasets.flower102 <span class="keyword">import</span> FlowerDataset</span><br><span class="line"><span class="keyword">import</span> torchvision.transforms <span class="keyword">as</span> transforms</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">BASE_DIR = os.path.dirname(os.path.abspath(__file__)) <span class="comment"># å¾—åˆ°å½“å‰æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•</span></span><br><span class="line">sys.path.append(os.path.join(BASE_DIR, <span class="string">&quot;..&quot;</span>))</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.optim <span class="keyword">as</span> optim</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> DataLoader</span><br><span class="line"><span class="keyword">from</span> torchvision.models <span class="keyword">import</span> resnet18</span><br><span class="line"><span class="keyword">from</span> tools.model_trainer <span class="keyword">import</span> ModelTrainer</span><br><span class="line"><span class="keyword">from</span> tools.common_tools <span class="keyword">import</span> setup_seed, show_confMat, plot_line, Logger, check_data_dir, make_logger, get_model</span><br><span class="line"><span class="keyword">from</span> config.flower_config <span class="keyword">import</span> cfg</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> datasets.flower102 <span class="keyword">import</span> FlowerDataset</span><br><span class="line"><span class="keyword">from</span> tools.my_loss <span class="keyword">import</span> LabelSmoothLoss</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">setup_seed(<span class="number">12345</span>) <span class="comment"># å…ˆå›ºå®šéšæœºç§å­</span></span><br><span class="line">device = torch.device(<span class="string">&quot;cuda&quot;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&#x27;cpu&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è§£æå‘½ä»¤è¡Œçš„å‚æ•°</span></span><br><span class="line">parser = argparse.ArgumentParser(description=<span class="string">&#x27;Training&#x27;</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;--lr&#x27;</span>,default=<span class="literal">None</span>, <span class="built_in">type</span>=<span class="built_in">float</span>, <span class="built_in">help</span>=<span class="string">&#x27;learning rate&#x27;</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;--bs&#x27;</span>,default=<span class="literal">None</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, <span class="built_in">help</span>=<span class="string">&#x27;training batch size&#x27;</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;--max_epoch&#x27;</span>,default=<span class="literal">None</span>, <span class="built_in">type</span>=<span class="built_in">int</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;--data_root_dir&#x27;</span>,default=<span class="string">r&quot;/Users/kenton/Downloads/deeplearning_dataset/flower102&quot;</span>,</span><br><span class="line">                    <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&#x27;path to your dataset&#x27;</span>)</span><br><span class="line"></span><br><span class="line">args = parser.parse_args()</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¥æ”¶å‚æ•°</span></span><br><span class="line">cfg.lr_init = args.lr <span class="keyword">if</span> args.lr <span class="keyword">else</span> cfg.lr_init</span><br><span class="line">cfg.train_bs = args.bs <span class="keyword">if</span> args.bs <span class="keyword">else</span> cfg.train_bs</span><br><span class="line">cfg.max_epoch = args.max_epoch <span class="keyword">if</span> args.bs <span class="keyword">else</span> cfg.max_epoch</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># step 0: config</span></span><br><span class="line">    <span class="comment"># æ•°æ®è·¯å¾„</span></span><br><span class="line">    train_dir = os.path.join(args.data_root_dir, <span class="string">&quot;train&quot;</span>)</span><br><span class="line">    valid_dir = os.path.join(args.data_root_dir, <span class="string">&quot;valid&quot;</span>)</span><br><span class="line">    path_state_dict = <span class="string">&quot;/Users/kenton/Downloads/deeplearning_dataset/pretrain_model/resnet18-f37072fd.pth&quot;</span> <span class="comment"># é¢„è®­ç»ƒæ¨¡å‹æ‰€åœ¨ä½ç½®</span></span><br><span class="line">    check_data_dir(train_dir) <span class="comment"># éªŒè¯è·¯å¾„æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    check_data_dir(valid_dir)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆ›å»ºlogger</span></span><br><span class="line">    res_dir = os.path.join(BASE_DIR, <span class="string">&quot;..&quot;</span>, <span class="string">&quot;..&quot;</span>, <span class="string">&quot;results&quot;</span>)</span><br><span class="line">    logger, log_dir = make_logger(res_dir)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># step 1: æ•°æ®é›†</span></span><br><span class="line">    <span class="comment"># æ„å»ºDatasetå®ä¾‹ï¼Œæ„å»ºDataLoader</span></span><br><span class="line">    train_data = FlowerDataset(root_dir=train_dir, transform=cfg.transforms_train)</span><br><span class="line">    valid_data = FlowerDataset(root_dir=valid_dir, transform=cfg.transforms_valid)</span><br><span class="line">    train_loader = DataLoader(dataset=train_data, batch_size=cfg.train_bs, shuffle=<span class="literal">True</span>, num_workers=cfg.workers)</span><br><span class="line">    valid_loader = DataLoader(dataset=valid_data, batch_size=cfg.valid_bs, num_workers=cfg.workers)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. æ¨¡å‹</span></span><br><span class="line">    model = get_model(cfg, train_data.cls_num, logger)</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    # åŠ è½½é¢„è®­ç»ƒæ¨¡å‹çš„å‚æ•° state_dict</span></span><br><span class="line"><span class="string">    if os.path.exists(path_state_dict):</span></span><br><span class="line"><span class="string">        pretrained_state_dict = torch.load(path_state_dict, map_location=&#x27;cpu&#x27;)</span></span><br><span class="line"><span class="string">        model.load_state_dict(pretrained_state_dict)</span></span><br><span class="line"><span class="string">        logger.info(&quot;Load pretrained model&quot;)</span></span><br><span class="line"><span class="string">    else:</span></span><br><span class="line"><span class="string">        logger.info(&quot;The pretrained model path &#123;&#125; is not exists&quot;.format(path_state_dict))</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    # ä¿®æ”¹æœ€åä¸€å±‚</span></span><br><span class="line"><span class="string">    num_ftrs = model.fc.in_features</span></span><br><span class="line"><span class="string">    model.fc = nn.Linear(num_ftrs, train_data.cls_num)</span></span><br><span class="line"><span class="string">    # to device</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    model.to(device)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3. æŸå¤±å‡½æ•° ä¼˜åŒ–å™¨ ç­‰</span></span><br><span class="line">    <span class="keyword">if</span> cfg.lable_smooth:</span><br><span class="line">        loss_f = LabelSmoothLoss(cfg.label_smooth_eps)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        loss_f = nn.CrossEntropyLoss()</span><br><span class="line">    optimizer = optim.SGD(model.parameters(), lr=cfg.lr_init, momentum=cfg.momentum, weight_decay=cfg.weight_decay)</span><br><span class="line">    scheduler = optim.lr_scheduler.MultiStepLR(optimizer, gamma=cfg.factor, milestones=cfg.milestones)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 4. è¿­ä»£è®­ç»ƒ</span></span><br><span class="line">    loss_rec = &#123;<span class="string">&#x27;train&#x27;</span>:[], <span class="string">&quot;valid&quot;</span>:[]&#125;</span><br><span class="line">    acc_rec = &#123;<span class="string">&#x27;train&#x27;</span>:[], <span class="string">&quot;valid&quot;</span>:[]&#125;</span><br><span class="line">    best_acc, best_epoch = <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(cfg.max_epoch):</span><br><span class="line"></span><br><span class="line">        <span class="comment"># dataloader</span></span><br><span class="line">        loss_train, acc_train, mat_train, path_error_train = ModelTrainer.train(</span><br><span class="line">            train_loader, model, loss_f, optimizer, scheduler, epoch, device, cfg, logger)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># valid</span></span><br><span class="line">        loss_valid, acc_valid, mat_valid, path_error_valid = ModelTrainer.valid(</span><br><span class="line">            valid_loader, model, loss_f, device)</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">&quot;Epoch[&#123;:0&gt;3&#125;/&#123;:0&gt;3&#125;] Train Acc:&#123;:.2%&#125; Valid Acc:&#123;:.2%&#125; Train loss:&#123;:.4f&#125; Valid loss:&#123;:.4f&#125;&quot;</span>.<span class="built_in">format</span>(epoch + <span class="number">1</span>,</span><br><span class="line">                cfg.max_epoch, acc_train, acc_valid, loss_train, loss_valid,</span><br><span class="line">                optimizer.param_groups[<span class="number">0</span>][<span class="string">&quot;lr&quot;</span>]))</span><br><span class="line"></span><br><span class="line">        scheduler.step() <span class="comment"># å­¦ä¹ ç‡è¿›è¡Œæ›´æ–°ï¼ï¼ï¼</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># è®°å½•è®­ç»ƒä¿¡æ¯</span></span><br><span class="line">        loss_rec[<span class="string">&quot;train&quot;</span>].append(loss_train), loss_rec[<span class="string">&quot;valid&quot;</span>].append(loss_valid)</span><br><span class="line">        acc_rec[<span class="string">&quot;train&quot;</span>].append(acc_train), acc_rec[<span class="string">&quot;valid&quot;</span>].append(acc_valid)</span><br><span class="line">        <span class="comment"># ä¿å­˜æ··æ·†çŸ©é˜µå›¾</span></span><br><span class="line">        show_confMat(mat_train, train_data.names, <span class="string">&quot;train&quot;</span>, log_dir, epoch=epoch, verbose=epoch == cfg.max_epoch - <span class="number">1</span>)</span><br><span class="line">        show_confMat(mat_valid, valid_data.names, <span class="string">&quot;valid&quot;</span>, log_dir, epoch=epoch, verbose=epoch == cfg.max_epoch - <span class="number">1</span>)</span><br><span class="line">        <span class="comment"># ä¿å­˜lossæ›²çº¿ accæ›²çº¿</span></span><br><span class="line">        plt_x = np.arange(<span class="number">1</span>, epoch + <span class="number">2</span>)</span><br><span class="line">        plot_line(plt_x, loss_rec[<span class="string">&quot;train&quot;</span>], plt_x, loss_rec[<span class="string">&quot;valid&quot;</span>], mode=<span class="string">&quot;loss&quot;</span>, out_dir=log_dir)</span><br><span class="line">        plot_line(plt_x, acc_rec[<span class="string">&quot;train&quot;</span>], plt_x, acc_rec[<span class="string">&quot;valid&quot;</span>], mode=<span class="string">&quot;acc&quot;</span>, out_dir=log_dir)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ä¿å­˜æ¨¡å‹</span></span><br><span class="line">        <span class="keyword">if</span> best_acc &lt; acc_valid <span class="keyword">or</span> epoch == cfg.max_epoch - <span class="number">1</span>:</span><br><span class="line">            best_epoch = epoch <span class="keyword">if</span> best_acc &lt; acc_valid <span class="keyword">else</span> best_epoch</span><br><span class="line">            best_acc = acc_valid <span class="keyword">if</span> best_acc &lt; acc_valid <span class="keyword">else</span> best_acc</span><br><span class="line">            checkpoint = &#123;<span class="string">&quot;model_state_dict&quot;</span>: model.state_dict(),</span><br><span class="line">                          <span class="string">&quot;optimizer_state_dict&quot;</span>: optimizer.state_dict(),</span><br><span class="line">                          <span class="string">&quot;epoch&quot;</span>: epoch,</span><br><span class="line">                          <span class="string">&quot;best_acc&quot;</span>: best_acc&#125;</span><br><span class="line">            pkl_name = <span class="string">&quot;checkpoint_&#123;&#125;.pkl&quot;</span>.<span class="built_in">format</span>(epoch) <span class="keyword">if</span> epoch == cfg.max_epoch - <span class="number">1</span> <span class="keyword">else</span> <span class="string">&quot;checkpoint_best.pkl&quot;</span></span><br><span class="line">            path_checkpoint = os.path.join(log_dir, pkl_name)</span><br><span class="line">            torch.save(checkpoint, path_checkpoint)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># ä¿å­˜é”™è¯¯å›¾ç‰‡çš„è·¯å¾„</span></span><br><span class="line">            err_ims_name = <span class="string">&quot;error_imgs_&#123;&#125;.pkl&quot;</span>.<span class="built_in">format</span>(epoch) <span class="keyword">if</span> epoch == cfg.max_epoch - <span class="number">1</span> <span class="keyword">else</span> <span class="string">&quot;error_imgs_best.pkl&quot;</span></span><br><span class="line">            path_err_img = os.path.join(log_dir, err_ims_name)</span><br><span class="line">            error_info = &#123;&#125;</span><br><span class="line">            error_info[<span class="string">&quot;train&quot;</span>] = path_error_train</span><br><span class="line">            error_info[<span class="string">&quot;valid&quot;</span>] = path_error_valid</span><br><span class="line">            pickle.dump(error_info, <span class="built_in">open</span>(path_err_img, <span class="string">&quot;wb&quot;</span>))</span><br><span class="line">    logger.info(<span class="string">&quot;&#123;&#125; done, best acc:&#123;&#125; in: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">        datetime.strftime(datetime.now(), <span class="string">&quot;%m-%d_%H-%M&quot;</span>), best_acc, best_epoch))</span><br></pre></td></tr></table></figure><h3 id="tools-x2F-model-trainer-py-æ¨¡å‹è®­ç»ƒå‡½æ•°"><a href="#tools-x2F-model-trainer-py-æ¨¡å‹è®­ç»ƒå‡½æ•°" class="headerlink" title="tools&#x2F;model_trainer.py æ¨¡å‹è®­ç»ƒå‡½æ•°"></a>tools&#x2F;model_trainer.py æ¨¡å‹è®­ç»ƒå‡½æ•°</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"># @file name    :model_trainer.py</span></span><br><span class="line"><span class="string"># @author       :zz0320</span></span><br><span class="line"><span class="string"># @data         :2022-3-31</span></span><br><span class="line"><span class="string"># @brief        :å·¥å…·å‡½æ•° ç”¨æ¥æ¨¡å‹è®­ç»ƒ ç„¶åè¾“å‡ºè®­ç»ƒä¸­çš„æ•°æ®</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> Counter</span><br><span class="line"><span class="keyword">from</span> tools.mixup <span class="keyword">import</span> mixup_data, mixup_criterion</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ModelTrainer</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">train</span>(<span class="params">data_loader, model, loss_f, optimizer, scheduler, epoch_idx, device, cfg, logger</span>):</span><br><span class="line">        model.train()</span><br><span class="line"></span><br><span class="line">        class_num = data_loader.dataset.cls_num</span><br><span class="line">        conf_mat = np.zeros((class_num, class_num))</span><br><span class="line">        loss_sigma = []</span><br><span class="line">        loss_mean = <span class="number">0</span></span><br><span class="line">        acc_avg = <span class="number">0</span></span><br><span class="line">        path_error = []</span><br><span class="line">        label_list = []</span><br><span class="line">        <span class="keyword">for</span> i, data <span class="keyword">in</span> <span class="built_in">enumerate</span>(data_loader):</span><br><span class="line"></span><br><span class="line">            <span class="comment"># _, label = data</span></span><br><span class="line">            inputs, labels, path_imgs = data</span><br><span class="line">            label_list.extend(labels.tolist())</span><br><span class="line"></span><br><span class="line">            <span class="comment"># inputs, labels = data</span></span><br><span class="line">            inputs, labels, path_imgs = data</span><br><span class="line">            inputs, labels = inputs.to(device), labels.to(device)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># mixup</span></span><br><span class="line">            <span class="keyword">if</span> cfg.mixup:</span><br><span class="line">                mixup_inputs, label_a, label_b, lam = mixup_data(inputs, labels,</span><br><span class="line">                                        cfg.mixup_alpha,device)</span><br><span class="line">                inputs = mixup_inputs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment"># forward &amp; backward</span></span><br><span class="line">            outputs = model(inputs)</span><br><span class="line">            optimizer.zero_grad()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># lossè®¡ç®—</span></span><br><span class="line">            <span class="keyword">if</span> cfg.mixup:</span><br><span class="line">                loss = mixup_criterion(loss_f, outputs.cpu(), label_a.cpu(), label_b.cpu(), lam)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                loss = loss_f(outputs.cpu(), labels.cpu())</span><br><span class="line">            loss.backward()</span><br><span class="line">            optimizer.step()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># ç»Ÿè®¡loss</span></span><br><span class="line">            loss_sigma.append(loss.item())</span><br><span class="line">            loss_mean = np.mean(loss_sigma)</span><br><span class="line"></span><br><span class="line">            _, predicted = torch.<span class="built_in">max</span>(outputs.data, <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(labels)):</span><br><span class="line">                cate_i = labels[j].cpu().numpy()</span><br><span class="line">                pre_i = predicted[j].cpu().numpy()</span><br><span class="line">                conf_mat[cate_i, pre_i] += <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> cate_i != pre_i:</span><br><span class="line">                    path_error.append((cate_i, pre_i, path_imgs[j]))</span><br><span class="line">            acc_avg = conf_mat.trace() / conf_mat.<span class="built_in">sum</span>()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># æ¯ log_interval ä¸ª iter æ‰“å°ä¸€æ¬¡è®­ç»ƒä¿¡æ¯</span></span><br><span class="line">            <span class="keyword">if</span> i % cfg.log_interval == cfg.log_interval - <span class="number">1</span>:</span><br><span class="line">                logger.info(<span class="string">&quot;Training: Epoch[&#123;:0&gt;3&#125;/&#123;:0&gt;3&#125;] Iteration[&#123;:0&gt;3&#125;/&#123;:0&gt;3&#125;] Loss:&#123;:.4f&#125; Acc:&#123;:.2%&#125;&quot;</span>.<span class="built_in">format</span>(epoch_idx\</span><br><span class="line">                    + <span class="number">1</span>, cfg.max_epoch, i + <span class="number">1</span>, <span class="built_in">len</span>(data_loader), loss_mean, acc_avg))</span><br><span class="line">        logger.info(<span class="string">&quot;epoch:&#123;&#125; sampler:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(epoch_idx, Counter(label_list)))</span><br><span class="line">        <span class="keyword">return</span> loss_mean, acc_avg, conf_mat, path_error</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">valid</span>(<span class="params">data_loader, model, loss_f, device</span>):</span><br><span class="line">        model.<span class="built_in">eval</span>()</span><br><span class="line"></span><br><span class="line">        class_num = data_loader.dataset.cls_num</span><br><span class="line">        conf_mat = np.zeros((class_num, class_num))</span><br><span class="line">        loss_sigma = []</span><br><span class="line">        path_error = []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i, data <span class="keyword">in</span> <span class="built_in">enumerate</span>(data_loader):</span><br><span class="line">            inputs, labels, path_imgs = data</span><br><span class="line">            <span class="comment"># inputs, labels = data</span></span><br><span class="line">            inputs, labels = inputs.to(device), labels.to(device)</span><br><span class="line"></span><br><span class="line">            outputs = model(inputs)</span><br><span class="line">            loss = loss_f(outputs.cpu(), labels.cpu())</span><br><span class="line"></span><br><span class="line">            <span class="comment"># ç»Ÿè®¡æ··æ·†çŸ©é˜µ</span></span><br><span class="line">            _, predicted = torch.<span class="built_in">max</span>(outputs.data, <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(labels)):</span><br><span class="line">                cate_i = labels[j].cpu().numpy()</span><br><span class="line">                pre_i = predicted[j].cpu().numpy()</span><br><span class="line">                conf_mat[cate_i, pre_i] += <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> cate_i != pre_i:</span><br><span class="line">                    path_error.append((cate_i, pre_i, path_imgs[j]))</span><br><span class="line"></span><br><span class="line">            <span class="comment"># ç»Ÿè®¡loss</span></span><br><span class="line">            loss_sigma.append(loss.item())</span><br><span class="line"></span><br><span class="line">        acc_avg = conf_mat.trace() / conf_mat.<span class="built_in">sum</span>()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> np.mean(loss_sigma), acc_avg, conf_mat, path_error</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> èŠ±æœµåˆ†ç±»é¡¹ç›® </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Œç¯å¢ƒé…ç½®ã€ï¼ˆä¸€ï¼‰ä½¿ç”¨Condaé…ç½®mmdetctionç¯å¢ƒ</title>
      <link href="/2022/05/19/%E3%80%8C%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E3%80%8D%EF%BC%88%E4%B8%80%EF%BC%89mmdetection%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/"/>
      <url>/2022/05/19/%E3%80%8C%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E3%80%8D%EF%BC%88%E4%B8%80%EF%BC%89mmdetection%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<p>å‚è€ƒæ–‡ç« ã€Œ<a href="https://mmdetection.readthedocs.io/zh_CN/v2.22.0/get_started.html#id2"><strong>mmdetæ–‡æ¡£</strong></a>ã€ã€Œ<a href="https://pytorch.org/get-started/locally/"><strong>Pytorchå®˜ç½‘</strong></a>ã€</p><h2 id="Condaæ¿€æ´»ç¯å¢ƒ"><a href="#Condaæ¿€æ´»ç¯å¢ƒ" class="headerlink" title="Condaæ¿€æ´»ç¯å¢ƒ"></a>Condaæ¿€æ´»ç¯å¢ƒ</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">conda create -n py39_torch112 python=3.9</span><br><span class="line">conda activate py39_torch112  </span><br></pre></td></tr></table></figure><h2 id="ä½¿ç”¨pip-ä¸‹è½½Pytorch"><a href="#ä½¿ç”¨pip-ä¸‹è½½Pytorch" class="headerlink" title="ä½¿ç”¨pip ä¸‹è½½Pytorch"></a>ä½¿ç”¨pip ä¸‹è½½Pytorch</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pip3 install --pre torch torchvision torchaudio --extra-index-url https://download.pytorch.org/whl/nightly/cpu</span><br><span class="line"></span><br><span class="line">pip3 install torch torchvision torchaudio</span><br></pre></td></tr></table></figure><span id="more"></span><h2 id="å®‰è£…mmcv-full-x3D-x3D-1-4-5"><a href="#å®‰è£…mmcv-full-x3D-x3D-1-4-5" class="headerlink" title="å®‰è£…mmcv-full &#x3D;&#x3D; 1.4.5"></a>å®‰è£…mmcv-full &#x3D;&#x3D; 1.4.5</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install mmcv-full==1.4.5</span><br></pre></td></tr></table></figure><h2 id="Conda-å®‰è£…onnxå’Œonnxruntime"><a href="#Conda-å®‰è£…onnxå’Œonnxruntime" class="headerlink" title="Conda å®‰è£…onnxå’Œonnxruntime"></a>Conda å®‰è£…onnxå’Œonnxruntime</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conda install onnx onnxruntime</span><br></pre></td></tr></table></figure><h2 id="å®‰è£…ä¾èµ–ç¯å¢ƒåº“"><a href="#å®‰è£…ä¾èµ–ç¯å¢ƒåº“" class="headerlink" title="å®‰è£…ä¾èµ–ç¯å¢ƒåº“"></a>å®‰è£…ä¾èµ–ç¯å¢ƒåº“</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install -r requirements.txt</span><br></pre></td></tr></table></figure><h2 id="ä¹‹å-python-setup-py-develp"><a href="#ä¹‹å-python-setup-py-develp" class="headerlink" title="ä¹‹å python setup.py develp"></a>ä¹‹å python setup.py develp</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python setup.py develop</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> ç¯å¢ƒé…ç½® </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Œç¯å¢ƒé…ç½®ã€ä½¿ç”¨Condaé…ç½®mmdetctionç¯å¢ƒ</title>
      <link href="/2022/05/19/%E3%80%8C%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E3%80%8Dmmdetection%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/"/>
      <url>/2022/05/19/%E3%80%8C%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E3%80%8Dmmdetection%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<p>å‚è€ƒæ–‡ç« ã€Œ<a href="https://mmdetection.readthedocs.io/zh_CN/v2.22.0/get_started.html#id2"><strong>mmdetæ–‡æ¡£</strong></a>ã€ã€Œ<a href="https://pytorch.org/get-started/locally/"><strong>Pytorchå®˜ç½‘</strong></a>ã€</p><h2 id="Condaæ¿€æ´»ç¯å¢ƒ"><a href="#Condaæ¿€æ´»ç¯å¢ƒ" class="headerlink" title="Condaæ¿€æ´»ç¯å¢ƒ"></a>Condaæ¿€æ´»ç¯å¢ƒ</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">conda create -n py39_torch112 python=3.9</span><br><span class="line">conda activate py39_torch112  </span><br></pre></td></tr></table></figure><h2 id="ä½¿ç”¨pip-ä¸‹è½½Pytorch"><a href="#ä½¿ç”¨pip-ä¸‹è½½Pytorch" class="headerlink" title="ä½¿ç”¨pip ä¸‹è½½Pytorch"></a>ä½¿ç”¨pip ä¸‹è½½Pytorch</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip3 install --pre torch torchvision torchaudio --extra-index-url https://download.pytorch.org/whl/nightly/cpu</span><br><span class="line">pip3 install torch torchvision torchaudio</span><br></pre></td></tr></table></figure><span id="more"></span><h2 id="å®‰è£…mmcv-full-x3D-x3D-1-4-5"><a href="#å®‰è£…mmcv-full-x3D-x3D-1-4-5" class="headerlink" title="å®‰è£…mmcv-full &#x3D;&#x3D; 1.4.5"></a>å®‰è£…mmcv-full &#x3D;&#x3D; 1.4.5</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install mmcv-full==1.4.5</span><br></pre></td></tr></table></figure><h2 id="Conda-å®‰è£…onnxå’Œonnxruntime"><a href="#Conda-å®‰è£…onnxå’Œonnxruntime" class="headerlink" title="Conda å®‰è£…onnxå’Œonnxruntime"></a>Conda å®‰è£…onnxå’Œonnxruntime</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conda install onnx onnxruntime</span><br></pre></td></tr></table></figure><h2 id="å®‰è£…ä¾èµ–ç¯å¢ƒåº“"><a href="#å®‰è£…ä¾èµ–ç¯å¢ƒåº“" class="headerlink" title="å®‰è£…ä¾èµ–ç¯å¢ƒåº“"></a>å®‰è£…ä¾èµ–ç¯å¢ƒåº“</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install -r requirements.txt</span><br></pre></td></tr></table></figure><h2 id="ä¹‹å-python-setup-py-develp"><a href="#ä¹‹å-python-setup-py-develp" class="headerlink" title="ä¹‹å python setup.py develp"></a>ä¹‹å python setup.py develp</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python setup.py develop</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> ç¯å¢ƒé…ç½® </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€ŒçæŠ˜è…¾ã€æ”¯æŒApple Silionçš„æ–°ç‰ˆæœ¬Pytorchæµ‹è¯•</title>
      <link href="/2022/05/18/%E3%80%8C%E7%9E%8E%E6%8A%98%E8%85%BE%E3%80%8D%E6%94%AF%E6%8C%81Apple%20Silion%E7%9A%84%E6%96%B0%E7%89%88%E6%9C%ACPytorch%E6%B5%8B%E8%AF%95/"/>
      <url>/2022/05/18/%E3%80%8C%E7%9E%8E%E6%8A%98%E8%85%BE%E3%80%8D%E6%94%AF%E6%8C%81Apple%20Silion%E7%9A%84%E6%96%B0%E7%89%88%E6%9C%ACPytorch%E6%B5%8B%E8%AF%95/</url>
      
        <content type="html"><![CDATA[<h2 id="èƒŒæ™¯ä»‹ç»"><a href="#èƒŒæ™¯ä»‹ç»" class="headerlink" title="èƒŒæ™¯ä»‹ç»"></a>èƒŒæ™¯ä»‹ç»</h2><p>ä»Šå¤©æ—©æ™¨èµ·æ¥çœ‹åˆ°äº†ã€Œæœºå™¨ä¹‹å¿ƒã€å’Œã€Œé‡å­ä½ã€çš„å…¬ä¼—å·æ¨æ–‡ã€Œ<a href="https://mp.weixin.qq.com/s/UjnDVacH-6kSadPOnO32lQ">PyTorchå®£å¸ƒæ”¯æŒè‹¹æœM1èŠ¯ç‰‡GPUåŠ é€Ÿï¼šè®­ç»ƒå¿«6å€ï¼Œæ¨ç†æå‡21å€</a>ã€ã€Œ<a href="https://mp.weixin.qq.com/s/TMreqcWsvu-EOB1qEgg6Kg">ç‚¼ä¸¹é€Ÿåº¦Ã—7ï¼ä½ çš„Macç”µè„‘ä¹Ÿèƒ½åœ¨PyTorchè®­ç»ƒä¸­ç”¨GPUåŠ é€Ÿäº†</a>ã€</p><p>æˆ‘çš„å¤© è¿‡å¹´äº†è¿‡å¹´äº†  <strong>Pytorchæ”¯æŒApple Silionå•¦ï¼ï¼ï¼</strong> </p><p>çœ‹äº†çœ‹æ¨æ–‡ æœ‰Previewç‰ˆæœ¬å¯ä»¥ä½¿ç”¨äº† è¿™è¿˜ä¸æŠ˜è…¾èµ·æ¥ï¼Ÿ å¼€æ•´ï¼</p><h2 id="ç¯å¢ƒé…ç½®"><a href="#ç¯å¢ƒé…ç½®" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h2><p>å…ˆæ ¹æ®Pytorchçš„<a href="https://pytorch.org/blog/introducing-accelerated-pytorch-training-on-mac/">å®˜æ–¹æŒ‡å¼•</a>ç”¨Condaåˆ›å»ºä¸€ä¸ªåŸç”ŸPythonç¯å¢ƒã€ŒM1ç³»åˆ—Python3.9ä»¥ä¸Šæ‰æ˜¯åŸç”Ÿã€</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">conda create -n torch112_py39 python=3.9</span><br><span class="line">conda activate torch112_py39</span><br></pre></td></tr></table></figure><span id="more"></span><p>ä¹‹åè¿›å…¥ç¯å¢ƒ å®‰è£…torch</p><blockquote><p>è¿™é‡Œéœ€è¦æ³¨æ„ condaä¸‹é¢æ‰¾ä¸åˆ°torchaudio éœ€è¦åœ¨pipä¸‹é¢å®‰è£…</p><p>å®‰è£…ç»“æŸåä¸ºäº†é˜²æ­¢pipçš„ç¯å¢ƒä¸condaçš„ç¯å¢ƒå†²çª åˆ æ‰pipä¸‹é¢çš„torch</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">conda install pytorch torchvision -c pytorch-nightly</span><br><span class="line">pip install torchaudio</span><br><span class="line">pip uninstall torch</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å†å®‰è£…ä¸€ä¸ªä¾èµ–åº“ã€Œå¯èƒ½æœ‰ç”¨ğŸ˜‚ã€</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conda install pkg-config libuv</span><br></pre></td></tr></table></figure><p>OK ç¯å¢ƒé…ç½®å¥½äº† æ‰¾ä¸ªé¡¹ç›®æ¥è¯•ä¸€è¯•</p><h2 id="é¡¹ç›®å®æµ‹"><a href="#é¡¹ç›®å®æµ‹" class="headerlink" title="é¡¹ç›®å®æµ‹"></a>é¡¹ç›®å®æµ‹</h2><p>æ­£å¥½æ‰‹å¤´æœ‰ç›®æ ‡æ£€æµ‹CenterNetçš„é¡¹ç›®ä»£ç  è·‘è·‘çœ‹çœ‹æœ‰æ²¡æœ‰æå‡</p><p>åœ¨Pycharmé‡Œé¢å°†ç¼–è¯‘ç¯å¢ƒæ”¹æˆè®¾ç½®å¥½çš„<strong>torch112_py39</strong>ç¯å¢ƒ</p><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2dpqbqiihj20ya08uq3l.jpg"></p><p>ä¹‹åå®‰è£…é¡¹ç›®ä¾èµ–åº“</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install matplotlib</span><br><span class="line">pip install torchsummary</span><br></pre></td></tr></table></figure><p>æœ€åè¿è¡Œçœ‹çœ‹ç»“æœ</p><table><thead><tr><th>Torch1.9.0ï½œPython3.8</th><th>Torch1.10.2 | Python3.9</th><th>Torch1.9.0</th><th>Python3.9</th></tr></thead><tbody><tr><td><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2dqf6zkndj21fz0u078d.jpg"></td><td><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2dqhrgzalj21fz0u0aeb.jpg"></td><td><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2dvnjaakxj21fz0u078s.jpg"></td><td><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2dqgzjxb4j21fz0u078n.jpg"></td></tr><tr><td>1.43FPS</td><td>2.42FPS</td><td>4.29FPS</td><td>5.85FPS</td></tr></tbody></table><blockquote><p>Torché’ˆå¯¹MBPçš„GPUä»£ç ä¸ºâ€™mpsâ€™ éœ€è¦å°†modelå’Œdataéƒ½ç§»åˆ°device &#x3D; torch.device(â€˜mpsâ€™)ä¸Š</p></blockquote><p>å¹³å°ä¸ºMacBook M1 Pro 16+512 8æ ¸CPU 14æ ¸GPU</p><p>æœ€åæ¥çœ‹æ•ˆæœç¡®å®æ˜¯æœ‰æå‡ï¼Œè€ƒè™‘åˆ°ç›®æ ‡æ£€æµ‹è¿‡ç¨‹ä¸­étorchæ“ä½œå¾ˆå¤šä¸”åªèƒ½åœ¨CPUä¸Šè·‘è¿™ä¸ªé¡¹ç›®ï¼Œè¿™ç§æå‡æ•ˆæœè¿˜æ˜¯ä¸é”™çš„ï¼Œåç»­è€ƒè™‘å†æµ‹è¯•ä¸€ä¸‹Trainé˜¶æ®µçš„æå‡æ•ˆæœ</p>]]></content>
      
      
      
        <tags>
            
            <tag> å°é²œ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€Œè®ºæ–‡ç³»åˆ—ã€ï¼ˆä¸€ï¼‰æ—·è§†ç§‘æŠ€CVPR2022ã€CREStereoã€‘å®˜æ–¹GitHubä»£ç æ¨ç†è¿è¡Œ</title>
      <link href="/2022/05/11/%E3%80%8C%E8%AE%BA%E6%96%87%E7%B3%BB%E5%88%97%E3%80%8D%EF%BC%88%E4%B8%80%EF%BC%89%E6%97%B7%E8%A7%86%E7%A7%91%E6%8A%80CVPR2022%E3%80%90CREStereo%E3%80%91%E5%AE%98%E6%96%B9GitHub%E4%BB%A3%E7%A0%81%E6%8E%A8%E7%90%86%E8%BF%90%E8%A1%8C/"/>
      <url>/2022/05/11/%E3%80%8C%E8%AE%BA%E6%96%87%E7%B3%BB%E5%88%97%E3%80%8D%EF%BC%88%E4%B8%80%EF%BC%89%E6%97%B7%E8%A7%86%E7%A7%91%E6%8A%80CVPR2022%E3%80%90CREStereo%E3%80%91%E5%AE%98%E6%96%B9GitHub%E4%BB%A3%E7%A0%81%E6%8E%A8%E7%90%86%E8%BF%90%E8%A1%8C/</url>
      
        <content type="html"><![CDATA[<h2 id="è®ºæ–‡ç®€ä»‹"><a href="#è®ºæ–‡ç®€ä»‹" class="headerlink" title="è®ºæ–‡ç®€ä»‹"></a>è®ºæ–‡ç®€ä»‹</h2><p>CVPR2022è®ºæ–‡     <strong>ã€ŠåŸºäºè‡ªé€‚åº”ç›¸å…³çº§è”é€’å½’ç½‘ç»œçš„å®ç”¨åŒç›®åŒ¹é…ã€‹</strong>ttps:&#x2F;&#x2F;arxiv.org&#x2F;abs&#x2F;2203.11483</p><p>åŸæ–‡é“¾æ¥ï¼šã€Œ<a href="https://arxiv.org/abs/2203.11483">Practical Stereo Matching via Cascaded Recurrent Network with Adaptive Correlation</a>ã€</p><p>ä½œè€…è§£è¯»è§†é¢‘ï¼š</p><iframe src="//player.bilibili.com/player.html?aid=383885340&bvid=BV1oZ4y1h7mL&cid=717464018&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe><h2 id="è¿è¡Œå‡†å¤‡"><a href="#è¿è¡Œå‡†å¤‡" class="headerlink" title="è¿è¡Œå‡†å¤‡"></a>è¿è¡Œå‡†å¤‡</h2><p>åœ¨<strong>æ’æºäº‘</strong>å¹³å° é…ç½®ä¸€ä¸ª<strong>CUDA10.1</strong>çš„ç¯å¢ƒ è¿™é‡Œé€‰æ‹©<strong>Tesla T4</strong> ã€Œä½¿ç”¨å…¶ä»–å‹å·å¯èƒ½æ— æ³•åªèƒ½è¿›è¡ŒCUDA11åŠä»¥ä¸Šçš„é…ç½®ã€</p><span id="more"></span><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h24u0rmh0gj20mt02tt8p.jpg" alt="image-20220511212511378"  /><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h24u0x9dtgj20dg07t3yt.jpg" alt="image-20220511212457641"></p><p>è®¾ç½®æˆåŠŸåè¿›å…¥<strong>Jupyter-lab</strong>ï¼Œå®‰è£…<strong>OpenCV</strong></p><blockquote><p>å‚è€ƒã€Œ<a href="https://blog.csdn.net/keineahnung2345/article/details/84299532%E3%80%8D">https://blog.csdn.net/keineahnung2345/article/details/84299532ã€</a></p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pip install opencv-python</span><br><span class="line">apt-get install -y libglib2.0-0</span><br><span class="line">apt-get install -y libsm6 libxext6</span><br><span class="line">apt-get install -y libxrender-dev</span><br></pre></td></tr></table></figure><p>ä¹‹åæ ¹æ®å®˜æ–¹GitHubã€Œ<a href="https://github.com/megvii-research/CREStereo%E3%80%8D">https://github.com/megvii-research/CREStereoã€</a> è¿›è¡Œæ“ä½œ</p><blockquote><p>å»ºè®®ä½¿ç”¨Download ZIPè¿›è¡Œä¸‹è½½ ä¹‹åæ”¾å…¥æœåŠ¡å™¨ unzipå‡ºæ¥  git cloneç»å¸¸æŠ½é£å¡åœ¨cloneä¸åŠ¨å¼¹</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m pip install -r requirements.txt</span><br></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œéœ€è¦æå‰å°†requirements.txt ä¸­çš„ MegEngine&gt;&#x3D;1.8.2 æ”¹ä¸º MegEngine&#x3D;&#x3D;1.8.2 é˜²æ­¢å‡ºç°ç‰ˆæœ¬ä¸å…¼å®¹é—®é¢˜</p></blockquote><p>ç„¶åä¸‹è½½ä¸€ä¸ªå®˜æ–¹æä¾›çš„é¢„è®­ç»ƒæ¨¡å‹ã€Œ<a href="https://drive.google.com/file/d/1Wx_-zDQh7BUFBmN9im_26DFpnf3AkXj4/view">Googleç½‘ç›˜é“¾æ¥</a>ã€æ”¾åˆ°ä¸»ç›®å½•ä¸‹ç”¨äºå‰å‘æ¨ç†</p><p>æœ€åè¿è¡Œå¦‚ä¸‹ä»£ç ï¼Œå³å¯ç”Ÿæˆ<strong>æ·±åº¦å›¾</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 test.py --model_path path_to_mge_model --left img/test/left.png --right img/test/right.png --size 1024x1536 --output disparity.png</span><br></pre></td></tr></table></figure><h2 id="è¿è¡Œç»“æœå±•ç¤º"><a href="#è¿è¡Œç»“æœå±•ç¤º" class="headerlink" title="è¿è¡Œç»“æœå±•ç¤º"></a>è¿è¡Œç»“æœå±•ç¤º</h2><p>æœ€è¿‘æ­£å¥½åœ¨åšåŒç›®è§†è§‰ç›¸å…³çš„å·¥ä½œï¼Œæœ‰ä¸€äº›åŒç›®çš„ç´ æ</p><p>å®éªŒäº†ä¸€ä¸‹çœ‹çœ‹ï¼Œæ•ˆæœè¿˜æ˜¯æŒºä¸é”™çš„ï¼Œä¸‹é¢æ”¾ä¸Šå‡ å¼ æ•ˆæœå›¾</p><p>å¦‚æœåé¢èƒ½å¤Ÿåˆ©ç”¨å£°çº³æµ‹è·æˆ–è€…å…¶ä»–æ–¹æ³• åšä¸€ä¸ªæ°´ä¸‹è é²¼åŒç›®åŒ¹é…çš„çš„çœŸå€¼æ•°æ®é›†å°±æ›´å¥½</p><table><thead><tr><th align="center">å·¦ä¾§å›¾</th><th align="center">å³ä¾§å›¾</th><th align="center">æ·±åº¦å›¾</th></tr></thead><tbody><tr><td align="center"><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h24uqkkb4ej20zk0k0q53.jpg"></td><td align="center"><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h24uqkkb4ej20zk0k0q53.jpg"></td><td align="center"><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h24ut82ysij20zk0k0t97.jpg"></td></tr><tr><td align="center"><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h24up9kgcej20zk0k0tak.jpg"></td><td align="center"><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h24upf2e6jj20zk0k0wgb.jpg"></td><td align="center"><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h24uukp9oxj20zk0k0aav.jpg"></td></tr><tr><td align="center"><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h24uww73g7j20zk0k0whd.jpg"></td><td align="center"><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h24uww73g7j20zk0k0whd.jpg"></td><td align="center"><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h24ux180a4j20zk0k0q3s.jpg"></td></tr><tr><td align="center"><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h24uyh35k6j20zk0k0whf.jpg"></td><td align="center"><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h24uyeiq49j20zk0k0tbo.jpg"></td><td align="center"><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h24uyft7d6j20zk0k0jsd.jpg"></td></tr><tr><td align="center"><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h24v0hv9urj20zk0k0dip.jpg"></td><td align="center"><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h24v0hv9urj20zk0k0dip.jpg"></td><td align="center"><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h24v0ts6ulj20zk0k0gmk.jpg"></td></tr><tr><td align="center"><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h24v658pitj20zk0k0mzc.jpg"></td><td align="center"><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h24v64j9edj20zk0k0dhv.jpg"></td><td align="center"><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h24v633e4hj20zk0k03z6.jpg"></td></tr></tbody></table>]]></content>
      
      
      
        <tags>
            
            <tag> è®ºæ–‡ç³»åˆ— </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="/2022/05/08/hello-world/"/>
      <url>/2022/05/08/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><span id="more"></span><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
