<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.1.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic%7CCourier+New:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/silver/pace-theme-minimal.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"username.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="CamVid数据集介绍CamVid驾驶场景数据集，收集了701张驾驶场景语义分割图像，划分为训练、验证和测试，分别有367、101和233个样本">
<meta property="og:type" content="article">
<meta property="og:title" content="「分割项目」（二）基于自动驾驶CamVid数据集的分割任务">
<meta property="og:url" content="https://username.github.io/2022/05/22/%E3%80%8C%E5%88%86%E5%89%B2%E9%A1%B9%E7%9B%AE%E3%80%8D%EF%BC%88%E4%BA%8C%EF%BC%89%E5%9F%BA%E4%BA%8E%E8%87%AA%E5%8A%A8%E9%A9%BE%E9%A9%B6CamVid%E6%95%B0%E6%8D%AE%E9%9B%86%E7%9A%84%E5%88%86%E5%89%B2%E4%BB%BB%E5%8A%A1/index.html">
<meta property="og:site_name" content="陨石kk的博客">
<meta property="og:description" content="CamVid数据集介绍CamVid驾驶场景数据集，收集了701张驾驶场景语义分割图像，划分为训练、验证和测试，分别有367、101和233个样本">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hbmhcm0wj20tx0k0dj5.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/e6c9d24ely1h2he3khqu6j20zk0bkdig.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/e6c9d24ely1h2he43aq3jj20zk0dfgn0.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/e6c9d24ely1h2heg5db1gj20v30k00uw.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/e6c9d24ely1h2heiokcisj20u90k00tn.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hei5y43jj20ql0k03z8.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hexbngo5j20qo0k0mxs.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hexgdedtj20qo0k0t9k.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hf0z7oxdj20qo0k0gly.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hf140i1tj20qo0k03z4.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hf192jy2j20qo0k0q3p.jpg">
<meta property="article:published_time" content="2022-05-22T08:00:00.000Z">
<meta property="article:modified_time" content="2022-05-23T07:15:55.576Z">
<meta property="article:author" content="陨石kk">
<meta property="article:tag" content="分割项目">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hbmhcm0wj20tx0k0dj5.jpg">


<link rel="canonical" href="https://username.github.io/2022/05/22/%E3%80%8C%E5%88%86%E5%89%B2%E9%A1%B9%E7%9B%AE%E3%80%8D%EF%BC%88%E4%BA%8C%EF%BC%89%E5%9F%BA%E4%BA%8E%E8%87%AA%E5%8A%A8%E9%A9%BE%E9%A9%B6CamVid%E6%95%B0%E6%8D%AE%E9%9B%86%E7%9A%84%E5%88%86%E5%89%B2%E4%BB%BB%E5%8A%A1/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://username.github.io/2022/05/22/%E3%80%8C%E5%88%86%E5%89%B2%E9%A1%B9%E7%9B%AE%E3%80%8D%EF%BC%88%E4%BA%8C%EF%BC%89%E5%9F%BA%E4%BA%8E%E8%87%AA%E5%8A%A8%E9%A9%BE%E9%A9%B6CamVid%E6%95%B0%E6%8D%AE%E9%9B%86%E7%9A%84%E5%88%86%E5%89%B2%E4%BB%BB%E5%8A%A1/","path":"2022/05/22/「分割项目」（二）基于自动驾驶CamVid数据集的分割任务/","title":"「分割项目」（二）基于自动驾驶CamVid数据集的分割任务"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>「分割项目」（二）基于自动驾驶CamVid数据集的分割任务 | 陨石kk的博客</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">陨石kk的博客</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-主页"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>主页</a></li><li class="menu-item menu-item-标签"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-归档"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-关于"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#CamVid%E6%95%B0%E6%8D%AE%E9%9B%86%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.</span> <span class="nav-text">CamVid数据集介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E5%89%B2%E6%A8%A1%E5%9E%8B%E9%80%89%E6%8B%A9"><span class="nav-number">2.</span> <span class="nav-text">分割模型选择</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SegNet"><span class="nav-number">2.1.</span> <span class="nav-text">SegNet</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8A%80%E6%9C%AF%E8%A6%81%E7%82%B9"><span class="nav-number">2.1.1.</span> <span class="nav-text">技术要点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E4%B8%8A%E9%87%87%E6%A0%B7%E7%BB%84%E4%BB%B6"><span class="nav-number">2.1.2.</span> <span class="nav-text">其他上采样组件</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%BB%E6%89%BE%E6%9C%80%E4%BD%B3%E5%AD%A6%E4%B9%A0%E7%8E%87"><span class="nav-number">3.</span> <span class="nav-text">寻找最佳学习率</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A2%AF%E5%BA%A6%E8%A3%81%E5%89%AA"><span class="nav-number">4.</span> <span class="nav-text">梯度裁剪</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A2%AF%E5%BA%A6%E6%BF%80%E5%A2%9E%E9%97%AE%E9%A2%98"><span class="nav-number">4.1.</span> <span class="nav-text">梯度激增问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A2%AF%E5%BA%A6%E8%A3%81%E5%89%AA-1"><span class="nav-number">4.2.</span> <span class="nav-text">梯度裁剪</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99"><span class="nav-number">5.</span> <span class="nav-text">代码编写</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#bins-x2F-lr-range-test-py"><span class="nav-number">5.1.</span> <span class="nav-text">bins&#x2F;lr_range_test.py</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#bins-x2F-segnet-inference-py"><span class="nav-number">5.2.</span> <span class="nav-text">bins&#x2F;segnet_inference.py</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#config-x2F-camvid-config-py"><span class="nav-number">5.3.</span> <span class="nav-text">config&#x2F;camvid_config.py</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#models-x2F-segnet-py"><span class="nav-number">5.4.</span> <span class="nav-text">models&#x2F;segnet.py</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#src-x2F-camvid-train-py"><span class="nav-number">5.5.</span> <span class="nav-text">src&#x2F;camvid_train.py</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#datasets-x2F-camvid-dataset-py"><span class="nav-number">5.6.</span> <span class="nav-text">datasets&#x2F;camvid_dataset.py</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#src-x2F-camvid-train-py-1"><span class="nav-number">5.7.</span> <span class="nav-text">src&#x2F;camvid_train.py</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tools-x2F-common-tools-py"><span class="nav-number">5.8.</span> <span class="nav-text">tools&#x2F;common_tools.py</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tools-x2F-evalution-segmentation-py"><span class="nav-number">5.9.</span> <span class="nav-text">tools&#x2F;evalution_segmentation.py</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tools-x2F-helpers-py"><span class="nav-number">5.10.</span> <span class="nav-text">tools&#x2F;helpers.py</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tools-x2F-model-trainer-py"><span class="nav-number">5.11.</span> <span class="nav-text">tools&#x2F;model_trainer.py</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E8%B7%B5"><span class="nav-number">6.</span> <span class="nav-text">实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%AD%E7%BB%83%E5%8F%82%E6%95%B0"><span class="nav-number">6.1.</span> <span class="nav-text">训练参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%AD%E7%BB%83%E7%BB%93%E6%9E%9C"><span class="nav-number">6.2.</span> <span class="nav-text">训练结果</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="陨石kk"
      src="/uploads/%E5%A4%B4%E5%83%8F.jpg">
  <p class="site-author-name" itemprop="name">陨石kk</p>
  <div class="site-description" itemprop="description">无限进步</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">24</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/zz0320" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zz0320" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zyc160378629@gmail.com" title="E-Mail → mailto:zyc160378629@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://username.github.io/2022/05/22/%E3%80%8C%E5%88%86%E5%89%B2%E9%A1%B9%E7%9B%AE%E3%80%8D%EF%BC%88%E4%BA%8C%EF%BC%89%E5%9F%BA%E4%BA%8E%E8%87%AA%E5%8A%A8%E9%A9%BE%E9%A9%B6CamVid%E6%95%B0%E6%8D%AE%E9%9B%86%E7%9A%84%E5%88%86%E5%89%B2%E4%BB%BB%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/%E5%A4%B4%E5%83%8F.jpg">
      <meta itemprop="name" content="陨石kk">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="陨石kk的博客">
      <meta itemprop="description" content="无限进步">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="「分割项目」（二）基于自动驾驶CamVid数据集的分割任务 | 陨石kk的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          「分割项目」（二）基于自动驾驶CamVid数据集的分割任务
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-05-22 16:00:00" itemprop="dateCreated datePublished" datetime="2022-05-22T16:00:00+08:00">2022-05-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-05-23 15:15:55" itemprop="dateModified" datetime="2022-05-23T15:15:55+08:00">2022-05-23</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="CamVid数据集介绍"><a href="#CamVid数据集介绍" class="headerlink" title="CamVid数据集介绍"></a>CamVid数据集介绍</h2><p>CamVid驾驶场景数据集，收集了701张驾驶场景语义分割图像，划分为<strong>训练</strong>、<strong>验证</strong>和<strong>测试</strong>，分别有367、101和233个样本</p>
<img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hbmhcm0wj20tx0k0dj5.jpg" style="zoom:67%;">

<span id="more"></span>

<h2 id="分割模型选择"><a href="#分割模型选择" class="headerlink" title="分割模型选择"></a>分割模型选择</h2><h3 id="SegNet"><a href="#SegNet" class="headerlink" title="SegNet"></a>SegNet</h3><h4 id="技术要点"><a href="#技术要点" class="headerlink" title="技术要点"></a>技术要点</h4><p>VGG16 / Encoder-Decoder / 带索引的最大池化上采样</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2he3khqu6j20zk0bkdig.jpg"></p>
<p>带索引的最大池化上采样：记录下采样过程的indices，在上采样过程中使用，以提供位置信息</p>
<img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2he43aq3jj20zk0dfgn0.jpg" style="zoom:67%;">

<h4 id="其他上采样组件"><a href="#其他上采样组件" class="headerlink" title="其他上采样组件"></a>其他上采样组件</h4><p>UnPooling：反池化，带索引的反池化</p>
<p>插值运算：最近邻插值，双线性插值，双三次插值等</p>
<p>Transposed conv: 转置卷积，卷积核矩阵的shape进行了转置而得名</p>
<h2 id="寻找最佳学习率"><a href="#寻找最佳学习率" class="headerlink" title="寻找最佳学习率"></a>寻找最佳学习率</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://arxiv.org/abs/1506.01186">参考文章《Cyclical Learning Rates for Training Neural Networks》</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/vmbbc/pytorch-lr-finder">参考代码</a></p>
</blockquote>
<p>文章中提出了一种寻找最优学习率的方法，可适用于各类神经网络的初始学习率设置每个Iteration逐渐增加学习率，观察loss的变化选择一个损失下降最快的点对应的学习率</p>
<p>选择一个<strong>损失下降最快点对应的LR</strong>：观察Loss 梯度，得到梯度滑动平均图，找到下降最快的地方，从下图例可知道0.01的LR是对应损失下降最快的LR</p>
<table>
<thead>
<tr>
<th>Loss梯度图</th>
<th>Loss梯度滑动平均图</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2heg5db1gj20v30k00uw.jpg"></td>
<td><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2heiokcisj20u90k00tn.jpg"></td>
</tr>
</tbody></table>
<p>下图为SegNet在CamVid上的区间测试结果</p>
<p>LR Finder会自动计算最优学习率为<strong>steepest gradient（陡峭的梯度）</strong></p>
<p>对应的学习率为<strong>Suggested LR: 4.33E-01</strong></p>
<img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hei5y43jj20ql0k03z8.jpg" style="zoom: 50%;">



<h2 id="梯度裁剪"><a href="#梯度裁剪" class="headerlink" title="梯度裁剪"></a>梯度裁剪</h2><h3 id="梯度激增问题"><a href="#梯度激增问题" class="headerlink" title="梯度激增问题"></a>梯度激增问题</h3><p>训练SegResnet-50过程中有时候会出现loss激增的现象，通常是因为出现梯度过大导致的不稳定，可通过梯度裁剪来稳定模型训练</p>
<table>
<thead>
<tr>
<th><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hexbngo5j20qo0k0mxs.jpg"></th>
<th><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hexgdedtj20qo0k0t9k.jpg"></th>
</tr>
</thead>
</table>
<h3 id="梯度裁剪-1"><a href="#梯度裁剪-1" class="headerlink" title="梯度裁剪"></a>梯度裁剪</h3><p>PyTorch提供了两个梯度裁剪函数</p>
<p>clip_grad_norm_ ：Clips gradient norm of an iterable of parameters.</p>
<p>clip_grad_value_ :Clips gradient of an iterable of parameters at specified value.</p>
<p>裁剪思路：统计模型训练过程中的梯度的直方图，设定clip的阈值</p>
<p>例：clip_value :0.5，0.3仍激增</p>
<p>当调整为0.2时如下所示，mIoU从0.6025下降到0.5982</p>
<table>
<thead>
<tr>
<th><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hf0z7oxdj20qo0k0gly.jpg"></th>
<th><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hf140i1tj20qo0k03z4.jpg"></th>
<th><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h2hf192jy2j20qo0k0q3p.jpg"></th>
</tr>
</thead>
</table>
<h2 id="代码编写"><a href="#代码编写" class="headerlink" title="代码编写"></a>代码编写</h2><h3 id="bins-x2F-lr-range-test-py"><a href="#bins-x2F-lr-range-test-py" class="headerlink" title="bins/lr_range_test.py"></a>bins/lr_range_test.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string"># @file name  : lr_range_test.py</span></span><br><span class="line"><span class="string"># @author     : zz0320</span></span><br><span class="line"><span class="string"># @date       : 2022-04-17</span></span><br><span class="line"><span class="string"># @brief      : lr 区间测试脚本</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">import</span> matplotlib</span><br><span class="line"><span class="comment"># matplotlib.use('agg')</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">BASE_DIR = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">sys.path.append(os.path.join(BASE_DIR, <span class="string">'..'</span>))</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> torch.optim <span class="keyword">as</span> optim</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> DataLoader</span><br><span class="line"><span class="keyword">from</span> datasets.camvid_dataset <span class="keyword">import</span> CamvidDataset</span><br><span class="line"><span class="keyword">from</span> tools.common_tools <span class="keyword">import</span> setup_seed, show_confMat, plot_line, Logger, check_data_dir</span><br><span class="line"><span class="keyword">from</span> config.camvid_config <span class="keyword">import</span> cfg</span><br><span class="line"><span class="keyword">from</span> models.deeplabv3_plus <span class="keyword">import</span> DeepLabV3Plus</span><br><span class="line"><span class="keyword">from</span> models.unet <span class="keyword">import</span> UNet, UNetResnet</span><br><span class="line"><span class="keyword">from</span> models.segnet <span class="keyword">import</span> SegNet, SegResNet</span><br><span class="line"><span class="keyword">from</span> torch_lr_finder <span class="keyword">import</span> LRFinder</span><br><span class="line"></span><br><span class="line">setup_seed(<span class="number">12345</span>)  <span class="comment"># 先固定随机种子</span></span><br><span class="line"></span><br><span class="line">parser = argparse.ArgumentParser(description=<span class="string">'Training'</span>)</span><br><span class="line">parser.add_argument(<span class="string">'--lr'</span>, default=<span class="literal">None</span>, <span class="built_in">help</span>=<span class="string">'learning rate'</span>, <span class="built_in">type</span>=<span class="built_in">float</span>)</span><br><span class="line">parser.add_argument(<span class="string">'--max_epoch'</span>, default=<span class="literal">None</span>)</span><br><span class="line">parser.add_argument(<span class="string">'--train_bs'</span>, default=<span class="number">0</span>, <span class="built_in">type</span>=<span class="built_in">int</span>)</span><br><span class="line">parser.add_argument(<span class="string">'--data_root_dir'</span>, default=<span class="string">r"/Users/kenton/Downloads/deeplearning_dataset/camvid_from_paper"</span>,</span><br><span class="line">                    <span class="built_in">help</span>=<span class="string">"path to your dataset"</span>)</span><br><span class="line">args = parser.parse_args()</span><br><span class="line">cfg.lr_init = args.lr <span class="keyword">if</span> args.lr <span class="keyword">else</span> cfg.lr_init</span><br><span class="line">cfg.train_bs = args.train_bs <span class="keyword">if</span> args.train_bs <span class="keyword">else</span> cfg.train_bs</span><br><span class="line">cfg.max_epoch = args.max_epoch <span class="keyword">if</span> args.max_epoch <span class="keyword">else</span> cfg.max_epoch</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># 设置路径</span></span><br><span class="line">    path_model_50 = <span class="string">"/Users/kenton/Downloads/deeplearning_dataset/pretrain_model/resnet50-19c8e357.pth"</span> <span class="comment"># segnet</span></span><br><span class="line">    path_model_101 = <span class="string">"/Users/kenton/Downloads/deeplearning_dataset/pretrain_model/resnet101s-03a0f310.pth"</span>  <span class="comment"># deeplab</span></span><br><span class="line">    path_model_50s = <span class="string">"/Users/kenton/Downloads/deeplearning_dataset/pretrain_model/resnet50s-a75c83cf.pth"</span>  <span class="comment"># unet</span></span><br><span class="line">    path_model_vgg = <span class="string">"/Users/kenton/Downloads/deeplearning_dataset/pretrain_model/vgg16_bn-6c64b313.pth"</span></span><br><span class="line">    <span class="comment"># ------------------------------------ step 1/5 : 加载数据------------------------------------</span></span><br><span class="line">    <span class="comment"># 构建Dataset实例</span></span><br><span class="line">    root_dir = args.data_root_dir</span><br><span class="line">    train_img_dir = os.path.join(root_dir, <span class="string">'train'</span>)</span><br><span class="line">    train_lable_dir = os.path.join(root_dir, <span class="string">'train_labels'</span>)</span><br><span class="line">    path_to_dict = os.path.join(root_dir, <span class="string">'class_dict.csv'</span>)</span><br><span class="line">    check_data_dir(train_img_dir)</span><br><span class="line">    check_data_dir(train_lable_dir)</span><br><span class="line"></span><br><span class="line">    train_set = CamvidDataset(train_img_dir, train_lable_dir, path_to_dict, cfg.crop_size)</span><br><span class="line"></span><br><span class="line">    train_loader = DataLoader(train_set, batch_size=cfg.train_bs, shuffle=<span class="literal">True</span>, num_workers=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ------------------------------------ step 2/5 : 定义网络------------------------------------</span></span><br><span class="line">    model = SegNet(num_classes=train_set.cls_num, path_model=path_model_vgg)</span><br><span class="line">    <span class="comment"># model = SegResNet(num_classes=train_set.cls_num, path_model=None)</span></span><br><span class="line">    <span class="comment"># model = UNet(num_classes=train_set.cls_num)</span></span><br><span class="line">    <span class="comment"># model = DeepLabV3Plus(num_classes=train_set.cls_num, path_model=path_model)</span></span><br><span class="line">    model.to(cfg.device)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ------------------------------------ step 3/5 : 定义损失函数和优化器 ------------------------------------</span></span><br><span class="line">    loss_f = nn.CrossEntropyLoss().to(cfg.device)</span><br><span class="line">    optimizer = optim.SGD(model.parameters(), lr=<span class="number">1e-3</span>, weight_decay=<span class="number">1e-4</span>)</span><br><span class="line">    <span class="comment"># ------------------------------------ step 4/5 : 训练 --------------------------------------------------</span></span><br><span class="line">    <span class="comment"># 接口：data loader、model、optimizer、loss_f</span></span><br><span class="line">    lr_finder = LRFinder(model, optimizer, loss_f, device=cfg.device)</span><br><span class="line">    lr_finder.range_test(train_loader, end_lr=<span class="number">100</span>, num_iter=<span class="number">100</span>)</span><br><span class="line">    lr_finder.plot()  <span class="comment"># to inspect the loss-learning rate graph</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="bins-x2F-segnet-inference-py"><a href="#bins-x2F-segnet-inference-py" class="headerlink" title="bins/segnet_inference.py"></a>bins/segnet_inference.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string"># @file name  : segnet_inference.py</span></span><br><span class="line"><span class="string"># @author     : zz0320</span></span><br><span class="line"><span class="string"># @date       : 2022-04-17</span></span><br><span class="line"><span class="string"># @brief      : 前向推理代码 + 结果输出</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> matplotlib</span><br><span class="line"><span class="comment"># matplotlib.use('agg')</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">BASE_DIR = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">sys.path.append(os.path.join(BASE_DIR, <span class="string">'..'</span>))</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> models.segnet <span class="keyword">import</span> SegResNet</span><br><span class="line"><span class="keyword">import</span> torchvision.transforms <span class="keyword">as</span> transforms</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line">device = torch.device(<span class="string">"cuda"</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">'cpu'</span>)</span><br><span class="line"></span><br><span class="line">parser = argparse.ArgumentParser(description=<span class="string">'Inference'</span>)</span><br><span class="line">parser.add_argument(<span class="string">'--path_checkpoint'</span>,</span><br><span class="line">    default=<span class="string">r"/Users/kenton/Downloads/terminal_download/results/04-18_08-23/checkpoint_best.pkl"</span>,</span><br><span class="line">    <span class="built_in">help</span> = <span class="string">'path to your dataset'</span>)</span><br><span class="line">parser.add_argument(<span class="string">'--path_img'</span>, default=<span class="string">r"/Users/kenton/Downloads/deeplearning_dataset/camvid_from_paper/test/Seq05VD_f00210.png"</span>,</span><br><span class="line">                    <span class="built_in">help</span>=<span class="string">"path to your dataset"</span>)</span><br><span class="line">parser.add_argument(<span class="string">'--path_csv'</span>, default=<span class="string">r"/Users/kenton/Downloads/deeplearning_dataset/camvid_from_paper/class_dict.csv"</span>,</span><br><span class="line">                    <span class="built_in">help</span>=<span class="string">"path to your csv"</span>)</span><br><span class="line">args = parser.parse_args()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># 图片预处理</span></span><br><span class="line">    transform_img = transforms.Compose([</span><br><span class="line">        transforms.ToTensor(),</span><br><span class="line">        transforms.Normalize([<span class="number">0.485</span>, <span class="number">0.456</span>, <span class="number">0.406</span>], [<span class="number">0.229</span>, <span class="number">0.224</span>, <span class="number">0.225</span>])</span><br><span class="line">    ])</span><br><span class="line">    img = Image.<span class="built_in">open</span>(args.path_img)</span><br><span class="line">    img_tensor = transform_img(img)</span><br><span class="line">    img_tensor.unsqueeze_(<span class="number">0</span>)</span><br><span class="line">    img_tensor = img_tensor.to(device)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 模型加载</span></span><br><span class="line">    model = SegResNet(num_classes=<span class="number">12</span>)</span><br><span class="line">    checkpoint = torch.load(args.path_checkpoint, map_location=<span class="string">'cpu'</span>)</span><br><span class="line"></span><br><span class="line">    model.load_state_dict(checkpoint[<span class="string">"model_state_dict"</span>])</span><br><span class="line">    model.to(device)</span><br><span class="line"></span><br><span class="line">    model.<span class="built_in">eval</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 推理</span></span><br><span class="line">    <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">        outputs = model(img_tensor)</span><br><span class="line">    outputs = torch.<span class="built_in">max</span>(outputs, dim=<span class="number">1</span>)</span><br><span class="line">    pre_label = outputs[<span class="number">1</span>].squeeze().cpu().data.numpy()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 结果展示</span></span><br><span class="line">    pd_label_color = pd.read_csv(args.path_csv, sep=<span class="string">','</span>)</span><br><span class="line">    name_value = pd_label_color[<span class="string">'name'</span>].values</span><br><span class="line">    num_class = <span class="built_in">len</span>(name_value)</span><br><span class="line">    colormap = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_class):</span><br><span class="line">        tmp = pd_label_color.iloc[i]</span><br><span class="line">        color = [tmp[<span class="string">'r'</span>], tmp[<span class="string">'g'</span>], tmp[<span class="string">'b'</span>]]</span><br><span class="line">        colormap.append(color)</span><br><span class="line"></span><br><span class="line">    cm = np.array(colormap).astype(<span class="string">'uint8'</span>)</span><br><span class="line">    pre = cm[pre_label]</span><br><span class="line">    pre1 = Image.fromarray(pre)</span><br><span class="line"></span><br><span class="line">    plt.subplot(<span class="number">121</span>)</span><br><span class="line">    plt.imshow(pre1)</span><br><span class="line">    plt.subplot(<span class="number">122</span>)</span><br><span class="line">    plt.imshow(img)</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 展示图例</span></span><br><span class="line">    height = <span class="number">20</span></span><br><span class="line">    fake_img = np.zeros((height*<span class="number">12</span>, <span class="number">100</span>, <span class="number">3</span>), dtype=np.uint8)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_class):</span><br><span class="line">        tmp = pd_label_color.iloc[i]</span><br><span class="line">        color = [tmp[<span class="string">'r'</span>], tmp[<span class="string">'g'</span>], tmp[<span class="string">'b'</span>]]</span><br><span class="line">        fake_img[height*i:height*(i+<span class="number">1</span>), :, :] = color</span><br><span class="line"></span><br><span class="line">    plt.imshow(fake_img)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_class):</span><br><span class="line">        name = pd_label_color[<span class="string">"name"</span>][i]</span><br><span class="line">        plt.text(<span class="number">10</span>, <span class="number">15</span> + height*i, name)</span><br><span class="line">    plt.show()</span><br></pre></td></tr></table></figure>

<h3 id="config-x2F-camvid-config-py"><a href="#config-x2F-camvid-config-py" class="headerlink" title="config/camvid_config.py"></a>config/camvid_config.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string"># @file name  : camvid_config.py</span></span><br><span class="line"><span class="string"># @author     : zz0320</span></span><br><span class="line"><span class="string"># @date       : 2022-03-12</span></span><br><span class="line"><span class="string"># @brief      : camvid分割参数配置</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> easydict <span class="keyword">import</span> EasyDict</span><br><span class="line"></span><br><span class="line">cfg = EasyDict()  <span class="comment"># 访问属性的方式去使用key-value 即通过 .key获得value</span></span><br><span class="line"></span><br><span class="line">cfg.device = torch.device(<span class="string">"cuda"</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">"cpu"</span>)</span><br><span class="line">cfg.max_epoch = <span class="number">150</span>  <span class="comment"># 150</span></span><br><span class="line"></span><br><span class="line">cfg.crop_size = (<span class="number">360</span>, <span class="number">480</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># batch size</span></span><br><span class="line">cfg.train_bs = <span class="number">2</span>  <span class="comment"># 8</span></span><br><span class="line">cfg.valid_bs = <span class="number">1</span>    <span class="comment"># 4</span></span><br><span class="line">cfg.workers = <span class="number">1</span>  <span class="comment"># 16</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 学习率</span></span><br><span class="line">cfg.lr_init = <span class="number">0.1</span>  <span class="comment"># pretraied_model::0.1</span></span><br><span class="line">cfg.factor = <span class="number">0.1</span></span><br><span class="line">cfg.milestones = [<span class="number">75</span>, <span class="number">130</span>]</span><br><span class="line">cfg.weight_decay = <span class="number">1e-4</span></span><br><span class="line">cfg.momentum = <span class="number">0.9</span></span><br><span class="line"></span><br><span class="line">cfg.log_interval = <span class="number">10</span></span><br></pre></td></tr></table></figure>

<h3 id="models-x2F-segnet-py"><a href="#models-x2F-segnet-py" class="headerlink" title="models/segnet.py"></a>models/segnet.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string"># @file name  : segnet.py</span></span><br><span class="line"><span class="string"># @author     : zz0320</span></span><br><span class="line"><span class="string"># @date       : 2022-4-16</span></span><br><span class="line"><span class="string"># @brief      : segnet网络架构</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"><span class="keyword">from</span> torchvision <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line"><span class="keyword">from</span> math <span class="keyword">import</span> ceil</span><br><span class="line"><span class="keyword">from</span> tools.helpers <span class="keyword">import</span> set_trainable</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SegNet</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, num_classes, in_channels=<span class="number">3</span>, freeze_bn=<span class="literal">False</span>,</span></span><br><span class="line"><span class="params">        freeze_backbone=<span class="literal">False</span>, path_model=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(SegNet, self).__init__()</span><br><span class="line">        vgg_bn = models.vgg16_bn()</span><br><span class="line">        <span class="keyword">if</span> path_model:</span><br><span class="line">            vgg_bn.load_state_dict(torch.load(path_model, map_location=<span class="string">'cpu'</span>))</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"load pretrain model done!"</span>)</span><br><span class="line"></span><br><span class="line">        encoder = <span class="built_in">list</span>(vgg_bn.features.children())</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Adjust the input size</span></span><br><span class="line">        <span class="keyword">if</span> in_channels != <span class="number">3</span>:</span><br><span class="line">            encoder[<span class="number">0</span>] = nn.Conv2d(in_channels, <span class="number">64</span>, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Encoder, VGG without any maxpooling</span></span><br><span class="line">        self.stage1_encoder = nn.Sequential(*encoder[:<span class="number">6</span>])</span><br><span class="line">        self.stage2_encoder = nn.Sequential(*encoder[<span class="number">7</span>:<span class="number">13</span>])</span><br><span class="line">        self.stage3_encoder = nn.Sequential(*encoder[<span class="number">14</span>:<span class="number">23</span>])</span><br><span class="line">        self.stage4_encoder = nn.Sequential(*encoder[<span class="number">24</span>:<span class="number">33</span>])</span><br><span class="line">        self.stage5_encoder = nn.Sequential(*encoder[<span class="number">34</span>:-<span class="number">1</span>])</span><br><span class="line">        self.pool = nn.MaxPool2d(kernel_size=<span class="number">2</span>, stride=<span class="number">2</span>, return_indices=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Decoder, same as the encoder but reversed, maxpool will not be used</span></span><br><span class="line">        decoder = encoder</span><br><span class="line">        decoder = [i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">list</span>(<span class="built_in">reversed</span>(decoder)) <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(i, nn.MaxPool2d)]</span><br><span class="line">        <span class="comment"># Replace the last conv layer</span></span><br><span class="line">        decoder[-<span class="number">1</span>] = nn.Conv2d(<span class="number">64</span>, <span class="number">64</span>, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># When reversing, we also reversed conv-&gt;batchN-&gt;relu, correct it</span></span><br><span class="line">        decoder = [item <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(decoder), <span class="number">3</span>) <span class="keyword">for</span> item <span class="keyword">in</span> decoder[i:i + <span class="number">3</span>][::-<span class="number">1</span>]]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Replace some conv layers &amp; batchN after them</span></span><br><span class="line">        <span class="keyword">for</span> i, module <span class="keyword">in</span> <span class="built_in">enumerate</span>(decoder):</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(module, nn.Conv2d):</span><br><span class="line">                <span class="keyword">if</span> module.in_channels != module.out_channels:</span><br><span class="line">                    decoder[i + <span class="number">1</span>] = nn.BatchNorm2d(module.in_channels)</span><br><span class="line">                    decoder[i] = nn.Conv2d(module.out_channels, module.in_channels, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        self.stage1_decoder = nn.Sequential(*decoder[<span class="number">0</span>:<span class="number">9</span>])</span><br><span class="line">        self.stage2_decoder = nn.Sequential(*decoder[<span class="number">9</span>:<span class="number">18</span>])</span><br><span class="line">        self.stage3_decoder = nn.Sequential(*decoder[<span class="number">18</span>:<span class="number">27</span>])</span><br><span class="line">        self.stage4_decoder = nn.Sequential(*decoder[<span class="number">27</span>:<span class="number">33</span>])</span><br><span class="line">        self.stage5_decoder = nn.Sequential(*decoder[<span class="number">33</span>:],</span><br><span class="line">                                            nn.Conv2d(<span class="number">64</span>, num_classes, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">1</span>)</span><br><span class="line">                                            )</span><br><span class="line">        self.unpool = nn.MaxUnpool2d(kernel_size=<span class="number">2</span>, stride=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">        self._initialize_weights(self.stage1_decoder, self.stage2_decoder, self.stage3_decoder,</span><br><span class="line">                                 self.stage4_decoder, self.stage5_decoder)</span><br><span class="line">        <span class="keyword">if</span> freeze_bn:</span><br><span class="line">            self.freeze_bn()</span><br><span class="line">        <span class="keyword">if</span> freeze_backbone:</span><br><span class="line">            set_trainable([self.stage1_encoder, self.stage2_encoder, self.stage3_encoder, self.stage4_encoder,</span><br><span class="line">                           self.stage5_encoder], <span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_initialize_weights</span>(<span class="params">self, *stages</span>):</span><br><span class="line">        <span class="keyword">for</span> modules <span class="keyword">in</span> stages:</span><br><span class="line">            <span class="keyword">for</span> module <span class="keyword">in</span> modules.modules():</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">isinstance</span>(module, nn.Conv2d):</span><br><span class="line">                    nn.init.kaiming_normal_(module.weight)</span><br><span class="line">                    <span class="keyword">if</span> module.bias <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                        module.bias.data.zero_()</span><br><span class="line">                <span class="keyword">elif</span> <span class="built_in">isinstance</span>(module, nn.BatchNorm2d):</span><br><span class="line">                    module.weight.data.fill_(<span class="number">1</span>)</span><br><span class="line">                    module.bias.data.zero_()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">freeze_bn</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">for</span> module <span class="keyword">in</span> self.modules():</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(module, nn.BatchNorm2d):</span><br><span class="line">                module.<span class="built_in">eval</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="comment"># Encoder</span></span><br><span class="line">        x = self.stage1_encoder(x)</span><br><span class="line">        x1_size = x.size()</span><br><span class="line">        x, indices1 = self.pool(x)</span><br><span class="line"></span><br><span class="line">        x = self.stage2_encoder(x)</span><br><span class="line">        x2_size = x.size()</span><br><span class="line">        x, indices2 = self.pool(x)</span><br><span class="line"></span><br><span class="line">        x = self.stage3_encoder(x)</span><br><span class="line">        x3_size = x.size()</span><br><span class="line">        x, indices3 = self.pool(x)</span><br><span class="line"></span><br><span class="line">        x = self.stage4_encoder(x)</span><br><span class="line">        x4_size = x.size()</span><br><span class="line">        x, indices4 = self.pool(x)</span><br><span class="line"></span><br><span class="line">        x = self.stage5_encoder(x)</span><br><span class="line">        x5_size = x.size()</span><br><span class="line">        x, indices5 = self.pool(x)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Decoder</span></span><br><span class="line">        x = self.unpool(x, indices=indices5, output_size=x5_size)</span><br><span class="line">        x = self.stage1_decoder(x)</span><br><span class="line"></span><br><span class="line">        x = self.unpool(x, indices=indices4, output_size=x4_size)</span><br><span class="line">        x = self.stage2_decoder(x)</span><br><span class="line"></span><br><span class="line">        x = self.unpool(x, indices=indices3, output_size=x3_size)</span><br><span class="line">        x = self.stage3_decoder(x)</span><br><span class="line"></span><br><span class="line">        x = self.unpool(x, indices=indices2, output_size=x2_size)</span><br><span class="line">        x = self.stage4_decoder(x)</span><br><span class="line"></span><br><span class="line">        x = self.unpool(x, indices=indices1, output_size=x1_size)</span><br><span class="line">        x = self.stage5_decoder(x)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DecoderBottleneck</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, inchannels</span>):</span><br><span class="line">        <span class="built_in">super</span>(DecoderBottleneck, self).__init__()</span><br><span class="line">        self.conv1 = nn.Conv2d(inchannels, inchannels//<span class="number">4</span>, kernel_size=<span class="number">1</span>, bias=<span class="literal">False</span>)</span><br><span class="line">        self.bn1 = nn.BatchNorm2d(inchannels//<span class="number">4</span>)</span><br><span class="line">        self.conv2 = nn.ConvTranspose2d(inchannels//<span class="number">4</span>, inchannels//<span class="number">4</span>, kernel_size=<span class="number">2</span>, stride=<span class="number">2</span>, bias=<span class="literal">False</span>)</span><br><span class="line">        self.bn2 = nn.BatchNorm2d(inchannels//<span class="number">4</span>)</span><br><span class="line">        self.conv3 = nn.Conv2d(inchannels//<span class="number">4</span>, inchannels//<span class="number">2</span>, <span class="number">1</span>, bias=<span class="literal">False</span>)</span><br><span class="line">        self.bn3 = nn.BatchNorm2d(inchannels//<span class="number">2</span>)</span><br><span class="line">        self.relu = nn.ReLU(inplace=<span class="literal">True</span>)</span><br><span class="line">        self.downsample = nn.Sequential(</span><br><span class="line">                nn.ConvTranspose2d(inchannels, inchannels//<span class="number">2</span>, kernel_size=<span class="number">2</span>, stride=<span class="number">2</span>, bias=<span class="literal">False</span>),</span><br><span class="line">                nn.BatchNorm2d(inchannels//<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        out = self.conv1(x)</span><br><span class="line">        out = self.bn1(out)</span><br><span class="line">        out = self.relu(out)</span><br><span class="line">        out = self.conv2(out)</span><br><span class="line">        out = self.bn2(out)</span><br><span class="line">        out = self.relu(out)</span><br><span class="line">        out = self.conv3(out)</span><br><span class="line">        out = self.bn3(out)</span><br><span class="line"></span><br><span class="line">        identity = self.downsample(x)</span><br><span class="line">        out += identity</span><br><span class="line">        out = self.relu(out)</span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LastBottleneck</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, inchannels</span>):</span><br><span class="line">        <span class="built_in">super</span>(LastBottleneck, self).__init__()</span><br><span class="line">        self.conv1 = nn.Conv2d(inchannels, inchannels // <span class="number">4</span>, kernel_size=<span class="number">1</span>, bias=<span class="literal">False</span>)</span><br><span class="line">        self.bn1 = nn.BatchNorm2d(inchannels // <span class="number">4</span>)</span><br><span class="line">        self.conv2 = nn.Conv2d(inchannels // <span class="number">4</span>, inchannels // <span class="number">4</span>, kernel_size=<span class="number">3</span>, padding=<span class="number">1</span>, bias=<span class="literal">False</span>)</span><br><span class="line">        self.bn2 = nn.BatchNorm2d(inchannels // <span class="number">4</span>)</span><br><span class="line">        self.conv3 = nn.Conv2d(inchannels // <span class="number">4</span>, inchannels // <span class="number">4</span>, <span class="number">1</span>, bias=<span class="literal">False</span>)</span><br><span class="line">        self.bn3 = nn.BatchNorm2d(inchannels // <span class="number">4</span>)</span><br><span class="line">        self.relu = nn.ReLU(inplace=<span class="literal">True</span>)</span><br><span class="line">        self.downsample = nn.Sequential(</span><br><span class="line">            nn.Conv2d(inchannels, inchannels // <span class="number">4</span>, kernel_size=<span class="number">1</span>, bias=<span class="literal">False</span>),</span><br><span class="line">            nn.BatchNorm2d(inchannels // <span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        out = self.conv1(x)</span><br><span class="line">        out = self.bn1(out)</span><br><span class="line">        out = self.relu(out)</span><br><span class="line">        out = self.conv2(out)</span><br><span class="line">        out = self.bn2(out)</span><br><span class="line">        out = self.relu(out)</span><br><span class="line">        out = self.conv3(out)</span><br><span class="line">        out = self.bn3(out)</span><br><span class="line"></span><br><span class="line">        identity = self.downsample(x)</span><br><span class="line">        out += identity</span><br><span class="line">        out = self.relu(out)</span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SegResNet</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, num_classes, in_channels=<span class="number">3</span>, freeze_bn=<span class="literal">False</span>, path_model=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(SegResNet, self).__init__()</span><br><span class="line">        resnet101 = models.resnet101()</span><br><span class="line">        <span class="keyword">if</span> path_model:</span><br><span class="line">            resnet101.load_state_dict(torch.load(path_model, map_location=<span class="string">"cpu"</span>))</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"load pretrain model done!"</span>)</span><br><span class="line"></span><br><span class="line">        encoder = <span class="built_in">list</span>(resnet101.children())</span><br><span class="line">        <span class="keyword">if</span> in_channels != <span class="number">3</span>:</span><br><span class="line">            encoder[<span class="number">0</span>] = nn.Conv2d(in_channels, <span class="number">64</span>, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">1</span>)</span><br><span class="line">        encoder[<span class="number">3</span>].return_indices = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Encoder</span></span><br><span class="line">        self.first_conv = nn.Sequential(*encoder[:<span class="number">4</span>])</span><br><span class="line">        resnet101_blocks = <span class="built_in">list</span>(resnet101.children())[<span class="number">4</span>:-<span class="number">2</span>]</span><br><span class="line">        self.encoder = nn.Sequential(*resnet101_blocks)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Decoder</span></span><br><span class="line">        resnet101_untrained = models.resnet101(pretrained=<span class="literal">False</span>)</span><br><span class="line">        resnet101_blocks = <span class="built_in">list</span>(resnet101_untrained.children())[<span class="number">4</span>:-<span class="number">2</span>][::-<span class="number">1</span>]</span><br><span class="line">        decoder = []</span><br><span class="line">        channels = (<span class="number">2048</span>, <span class="number">1024</span>, <span class="number">512</span>)</span><br><span class="line">        <span class="keyword">for</span> i, block <span class="keyword">in</span> <span class="built_in">enumerate</span>(resnet101_blocks[:-<span class="number">1</span>]):</span><br><span class="line">            new_block = <span class="built_in">list</span>(block.children())[::-<span class="number">1</span>][:-<span class="number">1</span>]</span><br><span class="line">            decoder.append(nn.Sequential(*new_block, DecoderBottleneck(channels[i])))</span><br><span class="line">        new_block = <span class="built_in">list</span>(resnet101_blocks[-<span class="number">1</span>].children())[::-<span class="number">1</span>][:-<span class="number">1</span>]</span><br><span class="line">        decoder.append(nn.Sequential(*new_block, LastBottleneck(<span class="number">256</span>)))</span><br><span class="line"></span><br><span class="line">        self.decoder = nn.Sequential(*decoder)</span><br><span class="line">        self.last_conv = nn.Sequential(</span><br><span class="line">            nn.ConvTranspose2d(<span class="number">64</span>, <span class="number">64</span>, kernel_size=<span class="number">2</span>, stride=<span class="number">2</span>, bias=<span class="literal">False</span>),</span><br><span class="line">            nn.Conv2d(<span class="number">64</span>, num_classes, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">1</span>)</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">if</span> freeze_bn:</span><br><span class="line">            self.freeze_bn()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        inputsize = x.size()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Encoder</span></span><br><span class="line">        x, indices = self.first_conv(x)</span><br><span class="line">        x = self.encoder(x)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Decoder</span></span><br><span class="line">        x = self.decoder(x)</span><br><span class="line">        h_diff = ceil((x.size()[<span class="number">2</span>] - indices.size()[<span class="number">2</span>]) / <span class="number">2</span>)</span><br><span class="line">        w_diff = ceil((x.size()[<span class="number">3</span>] - indices.size()[<span class="number">3</span>]) / <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">if</span> indices.size()[<span class="number">2</span>] % <span class="number">2</span> == <span class="number">1</span>:</span><br><span class="line">            x = x[:, :, h_diff:x.size()[<span class="number">2</span>] - (h_diff - <span class="number">1</span>), w_diff: x.size()[<span class="number">3</span>] - (w_diff - <span class="number">1</span>)]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            x = x[:, :, h_diff:x.size()[<span class="number">2</span>] - h_diff, w_diff: x.size()[<span class="number">3</span>] - w_diff]</span><br><span class="line"></span><br><span class="line">        x = F.max_unpool2d(x, indices, kernel_size=<span class="number">2</span>, stride=<span class="number">2</span>)</span><br><span class="line">        x = self.last_conv(x)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> inputsize != x.size():</span><br><span class="line">            h_diff = (x.size()[<span class="number">2</span>] - inputsize[<span class="number">2</span>]) // <span class="number">2</span></span><br><span class="line">            w_diff = (x.size()[<span class="number">3</span>] - inputsize[<span class="number">3</span>]) // <span class="number">2</span></span><br><span class="line">            x = x[:, :, h_diff:x.size()[<span class="number">2</span>] - h_diff, w_diff: x.size()[<span class="number">3</span>] - w_diff]</span><br><span class="line">            <span class="keyword">if</span> h_diff % <span class="number">2</span> != <span class="number">0</span>: x = x[:, :, :-<span class="number">1</span>, :]</span><br><span class="line">            <span class="keyword">if</span> w_diff % <span class="number">2</span> != <span class="number">0</span>: x = x[:, :, :, :-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">freeze_bn</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">for</span> module <span class="keyword">in</span> self.modules():</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(module, nn.BatchNorm2d): module.<span class="built_in">eval</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    fake_img = torch.randn((<span class="number">2</span>, <span class="number">3</span>, <span class="number">224</span>, <span class="number">224</span>))</span><br><span class="line"></span><br><span class="line">    model = SegNet(num_classes=<span class="number">21</span>, path_model=<span class="number">0</span>)</span><br><span class="line">    <span class="comment"># model = SegResNet(num_classes=12)</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    output = model(fake_img)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(output.shape)</span><br></pre></td></tr></table></figure>

<h3 id="src-x2F-camvid-train-py"><a href="#src-x2F-camvid-train-py" class="headerlink" title="src/camvid_train.py"></a>src/camvid_train.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string"># @file name  : camvid_train.py</span></span><br><span class="line"><span class="string"># @author     : zz0320</span></span><br><span class="line"><span class="string"># @date       : 2022-4-16</span></span><br><span class="line"><span class="string"># @brief      : 模型训练主代码</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> matplotlib</span><br><span class="line"><span class="comment"># matplotlib.use('agg')</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">BASE_DIR = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">sys.path.append(os.path.join(BASE_DIR, <span class="string">'..'</span>))</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> torch.optim <span class="keyword">as</span> optim</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> DataLoader</span><br><span class="line"><span class="keyword">from</span> datasets.camvid_dataset <span class="keyword">import</span> CamvidDataset</span><br><span class="line"><span class="keyword">from</span> tools.model_trainer <span class="keyword">import</span> ModelTrainer</span><br><span class="line"><span class="keyword">from</span> tools.common_tools <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> config.camvid_config <span class="keyword">import</span> cfg</span><br><span class="line"><span class="keyword">from</span> models.segnet <span class="keyword">import</span> SegNet, SegResNet</span><br><span class="line"><span class="keyword">from</span> models.unet <span class="keyword">import</span> UNet, UNetResnet</span><br><span class="line"><span class="keyword">from</span> models.deeplabv3_plus <span class="keyword">import</span> DeepLabV3Plus</span><br><span class="line"><span class="keyword">from</span> tools.evalution_segmentaion <span class="keyword">import</span> calc_semantic_segmentation_iou</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">setup_seed(<span class="number">12345</span>)  <span class="comment"># 先固定随机种子</span></span><br><span class="line"></span><br><span class="line">parser = argparse.ArgumentParser(description=<span class="string">'Training'</span>)</span><br><span class="line">parser.add_argument(<span class="string">'--lr'</span>, default=<span class="literal">None</span>, <span class="built_in">help</span>=<span class="string">'learning rate'</span>, <span class="built_in">type</span>=<span class="built_in">float</span>)</span><br><span class="line">parser.add_argument(<span class="string">'--max_epoch'</span>, default=<span class="literal">None</span>, <span class="built_in">type</span>=<span class="built_in">int</span>)</span><br><span class="line">parser.add_argument(<span class="string">'--train_bs'</span>, default=<span class="number">0</span>, <span class="built_in">type</span>=<span class="built_in">int</span>)</span><br><span class="line">parser.add_argument(<span class="string">'--data_root_dir'</span>, default= <span class="string">r"/Users/kenton/Downloads/deeplearning_dataset/camvid_from_paper"</span>,</span><br><span class="line">                    <span class="built_in">help</span>=<span class="string">"path to your dataset"</span>)</span><br><span class="line">args = parser.parse_args()</span><br><span class="line">cfg.lr_init = args.lr <span class="keyword">if</span> args.lr <span class="keyword">else</span> cfg.lr_init</span><br><span class="line">cfg.train_bs = args.train_bs <span class="keyword">if</span> args.train_bs <span class="keyword">else</span> cfg.train_bs</span><br><span class="line">cfg.max_epoch = args.max_epoch <span class="keyword">if</span> args.max_epoch <span class="keyword">else</span> cfg.max_epoch</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># step0: setting path</span></span><br><span class="line">    <span class="comment"># path_model_101 = '/Users/kenton/Downloads/deeplearning_dataset/pretrain_model/resnet101s-03a0f310.pth'  # deeplab</span></span><br><span class="line">    <span class="comment"># path_model_50 = '/Users/kenton/Downloads/deeplearning_dataset/pretrain_model/resnet50s-a75c83cf.pth'  # unet</span></span><br><span class="line">    <span class="comment"># path_model_vgg = '/Users/kenton/Downloads/deeplearning_dataset/pretrain_model/vgg16_bn-6c64b313.pth'</span></span><br><span class="line">    <span class="comment"># path_model_50s = '/Users/kenton/Downloads/deeplearning_dataset/pretrain_model/resnet50s-a75c83cf.pth'</span></span><br><span class="line">    res_dir = os.path.join(BASE_DIR, <span class="string">".."</span>, <span class="string">".."</span>, <span class="string">"results"</span>)</span><br><span class="line">    logger, log_dir = make_logger(res_dir)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ------------------------------------ step 1/4 : 加载数据------------------------------------</span></span><br><span class="line">    <span class="comment"># 构建Dataset实例</span></span><br><span class="line">    root_dir = args.data_root_dir</span><br><span class="line">    train_img_dir = os.path.join(root_dir, <span class="string">'train'</span>)</span><br><span class="line">    train_lable_dir = os.path.join(root_dir, <span class="string">'train_labels'</span>)</span><br><span class="line">    valid_img_dir = os.path.join(root_dir, <span class="string">'val'</span>)</span><br><span class="line">    valid_label_dir = os.path.join(root_dir, <span class="string">'val_labels'</span>)</span><br><span class="line">    path_to_dict = os.path.join(root_dir, <span class="string">'class_dict.csv'</span>)</span><br><span class="line"></span><br><span class="line">    check_data_dir(train_img_dir)</span><br><span class="line">    check_data_dir(train_lable_dir)</span><br><span class="line">    check_data_dir(valid_img_dir)</span><br><span class="line">    check_data_dir(valid_label_dir)</span><br><span class="line"></span><br><span class="line">    train_data = CamvidDataset(train_img_dir, train_lable_dir, path_to_dict, cfg.crop_size)</span><br><span class="line">    valid_data = CamvidDataset(valid_img_dir, valid_label_dir, path_to_dict, cfg.crop_size)</span><br><span class="line">    train_loader = DataLoader(train_data, batch_size=cfg.train_bs, shuffle=<span class="literal">True</span>, num_workers=cfg.workers)</span><br><span class="line">    valid_loader = DataLoader(valid_data, batch_size=cfg.valid_bs, num_workers=cfg.workers)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ------------------------------------ step 2/4 : 定义网络------------------------------------</span></span><br><span class="line">    <span class="comment"># model = DeepLabV3Plus(num_classes=train_data.cls_num, path_model=path_model_101)</span></span><br><span class="line">    <span class="comment"># model = UNet(num_classes=train_data.cls_num)</span></span><br><span class="line">    <span class="comment"># model = UNetResnet(num_classes=train_data.cls_num, backbone='resnet50', path_model=path_model_50)</span></span><br><span class="line">    model = SegResNet(num_classes=train_data.cls_num)</span><br><span class="line">    model.to(cfg.device)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ------------------------------------ step 3/4 : 定义损失函数和优化器 ------------------------------------</span></span><br><span class="line">    loss_f = nn.CrossEntropyLoss().to(cfg.device)</span><br><span class="line">    optimizer = optim.SGD(model.parameters(), lr=cfg.lr_init, momentum=cfg.momentum, weight_decay=cfg.weight_decay)</span><br><span class="line">    scheduler = optim.lr_scheduler.MultiStepLR(optimizer, gamma=cfg.factor, milestones=cfg.milestones)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ------------------------------------ step 4/4 : 训练 --------------------------------------------------</span></span><br><span class="line">    <span class="comment"># 记录训练配置信息</span></span><br><span class="line">    logger.info(<span class="string">"cfg:\n{}\n loss_f:\n{}\n scheduler:\n{}\n optimizer:\n{}\n model name:\n{}\nmodel:\n{}"</span>.<span class="built_in">format</span>(</span><br><span class="line">        cfg, loss_f, scheduler, optimizer, model._get_name(), model))</span><br><span class="line"></span><br><span class="line">    loss_rec = {<span class="string">"train"</span>: [], <span class="string">"valid"</span>: []}</span><br><span class="line">    acc_rec = {<span class="string">"train"</span>: [], <span class="string">"valid"</span>: []}</span><br><span class="line">    miou_rec = {<span class="string">"train"</span>: [], <span class="string">"valid"</span>: []}</span><br><span class="line">    best_miou, best_epoch = <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">    grad_lst_epoch = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(cfg.max_epoch):</span><br><span class="line"></span><br><span class="line">        loss_train, acc_train, mat_train, miou_train, grad_lst = ModelTrainer.train(</span><br><span class="line">            train_loader, model, loss_f, cfg, optimizer, epoch, logger)</span><br><span class="line">        loss_valid, acc_valid, mat_valid, miou_valid = ModelTrainer.valid(</span><br><span class="line">            valid_loader, model, loss_f, cfg)</span><br><span class="line">        grad_lst_epoch.extend(grad_lst)</span><br><span class="line">        scheduler.step()</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">"Epoch[{:0&gt;3}/{:0&gt;3}] Train Acc: {:.2%} Valid Acc:{:.2%}\n"</span></span><br><span class="line">                    <span class="string">"Train loss:{:.4f} Train miou:{:.4f}\n"</span></span><br><span class="line">                    <span class="string">"Valid loss:{:.4f} Valid miou:{:.4f}\n"</span></span><br><span class="line">                    <span class="string">"LR:{}"</span>. <span class="built_in">format</span>(epoch, cfg.max_epoch, acc_train, acc_valid, loss_train, miou_train,</span><br><span class="line">                                    loss_valid, miou_valid, optimizer.param_groups[<span class="number">0</span>][<span class="string">"lr"</span>]))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 记录训练信息</span></span><br><span class="line">        loss_rec[<span class="string">"train"</span>].append(loss_train), loss_rec[<span class="string">"valid"</span>].append(loss_valid)</span><br><span class="line">        acc_rec[<span class="string">"train"</span>].append(acc_train), acc_rec[<span class="string">"valid"</span>].append(acc_valid)</span><br><span class="line">        miou_rec[<span class="string">"train"</span>].append(miou_train), miou_rec[<span class="string">"valid"</span>].append(miou_valid)</span><br><span class="line">        <span class="comment"># 保存混淆矩阵图</span></span><br><span class="line">        show_confMat(mat_train, train_data.names, <span class="string">"train"</span>, log_dir, epoch=epoch,</span><br><span class="line">                     verbose=epoch == cfg.max_epoch - <span class="number">1</span>, perc=<span class="literal">True</span>)</span><br><span class="line">        show_confMat(mat_valid, valid_data.names, <span class="string">"valid"</span>, log_dir, epoch=epoch,</span><br><span class="line">                     verbose=epoch == cfg.max_epoch - <span class="number">1</span>, perc=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># 保存loss曲线， acc曲线， miou曲线</span></span><br><span class="line">        plt_x = np.arange(<span class="number">1</span>, epoch + <span class="number">2</span>)</span><br><span class="line">        plot_line(plt_x, loss_rec[<span class="string">"train"</span>], plt_x, loss_rec[<span class="string">"valid"</span>], mode=<span class="string">"loss"</span>, out_dir=log_dir)</span><br><span class="line">        plot_line(plt_x, acc_rec[<span class="string">"train"</span>], plt_x, acc_rec[<span class="string">"valid"</span>], mode=<span class="string">"acc"</span>, out_dir=log_dir)</span><br><span class="line">        plot_line(plt_x, miou_rec[<span class="string">"train"</span>], plt_x, miou_rec[<span class="string">"valid"</span>], mode=<span class="string">"miou"</span>, out_dir=log_dir)</span><br><span class="line">        <span class="comment"># 保存模型</span></span><br><span class="line">        <span class="keyword">if</span> best_miou &lt; miou_valid <span class="keyword">or</span> epoch == cfg.max_epoch-<span class="number">1</span>:</span><br><span class="line"></span><br><span class="line">            best_epoch = epoch <span class="keyword">if</span> best_miou &lt; miou_valid <span class="keyword">else</span> best_epoch</span><br><span class="line">            best_miou = miou_valid <span class="keyword">if</span> best_miou &lt; miou_valid <span class="keyword">else</span> best_miou</span><br><span class="line">            checkpoint = {<span class="string">"model_state_dict"</span>: model.state_dict(),</span><br><span class="line">                          <span class="string">"optimizer_state_dict"</span>: optimizer.state_dict(),</span><br><span class="line">                          <span class="string">"epoch"</span>: epoch,</span><br><span class="line">                          <span class="string">"best_miou"</span>: best_miou}</span><br><span class="line">            pkl_name = <span class="string">"checkpoint_{}.pkl"</span>.<span class="built_in">format</span>(epoch) <span class="keyword">if</span> epoch == cfg.max_epoch-<span class="number">1</span> <span class="keyword">else</span> <span class="string">"checkpoint_best.pkl"</span></span><br><span class="line">            path_checkpoint = os.path.join(log_dir, pkl_name)</span><br><span class="line">            torch.save(checkpoint, path_checkpoint)</span><br><span class="line">            <span class="comment"># 观察各类别的iou：</span></span><br><span class="line">            iou_array = calc_semantic_segmentation_iou(mat_valid)</span><br><span class="line">            info = [<span class="string">"{}_iou:{:.2f}"</span>.<span class="built_in">format</span>(n, iou) <span class="keyword">for</span> n, iou <span class="keyword">in</span> <span class="built_in">zip</span>(train_data.names, iou_array)]</span><br><span class="line">            logger.info(<span class="string">"Best mIoU in {}. {}"</span>.<span class="built_in">format</span>(epoch, <span class="string">"\n"</span>.join(info)))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 梯度剪裁的图 显示 最大的梯度</span></span><br><span class="line">        <span class="keyword">if</span> cfg.hist_grad:</span><br><span class="line">            path_grad_png = os.path.join(log_dir, <span class="string">"grad_hist.png"</span>)</span><br><span class="line">            logger.info(<span class="string">"max grad in {}, is {}"</span>.<span class="built_in">format</span>(grad_lst_epoch.index(<span class="built_in">max</span>(grad_lst_epoch)), <span class="built_in">max</span>(grad_lst_epoch)))</span><br><span class="line">            <span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">            plt.hist(grad_lst_epoch)</span><br><span class="line">            plt.close()</span><br><span class="line">            plt.savefig(path_grad_png)</span><br><span class="line">            logger.info(grad_lst_epoch)</span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">"{} done, best_miou: {:.4f} in :{}"</span>.<span class="built_in">format</span>(</span><br><span class="line">        datetime.strftime(datetime.now(), <span class="string">'%m-%d_%H-%M'</span>), best_miou, best_epoch))</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="datasets-x2F-camvid-dataset-py"><a href="#datasets-x2F-camvid-dataset-py" class="headerlink" title="datasets/camvid_dataset.py"></a>datasets/camvid_dataset.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string"># @file name  : camvid_dataset.py</span></span><br><span class="line"><span class="string"># @author     : zz0320</span></span><br><span class="line"><span class="string"># @date       : 2022-03-12</span></span><br><span class="line"><span class="string"># @brief      : CamVid数据集的Dataset定义</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> Dataset</span><br><span class="line"><span class="keyword">import</span> torchvision.transforms.functional <span class="keyword">as</span> ff</span><br><span class="line"><span class="keyword">import</span> torchvision.transforms <span class="keyword">as</span> transforms</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> DataLoader</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LabelProcessor</span>:</span><br><span class="line">    <span class="string">"""对标签图像的编码"""</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, file_path</span>):</span><br><span class="line">        self.colormap = self.read_color_map(file_path)  <span class="comment"># 读取csv，获得label对应的rgb值, csv --&gt; rgb</span></span><br><span class="line">        self.cm2lbl = self.encode_label_pix(self.colormap)  <span class="comment"># 对label的rgb值制作映射矩阵，rgb --&gt; cls index</span></span><br><span class="line">        self.names = pd.read_csv(file_path, sep=<span class="string">','</span>).name.tolist()</span><br><span class="line">    <span class="comment"># 静态方法装饰器， 可以理解为定义在类中的普通函数，可以用self.&lt;name&gt;方式调用</span></span><br><span class="line">    <span class="comment"># 在静态方法内部不可以示例属性和实列对象，即不可以调用self.相关的内容</span></span><br><span class="line">    <span class="comment"># 使用静态方法的原因之一是程序设计的需要（简洁代码，封装功能等）</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">read_color_map</span>(<span class="params">file_path</span>):  <span class="comment"># data process and load.ipynb: 处理标签文件中colormap的数据</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        读取csv中信息，获得各类别标签的rgb像素，以list形式返回</span></span><br><span class="line"><span class="string">        :param file_path:</span></span><br><span class="line"><span class="string">        :return: list， list[0] == [128, 128, 128] ...</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        pd_label_color = pd.read_csv(file_path, sep=<span class="string">','</span>)</span><br><span class="line">        colormap = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(pd_label_color.index)):</span><br><span class="line">            tmp = pd_label_color.iloc[i]</span><br><span class="line">            color = [tmp[<span class="string">'r'</span>], tmp[<span class="string">'g'</span>], tmp[<span class="string">'b'</span>]]</span><br><span class="line">            colormap.append(color)</span><br><span class="line">        <span class="keyword">return</span> colormap</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">encode_label_pix</span>(<span class="params">colormap</span>):</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        生成标签编码，返回哈希表</span></span><br><span class="line"><span class="string">        key是像素值的编码，编码公式：(cm[0] * 256 + cm[1]) * 256 + cm[2]</span></span><br><span class="line"><span class="string">        value是类别，0,1,2,3,...,11</span></span><br><span class="line"><span class="string">        :param colormap:</span></span><br><span class="line"><span class="string">        :return: ndarray, shape =  (16777216,)</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        cm2lbl = np.zeros(<span class="number">256</span> ** <span class="number">3</span>)</span><br><span class="line">        <span class="keyword">for</span> i, cm <span class="keyword">in</span> <span class="built_in">enumerate</span>(colormap):</span><br><span class="line">            cm2lbl[(cm[<span class="number">0</span>] * <span class="number">256</span> + cm[<span class="number">1</span>]) * <span class="number">256</span> + cm[<span class="number">2</span>]] = i</span><br><span class="line">        <span class="keyword">return</span> cm2lbl</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">encode_label_img</span>(<span class="params">self, img</span>):</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        将rgb像素转换为 0-11 的标签形式</span></span><br><span class="line"><span class="string">        :param img:</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        data = np.array(img, dtype=<span class="string">'int32'</span>)</span><br><span class="line">        idx = (data[:, :, <span class="number">0</span>] * <span class="number">256</span> + data[:, :, <span class="number">1</span>]) * <span class="number">256</span> + data[:, :, <span class="number">2</span>]</span><br><span class="line">        <span class="keyword">return</span> np.array(self.cm2lbl[idx], dtype=<span class="string">'int64'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CamvidDataset</span>(<span class="title class_ inherited__">Dataset</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, dir_img, dir_l, path_csv, crop_size=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">"""para:</span></span><br><span class="line"><span class="string">            file_path(list): 数据和标签路径,列表元素第一个为图片路径，第二个为标签路径</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self.img_path = dir_img</span><br><span class="line">        self.label_path = dir_l</span><br><span class="line">        <span class="comment"># 2 从路径中取出图片和标签数据的文件名保持到两个列表当中（程序中的数据来源）</span></span><br><span class="line">        self.imgs = self.read_file(self.img_path)</span><br><span class="line">        self.labels = self.read_file(self.label_path)</span><br><span class="line">        <span class="comment"># 3 初始化数据处理函数设置</span></span><br><span class="line">        self.crop_size = crop_size</span><br><span class="line">        <span class="comment"># 初始化标签处理器</span></span><br><span class="line">        self.label_processor = LabelProcessor(path_csv)</span><br><span class="line">        self.names = pd.read_csv(path_csv, sep=<span class="string">','</span>).name.tolist()</span><br><span class="line">        self.cls_num = <span class="built_in">len</span>(self.names)</span><br><span class="line">        <span class="comment"># 统计类别数量</span></span><br><span class="line">        self.nums_per_cls = self.cal_cls_nums()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, index</span>):</span><br><span class="line">        img = self.imgs[index]</span><br><span class="line">        label = self.labels[index]</span><br><span class="line"></span><br><span class="line">        img = Image.<span class="built_in">open</span>(img)</span><br><span class="line">        label = Image.<span class="built_in">open</span>(label).convert(<span class="string">'RGB'</span>)</span><br><span class="line"></span><br><span class="line">        img, label = self.center_crop(img, label, self.crop_size)</span><br><span class="line">        img, label = self.img_transform(img, label)</span><br><span class="line">        <span class="keyword">return</span> img, label</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(self.imgs) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">"\ndata_dir:{} is a empty dir! Please checkout your path to images!"</span>.<span class="built_in">format</span>(</span><br><span class="line">                self.dir_img))   <span class="comment"># 代码具有友好的提示功能，便于debug</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(self.imgs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">read_file</span>(<span class="params">self, path</span>):</span><br><span class="line">        <span class="string">"""从文件夹中读取数据"""</span></span><br><span class="line">        files_list = os.listdir(path)</span><br><span class="line">        file_path_list = [os.path.join(path, img) <span class="keyword">for</span> img <span class="keyword">in</span> files_list]</span><br><span class="line">        file_path_list.sort()</span><br><span class="line">        <span class="keyword">return</span> file_path_list</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">center_crop</span>(<span class="params">self, data, label, crop_size</span>):</span><br><span class="line">        <span class="string">"""裁剪输入的图片和标签大小"""</span></span><br><span class="line">        data = ff.center_crop(data, crop_size)</span><br><span class="line">        label = ff.center_crop(label, crop_size)</span><br><span class="line">        <span class="keyword">return</span> data, label</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">img_transform</span>(<span class="params">self, img, label</span>):</span><br><span class="line">        <span class="string">"""对图片和标签做一些数值处理"""</span></span><br><span class="line">        label = np.array(label)  <span class="comment"># 以防不是np格式的数据</span></span><br><span class="line">        label = Image.fromarray(label.astype(<span class="string">'uint8'</span>))</span><br><span class="line">        transform_img = transforms.Compose(</span><br><span class="line">            [</span><br><span class="line">                transforms.ToTensor(),</span><br><span class="line">                transforms.Normalize([<span class="number">0.485</span>, <span class="number">0.456</span>, <span class="number">0.406</span>], [<span class="number">0.229</span>, <span class="number">0.224</span>, <span class="number">0.225</span>])</span><br><span class="line">            ]</span><br><span class="line">        )</span><br><span class="line">        img = transform_img(img)</span><br><span class="line">        label = self.label_processor.encode_label_img(label)  <span class="comment"># RGB np.array --&gt;   label index</span></span><br><span class="line">        label = torch.from_numpy(label)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> img, label</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">cal_cls_nums</span>(<span class="params">self</span>):</span><br><span class="line">        counter = np.zeros((<span class="number">12</span>,))</span><br><span class="line">        <span class="keyword">for</span> path <span class="keyword">in</span> self.labels:</span><br><span class="line">            label_img = Image.<span class="built_in">open</span>(path).convert(<span class="string">'RGB'</span>)</span><br><span class="line">            label = self.label_processor.encode_label_img(label_img).flatten()</span><br><span class="line">            count = np.bincount(label, minlength=<span class="number">12</span>)</span><br><span class="line">            counter += count</span><br><span class="line">        <span class="keyword">return</span> counter.tolist()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line"></span><br><span class="line">    camvid_dir = <span class="string">r"G:\deep_learning_data\camvid_from_paper"</span></span><br><span class="line">    path_to_dict = os.path.join(camvid_dir, <span class="string">'class_dict.csv'</span>)</span><br><span class="line">    TRAIN_ROOT = os.path.join(camvid_dir, <span class="string">'train'</span>)</span><br><span class="line">    TRAIN_LABEL = os.path.join(camvid_dir, <span class="string">'train_labels'</span>)</span><br><span class="line"></span><br><span class="line">    crop_size = (<span class="number">360</span>, <span class="number">480</span>)</span><br><span class="line">    train_data = CamvidDataset(TRAIN_ROOT, TRAIN_LABEL, path_to_dict, crop_size)</span><br><span class="line">    train_loader = DataLoader(train_data, batch_size=<span class="number">1</span>, shuffle=<span class="literal">True</span>, num_workers=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, data <span class="keyword">in</span> <span class="built_in">enumerate</span>(train_loader):</span><br><span class="line">        img_data, img_label = data</span><br><span class="line">        <span class="built_in">print</span>(img_data.shape, img_data.dtype, <span class="built_in">type</span>(img_data))       <span class="comment"># torch.float32</span></span><br><span class="line">        <span class="built_in">print</span>(img_label.shape, img_label.dtype, <span class="built_in">type</span>(img_label))     <span class="comment"># torch.longint(int64)</span></span><br></pre></td></tr></table></figure>

<h3 id="src-x2F-camvid-train-py-1"><a href="#src-x2F-camvid-train-py-1" class="headerlink" title="src/camvid_train.py"></a>src/camvid_train.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string"># @file name  : camvid_train.py</span></span><br><span class="line"><span class="string"># @author     : zz0320</span></span><br><span class="line"><span class="string"># @date       : 2022-03-12</span></span><br><span class="line"><span class="string"># @brief      : 模型训练主代码</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">import</span> matplotlib</span><br><span class="line"><span class="comment"># matplotlib.use('agg')</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">BASE_DIR = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">sys.path.append(os.path.join(BASE_DIR, <span class="string">'..'</span>))</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> torch.optim <span class="keyword">as</span> optim</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> DataLoader</span><br><span class="line"><span class="keyword">from</span> datasets.camvid_dataset <span class="keyword">import</span> CamvidDataset</span><br><span class="line"><span class="keyword">from</span> tools.model_trainer <span class="keyword">import</span> ModelTrainer</span><br><span class="line"><span class="keyword">from</span> tools.common_tools <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> config.camvid_config <span class="keyword">import</span> cfg</span><br><span class="line"><span class="keyword">from</span> models.unet <span class="keyword">import</span> UNet, UNetResnet</span><br><span class="line"><span class="keyword">from</span> models.deeplabv3_plus <span class="keyword">import</span> DeepLabV3Plus</span><br><span class="line"><span class="keyword">from</span> tools.evalution_segmentaion <span class="keyword">import</span> calc_semantic_segmentation_iou</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">setup_seed(<span class="number">12345</span>)  <span class="comment"># 先固定随机种子</span></span><br><span class="line"></span><br><span class="line">parser = argparse.ArgumentParser(description=<span class="string">'Training'</span>)</span><br><span class="line">parser.add_argument(<span class="string">'--lr'</span>, default=<span class="literal">None</span>, <span class="built_in">help</span>=<span class="string">'learning rate'</span>, <span class="built_in">type</span>=<span class="built_in">float</span>)</span><br><span class="line">parser.add_argument(<span class="string">'--max_epoch'</span>, default=<span class="literal">None</span>, <span class="built_in">type</span>=<span class="built_in">int</span>)</span><br><span class="line">parser.add_argument(<span class="string">'--train_bs'</span>, default=<span class="number">0</span>, <span class="built_in">type</span>=<span class="built_in">int</span>)</span><br><span class="line">parser.add_argument(<span class="string">'--data_root_dir'</span>, default=<span class="string">r"G:\deep_learning_data\camvid_from_paper"</span>,</span><br><span class="line">                    <span class="built_in">help</span>=<span class="string">"path to your dataset"</span>)</span><br><span class="line">args = parser.parse_args()</span><br><span class="line">cfg.lr_init = args.lr <span class="keyword">if</span> args.lr <span class="keyword">else</span> cfg.lr_init</span><br><span class="line">cfg.train_bs = args.train_bs <span class="keyword">if</span> args.train_bs <span class="keyword">else</span> cfg.train_bs</span><br><span class="line">cfg.max_epoch = args.max_epoch <span class="keyword">if</span> args.max_epoch <span class="keyword">else</span> cfg.max_epoch</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># step0: setting path</span></span><br><span class="line">    path_model_101 = os.path.join(BASE_DIR, <span class="string">".."</span>, <span class="string">".."</span>, <span class="string">"data"</span>, <span class="string">"pretrained_model"</span>, <span class="string">"resnet101s-03a0f310.pth"</span>)  <span class="comment"># deeplab</span></span><br><span class="line">    path_model_50 = os.path.join(BASE_DIR, <span class="string">".."</span>, <span class="string">".."</span>, <span class="string">"data"</span>, <span class="string">"pretrained_model"</span>, <span class="string">"resnet50s-a75c83cf.pth"</span>)  <span class="comment"># unet</span></span><br><span class="line">    path_model_vgg = os.path.join(BASE_DIR, <span class="string">".."</span>, <span class="string">".."</span>, <span class="string">"data"</span>, <span class="string">"pretrained_model"</span>, <span class="string">"vgg16_bn-6c64b313.pth"</span>)</span><br><span class="line">    res_dir = os.path.join(BASE_DIR, <span class="string">".."</span>, <span class="string">".."</span>, <span class="string">"results"</span>)</span><br><span class="line">    logger, log_dir = make_logger(res_dir)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ------------------------------------ step 1/4 : 加载数据------------------------------------</span></span><br><span class="line">    <span class="comment"># 构建Dataset实例</span></span><br><span class="line">    root_dir = args.data_root_dir</span><br><span class="line">    train_img_dir = os.path.join(root_dir, <span class="string">'train'</span>)</span><br><span class="line">    train_lable_dir = os.path.join(root_dir, <span class="string">'train_labels'</span>)</span><br><span class="line">    valid_img_dir = os.path.join(root_dir, <span class="string">'val'</span>)</span><br><span class="line">    valid_label_dir = os.path.join(root_dir, <span class="string">'val_labels'</span>)</span><br><span class="line">    path_to_dict = os.path.join(root_dir, <span class="string">'class_dict.csv'</span>)</span><br><span class="line">    check_data_dir(train_img_dir)</span><br><span class="line">    check_data_dir(train_lable_dir)</span><br><span class="line">    check_data_dir(valid_img_dir)</span><br><span class="line">    check_data_dir(valid_label_dir)</span><br><span class="line"></span><br><span class="line">    train_data = CamvidDataset(train_img_dir, train_lable_dir, path_to_dict, cfg.crop_size)</span><br><span class="line">    valid_data = CamvidDataset(valid_img_dir, valid_label_dir, path_to_dict, cfg.crop_size)</span><br><span class="line">    train_loader = DataLoader(train_data, batch_size=cfg.train_bs, shuffle=<span class="literal">True</span>, num_workers=cfg.workers)</span><br><span class="line">    valid_loader = DataLoader(valid_data, batch_size=cfg.valid_bs, num_workers=cfg.workers)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ------------------------------------ step 2/4 : 定义网络------------------------------------</span></span><br><span class="line">    model = DeepLabV3Plus(num_classes=train_data.cls_num, path_model=path_model_101)</span><br><span class="line">    <span class="comment"># model = UNet(num_classes=train_data.cls_num)</span></span><br><span class="line">    <span class="comment"># model = UNetResnet(num_classes=train_data.cls_num, backbone='resnet50', path_model=path_model_50)</span></span><br><span class="line">    model.to(cfg.device)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ------------------------------------ step 3/4 : 定义损失函数和优化器 ------------------------------------</span></span><br><span class="line">    loss_f = nn.CrossEntropyLoss().to(cfg.device)</span><br><span class="line">    optimizer = optim.SGD(model.parameters(), lr=cfg.lr_init, momentum=cfg.momentum, weight_decay=cfg.weight_decay)</span><br><span class="line">    scheduler = optim.lr_scheduler.MultiStepLR(optimizer, gamma=cfg.factor, milestones=cfg.milestones)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ------------------------------------ step 4/4 : 训练 --------------------------------------------------</span></span><br><span class="line">    <span class="comment"># 记录训练配置信息</span></span><br><span class="line">    logger.info(<span class="string">"cfg:\n{}\n loss_f:\n{}\n scheduler:\n{}\n optimizer:\n{}\n model name:\n{}\nmodel:\n{}"</span>.<span class="built_in">format</span>(</span><br><span class="line">        cfg, loss_f, scheduler, optimizer, model._get_name(), model))</span><br><span class="line"></span><br><span class="line">    loss_rec = {<span class="string">"train"</span>: [], <span class="string">"valid"</span>: []}</span><br><span class="line">    acc_rec = {<span class="string">"train"</span>: [], <span class="string">"valid"</span>: []}</span><br><span class="line">    miou_rec = {<span class="string">"train"</span>: [], <span class="string">"valid"</span>: []}</span><br><span class="line">    best_miou, best_epoch = <span class="number">0</span>, <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(cfg.max_epoch):</span><br><span class="line"></span><br><span class="line">        loss_train, acc_train, mat_train, miou_train, grad_lst = ModelTrainer.train(</span><br><span class="line">            train_loader, model, loss_f, cfg, optimizer, epoch, logger)</span><br><span class="line">        loss_valid, acc_valid, mat_valid, miou_valid = ModelTrainer.valid(</span><br><span class="line">            valid_loader, model, loss_f, cfg)</span><br><span class="line"></span><br><span class="line">        scheduler.step()</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">"Epoch[{:0&gt;3}/{:0&gt;3}] Train Acc: {:.2%} Valid Acc:{:.2%}\n"</span></span><br><span class="line">                    <span class="string">"Train loss:{:.4f} Train miou:{:.4f}\n"</span></span><br><span class="line">                    <span class="string">"Valid loss:{:.4f} Valid miou:{:.4f}\n"</span></span><br><span class="line">                    <span class="string">"LR:{}"</span>. <span class="built_in">format</span>(epoch, cfg.max_epoch, acc_train, acc_valid, loss_train, miou_train,</span><br><span class="line">                                    loss_valid, miou_valid, optimizer.param_groups[<span class="number">0</span>][<span class="string">"lr"</span>]))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 记录训练信息</span></span><br><span class="line">        loss_rec[<span class="string">"train"</span>].append(loss_train), loss_rec[<span class="string">"valid"</span>].append(loss_valid)</span><br><span class="line">        acc_rec[<span class="string">"train"</span>].append(acc_train), acc_rec[<span class="string">"valid"</span>].append(acc_valid)</span><br><span class="line">        miou_rec[<span class="string">"train"</span>].append(miou_train), miou_rec[<span class="string">"valid"</span>].append(miou_valid)</span><br><span class="line">        <span class="comment"># 保存混淆矩阵图</span></span><br><span class="line">        show_confMat(mat_train, train_data.names, <span class="string">"train"</span>, log_dir, epoch=epoch,</span><br><span class="line">                     verbose=epoch == cfg.max_epoch - <span class="number">1</span>, perc=<span class="literal">True</span>)</span><br><span class="line">        show_confMat(mat_valid, valid_data.names, <span class="string">"valid"</span>, log_dir, epoch=epoch,</span><br><span class="line">                     verbose=epoch == cfg.max_epoch - <span class="number">1</span>, perc=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># 保存loss曲线， acc曲线， miou曲线</span></span><br><span class="line">        plt_x = np.arange(<span class="number">1</span>, epoch + <span class="number">2</span>)</span><br><span class="line">        plot_line(plt_x, loss_rec[<span class="string">"train"</span>], plt_x, loss_rec[<span class="string">"valid"</span>], mode=<span class="string">"loss"</span>, out_dir=log_dir)</span><br><span class="line">        plot_line(plt_x, acc_rec[<span class="string">"train"</span>], plt_x, acc_rec[<span class="string">"valid"</span>], mode=<span class="string">"acc"</span>, out_dir=log_dir)</span><br><span class="line">        plot_line(plt_x, miou_rec[<span class="string">"train"</span>], plt_x, miou_rec[<span class="string">"valid"</span>], mode=<span class="string">"miou"</span>, out_dir=log_dir)</span><br><span class="line">        <span class="comment"># 保存模型</span></span><br><span class="line">        <span class="keyword">if</span> best_miou &lt; miou_valid <span class="keyword">or</span> epoch == cfg.max_epoch-<span class="number">1</span>:</span><br><span class="line"></span><br><span class="line">            best_epoch = epoch <span class="keyword">if</span> best_miou &lt; miou_valid <span class="keyword">else</span> best_epoch</span><br><span class="line">            best_miou = miou_valid <span class="keyword">if</span> best_miou &lt; miou_valid <span class="keyword">else</span> best_miou</span><br><span class="line">            checkpoint = {<span class="string">"model_state_dict"</span>: model.state_dict(),</span><br><span class="line">                          <span class="string">"optimizer_state_dict"</span>: optimizer.state_dict(),</span><br><span class="line">                          <span class="string">"epoch"</span>: epoch,</span><br><span class="line">                          <span class="string">"best_miou"</span>: best_miou}</span><br><span class="line">            pkl_name = <span class="string">"checkpoint_{}.pkl"</span>.<span class="built_in">format</span>(epoch) <span class="keyword">if</span> epoch == cfg.max_epoch-<span class="number">1</span> <span class="keyword">else</span> <span class="string">"checkpoint_best.pkl"</span></span><br><span class="line">            path_checkpoint = os.path.join(log_dir, pkl_name)</span><br><span class="line">            torch.save(checkpoint, path_checkpoint)</span><br><span class="line">            <span class="comment"># 观察各类别的iou：</span></span><br><span class="line">            iou_array = calc_semantic_segmentation_iou(mat_valid)</span><br><span class="line">            info = [<span class="string">"{}_iou:{:.2f}"</span>.<span class="built_in">format</span>(n, iou) <span class="keyword">for</span> n, iou <span class="keyword">in</span> <span class="built_in">zip</span>(train_data.names, iou_array)]</span><br><span class="line">            logger.info(<span class="string">"Best mIoU in {}. {}"</span>.<span class="built_in">format</span>(epoch, <span class="string">"\n"</span>.join(info)))</span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">"{} done, best_miou: {:.4f} in :{}"</span>.<span class="built_in">format</span>(</span><br><span class="line">        datetime.strftime(datetime.now(), <span class="string">'%m-%d_%H-%M'</span>), best_miou, best_epoch))</span><br></pre></td></tr></table></figure>

<h3 id="tools-x2F-common-tools-py"><a href="#tools-x2F-common-tools-py" class="headerlink" title="tools/common_tools.py"></a>tools/common_tools.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string"># @file name  : common_tools.py</span></span><br><span class="line"><span class="string"># @author     : zz0320</span></span><br><span class="line"><span class="string"># @date       : 2022-04-16</span></span><br><span class="line"><span class="string"># @brief      : 通用函数库</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">setup_seed</span>(<span class="params">seed=<span class="number">12345</span></span>):</span><br><span class="line">    np.random.seed(seed)</span><br><span class="line">    random.seed(seed)</span><br><span class="line">    torch.manual_seed(seed)     <span class="comment"># cpu</span></span><br><span class="line">    <span class="keyword">if</span> torch.cuda.is_available():</span><br><span class="line">        torch.cuda.manual_seed_all(seed)</span><br><span class="line">        torch.backends.cudnn.deterministic = <span class="literal">True</span></span><br><span class="line">        torch.backends.cudnn.benchmark = <span class="literal">True</span> <span class="comment"># 训练集变化不大时使训练加速，是固定cudnn最优配置，如卷积算法</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_confMat</span>(<span class="params">confusion_mat, classes, set_name, out_dir, epoch=<span class="number">999</span>, verbose=<span class="literal">False</span>, perc=<span class="literal">False</span></span>):</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    混淆矩阵绘制并保存图片</span></span><br><span class="line"><span class="string">    :param confusion_mat:  nd.array</span></span><br><span class="line"><span class="string">    :param classes: list or tuple, 类别名称</span></span><br><span class="line"><span class="string">    :param set_name: str, 数据集名称 train or valid or test?</span></span><br><span class="line"><span class="string">    :param out_dir:  str, 图片要保存的文件夹</span></span><br><span class="line"><span class="string">    :param epoch:  int, 第几个epoch</span></span><br><span class="line"><span class="string">    :param verbose: bool, 是否打印精度信息</span></span><br><span class="line"><span class="string">    :param perc: bool, 是否采用百分比，图像分割时用，因分类数目过大</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    cls_num = <span class="built_in">len</span>(classes)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 归一化</span></span><br><span class="line">    confusion_mat_tmp = confusion_mat.copy()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(classes)):</span><br><span class="line">        confusion_mat_tmp[i, :] = confusion_mat[i, :] / confusion_mat[i, :].<span class="built_in">sum</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置图像大小</span></span><br><span class="line">    <span class="keyword">if</span> cls_num &lt; <span class="number">10</span>:</span><br><span class="line">        figsize = <span class="number">6</span></span><br><span class="line">    <span class="keyword">elif</span> cls_num &gt;= <span class="number">100</span>:</span><br><span class="line">        figsize = <span class="number">30</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        figsize = np.linspace(<span class="number">6</span>, <span class="number">30</span>, <span class="number">91</span>)[cls_num-<span class="number">10</span>]</span><br><span class="line">    plt.figure(figsize=(<span class="built_in">int</span>(figsize), <span class="built_in">int</span>(figsize*<span class="number">1.3</span>)))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取颜色</span></span><br><span class="line">    cmap = plt.cm.get_cmap(<span class="string">'Greys'</span>)  <span class="comment"># 更多颜色: http://matplotlib.org/examples/color/colormaps_reference.html</span></span><br><span class="line">    plt.imshow(confusion_mat_tmp, cmap=cmap)</span><br><span class="line">    plt.colorbar(fraction=<span class="number">0.03</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置文字</span></span><br><span class="line">    xlocations = np.array(<span class="built_in">range</span>(<span class="built_in">len</span>(classes)))</span><br><span class="line">    plt.xticks(xlocations, <span class="built_in">list</span>(classes), rotation=<span class="number">60</span>)</span><br><span class="line">    plt.yticks(xlocations, <span class="built_in">list</span>(classes))</span><br><span class="line">    plt.xlabel(<span class="string">'Predict label'</span>)</span><br><span class="line">    plt.ylabel(<span class="string">'True label'</span>)</span><br><span class="line">    plt.title(<span class="string">"Confusion_Matrix_{}_{}"</span>.<span class="built_in">format</span>(set_name, epoch))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 打印数字</span></span><br><span class="line">    <span class="keyword">if</span> perc:</span><br><span class="line"></span><br><span class="line">        cls_per_nums = confusion_mat.<span class="built_in">sum</span>(axis=<span class="number">1</span>).reshape((cls_num, <span class="number">1</span>))</span><br><span class="line">        conf_mat_per = confusion_mat / cls_per_nums</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(confusion_mat_tmp.shape[<span class="number">0</span>]):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(confusion_mat_tmp.shape[<span class="number">1</span>]):</span><br><span class="line">                plt.text(x=j, y=i, s=<span class="string">"{:.0%}"</span>.<span class="built_in">format</span>(conf_mat_per[i, j]), va=<span class="string">'center'</span>, ha=<span class="string">'center'</span>, color=<span class="string">'red'</span>,</span><br><span class="line">                         fontsize=<span class="number">10</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(confusion_mat_tmp.shape[<span class="number">0</span>]):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(confusion_mat_tmp.shape[<span class="number">1</span>]):</span><br><span class="line">                plt.text(x=j, y=i, s=<span class="built_in">int</span>(confusion_mat[i, j]), va=<span class="string">'center'</span>, ha=<span class="string">'center'</span>, color=<span class="string">'red'</span>, fontsize=<span class="number">10</span>)</span><br><span class="line">    <span class="comment"># 保存</span></span><br><span class="line">    plt.savefig(os.path.join(out_dir, <span class="string">"Confusion_Matrix_{}.png"</span>.<span class="built_in">format</span>(set_name)))</span><br><span class="line">    plt.close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> verbose:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(cls_num):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">'class:{:&lt;10}, total num:{:&lt;6}, correct num:{:&lt;5}  Recall: {:.2%} Precision: {:.2%}'</span>.<span class="built_in">format</span>(</span><br><span class="line">                classes[i], np.<span class="built_in">sum</span>(confusion_mat[i, :]), confusion_mat[i, i],</span><br><span class="line">                confusion_mat[i, i] / (<span class="number">.1</span> + np.<span class="built_in">sum</span>(confusion_mat[i, :])),</span><br><span class="line">                confusion_mat[i, i] / (<span class="number">.1</span> + np.<span class="built_in">sum</span>(confusion_mat[:, i]))))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">plot_line</span>(<span class="params">train_x, train_y, valid_x, valid_y, mode, out_dir</span>):</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    绘制训练和验证集的loss曲线/acc曲线</span></span><br><span class="line"><span class="string">    :param train_x: epoch</span></span><br><span class="line"><span class="string">    :param train_y: 标量值</span></span><br><span class="line"><span class="string">    :param valid_x:</span></span><br><span class="line"><span class="string">    :param valid_y:</span></span><br><span class="line"><span class="string">    :param mode:  'loss' or 'acc'</span></span><br><span class="line"><span class="string">    :param out_dir:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    plt.plot(train_x, train_y, label=<span class="string">'Train'</span>)</span><br><span class="line">    plt.plot(valid_x, valid_y, label=<span class="string">'Valid'</span>)</span><br><span class="line"></span><br><span class="line">    plt.ylabel(<span class="built_in">str</span>(mode))</span><br><span class="line">    plt.xlabel(<span class="string">'Epoch'</span>)</span><br><span class="line"></span><br><span class="line">    location = <span class="string">'upper right'</span> <span class="keyword">if</span> mode == <span class="string">'loss'</span> <span class="keyword">else</span> <span class="string">'upper left'</span></span><br><span class="line">    plt.legend(loc=location)</span><br><span class="line"></span><br><span class="line">    plt.title(<span class="string">'_'</span>.join([mode]))</span><br><span class="line">    plt.savefig(os.path.join(out_dir, mode + <span class="string">'.png'</span>))</span><br><span class="line">    plt.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Logger</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, path_log</span>):</span><br><span class="line">        log_name = os.path.basename(path_log)</span><br><span class="line">        self.log_name = log_name <span class="keyword">if</span> log_name <span class="keyword">else</span> <span class="string">"root"</span></span><br><span class="line">        self.out_path = path_log</span><br><span class="line"></span><br><span class="line">        log_dir = os.path.dirname(self.out_path)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(log_dir):</span><br><span class="line">            os.makedirs(log_dir)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">init_logger</span>(<span class="params">self</span>):</span><br><span class="line">        logger = logging.getLogger(self.log_name)</span><br><span class="line">        logger.setLevel(level=logging.INFO)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 配置文件Handler</span></span><br><span class="line">        file_handler = logging.FileHandler(self.out_path, <span class="string">'w'</span>)</span><br><span class="line">        file_handler.setLevel(logging.INFO)</span><br><span class="line">        formatter = logging.Formatter(<span class="string">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span>)</span><br><span class="line">        file_handler.setFormatter(formatter)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 配置屏幕Handler</span></span><br><span class="line">        console_handler = logging.StreamHandler()</span><br><span class="line">        console_handler.setLevel(logging.INFO)</span><br><span class="line">        <span class="comment"># console_handler.setFormatter(logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s'))</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 添加handler</span></span><br><span class="line">        logger.addHandler(file_handler)</span><br><span class="line">        logger.addHandler(console_handler)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> logger</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_logger</span>(<span class="params">out_dir</span>):</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    在out_dir文件夹下以当前时间命名，创建日志文件夹，并创建logger用于记录信息</span></span><br><span class="line"><span class="string">    :param out_dir: str</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    now_time = datetime.now()</span><br><span class="line">    time_str = datetime.strftime(now_time, <span class="string">'%m-%d_%H-%M'</span>)</span><br><span class="line">    log_dir = os.path.join(out_dir, time_str)  <span class="comment"># 根据config中的创建时间作为文件夹名</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(log_dir):</span><br><span class="line">        os.makedirs(log_dir)</span><br><span class="line">    <span class="comment"># 创建logger</span></span><br><span class="line">    path_log = os.path.join(log_dir, <span class="string">"log.log"</span>)</span><br><span class="line">    logger = Logger(path_log)</span><br><span class="line">    logger = logger.init_logger()</span><br><span class="line">    <span class="keyword">return</span> logger, log_dir</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_data_dir</span>(<span class="params">path_tmp</span>):</span><br><span class="line">    <span class="keyword">assert</span> os.path.exists(path_tmp), \</span><br><span class="line">        <span class="string">"\n\n路径不存在，当前变量中指定的路径是：\n{}\n请检查相对路径的设置，或者文件是否存在"</span>.<span class="built_in">format</span>(os.path.abspath(path_tmp))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_logger</span>(<span class="params">BASE_DIR</span>):</span><br><span class="line">    <span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">    now_time = datetime.now()</span><br><span class="line">    time_str = datetime.strftime(now_time, <span class="string">'%m-%d_%H-%M'</span>)</span><br><span class="line">    log_dir = os.path.join(BASE_DIR, <span class="string">".."</span>, <span class="string">".."</span>, <span class="string">"results"</span>, time_str)  <span class="comment"># 根据config中的创建时间作为文件夹名</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(log_dir):</span><br><span class="line">        os.makedirs(log_dir)</span><br><span class="line">    path_log = os.path.join(log_dir, <span class="string">"log.log"</span>)</span><br><span class="line">    logger = Logger(path_log)</span><br><span class="line">    logger = logger.init_logger()</span><br><span class="line">    <span class="keyword">return</span> logger, log_dir</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">adjust_learning_rate</span>(<span class="params">optimizer, epoch, args, multiple</span>):</span><br><span class="line">    <span class="string">"""Sets the learning rate to the initial LR decayed by 0.95 every 20 epochs"""</span></span><br><span class="line">    <span class="comment"># lr = args.lr * (0.95 ** (epoch // 4))</span></span><br><span class="line">    lr = args.lr * (<span class="number">0.95</span> ** (epoch // <span class="number">20</span>))</span><br><span class="line">    <span class="keyword">for</span> i, param_group <span class="keyword">in</span> <span class="built_in">enumerate</span>(optimizer.param_groups):</span><br><span class="line">        param_group[<span class="string">'lr'</span>] = lr * multiple[i]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line"></span><br><span class="line">    setup_seed(<span class="number">2</span>)</span><br><span class="line">    <span class="built_in">print</span>(np.random.randint(<span class="number">0</span>, <span class="number">10</span>, <span class="number">1</span>))</span><br></pre></td></tr></table></figure>

<h3 id="tools-x2F-evalution-segmentation-py"><a href="#tools-x2F-evalution-segmentation-py" class="headerlink" title="tools/evalution_segmentation.py"></a>tools/evalution_segmentation.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string"># @file name  : evalution_segmention.py</span></span><br><span class="line"><span class="string"># @author     : zz0320</span></span><br><span class="line"><span class="string"># @date       : 2022-04-16</span></span><br><span class="line"><span class="string"># @brief      : 设定分割任务的评价指标 具体的有 混淆矩阵 mIOU 评估矩阵等等</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> division</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> six</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calc_semantic_segmentation_confusion</span>(<span class="params">pred_labels, gt_labels, n_class</span>):</span><br><span class="line">    <span class="string">"""Collect a confusion matrix.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    The number of classes :math:`n\_class` is</span></span><br><span class="line"><span class="string">    :math:`max(pred\_labels, gt\_labels) + 1`, which is</span></span><br><span class="line"><span class="string">    the maximum class id of the inputs added by one.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        pred_labels (iterable of numpy.ndarray): A collection of predicted</span></span><br><span class="line"><span class="string">            labels. The shape of a label array</span></span><br><span class="line"><span class="string">            is :math:`(H, W)`. :math:`H` and :math:`W`</span></span><br><span class="line"><span class="string">            are height and width of the label.</span></span><br><span class="line"><span class="string">        gt_labels (iterable of numpy.ndarray): A collection of ground</span></span><br><span class="line"><span class="string">            truth labels. The shape of a ground truth label array is</span></span><br><span class="line"><span class="string">            :math:`(H, W)`, and its corresponding prediction label should</span></span><br><span class="line"><span class="string">            have the same shape.</span></span><br><span class="line"><span class="string">            A pixel with value :obj:`-1` will be ignored during evaluation.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        numpy.ndarray:</span></span><br><span class="line"><span class="string">        A confusion matrix. Its shape is :math:`(n\_class, n\_class)`.</span></span><br><span class="line"><span class="string">        The :math:`(i, j)` th element corresponds to the number of pixels</span></span><br><span class="line"><span class="string">        that are labeled as class :math:`i` by the ground truth and</span></span><br><span class="line"><span class="string">        class :math:`j` by the prediction.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    pred_labels = <span class="built_in">iter</span>(pred_labels)  <span class="comment"># (352, 480)</span></span><br><span class="line">    gt_labels = <span class="built_in">iter</span>(gt_labels)  <span class="comment"># (352, 480)</span></span><br><span class="line"></span><br><span class="line">    confusion = np.zeros((n_class, n_class), dtype=np.int64)  <span class="comment"># (12, 12)</span></span><br><span class="line">    <span class="keyword">for</span> pred_label, gt_label <span class="keyword">in</span> six.moves.<span class="built_in">zip</span>(pred_labels, gt_labels):</span><br><span class="line">        <span class="keyword">if</span> pred_label.ndim != <span class="number">2</span> <span class="keyword">or</span> gt_label.ndim != <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'ndim of labels should be two. pred.ndim:{}, gt.ndim:{}'</span>.<span class="built_in">format</span>(</span><br><span class="line">                pred_label.ndim, gt_label.ndim))</span><br><span class="line">        <span class="keyword">if</span> pred_label.shape != gt_label.shape:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'Shape of ground truth and prediction should'</span></span><br><span class="line">                             <span class="string">' be same.'</span>)</span><br><span class="line">        pred_label = pred_label.flatten()  <span class="comment"># (168960, )</span></span><br><span class="line">        gt_label = gt_label.flatten()  <span class="comment"># (168960, )</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Dynamically expand the confusion matrix if necessary.</span></span><br><span class="line">        lb_max = np.<span class="built_in">max</span>((pred_label, gt_label))</span><br><span class="line">        <span class="comment"># print(lb_max)</span></span><br><span class="line">        <span class="keyword">if</span> lb_max &gt;= n_class:</span><br><span class="line">            expanded_confusion = np.zeros(</span><br><span class="line">                (lb_max + <span class="number">1</span>, lb_max + <span class="number">1</span>), dtype=np.int64)</span><br><span class="line">            expanded_confusion[<span class="number">0</span>:n_class, <span class="number">0</span>:n_class] = confusion</span><br><span class="line"></span><br><span class="line">            n_class = lb_max + <span class="number">1</span></span><br><span class="line">            confusion = expanded_confusion</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Count statistics from valid pixels.  极度巧妙 × class_nums 正好使得每个ij能够对应.</span></span><br><span class="line">        <span class="comment"># 把2d矩阵变为1d进行编号排序，n_cls*gt 是确定在哪一行，+pred 表示真实标签在这一行，然后预测为第几个</span></span><br><span class="line">        <span class="comment"># 统计完成后再reshape回2d矩阵</span></span><br><span class="line">        mask = gt_label &gt;= <span class="number">0</span></span><br><span class="line">        confusion += np.bincount(</span><br><span class="line">            n_class * gt_label[mask].astype(<span class="built_in">int</span>) + pred_label[mask],</span><br><span class="line">            minlength=n_class ** <span class="number">2</span>) \</span><br><span class="line">            .reshape((n_class, n_class))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> iter_ <span class="keyword">in</span> (pred_labels, gt_labels):</span><br><span class="line">        <span class="comment"># This code assumes any iterator does not contain None as its items.</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">next</span>(iter_, <span class="literal">None</span>) <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'Length of input iterables need to be same'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> confusion</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calc_semantic_segmentation_iou</span>(<span class="params">confusion</span>):</span><br><span class="line">    <span class="string">"""Calculate Intersection over Union with a given confusion matrix.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    The definition of Intersection over Union (IoU) is as follows,</span></span><br><span class="line"><span class="string">    where :math:`N_{ij}` is the number of pixels</span></span><br><span class="line"><span class="string">    that are labeled as class :math:`i` by the ground truth and</span></span><br><span class="line"><span class="string">    class :math:`j` by the prediction.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    * :math:`\\text{IoU of the i-th class} =  \</span></span><br><span class="line"><span class="string">        \\frac{N_{ii}}{\\sum_{j=1}^k N_{ij} + \\sum_{j=1}^k N_{ji} - N_{ii}}`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        confusion (numpy.ndarray): A confusion matrix. Its shape is</span></span><br><span class="line"><span class="string">            :math:`(n\_class, n\_class)`.</span></span><br><span class="line"><span class="string">            The :math:`(i, j)` th element corresponds to the number of pixels</span></span><br><span class="line"><span class="string">            that are labeled as class :math:`i` by the ground truth and</span></span><br><span class="line"><span class="string">            class :math:`j` by the prediction.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        numpy.ndarray:</span></span><br><span class="line"><span class="string">        An array of IoUs for the :math:`n\_class` classes. Its shape is</span></span><br><span class="line"><span class="string">        :math:`(n\_class,)`.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    iou_denominator = (confusion.<span class="built_in">sum</span>(axis=<span class="number">1</span>) + confusion.<span class="built_in">sum</span>(axis=<span class="number">0</span>)</span><br><span class="line">                       - np.diag(confusion))</span><br><span class="line">    <span class="comment"># 混淆矩阵 行和 + 列和- 中间出现过两次的值 ==&gt;&gt; 并集</span></span><br><span class="line">    <span class="comment"># 混淆矩阵 值 ==&gt;&gt; 交集</span></span><br><span class="line">    iou = np.diag(confusion) / iou_denominator  <span class="comment"># 预测正确的数量 / 真实的数量+预测为该类的数量，即  交集/并集</span></span><br><span class="line">    <span class="keyword">return</span> iou</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">eval_semantic_segmentation</span>(<span class="params">pred_labels, gt_labels, n_class</span>):</span><br><span class="line">    <span class="string">"""Evaluate metrics used in Semantic Segmentation.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    This function calculates Intersection over Union (IoU), Pixel Accuracy</span></span><br><span class="line"><span class="string">    and Class Accuracy for the task of semantic segmentation.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    The definition of metrics calculated by this function is as follows,</span></span><br><span class="line"><span class="string">    where :math:`N_{ij}` is the number of pixels</span></span><br><span class="line"><span class="string">    that are labeled as class :math:`i` by the ground truth and</span></span><br><span class="line"><span class="string">    class :math:`j` by the prediction.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    * :math:`\\text{IoU of the i-th class} =  \</span></span><br><span class="line"><span class="string">        \\frac{N_{ii}}{\\sum_{j=1}^k N_{ij} + \\sum_{j=1}^k N_{ji} - N_{ii}}`</span></span><br><span class="line"><span class="string">    * :math:`\\text{mIoU} = \\frac{1}{k} \</span></span><br><span class="line"><span class="string">        \\sum_{i=1}^k \</span></span><br><span class="line"><span class="string">        \\frac{N_{ii}}{\\sum_{j=1}^k N_{ij} + \\sum_{j=1}^k N_{ji} - N_{ii}}`</span></span><br><span class="line"><span class="string">    * :math:`\\text{Pixel Accuracy} =  \</span></span><br><span class="line"><span class="string">        \\frac \</span></span><br><span class="line"><span class="string">        {\\sum_{i=1}^k N_{ii}} \</span></span><br><span class="line"><span class="string">        {\\sum_{i=1}^k \\sum_{j=1}^k N_{ij}}`</span></span><br><span class="line"><span class="string">    * :math:`\\text{Class Accuracy} = \</span></span><br><span class="line"><span class="string">        \\frac{N_{ii}}{\\sum_{j=1}^k N_{ij}}`</span></span><br><span class="line"><span class="string">    * :math:`\\text{Mean Class Accuracy} = \\frac{1}{k} \</span></span><br><span class="line"><span class="string">        \\sum_{i=1}^k \</span></span><br><span class="line"><span class="string">        \\frac{N_{ii}}{\\sum_{j=1}^k N_{ij}}`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    The more detailed description of the above metrics can be found in a</span></span><br><span class="line"><span class="string">    review on semantic segmentation [#]_.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    The number of classes :math:`n\_class` is</span></span><br><span class="line"><span class="string">    :math:`max(pred\_labels, gt\_labels) + 1`, which is</span></span><br><span class="line"><span class="string">    the maximum class id of the inputs added by one.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    .. [#] Alberto Garcia-Garcia, Sergio Orts-Escolano, Sergiu Oprea, \</span></span><br><span class="line"><span class="string">    Victor Villena-Martinez, Jose Garcia-Rodriguez. \</span></span><br><span class="line"><span class="string">    `A Review on Deep Learning Techniques Applied to Semantic Segmentation \</span></span><br><span class="line"><span class="string">    &lt;https://arxiv.org/abs/1704.06857&gt;`_. arXiv 2017.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        pred_labels (iterable of numpy.ndarray): A collection of predicted</span></span><br><span class="line"><span class="string">            labels. The shape of a label array</span></span><br><span class="line"><span class="string">            is :math:`(H, W)`. :math:`H` and :math:`W`</span></span><br><span class="line"><span class="string">            are height and width of the label.</span></span><br><span class="line"><span class="string">            For example, this is a list of labels</span></span><br><span class="line"><span class="string">            :obj:`[label_0, label_1, ...]`, where</span></span><br><span class="line"><span class="string">            :obj:`label_i.shape = (H_i, W_i)`.</span></span><br><span class="line"><span class="string">        gt_labels (iterable of numpy.ndarray): A collection of ground</span></span><br><span class="line"><span class="string">            truth labels. The shape of a ground truth label array is</span></span><br><span class="line"><span class="string">            :math:`(H, W)`, and its corresponding prediction label should</span></span><br><span class="line"><span class="string">            have the same shape.</span></span><br><span class="line"><span class="string">            A pixel with value :obj:`-1` will be ignored during evaluation.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        dict:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        The keys, value-types and the description of the values are listed</span></span><br><span class="line"><span class="string">        below.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        * **iou** (*numpy.ndarray*): An array of IoUs for the \</span></span><br><span class="line"><span class="string">            :math:`n\_class` classes. Its shape is :math:`(n\_class,)`.</span></span><br><span class="line"><span class="string">        * **miou** (*float*): The average of IoUs over classes.</span></span><br><span class="line"><span class="string">        * **pixel_accuracy** (*float*): The computed pixel accuracy.</span></span><br><span class="line"><span class="string">        * **class_accuracy** (*numpy.ndarray*): An array of class accuracies \</span></span><br><span class="line"><span class="string">            for the :math:`n\_class` classes. \</span></span><br><span class="line"><span class="string">            Its shape is :math:`(n\_class,)`.</span></span><br><span class="line"><span class="string">        * **mean_class_accuracy** (*float*): The average of class accuracies.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    # Evaluation code is based on</span></span><br><span class="line"><span class="string">    # https://github.com/shelhamer/fcn.berkeleyvision.org/blob/master/</span></span><br><span class="line"><span class="string">    # score.py#L37</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    confusion = calc_semantic_segmentation_confusion(pred_labels, gt_labels, n_class)</span><br><span class="line">    iou = calc_semantic_segmentation_iou(confusion)</span><br><span class="line">    pixel_accuracy = np.diag(confusion).<span class="built_in">sum</span>() / confusion.<span class="built_in">sum</span>()</span><br><span class="line">    class_accuracy = np.diag(confusion) / (np.<span class="built_in">sum</span>(confusion, axis=<span class="number">1</span>) + <span class="number">1e-10</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> {<span class="string">'iou'</span>: iou, <span class="string">'miou'</span>: np.nanmean(iou), <span class="comment"># 取平均就是mIoU</span></span><br><span class="line">            <span class="string">'pixel_accuracy'</span>: pixel_accuracy,</span><br><span class="line">            <span class="string">'class_accuracy'</span>: class_accuracy,</span><br><span class="line">            <span class="string">'mean_class_accuracy'</span>: np.nanmean(class_accuracy),</span><br><span class="line">            <span class="string">'conf_mat'</span>: confusion}</span><br><span class="line">    <span class="comment"># 'mean_class_accuracy': np.nanmean(class_accuracy)}</span></span><br></pre></td></tr></table></figure>

<h3 id="tools-x2F-helpers-py"><a href="#tools-x2F-helpers-py" class="headerlink" title="tools/helpers.py"></a>tools/helpers.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> PIL</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dir_exists</span>(<span class="params">path</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(path):</span><br><span class="line">            os.makedirs(path)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">initialize_weights</span>(<span class="params">*models</span>):</span><br><span class="line">    <span class="keyword">for</span> model <span class="keyword">in</span> models:</span><br><span class="line">        <span class="keyword">for</span> m <span class="keyword">in</span> model.modules():</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(m, nn.Conv2d):</span><br><span class="line">                nn.init.kaiming_normal_(m.weight.data, nonlinearity=<span class="string">'relu'</span>)</span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">isinstance</span>(m, nn.BatchNorm2d):</span><br><span class="line">                m.weight.data.fill_(<span class="number">1.</span>)</span><br><span class="line">                m.bias.data.fill_(<span class="number">1e-4</span>)</span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">isinstance</span>(m, nn.Linear):</span><br><span class="line">                m.weight.data.normal_(<span class="number">0.0</span>, <span class="number">0.0001</span>)</span><br><span class="line">                m.bias.data.zero_()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_upsampling_weight</span>(<span class="params">in_channels, out_channels, kernel_size</span>):</span><br><span class="line">    factor = (kernel_size + <span class="number">1</span>) // <span class="number">2</span></span><br><span class="line">    <span class="keyword">if</span> kernel_size % <span class="number">2</span> == <span class="number">1</span>:</span><br><span class="line">            center = factor - <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">            center = factor - <span class="number">0.5</span></span><br><span class="line">    og = np.ogrid[:kernel_size, :kernel_size]</span><br><span class="line">    filt = (<span class="number">1</span> - <span class="built_in">abs</span>(og[<span class="number">0</span>] - center) / factor) * (<span class="number">1</span> - <span class="built_in">abs</span>(og[<span class="number">1</span>] - center) / factor)</span><br><span class="line">    weight = np.zeros((in_channels, out_channels, kernel_size, kernel_size), dtype=np.float64)</span><br><span class="line">    weight[<span class="built_in">list</span>(<span class="built_in">range</span>(in_channels)), <span class="built_in">list</span>(<span class="built_in">range</span>(out_channels)), :, :] = filt</span><br><span class="line">    <span class="keyword">return</span> torch.from_numpy(weight).<span class="built_in">float</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">colorize_mask</span>(<span class="params">mask, palette</span>):</span><br><span class="line">    zero_pad = <span class="number">256</span> * <span class="number">3</span> - <span class="built_in">len</span>(palette)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(zero_pad):</span><br><span class="line">        palette.append(<span class="number">0</span>)</span><br><span class="line">    new_mask = PIL.Image.fromarray(mask.astype(np.uint8)).convert(<span class="string">'P'</span>)</span><br><span class="line">    new_mask.putpalette(palette)</span><br><span class="line">    <span class="keyword">return</span> new_mask</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">set_trainable_attr</span>(<span class="params">m, b</span>):</span><br><span class="line">    m.trainable = b</span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> m.parameters():</span><br><span class="line">        p.requires_grad = b</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">apply_leaf</span>(<span class="params">m, f</span>):</span><br><span class="line">    c = m <span class="keyword">if</span> <span class="built_in">isinstance</span>(m, (<span class="built_in">list</span>, <span class="built_in">tuple</span>)) <span class="keyword">else</span> <span class="built_in">list</span>(m.children())</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(m, nn.Module):</span><br><span class="line">        f(m)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(c) &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">for</span> l <span class="keyword">in</span> c:</span><br><span class="line">            apply_leaf(l, f)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">set_trainable</span>(<span class="params">l, b</span>):</span><br><span class="line">    apply_leaf(l, <span class="keyword">lambda</span> m: set_trainable_attr(m, b))</span><br></pre></td></tr></table></figure>

<h3 id="tools-x2F-model-trainer-py"><a href="#tools-x2F-model-trainer-py" class="headerlink" title="tools/model_trainer.py"></a>tools/model_trainer.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string"># @file name  : model_trainer.py</span></span><br><span class="line"><span class="string"># @author     : zz0320</span></span><br><span class="line"><span class="string"># @date       : 2022-04-16</span></span><br><span class="line"><span class="string"># @brief      : 模型训练流程类</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> Counter</span><br><span class="line"><span class="keyword">from</span> tools.evalution_segmentaion <span class="keyword">import</span> eval_semantic_segmentation</span><br><span class="line"><span class="keyword">from</span> torch.nn.utils <span class="keyword">import</span> clip_grad_value_</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ModelTrainer</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">train</span>(<span class="params">data_loader, model, loss_f, cfg, optimizer, epoch_idx, logger</span>):</span><br><span class="line">        model.train()</span><br><span class="line"></span><br><span class="line">        class_num = data_loader.dataset.cls_num</span><br><span class="line">        conf_mat = np.zeros((class_num, class_num))</span><br><span class="line">        loss_sigma = []</span><br><span class="line">        train_acc = []</span><br><span class="line">        train_miou = []</span><br><span class="line">        grad_lst_iter = []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i, data <span class="keyword">in</span> <span class="built_in">enumerate</span>(data_loader):</span><br><span class="line">            inputs, labels = data</span><br><span class="line">            inputs, labels = inputs.to(cfg.device), labels.to(cfg.device)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># foward &amp; backward</span></span><br><span class="line">            outputs = model(inputs)</span><br><span class="line">            optimizer.zero_grad()</span><br><span class="line">            loss = loss_f(outputs.cpu(), labels.cpu())</span><br><span class="line">            loss.backward()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> cfg.is_clip:</span><br><span class="line">                clip_grad_value_(model.parameters(), cfg.clip_value)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> cfg.hist_grad:</span><br><span class="line">                grad_lst_tmp = []</span><br><span class="line">                <span class="keyword">for</span> p <span class="keyword">in</span> model.parameters():</span><br><span class="line">                    grad_lst_tmp.append(torch.<span class="built_in">max</span>(p.grad.<span class="built_in">abs</span>()).cpu().numpy())</span><br><span class="line">                grad_lst_iter.append(<span class="built_in">max</span>(grad_lst_tmp).flatten()[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">            optimizer.step()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># eval</span></span><br><span class="line">            pre_label = outputs.<span class="built_in">max</span>(dim=<span class="number">1</span>)[<span class="number">1</span>].data.cpu().numpy()  <span class="comment"># (bs, 360, 480)</span></span><br><span class="line">            pre_label = [i <span class="keyword">for</span> i <span class="keyword">in</span> pre_label]  <span class="comment"># 一个元素是一个样本的预测。pre_label[0].shape = (360,480)</span></span><br><span class="line">            true_label = labels.data.cpu().numpy()</span><br><span class="line">            true_label = [i <span class="keyword">for</span> i <span class="keyword">in</span> true_label]  <span class="comment"># true_label[0].shape (360, 480)</span></span><br><span class="line"></span><br><span class="line">            eval_metrix = eval_semantic_segmentation(pre_label, true_label, class_num)</span><br><span class="line">            train_acc.append(eval_metrix[<span class="string">'mean_class_accuracy'</span>])</span><br><span class="line">            train_miou.append(eval_metrix[<span class="string">'miou'</span>])</span><br><span class="line">            conf_mat += eval_metrix[<span class="string">"conf_mat"</span>]</span><br><span class="line">            loss_sigma.append(loss.item())</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 间隔 log_interval 个 iteration 打印一次训练信息</span></span><br><span class="line">            <span class="keyword">if</span> i % cfg.log_interval == cfg.log_interval - <span class="number">1</span>:</span><br><span class="line">                logger.info(<span class="string">'|Epoch[{}/{}]||batch[{}/{}]|batch_loss:{:.4f}||mIoU:{:.4f}'</span>.<span class="built_in">format</span>(epoch_idx,</span><br><span class="line">                                    cfg.max_epoch, i + <span class="number">1</span>, <span class="built_in">len</span>(data_loader), loss.item(), eval_metrix[<span class="string">'miou'</span>]))</span><br><span class="line"></span><br><span class="line">        loss_mean = np.mean(loss_sigma)</span><br><span class="line">        acc_mean = np.mean(train_acc)</span><br><span class="line">        miou_mean = np.mean(train_miou)</span><br><span class="line">        <span class="keyword">return</span> loss_mean, acc_mean, conf_mat, miou_mean, grad_lst_iter</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">valid</span>(<span class="params">data_loader, model, loss_f, cfg</span>):</span><br><span class="line">        model.<span class="built_in">eval</span>()</span><br><span class="line"></span><br><span class="line">        class_num = data_loader.dataset.cls_num</span><br><span class="line">        conf_mat = np.zeros((class_num, class_num))</span><br><span class="line">        loss_sigma = []</span><br><span class="line">        valid_acc = []</span><br><span class="line">        valid_miou = []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i, data <span class="keyword">in</span> <span class="built_in">enumerate</span>(data_loader):</span><br><span class="line">            inputs, labels = data</span><br><span class="line">            inputs, labels = inputs.to(cfg.device), labels.to(cfg.device)</span><br><span class="line"></span><br><span class="line">            outputs = model(inputs)</span><br><span class="line">            loss = loss_f(outputs.cpu(), labels.cpu())</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 统计loss</span></span><br><span class="line">            loss_sigma.append(loss.item())</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 评估 mIoU的计算</span></span><br><span class="line">            pre_label = outputs.<span class="built_in">max</span>(dim=<span class="number">1</span>)[<span class="number">1</span>].data.cpu().numpy()  <span class="comment"># (bs, 360, 480)</span></span><br><span class="line">            pre_label = [i <span class="keyword">for</span> i <span class="keyword">in</span> pre_label]  <span class="comment"># 一个元素是一个样本的预测。pre_label[0].shape = (360,480)</span></span><br><span class="line">            true_label = labels.data.cpu().numpy()</span><br><span class="line">            true_label = [i <span class="keyword">for</span> i <span class="keyword">in</span> true_label]  <span class="comment"># true_label[0].shape (360, 480)</span></span><br><span class="line"></span><br><span class="line">            eval_metrix = eval_semantic_segmentation(pre_label, true_label, class_num) <span class="comment"># 一系列指标的计算 主要是IoU的计算</span></span><br><span class="line">            valid_acc.append(eval_metrix[<span class="string">'mean_class_accuracy'</span>])</span><br><span class="line">            valid_miou.append(eval_metrix[<span class="string">'miou'</span>])</span><br><span class="line">            conf_mat += eval_metrix[<span class="string">"conf_mat"</span>]</span><br><span class="line">            loss_sigma.append(loss.item())</span><br><span class="line"></span><br><span class="line">        loss_mean = np.mean(loss_sigma)</span><br><span class="line">        acc_mean = np.mean(valid_acc)</span><br><span class="line">        miou_mean = np.mean(valid_miou)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> loss_mean, acc_mean, conf_mat, miou_mean</span><br></pre></td></tr></table></figure>

<h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><h3 id="训练参数"><a href="#训练参数" class="headerlink" title="训练参数"></a>训练参数</h3><table>
<thead>
<tr>
<th>参数</th>
<th>值</th>
</tr>
</thead>
<tbody><tr>
<td>max_epoch</td>
<td>100</td>
</tr>
<tr>
<td>crop_size</td>
<td>[360, 480]</td>
</tr>
<tr>
<td>clip_value「梯度裁剪阈值」</td>
<td>1</td>
</tr>
<tr>
<td>train_bs</td>
<td>4</td>
</tr>
<tr>
<td>valid_bs</td>
<td>2</td>
</tr>
<tr>
<td>workers</td>
<td>4</td>
</tr>
<tr>
<td>lr_init</td>
<td>1</td>
</tr>
<tr>
<td>weight_decay</td>
<td>0.0001</td>
</tr>
<tr>
<td>momentum</td>
<td>0.9</td>
</tr>
<tr>
<td>milestones</td>
<td>[50, 85]</td>
</tr>
<tr>
<td>log_interval</td>
<td>10</td>
</tr>
<tr>
<td>loss_f</td>
<td>CrossEntropyLoss</td>
</tr>
<tr>
<td>optimizer</td>
<td>SGD</td>
</tr>
<tr>
<td>Backbone</td>
<td>ResNet-101</td>
</tr>
</tbody></table>
<h3 id="训练结果"><a href="#训练结果" class="headerlink" title="训练结果"></a>训练结果</h3><table>
<thead>
<tr>
<th></th>
<th>Train Acc</th>
<th>Valid Acc</th>
<th>Train loss</th>
<th>Train miou</th>
<th>Valid loss</th>
<th>Valid miou</th>
<th>LR</th>
<th align="left">max grad</th>
</tr>
</thead>
<tbody><tr>
<td><strong>裁剪前</strong></td>
<td>72.46%</td>
<td>57.25%</td>
<td>0.1807</td>
<td>0.6480</td>
<td>0.4784</td>
<td>0.4776</td>
<td>0.1</td>
<td align="left">in 0, is 13.799</td>
</tr>
<tr>
<td><strong>裁剪后</strong></td>
<td>71.02%</td>
<td>58.07%</td>
<td>0.1994</td>
<td>0.6318</td>
<td>0.4389</td>
<td>0.4875</td>
<td>0.1</td>
<td align="left">in 0, is 1.0</td>
</tr>
</tbody></table>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E5%88%86%E5%89%B2%E9%A1%B9%E7%9B%AE/" rel="tag"># 分割项目</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/05/22/%E3%80%8C%E5%88%86%E5%89%B2%E9%A1%B9%E7%9B%AE%E3%80%8D%EF%BC%88%E4%B8%80%EF%BC%89%E5%88%86%E5%89%B2%E8%AF%84%E4%BB%B7%E6%8C%87%E6%A0%87%E4%B8%8E%E5%B8%B8%E7%94%A8%E6%A8%A1%E5%9E%8B%E4%BB%8B%E7%BB%8D/" rel="prev" title="「分割项目」（一）分割评价指标与常用模型介绍">
                  <i class="fa fa-chevron-left"></i> 「分割项目」（一）分割评价指标与常用模型介绍
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/05/22/%E3%80%8C%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7%E3%80%8D%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7%E5%92%8C%E7%BD%91%E7%AB%99/" rel="next" title="「常用工具」持续更新常用工具和网站">
                  「常用工具」持续更新常用工具和网站 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">陨石kk</span>
</div>

<!--
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>
--!>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>



  <script src="/js/third-party/fancybox.js"></script>

  <script src="/js/third-party/pace.js"></script>

  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js","integrity":"sha256-r+3itOMtGGjap0x+10hu6jW/gZCzxHsoKrOd7gyRSGY="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/assets/hijiki.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body>
</html>
